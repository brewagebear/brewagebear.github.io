{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/review-essence-of-object-orientation/",
    "result": {"data":{"cur":{"id":"71473346-b939-5b1f-9fc7-2698078a9f3f","html":"<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#step-11-%EC%8B%A4%EC%84%B8%EA%B3%84-%EC%98%88%EC%8B%9C%EB%A5%BC-%ED%86%B5%ED%95%9C-%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EB%93%A4%EC%97%AC%EB%8B%A4%EB%B3%B4%EA%B8%B0\">STEP 1.1 실세계 예시를 통한 객체지향 들여다보기</a></li>\n<li><a href=\"#step-111-%EC%9A%94%EC%B2%AD%EA%B3%BC-%EC%9D%91%EB%8B%B5%EC%9C%BC%EB%A1%9C-%EA%B5%AC%EC%84%B1%EB%90%9C-%ED%98%91%EB%A0%A5\">STEP 1.1.1 요청과 응답으로 구성된 협력</a></li>\n<li><a href=\"#step-112-%EC%97%AD%ED%95%A0%EA%B3%BC-%EC%B1%85%EC%9E%84\">STEP 1.1.2 역할과 책임</a></li>\n<li><a href=\"#step-12-%EC%A4%91%EA%B0%84-%EC%A0%95%EB%A6%AC\">STEP 1.2 중간 정리</a></li>\n<li><a href=\"#step-21-%EC%83%81%ED%83%9C%EC%99%80-%ED%96%89%EB%8F%99%EC%9D%84-%ED%95%A8%EA%BB%98-%EC%A7%80%EB%8B%8C-%EC%9E%90%EC%9C%A8%EC%A0%81%EC%9D%B8-%EA%B0%9D%EC%B2%B4\">STEP 2.1 상태와 행동을 함께 지닌 자율적인 객체</a></li>\n<li><a href=\"#step-22-%ED%98%91%EB%A0%A5%EA%B3%BC-%EB%A9%94%EC%8B%9C%EC%A7%80\">STEP 2.2 협력과 메시지</a></li>\n<li><a href=\"#step-23-%EB%A9%94%EC%84%9C%EB%93%9C%EC%99%80-%EC%9E%90%EC%9C%A8%EC%84%B1\">STEP 2.3 메서드와 자율성</a></li>\n</ul>\n</div>\n<h1 id=\"객체지향의-사실과-오해-1장-리뷰\" style=\"position:relative;\"><a href=\"#%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%9D%98-%EC%82%AC%EC%8B%A4%EA%B3%BC-%EC%98%A4%ED%95%B4-1%EC%9E%A5-%EB%A6%AC%EB%B7%B0\" aria-label=\"객체지향의 사실과 오해 1장 리뷰 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>객체지향의 사실과 오해 1장 리뷰</h1>\n<ul>\n<li>STEP 1. 객체지향은 실세계의 모방이다?\n<ul>\n<li>STEP 1.1 실세계 예시를 통한 객체지향 들여다보기\n<ul>\n<li>STEP 1.1.1 요청과 응답으로 구성된 협력</li>\n<li>STEP 1.1.2 역할과 책임</li>\n</ul>\n</li>\n<li>STEP 1.2 중간 정리</li>\n</ul>\n</li>\n<li>STEP 2. 협력 속에 사는 객체\n<ul>\n<li>STEP 2.1 상태와 행동을 함께 지닌 자율적인 객체</li>\n<li>STEP 2.2 협력과 메시지</li>\n<li>STEP 2.3 메서드와 자율성</li>\n</ul>\n</li>\n<li>STEP 3. 객체지향의 본질</li>\n<li>STEP 4. 객체를 지향하라</li>\n</ul>\n<br/>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p>이 책을 보고 나서 많은 것들을 깨닫고, 많은 생각을 하게 되었다. 정말 객체지향이란 무엇인지? 에 대해서 가슴에 와닿게 설명해준 책이라 생각한다. 특히 나와 같은 초보들에게 말이다.</p>\n<p>이번 포스팅은 이 책을 읽고 같이 OOP에 대해서 좀 더 깊게 들어가고자 조영호님의 “객체지향의 사실과 오해”라는 책의 1장을 리뷰해보자 한다.</p>\n<center>\n<img src=\"https://user-images.githubusercontent.com/22961251/99187721-28c81400-2750-11eb-93b9-4c5e94c4c8ae.png\">\n</center>\n<br>\n<h1 id=\"step-1-객체지향은-실세계의-모방이다\" style=\"position:relative;\"><a href=\"#step-1-%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%9D%80-%EC%8B%A4%EC%84%B8%EA%B3%84%EC%9D%98-%EB%AA%A8%EB%B0%A9%EC%9D%B4%EB%8B%A4\" aria-label=\"step 1 객체지향은 실세계의 모방이다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. 객체지향은 실세계의 모방이다?</h1>\n<p><strong>객체지향은 실세계를 직접적이고 직관적으로 모델링 할 수 있다.</strong></p>\n<p>위의 말을 다시 풀어보자면, <strong>객체지향 세계는 실세계의 모방</strong>이라는 뜻이다.</p>\n<p>객체지향을 위와 같은 말로 설명할 수 있을까? 이 책의 저자 조용호님은 다음과 같이 말한다.</p>\n<blockquote>\n<p>이러한 설명은 철학적인 개념을 설명하는 데 적합하지만, 유연하고 실용적인 관점에서는 적합하지 않다.</p>\n</blockquote>\n<p>그렇다면? 객체지향과 실세계의 연관성은 어떻게 될까? 이 책에 나온 예를 들어보자.</p>\n<ul>\n<li>\n<p>건물의 방화벽과 네트워크의 방화벽</p>\n<p>→ 건물의 방화벽은 말 그대로 건물 내에 불이 번지는 것을 막기 위한 방화벽이다.</p>\n<p>→ 네트워크의 방화벽은 네트워크 침입을 막는 것이다.</p>\n</li>\n</ul>\n<p>일단, 의미적 거리만큼이나 소프트웨어 객체와 실세계 사물 사이에 존재하는 연관성은 희미하다.</p>\n<p>그렇다면 객체지향은 무엇일까?</p>\n<p>→ <strong>객체지향의 목표는 실세계를 모방하는 것이 아니다! 오히려 새로운 세계를 창조하는 것이다.</strong></p>\n<p>하지만, 실세계의 모방이라는 말은 객체지향의 철학적인 개념을 설명하는 데 적합하다하였다.</p>\n<p>나는 실세계의 예시를 통하여, 객체지향이 담고 있는 철학적인 개념 무엇인지? 설명하고자 한다.</p>\n<h2 id=\"step-11-실세계-예시를-통한-객체지향-들여다보기\" style=\"position:relative;\"><a href=\"#step-11-%EC%8B%A4%EC%84%B8%EA%B3%84-%EC%98%88%EC%8B%9C%EB%A5%BC-%ED%86%B5%ED%95%9C-%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EB%93%A4%EC%97%AC%EB%8B%A4%EB%B3%B4%EA%B8%B0\" aria-label=\"step 11 실세계 예시를 통한 객체지향 들여다보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1 실세계 예시를 통한 객체지향 들여다보기</h2>\n<center>\n<img src=\"https://user-images.githubusercontent.com/22961251/99187716-24036000-2750-11eb-939e-f238d1c1bb2e.png\">\n</center>\n<br>\n<p>출근길은 항상 고되다 현대인들은 이러한 고됨을 덜기 위해 카페를 찾아 커피를 구매한 뒤 본격적인 오전 업무를 진행하기 전 커피 한잔의 여유를 즐기곤 한다. 실세계의 예를 통해서 객체지향을 비교해볼 예시는 바로 출근길의 카페이다.</p>\n<p>대부분의 카페는 아래와 같이 주문이 처리될 것이다.</p>\n<ol>\n<li>손님은 커피를 주문한다.</li>\n<li>캐시어는 주문을 받는다.</li>\n<li>바리스타는 커피를 제조한다.</li>\n<li>바리스타는 제조한 커피를 캐시어에게 전달한다.</li>\n<li>캐시어는 전달받은 커피를 손님에게 전달한다.</li>\n<li>손님은 완성된 커피를 받는다.</li>\n</ol>\n<p>물론, 캐시어가 바리스타의 역할을 해서 주문을 받고 커피를 제조할 수도 있으며, 반대도 가능할 것이다.</p>\n<p>이 내용은 아래서 다뤄 볼 예정이다. 하지만 위의 예시(1~6)를 토대로 설명해보고자 한다.</p>\n<p>위와 같이 실세계에서 단순한 커피를 주문하는 작은 이벤트를 완성하는 데도 <strong>여러 사람의 조율과 조화</strong>가 필요한 것을 볼 수 있다.</p>\n<p>모든 음료 주문은 손님이 커피를 주문하고, 캐시어가 주문을 받고, 바리스타가 커피를 제조함으로서 이뤄진다.</p>\n<p>이 과정은 <strong>역할, 책임, 협력이라는 세 가지 개념이 한데 어울려 조화</strong>를 이루며 만들어 낸 것이다.</p>\n<ul>\n<li>\n<p>역할</p>\n<ul>\n<li>주문하는 손님</li>\n<li>주문을 받는 캐시어</li>\n<li>커피를 제조하는 바리스타</li>\n</ul>\n</li>\n<li>\n<p>책임</p>\n<ul>\n<li>손님은 주문할 책임을 수행</li>\n<li>캐시어는 주문을 받는 책임을 수행</li>\n<li>바리스타는 주문된 커피를 제조하는 책임을 수행</li>\n</ul>\n</li>\n</ul>\n<p>역할과 책임은 위와 같이 구성된 것을 볼 수가 있다. 그렇다면? 협력은 무엇일까?</p>\n<p>위와 같은 역할과 책임 속에 암묵적인 협력이 존재한다. 우리는 이 협력관계가 무엇인지 파악하고자 한다.</p>\n<h2 id=\"step-111-요청과-응답으로-구성된-협력\" style=\"position:relative;\"><a href=\"#step-111-%EC%9A%94%EC%B2%AD%EA%B3%BC-%EC%9D%91%EB%8B%B5%EC%9C%BC%EB%A1%9C-%EA%B5%AC%EC%84%B1%EB%90%9C-%ED%98%91%EB%A0%A5\" aria-label=\"step 111 요청과 응답으로 구성된 협력 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.1 요청과 응답으로 구성된 협력</h2>\n<center>\n<img src=\"https://user-images.githubusercontent.com/22961251/99187720-282f7d80-2750-11eb-8be4-d9bcc48a8d40.png\">\n</center>\n<p>실세계에서 우리는 스스로 해결하지 못하는 문제와 마주치면 문제 해결에 필요한 지식을 알고 있거나 서비스를 제공해줄 수 있는 사람에게 도움을 **요청(Request)**한다.</p>\n<p>위의 예시는 출근길 카페에 대한 요청 예시이다. 하나의 문제를 해결하기 위해서 다 수의 요청이 발생하는 것이 일반적이며, 따라서 요청은 <strong>연쇄적으로 발생한다.</strong> 응답 또한, 요청의 방향과 반대 방향으로 연쇄적으로 전달 되는 것을 알 수가 있다.</p>\n<ul>\n<li>손님은 커피를 제조하여 먹고싶은 문제를 해결하고자 함. → 카페에 들러서 커피 주문을 한다.</li>\n<li>캐시어는 주문을 해결할 수 있으나 커피 제조라는 문제를 해결하지 못한다 → 바리스타에게 커피 요청</li>\n<li>바리스타는 완성된 커피를 전달한다.</li>\n</ul>\n<p>이렇게 <strong>요청과 응답을 통해 다른 사람과 협력 할 수 있는 것</strong>은 복잡한 문제를 해결할 수 있는 공동체를 형성한다.</p>\n<h2 id=\"step-112-역할과-책임\" style=\"position:relative;\"><a href=\"#step-112-%EC%97%AD%ED%95%A0%EA%B3%BC-%EC%B1%85%EC%9E%84\" aria-label=\"step 112 역할과 책임 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.2 역할과 책임</h2>\n<p>사람들은 다른 사람들과 협력하는 과정 속에서 특별한 역할(Rule)을 부여받는다.</p>\n<p>역할은 <strong>어떤 협력에 참여하는 특정한 사람이 협력 안에서 차지하는 책임이나 임무를 의미</strong>한다.</p>\n<p>위의 예시를 들어서 설명하면, 어떤 사람이 손님이라는 역할을 맡았다면 커피를 주문하는 임무를 맡게되며, 캐시어라는 역할을 맡았으면 손님으로부터 주문을 받아야하는 임무를 맡게된다. 바리스타의 역할을 맡은 사람은 주문된 커피를 제조할 책임이 있다.</p>\n<p>위에서 “바리스타는 커피를 제조할 책임이 있다”라 하였는데 즉, <strong>역할은 책임이라는 개념을 내포</strong>함을 알 수가 있다.</p>\n<p>이러한 사실들은 몇가지 중요한 개념을 제시한다.</p>\n<ul>\n<li><strong>여러 사람이 동일한 역할을 수행할 수 있다.</strong></li>\n<li><strong>역할은 대체가능성을 의미한다.</strong></li>\n<li><strong>책임을 수행하는 방법은 자율적으로 선택할 수 있다.</strong></li>\n<li><strong>한 사람이 동시에 여러 역할을 수행할 수 있다.</strong></li>\n</ul>\n<p><strong>1. 여러 사람이 동일한 역할을 수행할 수 있다.</strong></p>\n<p>손님은 단지 커피를 받기만 하면 된다. 바리스타가 누군지 캐시어가 누군지는 신경쓰지 않는다. 만일, 캐시어가 그만둔다하더라도 캐시어라는 역할에 따르는 책임을 수행할 수 있는 다른 사람을 고용하면 된다.</p>\n<p>즉, 손님 입장에서는 캐시어가 주문을 받고 커피가 완성됐다는 사실을 통보하는 책임을 성실히 이행할 수 있다면 그만이다.</p>\n<p><strong>2. 역할은 대체 가능성을 의미한다.</strong></p>\n<p>손님 입장에서 캐시어는 **대체 가능(Subsittutable)**하다. 만약 두 명이 캐시어의 역할을 수행할 수 있다면, 손님 입장에서는 둘 중 어느누가 역할을 수행하더라도 문제가 되지않는다.</p>\n<p><strong>3. 책임을 수행하는 방법은 자율적으로 선택할 수 있다.</strong></p>\n<p>요청을 받은 사람들은 요청을 처리하는 방법을 자유롭게 선택할 수 있다. 즉, 바리스타가 카페라떼의 주문이 들어온 경우 어떠한 바리스타는 라떼아트를 할 수 있을 것이며, 어떤 바리스타는 풍미를 돋우기 위해 노력할지 모른다.</p>\n<p>즉, 바리스타의 역할을 수행하는 사람들마다 서로 다른 방식으로 요청을 처리한다는 것이다.</p>\n<p>그러나 그 결과 나오는 “카페라떼”는 변하지 않는다.</p>\n<p>이처럼 동일한 **요청에 대해 서로 다른 방식으로 응답할 수 있는 능력을 다형성(Polymorphism)**이라 한다.</p>\n<p><strong>4. 한 사람이 동시에 여러 역할을 수행할 수 있다.</strong></p>\n<p>처음 예시를 들 때 바리스타가 캐시어의 역할을 수행할 수 있을 수 있으며, 반대도 가능하다하였다.</p>\n<p>우리 주변의 카페도 그런 경우가 많다. 위의 예시는 캐시어와 바리스타라는 개별적인 역할을 이용해 협력관계를 묘사했지만, 한 사람이 캐시어와 바리스타의 역할을 동시에 수행하는 것도 가능하다.</p>\n<p>즉, 한 사람이 동시에 둘 이상의 역할을 수행하는 것이 가능하다.</p>\n<p>이는 다형성의 개념으로도 볼 수 있는데 학교에 등교할 때는 학생이라는 역할을 수행하며, 집에 돌아와서는 부모님의 막내아들이라는 역할을 수행하는 나와 같다고 볼 수 있다.</p>\n<h2 id=\"step-12-중간-정리\" style=\"position:relative;\"><a href=\"#step-12-%EC%A4%91%EA%B0%84-%EC%A0%95%EB%A6%AC\" aria-label=\"step 12 중간 정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.2 중간 정리</h2>\n<p>출근길 카페 예시를 통해서 알게 된 내용은 다음과 같다.</p>\n<p><strong>협력(collaboration)</strong> : <strong>문제를 해결할 수 있는 다른 사람에게 요청과 응답을 통해 문제를 해결하는 것</strong></p>\n<p><strong>역할(Rule)</strong> : <strong>어떤 협력에 참여하는 특정한 사람이 협력 안에서 차지하는 책임이나 임무</strong></p>\n<p><strong>책임(Responsiblilty)</strong> :  <strong>협력하는 과정에서 문제를 해결하기 위해 자신에 임무를 성실히 수행하는 것</strong></p>\n<p>또한, <strong>역할은 의미적으로 책임이라는 개념을 내포한다</strong>하였다.</p>\n<p>그리고 역할과 책임은 다음과 같은 특성을 갖는다.</p>\n<ul>\n<li><strong>여러 사람이 동일한 역할을 수행할 수 있다.</strong></li>\n<li><strong>역할은 대체 가능성을 의미한다.</strong></li>\n<li><strong>책임을 수행하는 방법은 자율적으로 선택할 수 있다.</strong></li>\n<li><strong>한 사람이 동시에 여러 역할을 수행할 수 있다.</strong></li>\n</ul>\n<p>그렇다면 출근길 카페 예시를 객체지향 세계로 옮기면 어떻게 될까?</p>\n<ul>\n<li>손님, 캐시어, 바리스타 → <strong>객체(Object)</strong></li>\n<li>손님이 캐시어에게 주문을 요청, 캐시어가 바리스타에게 커피 제조를 요청 → <strong>메시지(Message)</strong></li>\n<li>캐시어가 주문 요청을 처리하는 방법, 바리스타가 제조 요청을 처리하는 방법 → <strong>메서드(Method)</strong></li>\n</ul>\n<p>위와 같이 실세계의 예를 들어 객체지향 세계가 어떻게 이뤄지는지 철학적인 개념을 알게 되었다.</p>\n<p>이제 좀 더 실용적인 관점에서 이를 보고자 한다.</p>\n<h1 id=\"step-2-협력-속에-사는-객체\" style=\"position:relative;\"><a href=\"#step-2-%ED%98%91%EB%A0%A5-%EC%86%8D%EC%97%90-%EC%82%AC%EB%8A%94-%EA%B0%9D%EC%B2%B4\" aria-label=\"step 2 협력 속에 사는 객체 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2. 협력 속에 사는 객체</h1>\n<blockquote>\n<p>“어떤 객체도 섬이 아니다.” - Ward Cunningham, Kent Beck (1989)</p>\n</blockquote>\n<p>내가 가장 인상이 깊었던 말이었다. 객체지향의 본질을 밑에서 또 정리하겠지만, 여기까지 읽었을 때 객체지향이 무엇인가에 대해서 감이 오는가?</p>\n<p>나는 이렇게 생각한다.</p>\n<p><strong>“복잡하고 거대한 문제를 해결하기 위해서 역할과 책임을 성실히 수행하며 자율적으로 협력하는 객체들을 만들어 내는 것”</strong></p>\n<p>사람들이 어떠한 문제를 해결하기 위해서 협력하듯이 객체들은 애플리케이션의 기능을 구현하기 위해서 협력한다.</p>\n<p>객체지향 세계에서 협력에 참여하는 주체는 **객체(Object)**이다. 실세계에서 인간이라는 것이 없으면 역할, 책임, 협력은 아무런 의미가 없는 것 처럼 객체지향도 마찬가지이다.</p>\n<p>따라서, 객체는 다음 두 가지를 갖춰야한다.</p>\n<ol>\n<li><strong>객체는 충분히 ‘협력적’이어야 한다.</strong></li>\n<li><strong>객체는 충분히 ‘자율적’이어야 한다.</strong></li>\n</ol>\n<ul>\n<li><strong>객체는 충분히 ‘협력적’이어야 한다.</strong></li>\n</ul>\n<p><strong>“어떤 객체도 섬이 아니다”라는 말</strong>처럼 객체지향에서 꼭 잊으면 안되는 것이 <strong>협력</strong>이다. 객체지향 세계에서 객체는 다른 객체의 요청에 충실히 귀를 기울이고, 다른 객체에게 적극적으로 도움을 요청해야한다는 것이다.</p>\n<p>혼자서 모든 것을 처리하는 전지전능한 객체는 내부적인 복잡도에 의해 스스로 자멸한다.</p>\n<p>→ 이는 SOILD 원칙 중 **단일 책임 원칙(Single Responsibility Principle)**과 관련이 있다고 볼 수 있다.</p>\n<p>여기서 협력적이라는 말은 다른 객체의 명령에 수동적으로 움직이는 객체들을 말하는 것이 아니다.</p>\n<p>객체는 요청이 들어온 객체의 명령에 복종하는 것이 아니라 자율적으로 처리한다. 단순하게 말하면 요청에 응답을 주는 것일 뿐 내부적으로 어떠한 방식으로 응답을 생성 했는지는 외부 객체가 관여하지 않는다.</p>\n<p>→  이는 객체지향의 특성 중에 하나인 **캡슐화(Encapsulation)**과 관련이 있다.</p>\n<ul>\n<li><strong>객체는 충분히 ‘자율적’이어야 한다.</strong></li>\n</ul>\n<p>잠깐 설명했던 것 처럼 요청을 한 객체는 응답을 주는 객체에게 내부적으로 어떻게 응답을 생성하라 간섭을 하지 않는다. 단순하게 요청을 하고 해당 응답을 기다릴 뿐이다.</p>\n<p>잠깐 다시 출근길 카페로 돌아가보자.</p>\n<p>우리가 만약 캐시어라면 손님이 주문하면 행동을 시작하지만 손님이 주문하는 절차나 바리스타에게 접수한 것을 전달하는 방법은 스스로 결정한다.</p>\n<p>즉, 캐시어는 <strong>요청에 대해 스스로 판단하고 행동하는 자율적 존재</strong>이다.</p>\n<p>객체지향 세계에서도 마찬가지이다. <strong>객체는 협력에 참여하지만 스스로의 결정과 판단에 따라 행동하는 자율적인 존재</strong>이다. 그렇다면 어떻게 충분히 협력적이고, 자율적인 객체를 만들 수 있을까?</p>\n<h2 id=\"step-21-상태와-행동을-함께-지닌-자율적인-객체\" style=\"position:relative;\"><a href=\"#step-21-%EC%83%81%ED%83%9C%EC%99%80-%ED%96%89%EB%8F%99%EC%9D%84-%ED%95%A8%EA%BB%98-%EC%A7%80%EB%8B%8C-%EC%9E%90%EC%9C%A8%EC%A0%81%EC%9D%B8-%EA%B0%9D%EC%B2%B4\" aria-label=\"step 21 상태와 행동을 함께 지닌 자율적인 객체 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1 상태와 행동을 함께 지닌 자율적인 객체</h2>\n<p>이 장에서는 어떻게 충분히 협력적이고, 자율적인 객체를 만들 수 있을까?에 대한 해답을 내놓으려고 한다.</p>\n<p>힌트는 사실 위에서도 설명했지만, **캡슐화(Encapsulation)**랑 관련이 깊다.</p>\n<p>“객체는 **상태(state)와 행위(behavior)**를 갖는다”라는 말을 많이 들어 봤을 것이다. 객체가 협력에 참여하기 위해서 어떤 행동을 해야 한다면 그 행동을 하는 데 필요한 상태도 함께 지니고 있어야 한다는 것을 의미한다.</p>\n<p>객체의 <strong>자율성은 객체의 내부와 외부를 명확하게 구분하는 것으로부터 나온다.</strong> 즉, 무엇(What)을 수행하는지 알 수 있지만 어떻게(How) 수행하는지에 대해서 알 수 없다.</p>\n<p>그렇기에 객체의 자율성은 캡슐화와 관련이 깊다는 것이다.</p>\n<h2 id=\"step-22-협력과-메시지\" style=\"position:relative;\"><a href=\"#step-22-%ED%98%91%EB%A0%A5%EA%B3%BC-%EB%A9%94%EC%8B%9C%EC%A7%80\" aria-label=\"step 22 협력과 메시지 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2 협력과 메시지</h2>\n<p>인간 세계와 달리 객체지향 세계에서는 한 가지 의사소통 수단만이 존재한다. 바로 그것이 <strong>메시지</strong>이다.</p>\n<p>객체는 협력을 위해 다른 객체에게 메시지를 전송하고 다른 객체로 부터 메시지를 수신한다.</p>\n<p>객체지향 세계에서의 <strong>협력은 메시지를 전송하는 객체(Sender)와 수신하는 객체(Receiver) 사이에서 이뤄진다.</strong></p>\n<h2 id=\"step-23-메서드와-자율성\" style=\"position:relative;\"><a href=\"#step-23-%EB%A9%94%EC%84%9C%EB%93%9C%EC%99%80-%EC%9E%90%EC%9C%A8%EC%84%B1\" aria-label=\"step 23 메서드와 자율성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3 메서드와 자율성</h2>\n<p>어떤 객체가 협력을 위해 메세지를 수신하면 자신이 처리할 수 있는지 판단한 뒤 미리 정해진 자신만의 방법으로 메세지를 처리한다. 이 처리하는 방법을 <strong>메서드</strong>라고 부른다.</p>\n<p>그렇다면 메서드와 자율성은 무슨 연관성이 있을까?</p>\n<p>객체는 메시지를 수신하면 이를 수신할 수 있는지 판단하는데 이때, 판단할 수 있으면 위에서 얘기한 바와 같이 <strong>어떻게 처리하는 부분이 바로 메서드</strong>일 것이다.</p>\n<p>예를 들면 동일한 커피 제조 요청에도 바리스타는 커피머신으로 커피를 내릴 수도 있으며, 어떤 경우에는 핸드 드립으로 커피를 내릴 수도 있을 것이다.</p>\n<p>객체지향 세계에서는 협력에 참여하는 객체들 간의 메세지와 메서드의 분리를 통하여 자율성을 증진시킨다.</p>\n<p>좀 더 깊게 말하면, <strong>외부의 요청이 무엇인지를 표현하는 메시지와 요청을 처리하기 위한 구체적인 방법인 메서드를 분리하는 것</strong>이 객체의 자율성을 높인다. 이것 또한 캡슐화와 아주 깊은 연관 관계를 갖는다.</p>\n<h1 id=\"step-3-객체지향의-본질\" style=\"position:relative;\"><a href=\"#step-3-%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%9D%98-%EB%B3%B8%EC%A7%88\" aria-label=\"step 3 객체지향의 본질 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 객체지향의 본질</h1>\n<p>이번 포스팅에서 설명한 내용을 종합하여 객체지향의 본질을 정리하면 다음과 같다고 볼 수 있다.</p>\n<ul>\n<li>\n<p><strong>객체지향이란 시스템을 상호작용하는 자율적인 객체들의 공동체로 바라보고 객체를 이용해 시스템을 분할하는 방법이다.</strong></p>\n</li>\n<li>\n<p><strong>자율적인 객체란 상태와 행위를 함께 지니며 스스로 자기 자신을 책임지는 객체를 의미한다.</strong></p>\n</li>\n<li>\n<p><strong>객체는 시스템의 행위를 구현하기 위해 다른 객체와 협력한다.</strong></p>\n<p>→ <strong>각 객체는 협력 내에서 정해진 역할을 수행하며, 역할은 관련된 책임의 집합이다.</strong></p>\n</li>\n<li>\n<p><strong>객체는 다른 객체와 협력하기 위해 메시지를 전송하며, 메시지를 수신한 객체는 메시지를 처리하는 데 적합한 메서드를 자율적으로 선택한다.</strong></p>\n</li>\n</ul>\n<h1 id=\"step-3-객체를-지향하라\" style=\"position:relative;\"><a href=\"#step-3-%EA%B0%9D%EC%B2%B4%EB%A5%BC-%EC%A7%80%ED%96%A5%ED%95%98%EB%9D%BC\" aria-label=\"step 3 객체를 지향하라 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 객체를 지향하라</h1>\n<p>항상 우리는 객체지향 프로그래밍 혹은 객체지향 설계를 이야기할 때 항상 중점으로 바라봤던 것은 객체가 아니라 <strong>클래스</strong>였다.</p>\n<p>돌이켜 생각해보자, 학부시절 객체지향 설계를 보면 클래스 다이어그램이 중요하다 배웠었고, 객체지향 프로그래밍에서는 첫 장부터 객체와 클래스란 무엇인가?로 시작하지 않았나라고 말이다.</p>\n<p>잘 생각해보자 자바스크립트와 같은 프로토타입(prototype) 기반 언어들은 클래스라는 개념이 없음에도 (ES6 이전을 생각하자) 객체지향 언어라고 불리었다.</p>\n<p>우리가 배워야할 것은 클래스 지향 프로그래밍과 설계가 아니다. 객체지향 프로그래밍과 설계이다.</p>\n<p>이 책의 저자 조용호님께서는 클래스를 강조하는 프로그래밍 언어적인 관점은 다음과 같은 문제가 있다고 한다.</p>\n<ol>\n<li><strong>객체의 캡슐화를 저해한다.</strong></li>\n<li><strong>클래스를 서로 강하게 결합시킨다.</strong></li>\n<li><strong>협력하는 객체들의 공동체가 아닌 클래스로 구성된 설계도의 관점은 유연하고 확장가능한 애플리케이션 구축을 방해한다.</strong></li>\n</ol>\n<p>우리는 이제 객체를 지향해야 한다.</p>\n<p>클래스의 관점에서 메시지를 주고받는 객체의 관점으로 사고의 중심을 전환해야 된다는 것을 잊지 말아야 한다.</p>\n<p>중요한 것은 어떤 클래스가 필요한가가 아니라 어떤 객체들이 어떤 메세지를 주고받으며 협력하는가이다.</p>","excerpt":"STEP 1.1 실세계 예시를 통한 객체지향 들여다보기 STEP 1.1.1 요청과 응답으로 구성된 협력 STEP 1.1.2 역할과 책임 STEP 1.2 중간 정리 STEP 2.1 상태와 행동을 함께 지닌 자율적인 객체 STEP 2.2 협력과 메시지 STEP 2.3 메서드와 자율성 객체지향의 사실과 오해 1장 리뷰 STEP 1. 객체지향은 실세계의 모방이다? STEP 1.1 실세계 예시를 통한 객체지향 들여다보기 STEP 1.1.1 요청과 응답으로 구성된 협력 STEP 1.1.2 역할과 책임 STEP 1.2 중간 정리 STEP 2. 협력 속에 사는 객체 STEP 2.1 상태와 행동을 함께 지닌 자율적인 객체 STEP 2.2 협력과 메시지 STEP 2.3 메서드와 자율성 STEP 3. 객체지향의 본질 STEP 4. 객체를 지향하라 개요 이 책을 보고 나서 많은 것들을 깨닫고, 많은 생각을 하게 되었다. 정말 객체지향이란 무엇인지? 에 대해서 가슴에 와닿게 설명해준 책이라 생각한다. 특…","frontmatter":{"date":"November 15, 2020","title":"Book Review - 객체지향의 사실과 오해 1장 리뷰","categories":"개발 독서요약","author":"개발한입","emoji":"📚"},"fields":{"slug":"/review-essence-of-object-orientation/"}},"next":{"id":"2d56fc77-4903-5159-a64c-f40e3e42384e","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#step-11-%EC%BD%9C%EB%A0%89%EC%85%98-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC\">STEP 1.1 콜렉션 리팩토링에 대한 고민</a></p>\n<ul>\n<li><a href=\"#step-111-%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4%EC%97%90-%EC%A2%85%EC%86%8D%EC%A0%81%EC%9D%B8-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0-%EC%83%9D%EC%84%B1\">STEP 1.1.1 비즈니스에 종속적인 자료구조 생성</a></li>\n<li><a href=\"#step-112-collection%EC%9D%98-%EB%B6%88%EB%B3%80%EC%84%B1%EC%9D%84-%EB%B3%B4%EC%9E%A5\">STEP 1.1.2 Collection의 불변성을 보장</a></li>\n<li><a href=\"#step-113-%EA%B3%BC%EC%A0%9C%EC%97%90%EC%84%9C-%ED%99%9C%EC%9A%A9%ED%95%9C-%EB%B0%A9%EB%B2%95\">STEP 1.1.3 과제에서 활용한 방법</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-12-%EC%9D%B8%EC%A1%B0%ED%82%A4%EC%99%80-%EC%9E%90%EC%97%B0%ED%82%A4%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC\">STEP 1.2 인조키와 자연키에 대한 고민</a></p>\n</li>\n<li>\n<p><a href=\"#step-13-jpa-%EC%84%A4%EA%B3%84%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC\">STEP 1.3 JPA 설계에 대한 고민</a></p>\n</li>\n<li>\n<p><a href=\"#step-21-jpa-lazyinitializationexception-%ED%95%B8%EB%93%A4%EB%A7%81\">STEP 2.1 JPA LazyInitializationException 핸들링</a></p>\n<ul>\n<li><a href=\"#step-211-jpa-%EC%A7%80%EC%97%B0%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A6%89%EC%8B%9C%EB%A1%9C%EB%94%A9\">STEP 2.1.1 JPA 지연로딩과 즉시로딩</a></li>\n<li><a href=\"#step-212-jpa-n1-%EB%AC%B8%EC%A0%9C\">STEP 2.1.2 JPA N+1 문제</a></li>\n<li><a href=\"#step-213-fetch-join%EC%9D%84-%ED%86%B5%ED%95%9C-%ED%8A%B8%EB%9F%AC%EB%B8%94-%EC%8A%88%ED%8C%85\">STEP 2.1.3 Fetch Join을 통한 트러블 슈팅</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-22-%EB%8F%99%EC%9D%BC-%EA%B0%9D%EC%B2%B4-groupby-%ED%95%B8%EB%93%A4%EB%A7%81\">STEP 2.2 동일 객체 GroupBy 핸들링</a></p>\n</li>\n<li>\n<p><a href=\"#step-31-%EC%A0%95%EC%A0%81-%ED%8C%A9%ED%86%A0%EB%A6%AC-%EB%A9%94%EC%86%8C%EB%93%9C-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81-%EA%B4%80%EB%A0%A8\">STEP 3.1 정적 팩토리 메소드 리팩토링 관련</a></p>\n</li>\n</ul>\n</div>\n<ul>\n<li>STEP 1. 구현 중에 맞딱드린 고민과 해결방법\n<ul>\n<li>STEP 1.1 콜렉션 리팩토링에 대한 고민</li>\n<li>STEP 1.2 인조키와 자연키에 대한 고민</li>\n<li>STEP 1.3 JPA 설계에 대한 고민</li>\n</ul>\n</li>\n<li>STEP 2. 트러블 슈팅\n<ul>\n<li>STEP 2.1 JPA LazyInitializationException 핸들링</li>\n<li>STEP 2.2 동일 객체 GroupBy 핸들링</li>\n</ul>\n</li>\n<li>STEP 3. 아쉬운 점\n<ul>\n<li>STEP 3.1 정적 팩토리 메소드 리팩토링 관련</li>\n</ul>\n</li>\n<li>STEP 4. 참고자료(REFERENCE)</li>\n</ul>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p>모 스타트업의 과제 전형을 참가 한 뒤에 스스로 코드 리뷰 및 후기를 남기기 위해서 작성해보겠다.</p>\n<p>과제는 스프링을 활용한 작은 규모의 커맨드 라인 서비스를 만드는 것이었고, 더미테이블이 주어졌다.</p>\n<p>자세한 내용은 비밀로 유지해달라는 부탁을 받아서,  아쉽게도 전체 코드를 공개를 못하게 됐지만 내가 과제를 하면서 고민했던 부분들을 따로 정리하고자 이 포스트를 작성한다.</p>\n<h1 id=\"step-1-구현-중에-맞딱드린-고민과-해결방법\" style=\"position:relative;\"><a href=\"#step-1-%EA%B5%AC%ED%98%84-%EC%A4%91%EC%97%90-%EB%A7%9E%EB%94%B1%EB%93%9C%EB%A6%B0-%EA%B3%A0%EB%AF%BC%EA%B3%BC-%ED%95%B4%EA%B2%B0%EB%B0%A9%EB%B2%95\" aria-label=\"step 1 구현 중에 맞딱드린 고민과 해결방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. 구현 중에 맞딱드린 고민과 해결방법</h1>\n<h2 id=\"step-11-콜렉션-리팩토링에-대한-고민\" style=\"position:relative;\"><a href=\"#step-11-%EC%BD%9C%EB%A0%89%EC%85%98-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC\" aria-label=\"step 11 콜렉션 리팩토링에 대한 고민 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1 콜렉션 리팩토링에 대한 고민</h2>\n<p>과제를 진행하면서 무분별하게 콜렉션이 남발되는 부분이 있었다.</p>\n<p>이를 처리하기 위해서 일급 콜렉션을 도입하자고 생각하였다.</p>\n<p>이전부터 일급 콜렉션을 활용하는 방법과 장점을 알고 있었으나, 개념만 익혀놨을 뿐 써보지는 않았었다. 그래서 간단하게 정의와 장점을 알고 넘어가고자 한다.</p>\n<p>일단, 먼저 일급 콜렉션이 무엇인지? 알아보고자 한다.</p>\n<p>아래와 같이 카드덱 클래스가 존재한다고 가정하자.</p>\n<p>카드덱 클래스는 Card객체의 List를 가지고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CardDeck</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> CARD_DECK_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">13</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> PATTERN_A_NUMBER <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> PATTERN_J_NUMBER <span class=\"token operator\">=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> PATTERN_Q_NUMBER <span class=\"token operator\">=</span> <span class=\"token number\">12</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> PATTERN_K_NUMBER <span class=\"token operator\">=</span> <span class=\"token number\">13</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> cards <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이런 List<Card> 를 Wrapping을 아래의 코드와 같이 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Cards</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> cards<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Cards</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> cards<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>cards <span class=\"token operator\">=</span> cards<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>즉, 어떤 Collection을 <strong>Class로 Wrapping하는데 Wrapping한 대상이 된 Collection 의외에 다른 멤버변수가 없게 하는 것</strong>이 일급 콜렉션이다.</p>\n<p>이렇게 함으로써 어떤 장점을 가지게 될까?</p>\n<ol>\n<li>비즈니스에 종속적인 자료구조 생성</li>\n<li>Collection의 불변성(Immutable)을 보장</li>\n<li>상태와 행위를 한 곳에서 관리</li>\n<li>이름이 있는 콜렉션</li>\n</ol>\n<p>하나씩 살펴보고자 한다.</p>\n<h3 id=\"step-111-비즈니스에-종속적인-자료구조-생성\" style=\"position:relative;\"><a href=\"#step-111-%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4%EC%97%90-%EC%A2%85%EC%86%8D%EC%A0%81%EC%9D%B8-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0-%EC%83%9D%EC%84%B1\" aria-label=\"step 111 비즈니스에 종속적인 자료구조 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.1 비즈니스에 종속적인 자료구조 생성</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> patterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">CardSuit</span><span class=\"token punctuation\">.</span>SPADE<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">CardSuit</span><span class=\"token punctuation\">.</span>HEART<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">CardSuit</span><span class=\"token punctuation\">.</span>DIAMOND<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">CardSuit</span><span class=\"token punctuation\">.</span>CLUB<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">generatedCardDeckByPattern</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> pattern<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> CARD_DECK_SIZE<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">String</span> denomination <span class=\"token operator\">=</span> <span class=\"token function\">numberToDenomination</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Card</span> card <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Card</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CardSuit</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> denomination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>cards<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">generatedAllCardDeck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token class-name\">CardDeck</span><span class=\"token punctuation\">.</span>patterns<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">generatedCardDeckByPattern</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CardDeck</span><span class=\"token punctuation\">.</span>patterns<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>CardDeck은 위와 같은 행위를 통하여 전체 카드 52장을 만들어 낸다.</p>\n<p>이때, 나는 enum(cardSuit)을 통하여 패턴(스페이드, 하트, 다이아, 클로버) 등을 처리했다.</p>\n<p>그렇다면 이에 대한 검증 로직은 어디서 처리해야될까?</p>\n<p>물론, CardDeck에서 처리해도 된다고 생각이 들지만, 만약 비즈니스 로직이 많아지면서 클래스에 방대한 로직들이 쌓이게 된다면 검증로직을 쉽사리 찾기도 힘들 것이다.</p>\n<p>또한, 코드나 도메인을 모르는 사람들이 볼 때도 문제가 발생할 소지가 있다.</p>\n<p>그래서 이것을 일급 콜렉션으로 뺀다면 다음과 같이 해결 할 수 있을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Cards</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> CARDS_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">52</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> cards<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Cards</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> cards<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">validationSize</span><span class=\"token punctuation\">(</span>cards<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">validateDuplicate</span><span class=\"token punctuation\">(</span>cards<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>cards <span class=\"token operator\">=</span> cards<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">validationSize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> cards<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>cards<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> CARDS_SIZE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"전체 생성된 카드의 크기는 52장여야 합니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">validateDuplicate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> cards<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Card</span><span class=\"token punctuation\">></span></span> nonDuplicatedCards <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>cards<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>nonDuplicatedCards<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> cards<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"카드는 중복 생성할 수 없습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 함으로서 비즈니스 로직에 종속적인 자료구조를 생성하며, 상태와 행위를 한 곳에 집중시킬 수 있으며, 이름을 갖는 콜렉션을 사용할 수 있다.</p>\n<h3 id=\"step-112-collection의-불변성을-보장\" style=\"position:relative;\"><a href=\"#step-112-collection%EC%9D%98-%EB%B6%88%EB%B3%80%EC%84%B1%EC%9D%84-%EB%B3%B4%EC%9E%A5\" aria-label=\"step 112 collection의 불변성을 보장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.2 Collection의 불변성을 보장</h3>\n<p>여기서 가장 중요한 것은 콜렉션 특성상 <strong>Getter를 그대로 사용하면 레퍼런스 관계가 되어 값을 추가</strong> 할 수 있다. 따라서, 일급 콜렉션의 불변성을 보장하기 위해서는 <strong>필요한 값만을 반환</strong>하는 별도의 메소드들을 만들어서 사용해야 한다.</p>\n<p>나 또한, 별 생각없이 지나갔던 부분이었는데 이 부분은 <a href=\"https://woowacourse.github.io/javable/2020-05-08/First-Class-Collection\">일급 컬렉션을 사용하는 이유</a>를 보면서 알게되었다.</p>\n<p>해당 포스트의 샘플 코드를 몇개 가져와서 예시를 들어 설명해보겠다.</p>\n<p>로또 프로젝트를 진행한다고 가정했을 때 로또(Lotto)는 난수 6개인 로또번호(LottoNumber)를 리스트로 들고 있을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Lotto</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LottoNumber</span><span class=\"token punctuation\">></span></span> lotto<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Lotto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LottoNumber</span><span class=\"token punctuation\">></span></span> lotto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lotto <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>lotto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LottoNumber</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getLotto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> lotto<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LottoNumber</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> lottoNumber<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LottoNumber</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> lottoNumber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lottoNumber <span class=\"token operator\">=</span> lottoNumber<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이때 위의 getLotto()와 같이 Getter를 사용하면 콜렉션과 레퍼런스 관계가 되기때문에 값을 추가할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> lotto_변화_테스트<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LottoNumber</span><span class=\"token punctuation\">></span></span> lottoNumbers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    lottoNumbers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">LottoNumber</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Lotto</span> lotto <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Lotto</span><span class=\"token punctuation\">(</span>lottoNumbers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    lottoNumbers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">LottoNumber</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>따라서 일급 콜렉션의 불변을 보장하고 싶으면 위와 같이 <strong>내부 변수를 그대로 반환하는 Getter의 사용</strong>을 지양해야한다. 즉, 콜렉션 값을 그대로 반환하는 것을 없애는 것이 좋다.</p>\n<p>만약 그것들이 필요하다 하면 <a href=\"https://woowacourse.github.io/javable/2020-05-08/First-Class-Collection\">일급 컬렉션을 사용하는 이유</a> 하단에 어떻게하면 불변을 보장하면서 Getter를 사용할 수 있는지 나온다.</p>\n<h3 id=\"step-113-과제에서-활용한-방법\" style=\"position:relative;\"><a href=\"#step-113-%EA%B3%BC%EC%A0%9C%EC%97%90%EC%84%9C-%ED%99%9C%EC%9A%A9%ED%95%9C-%EB%B0%A9%EB%B2%95\" aria-label=\"step 113 과제에서 활용한 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.3 과제에서 활용한 방법</h3>\n<p>다시 과제 이야기로 돌아와 내가 일급 콜렉션을 쓰게 된 계기는 Order 클래스는 주문과 관계된 클래스다보니 비즈니스 로직이 많이 쌓일 수 밖에 없는 구조를 갖게되었다.</p>\n<p>그러다보니 자주 쓰는 콜렉션 중에서 주문과 관련된 콜렉션을 일급 콜렉션화하자라는 생각을 하게됐고, 아래와 같이 구현했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token comment\">//기본 생성자 제한</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token class-name\">AccessLevel</span><span class=\"token punctuation\">.</span>PRIVATE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderProductGroups</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OrderProductGroups</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>orderProducts <span class=\"token operator\">=</span> orderProducts<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">toMovieSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> orderProducts<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProduct</span><span class=\"token operator\">::</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>product <span class=\"token operator\">-></span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getProductType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equalsIgnoreCase</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movie\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">toMovieList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> orderProducts<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProduct</span><span class=\"token operator\">::</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>product <span class=\"token operator\">-></span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getProductType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equalsIgnoreCase</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movie\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\t  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기존에 List<OrderProduct>를 사용했는데 Order 비즈니스 로직이 해당 리스트로 인하여 너무 지저분해지고 있었다. 따라서, List<OrderProduct>를 OrderProductGroups라는 일급콜렉션화를 진행하였다.</p>\n<p>이를 통해서 코드가 매우 간결해지고 깔끔해짐을 알 수 있었는데 어떤 결과가 생겼는지 알아보자.</p>\n<p>살펴볼 코드의 로직은 아주 단순하다. List를 Set으로 만들어 사이즈가 다를 경우 중복값이 존재하니 해당 경우에 예외를 던지는 코드였다.</p>\n<ul>\n<li>리팩토링 전</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">checkDuplicatedMovie</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isDuplicatedMovie</span><span class=\"token punctuation\">(</span>orderProducts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DuplicatedMovieOrderException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"같은 Movie를 여러 개 주문이 불가합니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isDuplicatedMovie</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> movies <span class=\"token operator\">=</span> orderProducts<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProduct</span><span class=\"token operator\">::</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>product <span class=\"token operator\">-></span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getProductType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equalsIgnoreCase</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movie\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> movieSet <span class=\"token operator\">=</span> orderProducts<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProduct</span><span class=\"token operator\">::</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>product <span class=\"token operator\">-></span> product<span class=\"token punctuation\">.</span><span class=\"token function\">getProductType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equalsIgnoreCase</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movie\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> movies<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> movieSet<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>일급 콜렉션 사용을 통한 리팩토링 후</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">checkDuplicatedMovie</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProductGroups</span> orderProductGroups<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isDuplicatedMovie</span><span class=\"token punctuation\">(</span>orderProductGroups<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DuplicatedMovieOrderException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"같은 Movie를 여러 개 주문이 불가합니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isDuplicatedMovie</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProductGroups</span> orderProductGroups<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> products <span class=\"token operator\">=</span> orderProductGroups<span class=\"token punctuation\">.</span><span class=\"token function\">toMovieList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Product</span><span class=\"token punctuation\">></span></span> productSet <span class=\"token operator\">=</span> orderProductGroups<span class=\"token punctuation\">.</span><span class=\"token function\">toMovieSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> productSet<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 매우 깔끔해짐을 알 수가 있다. 또한, List<OrderProduct>에 영향을 받던 다른 코드들도 마찬가지로 깔끔하게 리팩토링을 할 수 있게 되었다.</p>\n<h2 id=\"step-12-인조키와-자연키에-대한-고민\" style=\"position:relative;\"><a href=\"#step-12-%EC%9D%B8%EC%A1%B0%ED%82%A4%EC%99%80-%EC%9E%90%EC%97%B0%ED%82%A4%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC\" aria-label=\"step 12 인조키와 자연키에 대한 고민 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.2 인조키와 자연키에 대한 고민</h2>\n<p>과제는 위에서 말한거처럼 더미테이블이 주어졌다. 이때 나는 Spring Data JPA를 도입하였는데 고민했던 부분은 PK 설정에 대한 부분이었다.</p>\n<p>혼자 프로젝트를 진행하거나 스터디를 진행했을 때는 PK를 단순하게 JPA 전략이 알아서하게끔 처리했었는데 이게 맞는 것인지에 대해서는 깊게 생각을 안했었다.</p>\n<p>하지만, 주어진 더미데이터에는 PK로 쓸 수 있는 부분이 있었고 이에 대해서 고민하기 시작했다. 이때, 인조키와 자연키에 대해서 알게 되었다.</p>\n<ul>\n<li>자연키(Natural Key)란?</li>\n</ul>\n<p><strong>비즈니스 모델에서 자연스레 나오는 속성을 기본키로 정하는 것</strong></p>\n<ul>\n<li>인조키(Artificial Key)란?</li>\n</ul>\n<p><strong>속성 중에서 기본키로 추출할 속성이 없어서 인위적으로 고유번호를 지정하는 것</strong></p>\n<p>자연키는 예시로 들 수 있는 것이 주민등록번호가 있을 것이다.</p>\n<p>인조키는 예시로 들 수 있는 것이 UUID나 DB 자체에서 생성된 시퀀스로 볼 수 있을 것이다.</p>\n<p>나는 자연키는 따로 필드를 빼두고 인조키를 PK로 활용하는 방안으로 설계를 진행하였다. 이 말은 그냥 JPA에서 알아서 PK를 처리하도록 하게끔 <code class=\"language-text\">@GeneratedValue(strategy = GenerationType.IDENTITY)</code> 전략을 활용하였다는 말이다.</p>\n<p>이 부분에 대해서 좀 더 알고 싶으면 해당 포스팅을 추천한다.</p>\n<p><a href=\"https://multifrontgarden.tistory.com/180\">기본키는 무엇으로 할까 - 자연키, 인조키</a></p>\n<h2 id=\"step-13-jpa-설계에-대한-고민\" style=\"position:relative;\"><a href=\"#step-13-jpa-%EC%84%A4%EA%B3%84%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC\" aria-label=\"step 13 jpa 설계에 대한 고민 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.3 JPA 설계에 대한 고민</h2>\n<p>주어진 과제에서 상품(Item)을 처리하는 부분이 있었는데 상품은 2개의 카테고리로 분리되어있었다. 그러나, 이것을 제외하고는 모든 필드가 동일하였다.</p>\n<p>만약, 두 카테고리가 다른 부분이 존재하였으면 공통부분은 추상클래스로 뺀 후에 처리를 했을 것 같다. 하지만 모든 필드가 동일한 것에 대해서는 어떻게 처리해야될까 고민했다.</p>\n<ul>\n<li>카테고리 클래스를 따로 빼서 처리해야될까?</li>\n<li>각각 카테고리로 나눠진 상품의 개별 클래스를 나눠서 짤까?</li>\n</ul>\n<p>결론 끝에 도달한 것은 상품이라는 클래스는 언제나 변화무쌍할 수 있다는 것이다. 과제에서 주어진 요구사항은 단순했지만, 각각 카테고리에 나중에 부분적으로 변화할 수 있는 부분들이 있다고 생각하였다.</p>\n<p>또한, 상태는 같아도 행위자체는 다르게 동작해야하는 부분들이 존재했다.</p>\n<p>따라서, 확장 가능성과 유지보수의 용이성으로 볼 때 추상클래스를 도입하는게 좋다고 판단하였다.</p>\n<ul>\n<li>추상클래스 Product</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"tbl_prod\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@DiscriminatorColumn</span>\n<span class=\"token annotation punctuation\">@Inheritance</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">InheritanceType</span><span class=\"token punctuation\">.</span>SINGLE_TABLE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Product</span> <span class=\"token punctuation\">{</span>\n\t\t\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span>IDENTITY<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"prod_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span> <span class=\"token comment\">//인조키</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"prod_key\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Long</span> naturalKey<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 자연키 = 상품번호</span>\n\n    <span class=\"token comment\">// @DiscriminatorColumn 기본값이 dtype이다. </span>\n    <span class=\"token comment\">// 카테고리에 따라서 다르게 동작해야할 로직이 존재해서 카테고리 참조를 위해 추가</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"dtype\"</span><span class=\"token punctuation\">,</span> nullable<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> updatable<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> insertable<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">String</span> productType<span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>자식클래스 Book</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"tbl_book\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@DiscriminatorValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"book\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@PrimaryKeyJoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"book_id\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// JPA 기본 생성자 생성 제한</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token class-name\">AccessLevel</span><span class=\"token punctuation\">.</span>PROTECTED<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Product</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 상태 존재 X</span>\n    <span class=\"token comment\">// 추상클래스 상태의 접근제어자들이 protected로 선언 되어있음</span>\n    <span class=\"token comment\">// 자식 클래스에서 concrete object로 생성하게끔 함.</span>\n    <span class=\"token annotation punctuation\">@Builder</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Book</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> naturalKey<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> productType<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>naturalKey <span class=\"token operator\">=</span> naturalKey<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>productType <span class=\"token operator\">=</span> productType<span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>과제의 기한이 7일이 주어진 타임어택형 과제였기 때문에, JPA의 Inheritance strategy로 <code class=\"language-text\">SINGLE_TABLE</code> 전략을 활용하기로 했다. 물론, <code class=\"language-text\">JOINED</code> 전략이 훨씬 정규화되어있고 좋기야하겠지만 가뜩이나 처리가 빡센 JPA 조인을 트러블 슈팅을 하면서 시간을 쓸 바에는 간단한 <code class=\"language-text\">SINGLE_TABLE</code> 전략이 낫다고 생각하여 채택했다.</p>\n<p>JPA의 상속 전략에 대해서 알고 싶으면 <a href=\"https://ict-nroo.tistory.com/128\">[JPA] 상속관계 매핑 전략(@Inheritance, @DiscriminatorColumn)</a> 이 포스팅을 읽어보도록 하자.</p>\n<h1 id=\"step-2-트러블-슈팅\" style=\"position:relative;\"><a href=\"#step-2-%ED%8A%B8%EB%9F%AC%EB%B8%94-%EC%8A%88%ED%8C%85\" aria-label=\"step 2 트러블 슈팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2. 트러블 슈팅</h1>\n<h2 id=\"step-21-jpa-lazyinitializationexception-핸들링\" style=\"position:relative;\"><a href=\"#step-21-jpa-lazyinitializationexception-%ED%95%B8%EB%93%A4%EB%A7%81\" aria-label=\"step 21 jpa lazyinitializationexception 핸들링 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1 JPA LazyInitializationException 핸들링</h2>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/98634956-05e6cb80-231c-11eb-98ae-7c59859fe0d0.png\" alt=\"ERD\"></p>\n<p>위의 구조는 내가 사용한 JPA 객체 관계를 표시한 다이어그램이라 볼 수 있다.</p>\n<p>Product ↔ Order는 다대다의 관계를 갖는데, JPA에서 <code class=\"language-text\">@ManyToMany</code> 키워드로 테이블을 생성하면 아래와 같이 조인을 위한 OrderProduct 테이블이 생성된다.</p>\n<p>그러나, 기본 생성되는 연결 테이블(OrderProduct)은 필드를 추가하거나 제거하거나 혹은 비즈니스 로직을 담을 수 없다.</p>\n<p>왜냐하면, 기본 생성되는 조인 테이블은 매핑 정보만 넣는 것이 가능하고, 추가 정보를 넣는 것 자체가 불가능하기 때문이다. 또한, Order와 Product는 엔티티를 우리가 생성한거여서 내부적으로 비즈니스 로직이나 검증처리를 할 수 있지만, OrderProduct 테이블은 자체 생성되는 것이기 때문에 그러한 로직처리가 불가능하다.</p>\n<p>따라서, ManyToMany 관계는 조인 테이블 엔티티를 따로 만든 후에 일대다, 다대일 관계로  풀어주는 것이 맞다.</p>\n<p>즉, 기본 생성되는 연결 테이블을 엔티티로 승격해주는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"tbl_order_prod\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token class-name\">AccessLevel</span><span class=\"token punctuation\">.</span>PROTECTED<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderProduct</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_prod_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span>IDENTITY<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\t\t\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>LAZY<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"prod_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Product</span> product<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>LAZY<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">;</span>\n\n   <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런 식으로 연결 테이블을 엔티티로 승격시킬 수가 있다.</p>\n<p>그렇다면 지금까지 이야기한 내용과 <code class=\"language-text\">LazyInitializationException</code>과 무슨 상관관계가 있을까?</p>\n<p>주목해야될 것은 <code class=\"language-text\">@ManyToOne(fetch = FetchType.LAZY)</code> 부분이다.</p>\n<h3 id=\"step-211-jpa-지연로딩과-즉시로딩\" style=\"position:relative;\"><a href=\"#step-211-jpa-%EC%A7%80%EC%97%B0%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A6%89%EC%8B%9C%EB%A1%9C%EB%94%A9\" aria-label=\"step 211 jpa 지연로딩과 즉시로딩 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1.1 JPA 지연로딩과 즉시로딩</h3>\n<p>JPA에서는 엔티티를 조회할 때 두 가지 방식을 사용할 수 있다.</p>\n<p>바로, **즉시로딩(Eager Loading)**과 **지연로딩(Lazy Loading)**이다.</p>\n<p>두 개는 무슨 차이일까?</p>\n<p>아래와 같은 코드가 가정하고 살펴보자.</p>\n<ul>\n<li>Member 엔티티</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token annotation punctuation\">@ManyToOne</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Team</span> team<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Team 엔티티</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Team</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 Member 엔티티와 Team  엔티티가 있고, 팀과 회원을 모두 출력하는 로직과 회원만 출력하는 로직이 있다고 하자.</p>\n<ul>\n<li>회원과 팀 정보를 출력하는 비즈니스 로직</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printUserAndTeam</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">Team</span> team <span class=\"token operator\">=</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getTeam</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"회원 이름 : \"</span> <span class=\"token operator\">+</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"소속팀 : \"</span> <span class=\"token operator\">+</span> team<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>회원만 출력하는 비즈니스 로직</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"회원 이름 : \"</span> <span class=\"token operator\">+</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드를 보면 알겠지만, Team과 Member 엔티티가 연관관계에 있어도 회원만 출력하는 경우 Team까지 함께 조회하는 것을 효율적이지 않다.</p>\n<p>JPA는 이러한 문제를 해결하려고 <strong>엔티티가 실제 사용될 때까지 데이터베이스 조회를 지연하는 것을 제공</strong>하는데 그것이 지연로딩(Lazy Loading)이다.</p>\n<p>쉽게 이야기해서 Team과 Member가 연관관계에 있어도 team.getTeam()과 같이 직접적으로 사용하지 않을 때는 DB에 접근해서 가져오지 않는 것을 말한다.</p>\n<p>이러한 지연로딩을 처리하기 위해서 실제 엔티티 객체 대신에 데이터베이스 조회를 지연할 객체가 필요한데 이것을 프록시객체라 한다.</p>\n<p>지연로딩과 즉시로딩을 정리를 하면 다음과 같다.</p>\n<ul>\n<li><strong>즉시 로딩(Eager Loading)</strong> : <strong>엔티티를 조회할 때 연관된 엔티티도 함께 조회된다.</strong>\n<ul>\n<li>예) em.find(Member.class, memberId)를 하게되면 Team 엔티티도 조회된다.</li>\n<li>사용 방법 : @ManyToOne(fetch = fetchType.EAGER)</li>\n</ul>\n</li>\n<li><strong>지연 로딩(Lazy Loading)</strong> : <strong>연관된 엔티티를 실제 사용할 때 조회한다.</strong>\n<ul>\n<li>예) member.getTeam().getName() 처럼 조회한 팀을 실제 사용할 때 SQL를 호출한다.</li>\n<li>사용 방법 : @ManyToOne(fetch = fetchType.LAZY)</li>\n</ul>\n</li>\n</ul>\n<p>그런데, 나는 모든 페치 전략을 LAZY로 둔 상태였다.</p>\n<p>일부로 즉시 로딩의 사용을 배제한 채 모두 지연 로딩으로 설정했는데 그 이유는 다음과 같다.</p>\n<ol>\n<li>\n<p><strong>예상치 못한 SQL이 발생한다.</strong></p>\n<p>→ 연관관계를 5개를 들고 있는 엔티티면 조인이 5번 일어난다.</p>\n</li>\n<li>\n<p><strong>JPQL에서 즉시로딩은 N+1 문제를 일으킨다.</strong></p>\n<p>→ LAZY 페치전략도 N+1문제를 일으키긴하지만 EAGER의 경우 심각하다</p>\n</li>\n</ol>\n<p>해당 케이스를 좀 더 깊게 보기 위해서 N+1 문제에 대해서 알아보고자 한다.</p>\n<h3 id=\"step-212-jpa-n1-문제\" style=\"position:relative;\"><a href=\"#step-212-jpa-n1-%EB%AC%B8%EC%A0%9C\" aria-label=\"step 212 jpa n1 문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1.2 JPA N+1 문제</h3>\n<p>해당 예시를 살펴보기 위해서 <a href=\"https://www.popit.kr/jpa-n1-%EB%B0%9C%EC%83%9D%EC%9B%90%EC%9D%B8%EA%B3%BC-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95/\">JPA N+1 발생원인과 해결 방법</a> 포스팅의 예제 코드를 가져왔다.</p>\n<ul>\n<li>즉시로딩 N+1 문제</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Entity</span>\n<span class=\"token annotation builtin\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"member\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> Member <span class=\"token keyword\">private</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation builtin\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"member\"</span><span class=\"token punctuation\">,</span> fetch <span class=\"token operator\">=</span> FetchType<span class=\"token punctuation\">.</span>EAGER<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> orders<span class=\"token operator\">:</span> Set<span class=\"token operator\">&lt;</span>Order<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">emptySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation builtin\">@Entity</span>\n<span class=\"token annotation builtin\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"orders\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> Order <span class=\"token keyword\">private</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation builtin\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> FetchType<span class=\"token punctuation\">.</span>EAGER<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"member_id\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> updatable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> member<span class=\"token operator\">:</span> Member\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span></code></pre></div>\n<p>코틀린이지만, 우리가 중요하게 보면 되는 부분은 연관 관계 부분이다. 해당 코드는 Member ↔ Order의 연관관계를 갖는데, 이 경우에 Member를 조회해도 Order를 가져오기 때문에 N+1 문제가 발생한다.</p>\n<p>예를 들면, Member가 1명이고, Order가 10개인 경우에도 Select 쿼리가 10번 나가는 것을 확인할 수 있다.</p>\n<p>즉, N+1 문제는 <strong>N + 1 → 1 (회원) + N (주문)</strong> 과 같이 1번 조회에 대해서 해당 조회에 연관관계가 얽힌 엔티티의 개수(N) 만큼 추가적으로 조회하는 문제이다. 만약, 주문 이외에 배송정보나 쿠폰정보 등이 포함되게 된다면, N + 1 쿼리는</p>\n<p>**1(회원) + N(주문) + N(배송정보) + N(쿠폰정보)**와 같이 매우 많은 쿼리가 발생하게 된다.</p>\n<p>이는 최악의 경우(Worst Case) 인데, 그 이유는 찾으려고 하는 값이 영속성 컨텍스트 내 존재하게 되면 조회 쿼리가 나가지는 않기 때문이다.</p>\n<p>그렇다면 <strong>지연로딩(Lazy Loading)을 통해서 N+1 문제를 해결 할 수 있을까?</strong></p>\n<p>가능하다. 해당 코드의 fetch = FetchType.EAGER를 LAZY로 바꾸면 Member를 조회할 때 1번만 조회가 된다.</p>\n<p>→ <strong>Order를 실제 사용하기 전까지 Select해서 Order를 가져오지 않기 때문이다.</strong></p>\n<p>그러나, <strong>다른 케이스에서는 지연로딩을 사용하더라도 N+1 문제가 발생할 수 있다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Test</span>\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">`지연로딩인 n+1`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> members <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 회원 한명에 대한 조회는 문제가 없다</span>\n    <span class=\"token keyword\">val</span> firstMember <span class=\"token operator\">=</span> members<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"order size : <span class=\"token interpolation\"><span class=\"token delimiter variable\">${</span>firstMember<span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">.</span>size<span class=\"token delimiter variable\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 조회한 모든 회원에 대해서 조회하는 경우 문제 발생</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>member <span class=\"token keyword\">in</span> members<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"order size: <span class=\"token interpolation\"><span class=\"token delimiter variable\">${</span>member<span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">.</span>size<span class=\"token delimiter variable\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 <code class=\"language-text\">findAll()</code>로 구한 members의 각각 해당하는 Order를 구하려고 하면, N+1 문제가 지연로딩에서도 동일하게 발생함을 알 수가 있다.</p>\n<p>이 케이스에서는 왜 N+1 문제가 발생하는 것일까?</p>\n<p>원인은 JPQL때문이다. <strong>JPQL은 글로벌 페치 전략을 완전히 무시하고 SQL을 실행한다.</strong></p>\n<p><code class=\"language-text\">memberRepository.findAll()</code>은 <code class=\"language-text\">select * from member</code>와 같은 SQL을 생성한다.</p>\n<p>아래와 같은 코드가 즉시 로딩과 지연 로딩에서 어떤 차이를 갖는지 알아보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> members <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>즉시로딩인 경우</li>\n</ul>\n<ol>\n<li><code class=\"language-text\">select * from member</code>가 members에 바인딩</li>\n<li>members의 글로벌 페치 전략이 EAGER이기 때문에 바인딩 된 후에 추가로 Order 객체 Select</li>\n</ol>\n<ul>\n<li>지연로딩인 경우</li>\n</ul>\n<ol>\n<li><code class=\"language-text\">select * from member</code>가 members에 바인딩</li>\n<li>members의 글로벌 페치 전략이 LAZY이기 때문에 바인딩 된 후 실제 Order 접근 시까지 조회쿼리 발생 X</li>\n<li>각 member의 order를 처리 → order 실제 사용 <code class=\"language-text\">member.order.size</code></li>\n<li>order를 조회해야함 → 즉, member 1건당 order 조회 N번 수행 N+1 문제 발생</li>\n</ol>\n<p>즉, 지연로딩인 경우에는 <strong><code class=\"language-text\">@OneToMany</code> 관계를 갖고 있는 Collection 내용에 접근할 때 N+1 문제가 발생한다.</strong></p>\n<p>변수에 접근할 때마다 쿼리가 날아가는 것이다.</p>\n<p>이 N+1 문제를 해결하기 위해서 자주 쓰는 방법 중에 하나가 **페치 조인(Fetch Join)**이 있다.</p>\n<p>하지만, 나 같은 경우에는 N+1 문제가 발생한 부분도 있었지만 다른 문제도 갖고 있었는데 바로 <code class=\"language-text\">LazyInitializationException</code> 문제였다. 이것 또한 fetch join으로 해결 하였는데 어떻게 해결했는지 알아보자</p>\n<h3 id=\"step-213-fetch-join을-통한-트러블-슈팅\" style=\"position:relative;\"><a href=\"#step-213-fetch-join%EC%9D%84-%ED%86%B5%ED%95%9C-%ED%8A%B8%EB%9F%AC%EB%B8%94-%EC%8A%88%ED%8C%85\" aria-label=\"step 213 fetch join을 통한 트러블 슈팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1.3 Fetch Join을 통한 트러블 슈팅</h3>\n<p>내가 수행한 과제의 경우에서 Product ↔ OrderProduct ↔ Order의 연관관계를 갖고 있었다.</p>\n<p>N+1 문제는 사실 Fetch Join을 많이 사용하는 용례를 설명하기 위해서도 있고 정리를 위해서 겸사겸사 정리하였다.</p>\n<p>나에게 더 중요한 문제는 <code class=\"language-text\">LazyInitializationException</code> 핸들링이었다.</p>\n<ul>\n<li>OrderResponseInfo (Order DTO 클래스)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Setter</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token class-name\">AccessLevel</span><span class=\"token punctuation\">.</span>PRIVATE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderResponseInfo</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OrderResponseInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>orderProducts <span class=\"token operator\">=</span> order<span class=\"token punctuation\">.</span><span class=\"token function\">getOrderProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Order와 OrderProduct가 연관관계를 맺는 부분</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"order\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span>ALL<span class=\"token punctuation\">,</span> orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>Order는 OrderProduct와 @OneToMany 관계를 가지고 있다. OrderProduct는 아까전에 JPA 설계에 대한 고민 부분을 보면 Order와 Product가 @OneToMany 관계로 연결된 테이블을 엔티티로 승격시켰다고 말했었다.</p>\n<p>여기서 내가 <code class=\"language-text\">LazyInitializationException</code> 예외를 맞딱드린 부분은 컨트롤러 부분에서 상품명을 출력할 때였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printProductTitle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderResponseInfo</span> dto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProduct</span> orderProduct <span class=\"token operator\">:</span> dto<span class=\"token punctuation\">.</span><span class=\"token function\">getOrderProducts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// LazyInitializationException 발생!</span>\n       writer<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>orderProduct<span class=\"token punctuation\">.</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTitle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" - \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>orderProduct<span class=\"token punctuation\">.</span><span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"개\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>왜 발생한 것일까?  하이버네이트 API를 보면 해당 예외는 다음과 같을 때 발생한다고 한다.</p>\n<blockquote>\n<p>Indicates access to unfetched data outside of a session context. For example, when an uninitialized proxy or collection is accessed after the session was closed.</p>\n</blockquote>\n<p>즉, 세션 컨텍스트 외부에 페치되지 않은 객체에 접근하고자 할 때 발생하는 예외인데 이를 쉽게 설명하자면 나는 지연로딩을 사용하고 있기 때문에 상위 엔티티를 조회했다고 한들 하위 엔티티가 직접적으로 가져와지지 않은 상태기 때문에 에러가 발생하는 것이다.</p>\n<ol>\n<li>\n<p>조회 서비스가 Select를 위한 서비스 (트랜잭션이 걸린)에 조회 요청을 한다.</p>\n</li>\n<li>\n<p>조회 결과가 반환 되면서 트랜잭션 종료</p>\n<ul>\n<li>이때 Entity는 영속상태가 아니라, 준영속 상태로 빠진다.</li>\n<li>만약 EAGER 패치로 가져왔다면 Entity의 하위 Entity가 함께 가져왔을 것이다.</li>\n</ul>\n<p>→ <strong>그러나, Lazy로 가져온 경우라면 하위 엔티티는 존재하지 않는 상태.</strong></p>\n</li>\n<li>\n<p>Lazy 로 가져온 데이터가 준 영속 상태에서 하위 엔티티를 조회하면 <code class=\"language-text\">LazyInitializationException</code>이 발생한다.</p>\n</li>\n</ol>\n<p>즉, 내 케이스의 경우에는 <strong>OrderProduct를 가져왔어도 하위 엔티티인 Product는 가져오지 않은 상태</strong>이다. 따라서 하위 엔티티에 대해서 조회하고자 하면 해당 예외가 발생하는 것이다.</p>\n<p>이를 아주 간단하게 아래와 같이 해결할 수 있다.</p>\n<ul>\n<li>Fetch Join 사용을 통한 LazyInitializationException 트러블 슈팅</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">OrderRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Order</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select distinct o from Order o \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"join fetch o.orderProducts op \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"join fetch op.product p \"</span> <span class=\"token operator\">+</span>\n            <span class=\"token string\">\"where o.id=?1\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Order</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Fetch Join을 사용하게 되면 <strong>연관관계가 얽힌 객체를 조회할 때 프록시 객체를 사용하는 것이 아니라 실제 엔티티를 조회</strong>한다. 따라서, 이를 통하여 연관 객체를 한번에 가져올 수 있는 것이다. LazyInitializationException뿐만 아니라 N+1 문제도 실제 엔티티를 조회하면서 연관 객체를 한번에 가져오면서 해결 할 수 있다.</p>\n<p>단, Fetch Join도 한계점이 존재한다.</p>\n<p>해당 내용은 <a href=\"https://www.popit.kr/jpa-n1-%EB%B0%9C%EC%83%9D%EC%9B%90%EC%9D%B8%EA%B3%BC-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95/\">JPA N+1 발생원인과 해결 방법</a>과 김영한님의 인프런 강의 <a href=\"https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-JPA-API%EA%B0%9C%EB%B0%9C-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94\">스프링부트-JPA-API개발-성능최적화</a> 섹션 3부분에 아주 잘나와있으니 참고해보자.</p>\n<h2 id=\"step-22-동일-객체-groupby-핸들링\" style=\"position:relative;\"><a href=\"#step-22-%EB%8F%99%EC%9D%BC-%EA%B0%9D%EC%B2%B4-groupby-%ED%95%B8%EB%93%A4%EB%A7%81\" aria-label=\"step 22 동일 객체 groupby 핸들링 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2 동일 객체 GroupBy 핸들링</h2>\n<p>동일한 상품이 단 건으로 여러번 주문 됐을 때,  하나의 그룹으로 묶는 것을 수행하고 싶었다.</p>\n<p>이를 테면, 메로나 1개 / 메로나 3개 → 메로나 4개 이런식으로 말이다.</p>\n<p>이는 과제의 요구사항에는 없는 부분이였지만 모든 기능을 구현 후에 시간이 남아서 따로 처리했었다.</p>\n<p>스트림을 그렇게 잘 다루는 편이 아니라 생각보다 오래걸렸었다.</p>\n<ul>\n<li>GroupBy를 위한 Mapping용 객체</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Setter</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span><span class=\"token punctuation\">(</span>access <span class=\"token operator\">=</span> <span class=\"token class-name\">AccessLevel</span><span class=\"token punctuation\">.</span>PRIVATE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MappingOrderProduct</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MappingOrderProduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProduct</span> orderProduct<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> orderProduct<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">groupingByOrderProducts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProductGroups</span> orderProductGroups<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> groupingMap <span class=\"token operator\">=</span> <span class=\"token function\">getGroupingMap</span><span class=\"token punctuation\">(</span>orderProductGroups<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts <span class=\"token operator\">=</span> orderProductGroups<span class=\"token punctuation\">.</span><span class=\"token function\">removeDuplicate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">updateGroupingOrderCount</span><span class=\"token punctuation\">(</span>groupingMap<span class=\"token punctuation\">,</span> orderProducts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> orderProducts<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateGroupingOrderCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> groupingMap<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> orderProducts<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProduct</span> orderProduct <span class=\"token operator\">:</span> orderProducts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Integer</span> groupingCount <span class=\"token operator\">=</span> groupingMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>orderProduct<span class=\"token punctuation\">.</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getNaturalKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            orderProduct<span class=\"token punctuation\">.</span><span class=\"token function\">updateCount</span><span class=\"token punctuation\">(</span>groupingCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getGroupingMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderProductGroups</span> orderProductGroups<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MappingOrderProduct</span><span class=\"token punctuation\">></span></span> productGroups <span class=\"token operator\">=</span> orderProductGroups<span class=\"token punctuation\">.</span><span class=\"token function\">toProductGroups</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">createGroupingMapByProductGroups</span><span class=\"token punctuation\">(</span>productGroups<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createGroupingMapByProductGroups</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MappingOrderProduct</span><span class=\"token punctuation\">></span></span> productGroups<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> productGroups<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token function\">groupingBy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MappingOrderProduct</span><span class=\"token operator\">::</span><span class=\"token function\">getNaturalKey</span><span class=\"token punctuation\">,</span>\n                            <span class=\"token function\">summingInt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MappingOrderProduct</span><span class=\"token operator\">::</span><span class=\"token function\">getOrderCount</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li>자연키를 통하여 기존 주문상품 리스트를 groupingBy를 한 후 주문 갯수를 summingInt를 통하여 합산한 Map 생성</li>\n<li>기존 주문상품 리스트를 자연키를 통하여 중복 제거 수행</li>\n<li>Map을 통하여 합산된 주문 개수를 기존 주문상품 리스트에 업데이트하여 리턴</li>\n</ol>\n<p>이러한 방식으로 처리하였다.</p>\n<p>중복 제거는 일급 콜렉션으로 만든 OrderProductGroups에 구현해놨는데 아래와 같이 짰다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderProduct</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">removeDuplicate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> orderProducts<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token function\">distinctBy</span><span class=\"token punctuation\">(</span>orderProduct <span class=\"token operator\">-></span> orderProduct<span class=\"token punctuation\">.</span><span class=\"token function\">getProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getNaturalKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Predicate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">distinctBy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> f<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> objects <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> t <span class=\"token operator\">-></span> objects<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h1 id=\"step-3-아쉬운-점\" style=\"position:relative;\"><a href=\"#step-3-%EC%95%84%EC%89%AC%EC%9A%B4-%EC%A0%90\" aria-label=\"step 3 아쉬운 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 아쉬운 점</h1>\n<p>과제를 진행할 당시에는 몰랐지만, 혼자서 코드 리뷰를 한 뒤에 느낀 아쉬운 점을 적어보겠다.</p>\n<h2 id=\"step-31-정적-팩토리-메소드-리팩토링-관련\" style=\"position:relative;\"><a href=\"#step-31-%EC%A0%95%EC%A0%81-%ED%8C%A9%ED%86%A0%EB%A6%AC-%EB%A9%94%EC%86%8C%EB%93%9C-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81-%EA%B4%80%EB%A0%A8\" aria-label=\"step 31 정적 팩토리 메소드 리팩토링 관련 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.1 정적 팩토리 메소드 리팩토링 관련</h2>\n<p>위에서 설명한 것과 같이 Product를 추상 클래스로 선언 후에 사용했었다 얘기를 했었다.</p>\n<p>그래서 concrete object인 Product를 extends한 하위 클래스를 생성할 때 빌더 패턴과 정적 팩토리 메소드 패턴을 활용했었다.</p>\n<ul>\n<li>하위 클래스의 Builder 부분</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Builder</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Movie</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> naturalKey<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>naturalKey <span class=\"token operator\">=</span> naturlKey<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\t\t\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Movie</span> <span class=\"token function\">createMovie</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> naturalKey<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">validation</span><span class=\"token punctuation\">(</span>naturalKey<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">Movie</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t        <span class=\"token punctuation\">.</span><span class=\"token function\">naturalKey</span><span class=\"token punctuation\">(</span>naturalKey<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>구현한 정적 팩토리 메소드 패턴</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProductFactory</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Product</span> <span class=\"token function\">createProduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestInfo</span> dto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Movie\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equalsIgnoreCase</span><span class=\"token punctuation\">(</span>dto<span class=\"token punctuation\">.</span><span class=\"token function\">getProductType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">Movie</span><span class=\"token punctuation\">.</span><span class=\"token function\">createMovie</span><span class=\"token punctuation\">(</span>dto<span class=\"token punctuation\">.</span><span class=\"token function\">getNaturalKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> \n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Product 객체를 생성할 수 없습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Product</span> <span class=\"token function\">getProduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductResponseInfo</span> dto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Movie\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equalsIgnoreCase</span><span class=\"token punctuation\">(</span>dto<span class=\"token punctuation\">.</span><span class=\"token function\">getProductType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">Movie</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMovie</span><span class=\"token punctuation\">(</span>dto<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> \n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Product 객체를 생성할 수 없습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>사실 어떻게 보면 팩토리 패턴에 가까이 설계 했는데, 카테고리마다 다른 concrete object를 생성하기 때문에 분기 처리를 하여 처리했다.</p>\n<p>여기서 Factory를 사용한 이유는 createProduct로 알맞은 Request DTO가 들어왔을 때 카테고리 분류에 따라서 concrete object를 생성하기 위함이었다. 서브 클래스 내부의 create 메소드는 따로 사용할 때가 있다고 판단해서 냅둔 것인데 이렇게 처리하는 것은 어쨋든 간 productFactory를 사용하는 게 아니라 subclass의 create 메소드가 노출될 확률이 있다고 생각한다.</p>\n<p>또한 하위 클래스 내부에 validation 메소드를 집어 넣었는데 try를 통하여 exception을 캐치하는 것이 아니라 IllegalArgumentException을 따로 던져주는 것을 확인 할 수 있었다.</p>\n<p>이 부분은 try-catch로 처리해야된다고 생각한다.</p>\n<p>이 부분을 다시 리팩토링해보면 이렇게 될 것같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// Subclass </span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Product</span> <span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestInfo</span> dto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">validation</span><span class=\"token punctuation\">(</span>dto<span class=\"token punctuation\">.</span><span class=\"token function\">getNaturalKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">Movie</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t        <span class=\"token punctuation\">.</span><span class=\"token function\">naturalKey</span><span class=\"token punctuation\">(</span>dto<span class=\"token punctuation\">.</span><span class=\"token function\">getNaturalKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Factory</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Product</span> <span class=\"token function\">createProduct</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProductRequestInfo</span> dto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Product</span> product <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isMovie</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Movie\"</span><span class=\"token punctuation\">,</span> dto<span class=\"token punctuation\">.</span><span class=\"token function\">getProductType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            product <span class=\"token operator\">=</span> <span class=\"token class-name\">Movie</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>dto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalArgumentException</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> product<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다른 방법은 아예 Factory를 없애고, 추상 클래스에 <code class=\"language-text\">isMovie()</code>과 같은 메소드를 추가하여 서브클래스에서 구현한 뒤에 처리하는 방법도 있을 것 같다.</p>\n<p>추상 클래스에 빌더 패턴을 적용하는 등 아쉬운 부분이 있지만, 이것은 지금 구현된 아키텍처에는 굳이 적용하지 않아도 될 부분이라고 생각하여 생략한다.</p>\n<p>또한, TDD나 기타 등등 쓸 내용이 더 많지만, 제일 시간을 오래쏟고 고민했던 것들 위주로 정리해봤다.</p>\n<p>그래도 나름 열심히 짜서 과제 전형에 합격해서 기분은 좋다 ㅎㅎ</p>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/98634965-0da67000-231c-11eb-884d-d40a26cce4b3.png\" alt=\"합격\"></p>\n<h1 id=\"step-4-reference\" style=\"position:relative;\"><a href=\"#step-4-reference\" aria-label=\"step 4 reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 4. REFERENCE</h1>\n<p><a href=\"https://jojoldu.tistory.com/412\">일급 컬렉션 (First Class Collection)의 소개와 써야할 이유</a></p>\n<p><a href=\"https://woowacourse.github.io/javable/2020-05-08/First-Class-Collection\">일급 컬렉션을 사용하는 이유</a></p>\n<p><a href=\"https://multifrontgarden.tistory.com/180\">기본키는 무엇으로 할까 - 자연키, 인조키</a></p>\n<p><a href=\"https://ict-nroo.tistory.com/132\">JPA - 즉시 로딩과 지연 로딩(FetchType.LAZY or EAGER)</a></p>\n<p><a href=\"https://ict-nroo.tistory.com/127\">JPA - @ManyToMany, 다대다[N:M] 관계</a></p>\n<p><a href=\"https://www.popit.kr/jpa-n1-%EB%B0%9C%EC%83%9D%EC%9B%90%EC%9D%B8%EA%B3%BC-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95/\">JPA N+1 발생원인과 해결방법</a></p>\n<p><a href=\"https://meetup.toast.com/posts/87\">JPA N+1 쿼리 문제와 해결</a></p>\n<p><a href=\"https://kapentaz.github.io/jpa/hibernate/@ManyToOne%EC%9D%98-N+1-%EB%AC%B8%EC%A0%9C-%EC%9B%90%EC%9D%B8-%EB%B0%8F-%ED%95%B4%EA%B2%B0/#\">@ManyToOne의-N+1-문제-원인-및-해결</a></p>\n<p><a href=\"https://uncle-bae.blogspot.com/2015/12/hibernate-lazyinitializationexception.html\">Hibernate LazyInitializationException 해결</a></p>","frontmatter":{"date":"November 10, 2020","title":"Review after the homework of a Startup - 어떤 스타트업의 과제 전형 참여 후기","categories":"개발","author":"개발한입","emoji":"💻"},"fields":{"slug":"/review-startup-homework/"}},"prev":{"id":"287f6419-a82a-51e9-8464-09d3be200c24","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#step-1-redis-write-back%EC%9D%84-%EB%8F%84%EC%9E%85%ED%95%98%EB%8A%94-%EC%97%AC%EC%A0%95%EA%B8%B0\">STEP 1. Redis Write Back을 도입하는 여정기</a></p>\n</li>\n<li>\n<p><a href=\"#step-1-redis-collection-%EC%84%A4%EA%B3%84-%EB%B0%8F-%EA%B5%AC%ED%98%84\">STEP 1. Redis Collection 설계 및 구현</a></p>\n<ul>\n<li><a href=\"#step-21-%EC%B6%94%EA%B0%80-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\">STEP 2.1 추가 요구사항</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-3-%EB%AC%B8%EC%A0%9C%EC%A0%90\">STEP 3. 문제점</a></p>\n</li>\n</ul>\n</div>\n<h1 id=\"목차\" style=\"position:relative;\"><a href=\"#%EB%AA%A9%EC%B0%A8\" aria-label=\"목차 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목차</h1>\n<ul>\n<li>개요</li>\n<li>STEP 1. Redis Write Back을 도입하는 여정기</li>\n<li>STEP 2. Redis Collection 설계 및 구현\n<ul>\n<li>STEP 2.1 추가 요구사항</li>\n</ul>\n</li>\n<li>STEP 3. 문제점</li>\n<li>STEP 4. REFERENCE</li>\n</ul>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p>현재 재직 중인 회사에서 추천 시스템을 도입하기 위해서 기존의 로깅 방식에 대해서 고도화가 필요했었다.</p>\n<p>일단, 아주 단순하게 기존 사용자에게 추천됐던 아이템과 읽은 아이템을 토대로 추천 시스템을 만들고자하였다.</p>\n<p>이 업무를 진행하기에 앞서 진행되어야하는 부분이 바로 어떤 아이템들이 추천되었고, 어떤 아이템을 읽었는지에 대한 로그를 수집하는 일이었다.</p>\n<p>기존에는 사용자가 클릭을 수행하면 바로 DB에 저장이 되는 형식이였으나 사용자가 증가함에 따라 DB 부하 문제도 있고, 개선책을 찾게 되었다.</p>\n<h2 id=\"step-1-redis-write-back을-도입하는-여정기\" style=\"position:relative;\"><a href=\"#step-1-redis-write-back%EC%9D%84-%EB%8F%84%EC%9E%85%ED%95%98%EB%8A%94-%EC%97%AC%EC%A0%95%EA%B8%B0\" aria-label=\"step 1 redis write back을 도입하는 여정기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. Redis Write Back을 도입하는 여정기</h2>\n<p>그에 대한 개선책으로는 이러한 흐름으로 생각하게 되었다.</p>\n<ul>\n<li>사용자가 클릭하면 이 데이터를 바로 DB로 넣는 부분은 DB 부하의 문제가 존재한다.</li>\n</ul>\n<blockquote>\n<p>그렇다면 어딘가에 클릭했던 내역을 모아두고 일정 시간이 되면 DB에 벌크 삽입(Bulk Insert)하는 방식은 어떨까?</p>\n</blockquote>\n<ul>\n<li>그렇다면 이 내역을 일정 기간 동안 모아둘 곳이 필요한데 어디다 모아둘 것인가?</li>\n</ul>\n<blockquote>\n<p>Redis를 사용하자</p>\n</blockquote>\n<p>위의 내용을 취합하면 우리가 내린 결론은 Redis를 <strong>Write Back</strong> 방식으로 사용하는 것이었다.</p>\n<p>해당 내용은 <a href=\"https://youtu.be/mPB2CZiAkKM?t=530\">우아한테크세미나 - 우아한 Redis</a> 을 참고해보자.</p>\n<p>그 후에 배치 잡을 통하여 Redis Cache에 저장된 값을 DB에 Bulk Insert하는 방식으로 방향을 잡게 되었다.</p>\n<h2 id=\"step-1-redis-collection-설계-및-구현\" style=\"position:relative;\"><a href=\"#step-1-redis-collection-%EC%84%A4%EA%B3%84-%EB%B0%8F-%EA%B5%AC%ED%98%84\" aria-label=\"step 1 redis collection 설계 및 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. Redis Collection 설계 및 구현</h2>\n<p>기존 Redis에는 사용자에게 추천될 아이템의 캐시만 있었던 상황인데 이제 추가적으로 Data들이 필요해졌다.</p>\n<ol>\n<li>해당 사용자에게 추천된 아이템들 Collection</li>\n<li>해당 사용자가 읽은 아이템 Collection</li>\n<li>해당 사용자가 언제, 읽었고 그 아이템이 추천된 아이템인지를 확인하는 Collection</li>\n</ol>\n<p>Redis Collection을 처음 다루다보니 아주 단순하게 <code class=\"language-text\">nested json</code> 형태로 작업을 하고자하였다. 그러나, 초반부터 난관에 봉착했다.</p>\n<p>그 이유는 아주 단순하다. Redis는 <code class=\"language-text\">nested hash</code> 를 지원안한다.</p>\n<p>예를 들어보자 아래와 같은 데이터 셋을 나는 가지고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Prod_Color  |   Prod_Count  |   Prod_Price   |   Prod_Info\n------------------------------------------------------------\n  Red        |       12      |       300      |   In Stock\n  Blue       |        8      |       310      |   In Stock</code></pre></div>\n<p>그래서 이걸 토대로 아래와 같은 명령어를 통해서 <code class=\"language-text\">Hashes</code> 로 저장하고자 하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">HMSET Records Prod_Color <span class=\"token string\">\"Red\"</span> Prod_Count <span class=\"token number\">12</span> Prod_Price <span class=\"token number\">300</span> Prod_Info <span class=\"token string\">\"In Stock\"</span>\nHMSET Records Prod_Color <span class=\"token string\">\"Blue\"</span> Prod_Count <span class=\"token number\">8</span> Prod_Price <span class=\"token number\">310</span> Prod_Info <span class=\"token string\">\"In Stock\"</span></code></pre></div>\n<p>대충 이 명령어를 수행하면 나올 데이터 셋은 아래와 같을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  Records : [\n\t\t{\n\t\t\tProd_Color : \"Red\",\n\t\t\tProd_Count : 12,\n\t\t\tProd_Price : 300,\n\t\t\tProd_Info : \"In Stock\"\n\t\t},\n\t\t{\n\t\t\tProd_Color : \"Blue\",\n\t\t\tProd_Count : 8,\n\t\t\tProd_Price : 310,\n\t\t\tProd_Info : \"In Stock\",\n\t\t}\n\t]\n}</code></pre></div>\n<p>그러나, 이런 결과는 Redis에서 허용되지 않는다.</p>\n<p>실제로 위의 명령어를 날린 후 <code class=\"language-text\">HGTALL Records</code> 명령어를 날려보면 이해가 될 것이다.</p>\n<p>그렇다면 위와 같은 데이터 구조를 Redis에서는 못 만드는 것일까?</p>\n<p>방법은 존재한다.</p>\n<p>바로 <strong>접미사(Suffix)</strong> 를 활용하는 방식이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/*\n Records:Prod_Color 형태로 Hash를 생성한다. \n 여기서는 Records:red / Records:blue 형태로 생성\n*/\nHMSET Records:red Prod_Color <span class=\"token string\">\"Red\"</span> Prod_Count <span class=\"token number\">12</span> Prod_Price <span class=\"token number\">300</span> Prod_Info <span class=\"token string\">\"In Stock\"</span>\nHMSET Records:blue Prod_Color <span class=\"token string\">\"Blue\"</span> Prod_Count <span class=\"token number\">8</span> Prod_Price <span class=\"token number\">310</span> Prod_Info <span class=\"token string\">\"In Stock\"</span>\n\n/* 생성된 Hash를 Set의 멤버로 삽입한다 Set의 키는 Records:Ids */\nSADD Records:Ids red\nSADD Records:Ids blue\n\n/* \n 이를 통하여 Records:Ids로 조회하면 어떤 값들이 들어가있는지 확인 할 수 있다. \n 이렇게 Set을 만듦으로써 전체 Product에 대한 내용은 Set에서 참조 가능하다.\n*/\nSMEMBERS Records:Ids\n\n/* Hash는 단순히 Records:Ids에서 갖고 있는 Item들을 통해 상세한 값을 조회한다. */\nHGETALL Records:ID_OF_MEMBER\n\n/* 아래의 커맨드로 조회가 가능 */\nHGETALL Records:red\nHGETALL Records:blue</code></pre></div>\n<p>자세한 내용은 <a href=\"https://stackoverflow.com/questions/6864968/writing-a-query-to-add-multiple-values-to-a-key-in-redis-hashes\">writing a query to add multiple values to a key in redis hashes</a> 을 참고하면된다.</p>\n<p>여기서 아이디어를 착안하여 아래와 같이 Collection 설계를 진행하였다.</p>\n<p>기존 추천 아이템 설계 Collection은 <code class=\"language-text\">recommend:UserIdKey</code> 를 통하여 각 개인에게 추천된 데이터 리스트들을 담아두었는데 이를 좀 더 확장하였다.</p>\n<ol>\n<li><code class=\"language-text\">recommend:UserIdKey</code></li>\n</ol>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896160-6b0ba580-8a0f-11eb-8f86-4d56fbfbfb04.png\" alt=\"redis-collection-ex-1\"></p>\n<p>기존에 사용자 추천 아이템들의 목록을 들고 있는 List</p>\n<ol start=\"2\">\n<li><code class=\"language-text\">userIdKey:readItemId</code></li>\n</ol>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896161-6c3cd280-8a0f-11eb-8893-207c5fb4bd0b.png\" alt=\"redis-collection-ex-2\"></p>\n<p>각 사용자가 어떤 아이템을 읽었는지에 대한 SET 각 아이템에 대해서 언제 읽었고, 추천되었는지 여부는 위의 아이디어를 차용하여 <code class=\"language-text\">HashMap</code>으로 처리하였다.</p>\n<ol start=\"3\">\n<li><code class=\"language-text\">userIdKey:readItemId</code></li>\n</ol>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896162-6c3cd280-8a0f-11eb-8b7a-c72fb594ac20.png\" alt=\"redis-collection-ex-3\"></p>\n<p>즉, abcd라는 사용자가 읽은 데이터의 경우에는 <code class=\"language-text\">abcd:readItemId</code> SET 콜렉션에 저장이 되고, 위의 유저가 itemId가 1인 아이템이 읽었을 경우에는 <code class=\"language-text\">abcd:1</code> HASH에 저장되게끔 설계를 진행하였다.</p>\n<p>이로써, <code class=\"language-text\">userId:readItemId</code> 콜렉션은 각각의 유저들이 어떠한 아이템을 읽었는가에 대한 전체 아이템 id를 갖고 있는 Set이 되며, <code class=\"language-text\">userId:readItemId</code> 구조의 Hash는 언제 읽었고, 이 아이템이 추천된 아이템인지를 <code class=\"language-text\">recommend:userId</code> 구조의 List에서 조회를 통하여 파악하여 생성하는 식으로 설계하였다.</p>\n<p>즉, 이런 식으로 Redis에서 들고 있다가 Batch를 통해서 일정 사이즈 만큼 chunk를 하여 Bulk Insert하는 방식으로 생각하게 되었다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896163-6cd56900-8a0f-11eb-8d44-d25f572b21ea.png\" alt=\"bulk-insert-code\"></p>\n<p>이후 Batch 처리를 하면서 TTL expire를 설정하여 배치를 돌고나면 캐시를 지우는 식으로 진행하였다.</p>\n<p>이렇게 끝날 줄 알았으나 문제점이 발생하였다.</p>\n<h3 id=\"step-21-추가-요구사항\" style=\"position:relative;\"><a href=\"#step-21-%EC%B6%94%EA%B0%80-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\" aria-label=\"step 21 추가 요구사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1 추가 요구사항</h3>\n<ul>\n<li>UserRecommendItem 스키마 예시</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896164-6d6dff80-8a0f-11eb-83a8-598968baec49.png\" alt=\"db-schema-ex-1\"></p>\n<ul>\n<li>UserReadRecommendItem 스키마 예시</li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896165-6e069600-8a0f-11eb-932d-ee4b50b19def.png\" alt=\"db-schema-ex-2\"></p>\n<p>문제는 <code class=\"language-text\">UserRecommendItem</code> 스키마에 존재했다. 여기에 <code class=\"language-text\">isRead</code> 속성이 추가되면서 <code class=\"language-text\">UserReadRecommendItem</code> 이 삽입된 후에 얘가 실제로 읽었으면 <code class=\"language-text\">true</code> 로 업데이트해야되는 상황이 된 것이다.</p>\n<p>기존에는 사용자가 읽은 부분에서 이 데이터가 읽었는지 안읽었는지 판별을 수행하였는데</p>\n<p>사용자에게 추천된 아이템에도 이 아이템이 읽었는지 안읽었는지에 대한 판별이 필요하다는 요구사항이 추가된 것이다.</p>\n<p>이렇게 되면 아주 큰 문제가 생기는데 바로 <strong>성능문제</strong>이다.</p>\n<p>사실 성능을 생각 안하고 쿼리를 던지면 간단하게 해결할 수 있는 문제일 것이다.</p>\n<p><code class=\"language-text\">UserReadRecommendItem</code> 에 삽입이 끝나면 다시 <code class=\"language-text\">UserRecommendItem</code> 의 값에서 존재하는 부분을 찾아서 <code class=\"language-text\">isRead</code> 를 업데이트하면 된다.</p>\n<p>그러나, 이 부분은 당연히 <strong>성능 상 문제</strong>가 존재한다.</p>\n<blockquote>\n<p>Select UserReadRecommendItem → Select UserRecommendItem → Update UserRecommendItem isRead = true</p>\n</blockquote>\n<p>이런식으로 <strong>2번의 조회 쿼리와 1번의 update 쿼리</strong>가 날라가는데 이는 대량의 데이터에서는 성능을 기대하기 어려울 수밖에 없다고 생각하였다.</p>\n<p>곰곰히 생각해보니 우리는 이미 Redis를 쓰고 있지 않은가?</p>\n<p>아 차라리 <code class=\"language-text\">Bulk Insert</code> 하기 전에 <code class=\"language-text\">Full-Scan</code> 한 데이터 캐시를 들고 있다가 Redis 상에서 처리를 해서 DB에 쑤시는 방법을 생각하게 되었다.</p>\n<p>아주 간단하게 <code class=\"language-text\">userId:readItemId</code> 와 <code class=\"language-text\">userId:recommendItemId</code> 를 추가하였다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896166-6e069600-8a0f-11eb-820f-fb859932b246.png\" alt=\"redis-collection-ex-4\"></p>\n<ol>\n<li><code class=\"language-text\">userId:readItemId</code> 콜렉션은 <code class=\"language-text\">userIdKey:readItemId</code> 구조의 Set을 전체를 담아두고 있는다.</li>\n<li><code class=\"language-text\">userId:recommendItemId</code> 콜렉션은 <code class=\"language-text\">recommend:userIdKey</code> 구조의 List 전체를 담아두고 있는다.</li>\n</ol>\n<p>우리는 이렇게 함으로써 사용자에게 추천된 아이템에 대한 정보 전체와 사용자가 읽은 아이템에 대한 정보 전체를 Redis에 캐싱을 할 수 있게 된다.</p>\n<p>기존에 업데이트하려고 했을 때 문제는 추천된 아이템에도 읽음 여부가 표시되어야하고 읽은 아이템에도 추천된 아이템인지 여부가 표시되어야한다.</p>\n<p>즉 추천되기도했고 사용자가 읽기도했던 아이템은 아래와 같은 교집합일 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://user-images.githubusercontent.com/22961251/111896367-f33e7a80-8a10-11eb-8e65-700716f0cb6c.png\">\n</p>\n<p>하지만 이 부분을 직접 꺼내와서 <strong>서비스 레이어에서 비교를 하자니 속도가 처참</strong>했다.</p>\n<p>그래서 Redis Command 부분을 찾는 중에 <code class=\"language-text\">SINTER</code> 라는 커맨드를 알게되었다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/22961251/111896168-6e9f2c80-8a0f-11eb-930a-0d0b1a838c61.png\" alt=\"redis-command-sinter\"></p>\n<p>우리가 원하는 교집합을 구하는 커맨드였다. 시간복잡도는 O(N*M)으로 빠르다고는 할 수 없겠지만 서비스레이어에서 직접 가져와서 비교하는 것보다 훨씬 빨랐다.</p>\n<p>아직까지 레디스의 메모리가 터지던가 그런 문제는 발생하지 않았으므로 해당 연산을 사용하기로 하였다.</p>\n<p>이렇게 함으로써 DB에 교집합에 속해있는 데이터만 추천된 아이템에 <code class=\"language-text\">isRead</code> 를 <code class=\"language-text\">true</code> 로 바꿔주면되니 전체를 탐색해서 업데이트해야되는 것이 아니라 보다 빠르게 업데이트가 가능해졌다.</p>\n<h2 id=\"step-3-문제점\" style=\"position:relative;\"><a href=\"#step-3-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"step 3 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 문제점</h2>\n<p>위의 로깅 시스템을 도입 후 잘 사용하고 있다고 생각하였다.</p>\n<p>그러나, 바로 문제점이 생겼다. 우리 예상과 다르게 로그의 양이 너무 빠르게 증가되는 문제였다.</p>\n<p>희한하게 Redis는 아주 단순하게 <code class=\"language-text\">standalone</code> 띄워놓고 사용하고 있었는데 죽지도 않고 잘 버텨주었고 샤딩이나 레플리케이션 관련하여 점진적으로 개선하자는 부분은 다들 알고 있던 부분이었으나 정작 문제가 생긴건 DB서버였다.</p>\n<p>빠르게 증가하는 로그 덕분에 DB 서버의 <code class=\"language-text\">Disk Full</code> 이 발생할 수 있는 사태까지 진행이되었다. 내부적으로 많은 이야기가 오갔고 결국 선택을 한 것이 <strong>Kakfa를 도입한 후 로그성 데이터들을 S3로 저장</strong>을 하자고 얘기가 나왔다.</p>\n<p>다음 편은 Kafka를 로컬에서 어떤식으로 삽질을 진행했고, 운영 서버의 Docker Swarm 레이어에 설계했던 Kafka를 탑재하는데까지의 삽질기에 대해서 작성해보고자 한다.</p>\n<p>Redis를 도입하면서 참고했던 자료는 Reference에 달아두었다.\n특히, <code class=\"language-text\">SMEMBERS</code>나 <code class=\"language-text\">LRANGE</code>, <code class=\"language-text\">HGETALL</code> 커맨드들은 <code class=\"language-text\">Keys</code> 커맨드만큼 사용하는데 주의해야하는 커맨드인데 밑에 레퍼런스들 중에서 Best Pratice 관련된 레퍼런스를 보던가 혹은 왜 쓰면 안되는지에 대해서는 Worst Practice를 참고해보자.</p>\n<h1 id=\"step-4-reference\" style=\"position:relative;\"><a href=\"#step-4-reference\" aria-label=\"step 4 reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 4. REFERENCE</h1>\n<ol>\n<li><a href=\"https://tech.kakao.com/2016/03/11/redis-scan/\">Redis의 SCAN은 어떻게 동작하는가? - Kakao Tech</a></li>\n<li><a href=\"https://charsyam.wordpress.com/2014/02/04/redis-scansscanzscanhscan-%EC%9D%B4%EC%95%BC%EA%B8%B0/\">Redis Scan/SScan/ZScan/HScan 이야기 - Charsyam’s Blog</a></li>\n<li><a href=\"https://jinhunpark.com/posts/2019/04/redis-best-practice/\">Redis best practice - Jin’s rambling</a></li>\n<li><a href=\"https://redislabs.com/blog/7-redis-worst-practices/\">7 redis Worst Practices - redislabs</a></li>\n<li><a href=\"https://www.objectrocket.com/blog/how-to/10-quick-tips-about-redis/\">10 quick tips about redis</a></li>\n</ol>","frontmatter":{"date":"December 29, 2020","title":"To The Moon - 더 나은 로깅시스템을 위한 여정 (Redis 편)","categories":"개발 인프라","author":"개발한입","emoji":"💻"},"fields":{"slug":"/better-logging-with-redis/"}},"site":{"siteMetadata":{"siteUrl":"https://brewagebear.github.io","comments":{"utterances":{"repo":"brewagebear/blog-comments"}}}}},"pageContext":{"slug":"/review-essence-of-object-orientation/","nextSlug":"/review-startup-homework/","prevSlug":"/better-logging-with-redis/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}