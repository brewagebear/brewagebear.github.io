{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/ligthsail-ci-cd-setup/",
    "result": {"data":{"cur":{"id":"485157c8-d131-526c-b6b1-d59105dae6b1","html":"<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p>이직을 한 후에 너무 바쁘다보니 블로그 포스팅을 신경을 쓰지 못하였다.\n아직도 바쁘긴하지만, 그래도 여유가 조금씩 생기고 있어서 틈틈히 썼던 초안을 다듬어서 올려보려고 노력해보겠다.</p>\n<p>이번 포스팅의 내용은 AWS Lightsail와 Github를 통한 CI/CD 구축 예시이다.</p>\n<h1 id=\"aws-lightsail과-github를-이용한-cicd-파이프라인-구축-예시\" style=\"position:relative;\"><a href=\"#aws-lightsail%EA%B3%BC-github%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-cicd-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%B6%95-%EC%98%88%EC%8B%9C\" aria-label=\"aws lightsail과 github를 이용한 cicd 파이프라인 구축 예시 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWS Lightsail과 Github를 이용한 CI/CD 파이프라인 구축 예시</h1>\n<ul>\n<li>STEP 1. AWS Lightsail란?</li>\n<li>STEP 2. AWS Lightsail과 Github를 이용한 CI/CD 파이프라인 구축 예시\n<ul>\n<li>STEP 2.1. Spring Boot Application Dockerize\n<ul>\n<li>STEP 2.1.1. Docker Buildkit</li>\n</ul>\n</li>\n<li>STEP 2.2 Lightsail 배포 전 사전 작업\n<ul>\n<li>STEP 2.2.1 IAM 계정 생성</li>\n<li>STEP 2.2.2 Github Secret을 통한 보안 작업</li>\n</ul>\n</li>\n<li>STEP 2.3 Github Deploy.yml 파일 작성</li>\n</ul>\n</li>\n<li>STEP 3. 정리</li>\n<li>STEP 4. REFERENCE</li>\n</ul>\n<h2 id=\"step-1-aws-lightsail란\" style=\"position:relative;\"><a href=\"#step-1-aws-lightsail%EB%9E%80\" aria-label=\"step 1 aws lightsail란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. AWS Lightsail란?</h2>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 63.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfUlEQVQ4y41SbW7bMAz1OXeOnWVH6CV2g/3egBYYNgwD7Dpp7MaSFYkfeoVoK3WaBBuBB1CS+fj46EaPfxBPAeQGxNnhOE0Yx1eICHLOUNUFJWfCqXzLjFNMSPMEpRPYHQxKEU1WtgIg42OoZiN9x0J+Ppe8NBOBqljeVJqirO932O9f8PzcYxiGGw0URIS0Aa+T1GjqIcYI5xz8HDA5bygKWRSi2UCiIBazo6Iqxqr6TBhCQN/3CJwxk8IlRSDBGAhzEvjImCIjSTZ7Lq1YOC4I6wKql8UPJrL7wmFgXpZVfEszJIzIxbu13ggrWY1spAAzY7c/YNe16H49ov39hK7rcBjGxc/kofOILIQtx7tCTtDoltyIxXL38xv+fvmE9uEzkjusXdeNR29KsVV4Jiy/TxhB/ZN1LwUlfCQc/YxXHxBZcTXRxjJTeHGpgvD4Fan9cVV4j+BjvlnK0l38C1L7/WKMW9vcvt9VqCkYqn+3FP4rmuuOene0/yF8A62v/nFTa1H1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"lightsail dashboard\" title=\"lightsail dashboard\" src=\"/static/5756058d14442a00a9fb6291add4f3e0/37523/lightsail-dashboard.png\" srcset=\"/static/5756058d14442a00a9fb6291add4f3e0/e9ff0/lightsail-dashboard.png 180w,\n/static/5756058d14442a00a9fb6291add4f3e0/f21e7/lightsail-dashboard.png 360w,\n/static/5756058d14442a00a9fb6291add4f3e0/37523/lightsail-dashboard.png 720w,\n/static/5756058d14442a00a9fb6291add4f3e0/302a4/lightsail-dashboard.png 1080w,\n/static/5756058d14442a00a9fb6291add4f3e0/203d3/lightsail-dashboard.png 1322w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n   <em>그림 1. 라이트세일 웹 콘솔</em>\n</p>\n<p>Lightsail(이하, 라이트세일)은 AWS에서 2016년에 공표한 서버 호스팅 서비스이다.</p>\n<p>기존 AWS 서비스 중에 하나지만 SQS나 RDS 등과 달리 Lightsail은 아예 독립적인 페이지를 갖고 있는 것을 볼 수가 있다.</p>\n<p>이렇게 구성된 이유는 기존 AWS가 너무 복잡하기 때문인데 실제로, 많이 사용하는 EC2 서비스의 경우에도 네트워크부터 스토리지까지 매우 다양한 옵션들이 존재하며, EC2를 실무에서 써본 분이라고 알겠지만 별도의 VPC와 같은 가상 네트워크가 필수가 되면서 점점 복잡도는 높아지고 있다.</p>\n<p>이러한 복잡도를 낮추고 저렴하게 사용할 수 있는 서비스가 바로 라이트세일이라 볼 수 있다.\n저렴한 가격으로 큰 서버로 옮기게 될 경우에도 익숙한 환경에서 적응할 수 있는 엔트리 모델의 서비스라고 볼 수 있다.</p>\n<p>실제로, 라이트세일은 나중에 EC2로 마이그레이션해주는 도구들과 고정 IP 및 저희가 뒤에 쓸 서비스 내용인 Lightsail container 서비스도 제공해준다.</p>\n<p>글 작성 시점 기준으로 Lightsail은 아래의 기능을 제공해준다.</p>\n<ol>\n<li>인스턴스 (기존 EC2와 비슷)</li>\n<li>컨테이너 (기존 ECS과 비슷)</li>\n<li>데이터베이스 (기존 RDS와 비슷)</li>\n<li>네트워크 (고정 IP 할당 및 DNS 서비스 등)</li>\n<li>스토리지 (기존 S3와 비슷)</li>\n</ol>\n<p>여기서 저희는 1번을 사용하는 것이 아닌 2번을 활용하여 Spring Boot Application을 Dockerize하여 배포파이프라인을 만들고 배포를 진행하는 식으로 진행해 볼 예정이다.</p>\n<p>사용을 해봤을 때 느낀점은 ECS 보다 매우 편리하고 관리하기도 매우 쉬웠다.\n또한, Github Actions API와 궁합도 잘맞아서 앞으로 사이드 프로젝트를 진행할 때 라이트세일 컨테이너를 쓰지않을까 생각해본다.</p>\n<p>좀 더 라이트세일에 대해서 궁금하시면 아래의 링크를 확인해주시면 좋을 것 같다.</p>\n<ol>\n<li><a href=\"https://www.44bits.io/ko/keyword/amazon-lightsail\">아마존 라이트세일(Amazon Lightsail)이란?</a></li>\n<li><a href=\"https://wooncloud.tistory.com/96\">AWS Lightsail - 라이트세일을 소개합니다., 운클라우드</a></li>\n<li><a href=\"https://swiftcoding.org/all-about-amazon-lightsail-billing\">아마존 라이트세일 요금의 모든 것과 비용 관리 방법 (서버 및 리소스 가격 책정 방법) - 스위프트코딩</a></li>\n</ol>\n<p>저희는 라이트 세일 가격정책이나 서비스 내용이 중심이 아니기에 이 부분은 생략을 하고 배포 파이프라인 구축 및 빌드 관련된 이야기를 나눠보고자 한다.</p>\n<h2 id=\"step-2-aws-lightsail과-github를-이용한-cicd-파이프라인-구축-예시\" style=\"position:relative;\"><a href=\"#step-2-aws-lightsail%EA%B3%BC-github%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-cicd-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%B6%95-%EC%98%88%EC%8B%9C\" aria-label=\"step 2 aws lightsail과 github를 이용한 cicd 파이프라인 구축 예시 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2. AWS Lightsail과 Github를 이용한 CI/CD 파이프라인 구축 예시</h2>\n<p>위에서 잠깐 언급한 내용처럼 저희는 라이트세일 컨테이너 서비스와 Github Action을 활용하여 CI/CD 파이프라인을 구축한다.</p>\n<p>대상이 될 어플리케이션은 간단한 스프링부트 어플리케이션을 활용할 예정이다.</p>\n<p>상세한 프로젝트 코드는 아래를 참고하자.</p>\n<ul>\n<li><a href=\"https://github.com/brewagebear/blog-example/tree/main/ligthsail-example\">brewagebear/blog-example/lightsail-example</a></li>\n</ul>\n<h3 id=\"step-21-spring-boot-application-dockerize\" style=\"position:relative;\"><a href=\"#step-21-spring-boot-application-dockerize\" aria-label=\"step 21 spring boot application dockerize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1. Spring Boot Application Dockerize</h3>\n<p>우선, 라이트세일 컨테이너 서비스에 배포를 하기 위해서는 기존 스프링 부트 어플리케이션을 도커라이징해야한다.</p>\n<p>예제 샘플(Dockerfile)은 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"># syntax=docker/dockerfile:experimental\nFROM openjdk:11-jdk AS build-stage\nWORKDIR /workspace/app\n\nCOPY src /workspace/app/src\nCOPY gradle /workspace/app/gradle\nCOPY gradlew settings.gradle build.gradle /workspace/app/\n\nRUN --mount=type=cache,target=/root/.gradle ./gradlew clean build -x test\nRUN mkdir -p build/dependencies &amp;&amp; (cd build/dependencies; jar -xf ../libs/ligthsail-example-1.0-SNAPSHOT.jar)\n\nFROM openjdk:11-jre-slim\nWORKDIR /tmp\nARG DEPENDENCY=/workspace/app/build/dependencies\n\nCOPY --from=build-stage ${DEPENDENCY}/BOOT-INF/lib ./app/lib\nCOPY --from=build-stage ${DEPENDENCY}/META-INF ./app/META-INF\nCOPY --from=build-stage ${DEPENDENCY}/BOOT-INF/classes ./app/\n\nENTRYPOINT [&quot;java&quot;,&quot;-cp&quot;,&quot;app:app/lib/*&quot;,&quot;io.github.brewagebear.LigthsailApp&quot;]</code></pre></div>\n<p>어려워 보일 수 있으나 한가지씩 뜯어보면 그렇게 어렵지 않다.</p>\n<h3 id=\"step-211-docker-buildkit\" style=\"position:relative;\"><a href=\"#step-211-docker-buildkit\" aria-label=\"step 211 docker buildkit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1.1. Docker Buildkit</h3>\n<p>우선 첫 줄에 아래와 같은 명령어가 적힌 것을 볼 수 있다.\n<code class=\"language-text\"># syntax=docker/dockerfile:experimental</code></p>\n<p>이 부분은 <a href=\"https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/reference.md#syntax\">moby/buildkit - syntax</a>에서 내용을 확인할 수 있다.\n즉, 위의 주석은 Buildkit을 활용하여 도커를 빌드할 때 실험적 기능을 키기 위한 옵션 주석이라고 볼 수 있다.</p>\n<p>그렇다면, <strong>BuildKit은 무엇일까?</strong>\nDocker 18.09버전부터 지원되기 시작한 백엔드 도구라고 한다.</p>\n<p>도커의 백엔드와 프론트엔드까지 다루기에는 양이 방대해져서 이 내용은 생략하고, 대략적으로 BuildKit에 장점에 대해서 기존까지의 도커 빌드 히스토리를 추적하여 설명하고자 한다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 52.222222222222214%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAUlEQVQoz2WRWW+bQBSF/f//RR/bt6qpkkhVH9pUSRPH2PFuFhsYVrMEMJjF5qvAUaOqV/p0z8xIZ+6ZGaxVHc2wUHeCDx9v8cOIbz+H3Hx/wPF8NF0gbBc4Ay0tp/84c+LUNpzaEwN3HxAlCfWpxnQ8jnWFabsohiDKD0Rp0pPkGXGWcKiOFE1FUb9T1mVv3HSG9NX2t3TlZweWqs7KECxsj5G2RdJ2Pc+qhhKEOMcSuzhiFwVWXqAIiyiO+/kHl1Gb3rBpa7LyiO3vsfw9ThAg9j6m3+HhvcZ4yeuFN53WFW4YImyH6lS/G3b5zzQEec56JxhrW55ljWdl2zPcqNzPV/xebnrdnY21HU5RYHg+86WMH4b/GnY9KI9sk4SprjPeGYx1k5lweVIFE9Nn48foSYaeHjCzAyLLyJvq7eFaBue3X+ppG7K6JExS3DjCjgKcKOx7F73rUZFzODd91KSuSJuatMhJspTkkDGompKyPvZ02oki1psdSyHYuC5Ly2JumMx0nZWwWJkC2fPQ4xiRJmxcn8fJgl8PI+6HEwZhHNARxAHxa8jdbMW1NOfz44ir0QvXL3O+SlO+dHpy0VfSlNvZipvZkk93Q34MJ0iTKaOXOQPd3PEXY8tMVZAUGWm95mmxQJI3TFSFsdIhM1aVy1qWkWS531P0LcI2MCyDP2sx5lbbyFmmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"single build\" title=\"single build\" src=\"/static/c10694cb441f39a1580bf64dc7e5df5d/37523/single-build.png\" srcset=\"/static/c10694cb441f39a1580bf64dc7e5df5d/e9ff0/single-build.png 180w,\n/static/c10694cb441f39a1580bf64dc7e5df5d/f21e7/single-build.png 360w,\n/static/c10694cb441f39a1580bf64dc7e5df5d/37523/single-build.png 720w,\n/static/c10694cb441f39a1580bf64dc7e5df5d/302a4/single-build.png 1080w,\n/static/c10694cb441f39a1580bf64dc7e5df5d/07a9c/single-build.png 1440w,\n/static/c10694cb441f39a1580bf64dc7e5df5d/f6a84/single-build.png 1629w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 1. 싱글 빌드 형태의 Dockerfile</em>\n</p>\n<p>초기에 도커 빌드를 할 때 위와 같은 Dockerfile을 생성하여 빌드를 하곤 하였다.\n그런데 이런 구조의 문제점은 옆에 하드 디스크 같이 보이는 아이콘의 갯수를 보면 이해할 수 있는데 명령행이 시작되면서 갈수록 레이어가 무거워진다는 단점이 존재하였다.</p>\n<p>실제로 이러한 빌드형태로 이미지를 생성하게 되면 상당히 많은 용량을 차지하는 것을 볼 수 있다.</p>\n<p>그렇다면, 이러한 방식을 개선한 점이 없을까?</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKklEQVQoz1WRWW/aQBSF+f+/o29tFeWlagtpk6ZtCE2hARvjfbwAXjDglbCEr7JJUDvSp7kaac45997WQFKZRzGa7fHmfZu0KPh83ePy4y1RkuDPg4btfsuRA4fjnucaDv9Rv9e0NMtllaXEqxUPwwnFpmJiOox1m2WaEi2XJOsVm+2G3fOO3WF3vmuT7eHEq3CL5hxfgFVVMo8W+MkCb51hhiEiitBnMyaejxWG+Os1syxltduSbJ+Iy/pPdEq4f96d49bOy7xA12wedQPJshrGQmAGAeZ8jhWETV2beElCkBfEZYUznZ0ED8eXubzMIcxyxoagp6p0FY3uRKenGnQVnTtZbbif6PzSTO4VDS2KCaoKRbfIirwW3J8F67TJ0wYvy5CEw9B2ebQ9ZD/gwfQZ2HOkaYyXFQ1+VjArSqKyPAdqNcU/m1qVJf4sZOK66L7ftKl6HqrjIKKQpCwJspSoyEk2FYuqYlGWrNL0tJTXhDX7455lniNsj6FhNEKK6yLbAtkSqJ6P7nho/pTpet0so04XFQWOP2s6bBVVzit5lTGNYzRT8EfXmbgOiuOclmPWmIwMA9m20adTLH+KIhzsMMB2XbIipRVEc/5FFYL+o0RvJPMgjxnoOr8nKn1Na0z6qspA05CEaNKPaxwHyxGEcUDLtA3OCIMvdz06t12uftxz0b7i4us179od3rY7XN7c8uHnHZ1+n5vhiG+S1PB9JPHp6hpZkfkLW24tN1CYtRIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"multi staging build\" title=\"multi staging build\" src=\"/static/246fd6be8945ca88fc48efa526b16851/37523/multi-staging-build.png\" srcset=\"/static/246fd6be8945ca88fc48efa526b16851/e9ff0/multi-staging-build.png 180w,\n/static/246fd6be8945ca88fc48efa526b16851/f21e7/multi-staging-build.png 360w,\n/static/246fd6be8945ca88fc48efa526b16851/37523/multi-staging-build.png 720w,\n/static/246fd6be8945ca88fc48efa526b16851/302a4/multi-staging-build.png 1080w,\n/static/246fd6be8945ca88fc48efa526b16851/07a9c/multi-staging-build.png 1440w,\n/static/246fd6be8945ca88fc48efa526b16851/cd7c1/multi-staging-build.png 1547w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 2. 멀티 스테이징 빌드 형태의 Dockerfile</em>\n</p>\n<p>위와 같은 방식으로 멀티 스테이징 빌드 방식으로 빌드를 할 경우에 좀 더 경량화된 이미지를 갖게된다.</p>\n<p>멀티 스테이징 빌드 방식은 이미지를 만드는 동안 빌드 등에서는 필요한 의존성이 존재하지만, 최종 컨테이너 이미지에는 필요 없는 환경을 제거할 수 있도록 단계를 나누어 이미지를 만드는 기법이다.</p>\n<p>따라서, 위와 같이 경량화된 도커파일을 얻을 수 있다.\n이렇게 되면서 빌드타임에 이점을 가져갈 수 있다.</p>\n<p>이 멀티스테이징 빌드는 많은 사람들에게 각광을 받았고 나온 후에 많은 사람들이 이용하는 빌드 방식이 되었다.</p>\n<p>그러나, 오늘날 빌드파일은 점차 계속해서 복잡해지고 있다.\n이를테면, 최종 이미지에 의존성이 A서비스의 의존성과 B 서비스의 의존성을 갖을 수 있는식으로 말이다.</p>\n<p>최종 이미지에는 두가지 모두 필요하지만, 사용자 입장에서 빌드타임을 더 단축시키기위해 만약, 다른 스테이지지만 최종에 모두 필요한 의존성이라면 병렬로 빌드할 수 있을 것이다.</p>\n<p>그래서 나온 것이 바로 BuildKit이다.</p>\n<p align=\"center\">\n    <img src=\"https://blukat.me/assets/2021/07/buildkit-slide.png\">\n</p>\n<p align=\"center\">\n    <a href=\"https://blukat.me/2021/07/docker-buildkit-speedup/\"><em>그림 3. Buildkit 병렬 빌드 - blukat29, 2021</em></a>\n</p>\n<p>당연히 BuildKit이 이 역할만 하는 애는 아니다.\n따라서, BuildKit이 해당 기능을 위해서만 나온건 아니고, 전반적인 빌드 속도나 기타 편의기능들을 추가한 도구라고 보면될 것 같다.</p>\n<p><a href=\"https://github.com/moby/buildkit#quick-start\">공식 레포지토리</a>를 보면 아래와 같은 핵심 기능을 설명하고 있다.</p>\n<p>Key features:</p>\n<ol>\n<li>Automatic garbage collection</li>\n<li>Extendable frontend formats</li>\n<li>Concurrent dependency resolution</li>\n<li>Efficient instruction caching</li>\n<li>Build cache import/export</li>\n<li>Nested build job invocations</li>\n<li>Distributable workers</li>\n<li>Multiple output formats</li>\n<li>Pluggable architecture</li>\n<li>Execution without root privileges</li>\n</ol>\n<p>여기서, 우리가 사용하는 Key feature는 5번(<strong>Build cache import/export</strong>)에 해당한다고 보면된다.</p>\n<p>사실 우리의 <code class=\"language-text\">Dockerfile</code>은 parallel multi staging build 기능이 필요없는 <code class=\"language-text\">Dockerfile</code>이기 때문이다.</p>\n<p>명령어를 키고 위의 <code class=\"language-text\">Dockerfile</code>을 아래와 같이 바꿔주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">... 중략 ...\n\n# AS-IS\nRUN --mount=type=cache,target=/root/.gradle ./gradlew clean build -x test\n\n# TO-BE\nRUN --mount=type=cache,target=/root/.gradle ls -alh /root/.gradle; ./gradlew clean build -x test; ls -alh /root/.gradle\n... 중략 ...</code></pre></div>\n<p>그 후에 아래의 명령어를 활용하여 빌드를 수행해보자.\n<code class=\"language-text\">DOCKER_BUILDKIT=1 docker build -t test/test:1.0.0 . --no-cache --progress=plain</code></p>\n<p>참고로, 여기서 <code class=\"language-text\">DOCKER_BUILDKIT=1</code> 은 Buildkit을 백엔드로 활성화한다는 의미이다.</p>\n<p>명령어를 통해서 초기 빌드 시에 대략 내 노트북 기준 35초 정도 걸리는 것을 확인하였다.\n참고로 TO-BE 부분은 아래의 내용을 확인하기 위해서 작성했다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 22.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArElEQVQY032PWQrDMAxEcxOHWPKWxWsWQqH3P9UUixZKP/oxzENCw2iIKSGXgpQzOpdahXOtwn23rCvCPMOHgHlZEEKA8x7WOfE+01pjHEcM133j8Xyi7jtSKSitifcQa60cETOUUnLwV0phOK8L7TiQc0KLG86ScOSIPW5YDCF6i9UZBGugiUBvdWZmafbtQ3+p1+7yzsEwg6ZJnIlgjQEzCX+CRFpL8+kn8AWO93YrQgJ4QgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"nocache\" title=\"nocache\" src=\"/static/07ee0b85ccac6a6c9f96aaf3448a7fa2/37523/nocache.png\" srcset=\"/static/07ee0b85ccac6a6c9f96aaf3448a7fa2/e9ff0/nocache.png 180w,\n/static/07ee0b85ccac6a6c9f96aaf3448a7fa2/f21e7/nocache.png 360w,\n/static/07ee0b85ccac6a6c9f96aaf3448a7fa2/37523/nocache.png 720w,\n/static/07ee0b85ccac6a6c9f96aaf3448a7fa2/302a4/nocache.png 1080w,\n/static/07ee0b85ccac6a6c9f96aaf3448a7fa2/07a9c/nocache.png 1440w,\n/static/07ee0b85ccac6a6c9f96aaf3448a7fa2/c02c7/nocache.png 2472w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 4. 초기 ls -alh로 검색 시 아무런 캐시 데이터가 없는 것이 확인된다.</em>\n</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABAUlEQVQoz42S6Y7CMAyEeZNeqGjplcRJD9CK93+qWY2boKKlVX9YzmF9mYl96YcBfhxhnYN4DwkBPgSUVYU8z1EUheayLHXNnCLdMae4bIEEhWkCz7q+13M+wLtxntcHvYcVwWCtQo+BzCKorhV+7nfd+x3gWnf9cPEPKBuFbdcdAgdjtLa+3ZBl2Rv6FcjipmkUtqvQOUzLonlr+7tCY9C27b5C5+C8x+/rpftzwCPLzmkszyfqun5b3u/yGaCIWqaI3S4fKZwIDGEdIxE4Ea0ldH48YKyNTYndsrGASvhIwz9MgDhSLjaDM2iiZQI/xoZKeEgQP5qg7RiciWSXCv8AAJdSDK7VaVkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"init cache\" title=\"init cache\" src=\"/static/2032bf4e54083178a1a262a4f5b58c39/37523/init-cache.png\" srcset=\"/static/2032bf4e54083178a1a262a4f5b58c39/e9ff0/init-cache.png 180w,\n/static/2032bf4e54083178a1a262a4f5b58c39/f21e7/init-cache.png 360w,\n/static/2032bf4e54083178a1a262a4f5b58c39/37523/init-cache.png 720w,\n/static/2032bf4e54083178a1a262a4f5b58c39/302a4/init-cache.png 1080w,\n/static/2032bf4e54083178a1a262a4f5b58c39/b94e3/init-cache.png 1126w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 5. Gradle Task가 끝난 후 ls -alh 명령 시 아래와 같이 캐시가 적재된다.</em>\n</p>\n<p>우리는 캐시가 적재되었음을 눈으로 확인하였다.\n그렇다면, 아래의 명령어를 통해서 빌드를 수행해보자.</p>\n<p><code class=\"language-text\">DOCKER_BUILDKIT=1 docker build -t test/test:1.0.0 . --progress=plain</code></p>\n<p>총 시간이 대략 1.9초 걸린것을 확인할 수 있다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 9.444444444444445%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAWElEQVQI11WNUQrAIAxDPUsFp9XV+jW8/8EyUmSwj0eSQpM03UFsztC5Fvxg7qG3GfoYUNUgfO+oreGqNZS5qSI9e8cDYSlLItOfEeZSCkQEOecPISK/+wscQzwA0qosrAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"buildkit cached\" title=\"buildkit cached\" src=\"/static/8772d07d493be68b048c1310a2d0ddc4/37523/buildkit-cached.png\" srcset=\"/static/8772d07d493be68b048c1310a2d0ddc4/e9ff0/buildkit-cached.png 180w,\n/static/8772d07d493be68b048c1310a2d0ddc4/f21e7/buildkit-cached.png 360w,\n/static/8772d07d493be68b048c1310a2d0ddc4/37523/buildkit-cached.png 720w,\n/static/8772d07d493be68b048c1310a2d0ddc4/302a4/buildkit-cached.png 1080w,\n/static/8772d07d493be68b048c1310a2d0ddc4/07a9c/buildkit-cached.png 1440w,\n/static/8772d07d493be68b048c1310a2d0ddc4/bf668/buildkit-cached.png 2328w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 6. 캐시가 적용되었음을 확인할 수 있다.</em>\n</p>\n<p>즉, BuildKit 캐시를 이용하면 Gradle에 등록된 의존성을 빌드할 때마다 새로 받는 것이 아니라 이미 캐시가 있으면 캐시를 활용하고, 변경된 부분만 사용한다고 볼 수 있다.</p>\n<p>실제로 build.gradle에 lombok만 추가해서 다시 빌드한 결과는 아래와 같다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 49.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABC0lEQVQoz5WSWY6DMBBEfZKw2gbM6g1I7n+ujqqFZwJRNJOPkhd1P6raCB8CrftO++NBzntat43itv3cYUXNNM/UGUOm76kfBjLGUNt11LYtr8M4Ul3XJBbnGIAGFCehuaoqFgrzPKcsyz7rduMaYZ2jECMDrPfkQmBH2EuluAgqiuJfEhxz39kh4ABCcI0zvv4X5PWDDNzud5qXhZ35GFlhXRmMyICy0yPedf8KFfYALtayKyg5BHScJtJak9KaV0hKyeemaagsy7PDNDc0IyIeJDXgMZRSLMyT75Xi+7R/iwwg3IUjai3lb6wjWn49X/anyIBhfgBinul/+uZlTw4TEDDExEyuRd/oCcU4JO01zlEHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"add new gradle dependency\" title=\"add new gradle dependency\" src=\"/static/24bb7ac33c0f6d61e2bea6a597eb8040/37523/add-new-gradle-dependency.png\" srcset=\"/static/24bb7ac33c0f6d61e2bea6a597eb8040/e9ff0/add-new-gradle-dependency.png 180w,\n/static/24bb7ac33c0f6d61e2bea6a597eb8040/f21e7/add-new-gradle-dependency.png 360w,\n/static/24bb7ac33c0f6d61e2bea6a597eb8040/37523/add-new-gradle-dependency.png 720w,\n/static/24bb7ac33c0f6d61e2bea6a597eb8040/302a4/add-new-gradle-dependency.png 1080w,\n/static/24bb7ac33c0f6d61e2bea6a597eb8040/07a9c/add-new-gradle-dependency.png 1440w,\n/static/24bb7ac33c0f6d61e2bea6a597eb8040/42b11/add-new-gradle-dependency.png 2364w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 8. 의존성 추가 시 기존 값은 캐시를 쓰고, 새 의존성은 리빌드 </em>\n</p>\n<p>즉, Buildkit을 활용하면 빌드타임이 빠르게 단축될 수 있다.</p>\n<p>BuildKit에 대해서는 더 할 말이 많은데, 포스팅의 길이가 길어질 것 같아서 우리가 사용하는 기능에 대해서만 다루고 다음으로 넘어가고자 한다.</p>\n<h2 id=\"step-22-lightsail-배포-전-사전-작업\" style=\"position:relative;\"><a href=\"#step-22-lightsail-%EB%B0%B0%ED%8F%AC-%EC%A0%84-%EC%82%AC%EC%A0%84-%EC%9E%91%EC%97%85\" aria-label=\"step 22 lightsail 배포 전 사전 작업 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2 Lightsail 배포 전 사전 작업</h2>\n<p>일단, 위에서 <code class=\"language-text\">Dockerfile</code>을 Buildkit의 캐시기능을 활용한 멀티스테이징 빌드기법으로 만들었다.</p>\n<p>저걸로 이제 우리는 Spring Application의 이미지를 말 수가 있는데, 이제 남은건 배포 스크립트 설정만 남아있다.</p>\n<p>그 전에 사전작업 몇 가지를 진행하고자한다.</p>\n<ol>\n<li>Lightsail IAM 계정 설정</li>\n</ol>\n<p>이 부분은 보안 상 이점을 가져가기 위해서 ROOT 계정이 아닌 서비스용 IAM 계정을 발급하는 내용이다.</p>\n<p>이 부분은 기존의 AWS Web Console을 통해서 작업할 수 있다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyUlEQVQY052P2QrCMBRE8/eCoIJgP8Sliv0SoVZf3LBqtU2b7d6RpEXwwRcHBk4muUtEfrsjv15xKRqM4xSj+QZRssdkvUOU7DBeZRgsthjGGYbxtvM3j5YZ+rMUvWkKoesKRASvWhYoixz/iyBeZQlmBjHjVj9xOJ5wPl9QVhKN0rCOgh3RD+Zgz8Y6CCnlZ0PPWutwNsbAWtsOI4JzFNjbNyTq2LnwzkspBfEonp+gqhsorQOHIub2I8Rheqt2G+7ufG66ep+9AaW6fAS0RXzFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"iam setting\" title=\"iam setting\" src=\"/static/32ffa6a8e388cd16c0f3980fd06d55fe/37523/iam-setting.png\" srcset=\"/static/32ffa6a8e388cd16c0f3980fd06d55fe/e9ff0/iam-setting.png 180w,\n/static/32ffa6a8e388cd16c0f3980fd06d55fe/f21e7/iam-setting.png 360w,\n/static/32ffa6a8e388cd16c0f3980fd06d55fe/37523/iam-setting.png 720w,\n/static/32ffa6a8e388cd16c0f3980fd06d55fe/302a4/iam-setting.png 1080w,\n/static/32ffa6a8e388cd16c0f3980fd06d55fe/07a9c/iam-setting.png 1440w,\n/static/32ffa6a8e388cd16c0f3980fd06d55fe/b0c25/iam-setting.png 1935w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 9. AWS 웹콘솔 - IAM </em>\n</p>\n<p>참고로, 위 두개에 초록색 활성화 버튼이 보이는데 저것은 권장사항보다는 필수사항이라고 생각이 든다. 생각보다 AWS 해킹사태가 빈번하게 발생해서 해커가 인스턴스를 채굴용으로 만들어서 몇 천만원 과금이 발생한 사례가 존재하기도 하였다.</p>\n<ol>\n<li><a href=\"https://velog.io/@gmtmoney2357/aws-%EC%A0%80%EC%97%90%EA%B2%90-2174%EB%A7%8C%EC%9B%90%EC%9D%B4-%EC%97%86%EC%8A%B5%EB%8B%88%EB%8B%A4.-%ED%95%B4%ED%82%B9%EA%B3%BC%EA%B8%88\">aws - 저에겐 2174만원이 없습니다.(해킹과금)</a></li>\n<li><a href=\"https://m.ruliweb.com/best/board/300143/read/56010593?\">aws 해킹때메 2천만원 요금 청구 왔었네</a></li>\n</ol>\n<p>이거말고도 더 많은 사례를 보았고, 심지어 아마존에서는 요즘은 모든 피해사례를 무료로 해주기보다는 일정 금액 손해배상을 요청한다하니 다른건 몰라도 ROOT 계정의 MFA는 필수로 설정하자.</p>\n<p>IAM 계정을 설정하는 이유도 동일하다.\n만약, 해킹을 당하더라도 IAM 계정이 권한이 좁게 주어지면, 해커가 인스턴스 생성이나 그런 행위는 못할 것이기 때문이다.</p>\n<p>귀찮더라도 작업을 진행해보자.</p>\n<p>순서는 아래와 같다.</p>\n<ol>\n<li>IAM 사용자 그룹 생성 (생략 가능)</li>\n<li>IAM 사용자 생성</li>\n<li>IAM 사용자 Accesskey &#x26; Private Key csv 다운로드</li>\n</ol>\n<p>1번은 해도 되고, 안해도 되는 부분이니 2번 부터 수행하고자한다.\nAWS Web Console IAM 대시보드 우측에 액세스 관리 > 사용자를 클릭하여 사용자 추가를 할 수 있다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 41.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABT0lEQVQoz4WS7c6bMAyFuf/72jWsrJu2Nx8F0tBRoBA7CWeyebWpvxbp0YmdYydS3JRcMD9nrMuKzBm6jv9Ta0XOGURSU/GlfcA/EhquGY80Yc4rUiWk4x90MJLwludTP3N7TaCa0M0LXkRo9pLQ73dcbz/ggsNH9wE7OPi7h+mtxrfo4QaranujSKz7waKLHabtAT4YDVXCVjdN2t5qUx+kgYPpDUy4wY4RP0OAiXeYGGDHU391pz9MAUteIY9rqDCm9MTvbcIzzVhoxcIr1vxSlrxhzrvy5JOZz5ycqUf85QWq8kIieOvgrAMlQi1VP4eJwcyfSmAiZGaUnFFLUdUzIvVJH/moRoIu9Lh+v8IYA+cchmHAOI6IMf5F4rZtcblc1Oe9h7UWX9tvGIaAMUaklNDICKRM2NOOfT+RcdDpOY435HIpEo+ojk6pb54/rYxmtaf2KlAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"create iam user\" title=\"create iam user\" src=\"/static/7b9fe636dd028f82f2f850ec38aec8c2/37523/create-iam-user.png\" srcset=\"/static/7b9fe636dd028f82f2f850ec38aec8c2/e9ff0/create-iam-user.png 180w,\n/static/7b9fe636dd028f82f2f850ec38aec8c2/f21e7/create-iam-user.png 360w,\n/static/7b9fe636dd028f82f2f850ec38aec8c2/37523/create-iam-user.png 720w,\n/static/7b9fe636dd028f82f2f850ec38aec8c2/e3189/create-iam-user.png 1035w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 10. AWS 웹콘솔 - IAM 사용자 추가 </em>\n</p>\n<p>나는 ‘lightsail-container-service’ 라는 계정을 생성하였다.\n이후 정책을 추가하면 된다.\n물론, 만들면서 정책을 추가해도 상관없다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 107.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADC0lEQVQ4y42VSY7zNhCF+/jJLshBcogsAgQJsku324M8aJ5JzSJFvqCKkuzGv+gIqIU5PH6vqki/SdmgLEtkaYqiKDiGYYC1FsaYb8Nag37SqLoZddPhrRtmFCSY5Wi7HvM8Qyn9rdDrtxiLWRvMSuGNBtI0hXcPkFcSUgoopXghUf6fWPgQy8IsSDbDMILoJkzT9APBd9+gDJpRoxlWwlFbpKLDIxeci04DrbJoZ4tMdEiqxo2rbdwglz2Pp3WLpJKo+xmDXglpgRcXuMYF0mZCPVnUE1CPBl6U43CPcEsqVJOFUEA1LriEOT4fMS5RDi8qkHUacl4Fu9mw2DlIEVUdxAwXk8E1ynHyE1zCjOeKXqMeF3hhxmP8mw6aATkbvFkSVJZPPD5itp13ahekjZ/3iOcoorrncRLj9ZlAXPdMvxO2TFgyyTlwp+6EGzltGg2kcqkgQUpTIkcUvXoS7jlcrd2z+osgEV6TkoUa7VJBlukQInSHuVTIaRV0ljO2TZto86vgKUg5FUHRoBwWHichSgXFh+cjKBs0ardscYsLnPwYiRhQdMpRTo58s5bT9aIOGJ+OtoJRdzRfcpgKnGLpaDKBsGohxpXQT3C4hUjksOZw+UJI89RWgi1bi1YD3uWAjz9+w/H2QFC2zvZqmQhiMXBRthxuVaagw6gX1xxaiAk4P/7B4f1XXMIAOTWpelb5shZmayfuwxfLJEb53QXrETg+/sS/559xTULE9YhY9HsDb7aKF8HN8sc1YLsMsROOwMn/G++nX3Dy7zjcYvi5gJhc9Ylyuw2uKAsuQbrS5Sz+yOVWFIuiB47+X/g4/8SCt1S4Zp0srlHBlramdoQut7e04jYqB42S5ueVsBqAz8cRXvg74loyxVZNInj3fJz9FH4uXR+OhotBhHxD1oPYsrVAry38vEUiLTe2e20oDIsQoV80+0NAQcQUz7V43pRx1sjKCt0wQFtAGQttwDHpBaPS/MTTHI2pdW6L7bdaLBFafvKncYRd/3Reg/oU23P/Om/MD+vNsuA/xmOSsKXQc9wAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"create iam policy\" title=\"create iam policy\" src=\"/static/2c3587eb14c6406d505a9cb69fdd7f0d/37523/create-iam-policy.png\" srcset=\"/static/2c3587eb14c6406d505a9cb69fdd7f0d/e9ff0/create-iam-policy.png 180w,\n/static/2c3587eb14c6406d505a9cb69fdd7f0d/f21e7/create-iam-policy.png 360w,\n/static/2c3587eb14c6406d505a9cb69fdd7f0d/37523/create-iam-policy.png 720w,\n/static/2c3587eb14c6406d505a9cb69fdd7f0d/36c33/create-iam-policy.png 946w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 11. AWS 웹콘솔 - IAM 사용자 정책 추가 </em>\n</p>\n<p>읽기, 쓰기 모두 ContainerService에 해당하는 권한을 추가하였다.\n단, 쓰기에서 CreateContainerService는 권한을 제거하였다. (루트 계정으로 생성하기 때문)</p>\n<p>따라서, 쓰기에는 ECR과 같은 솔루션을 쓸지는 모르겠지만</p>\n<ol>\n<li>CreateContainerServiceDeployment</li>\n<li>CreateContainserServiceRegistryLogin</li>\n<li>RegisterContainerImage</li>\n<li>UpdateContainerService</li>\n</ol>\n<p>정도면 될 것 같다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 594px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 87.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC0UlEQVQ4y42UW4scRRiGZ2+M4CGg/hBzk/WXeBEELzxHEP0hRjQJiUgg3nujUQkbwVtxMZPNssxmd5KZnZme6XNXT58PVY9UzfRkICyk4aGrv/rq/Q5VXb39/X0ODw/p9/uMRiNc12WxWGDb9kvjOA6WZTGdTukdHx8TRRG+7xPHMXmeG7IsM6Rpuhlr9Ny2TY81SZIghKA3Ho+NIRaCNEkIAt9EDIJgE0SPNZ7nGbS/TkLb9PxyuTQopegNh0PsxQLLFYydhKfziIUvTCZFUVBVlYmuRfQiLaBtXRXap/M1gl3fHM/H9gLmtovjeiaDMAyN2Ms+ClaCk7MzhqcnW5wynUx48GCPS5fe5b3dXXYvX2Zvb484FsznFp7rUtcVUkpk29K2rRn39M60QFE1pHlBZihppOLJySlfXP2Sjz/9nI8++YyHjx7TKBDLhCTLqRpp/JpWGqRU9M6mFguR82zuE5UQ1yA0FSRyVYoOWEvwRYIXxuRVS1Y2ZFWLKJVZp9E+K8EoYzhziUq1dniOn7eULcRpjuV4FDrF9VMriAppgmvfepXhzBicuMBL681kx7KB3+7/xbff3+S7G7f54fZPXP/xDtdu3GLwdEwmISzkWnArw8Fohh0XpuROTDvmwPtXPmBnZ4fXXn+DNy9e5K233+GVC69y78/7ph1B3j4XHE9mm751YjpL0ZVfQZAU2IHAckPcKMGPMzyRIvJVRaJS2xnOmEcpXlJtyhVb6O+0bCmq2pyAWu8mIBVml8U6gU0Px9MZqerK5AVMf9OWqZ/wbOFjxyVhqfByiV8ogpIVBVQt9Cbrc1g2kqpVL9JI6lbRSMwZ1O9WqnP/ld5gMCBNE0QUmQviPITQ8xF+EDKaB/z6n8O9hy6/9x3+6Dv88q/DyTSgd3R0ZK4dfbN0t8p5hEGA5fj8M5hz9c4BX9094Ou7B3zz8wEf3nrE349n/A8HeOzVPwDRcQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"iam arn setting\" title=\"iam arn setting\" src=\"/static/a644e983c2d6b29bde78c7a59d874f53/5fd3e/iam-arn-setting.png\" srcset=\"/static/a644e983c2d6b29bde78c7a59d874f53/e9ff0/iam-arn-setting.png 180w,\n/static/a644e983c2d6b29bde78c7a59d874f53/f21e7/iam-arn-setting.png 360w,\n/static/a644e983c2d6b29bde78c7a59d874f53/5fd3e/iam-arn-setting.png 594w\" sizes=\"(max-width: 594px) 100vw, 594px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 12. AWS 웹콘솔 - IAM 사용자 정책 추가 (ARN 세팅) </em>\n</p>\n<p>쓰기 기능은 ARN이 설정이 가능한데, 일단 명시적인 group-id를 얻으면 좋겠으나 현재는 그 값을 구하기 어려운 상황(컨테이너 생성 전)이라 id는 *로 와일드 카드를 추가해둔다.</p>\n<p>이 정도면 충분하지 않을까 생각을 해본다.</p>\n<p>그 후 IAM 사용자의 AccessKey &#x26; SecretKey를 Github Action에 사용하기 위해서 csv를 등록한 뒤에 github에 실제로 추가를 해야한다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 60.55555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABzklEQVQoz31TSW7jMBDU2Y4tURJXcZEoarEdO0iQw9xm/v+pGrC9YGIDcyhQJLurq4utwocEFxLeKoEdkw/k/R3/nj+jZQJtxQmccRSttDBufAn0cUWfjvDxgB1TL8RbJlFXHL+cw+/zB/6cL/geIgomLLRLqFrzIymMB8T5nUi7MEG7EbafKTZ/u2FF50bMIWKJM6Y+oeMaRS0sxvUCPx4epPtaEVFczkTa9TORumGhtQvXvbAJpZmxrTU2lSQUjFtKaJX/4Z8JM+JygYsH1NKhFu663r6ZuJ0Jh1YFcN2jkR5FJsoKnx+gbAwpFd1AikyYYPwE7dNN5URndljQSEexZaOvhMvpixQ+G58Ds28DeXmiwvPpE8v7F8blgjBebVF2JLtyTpFlZoMr3mFb8pfR2ewbvNUGpRrBdEJjVzR2QaUS9jJiUwrKu4spGuWplUyYVWbp15b1C/LdA893t/uC8Q4hHaHc+HiYXNHFFdPxk9ZGBbS6/y8ejyL9jOPHN1odyIdaWuQipdBgrgPzFqU0NNx39dlb2UVw00OYASGdMPgEIR2KSjj6K3JQ2WoipRa4QtUZQmkMdrXE7jYJuSDXAdmuPDK5C28jWmHxF9yyNdLVtRiiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"github secret\" title=\"github secret\" src=\"/static/b0e39b436832bc1509b544d5172b2583/37523/github-secret.png\" srcset=\"/static/b0e39b436832bc1509b544d5172b2583/e9ff0/github-secret.png 180w,\n/static/b0e39b436832bc1509b544d5172b2583/f21e7/github-secret.png 360w,\n/static/b0e39b436832bc1509b544d5172b2583/37523/github-secret.png 720w,\n/static/b0e39b436832bc1509b544d5172b2583/302a4/github-secret.png 1080w,\n/static/b0e39b436832bc1509b544d5172b2583/33c9c/github-secret.png 1133w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 13. Github - github action 대상 프로젝트에 secret 등록 </em>\n</p>\n<p>위와 같이 진행하면 사전작업은 끝이다.\n자 이제 배포 스크립트를 작성해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and deploy Docker app to Lightsail\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main <span class=\"token comment\"># 배포 트리거 대상 브랜치 on.push.branch -> 해당 브랜치가 푸시될 때 트리깅</span>\n\n<span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">AWS_REGION</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">2</span> \n  <span class=\"token key atrule\">AWS_LIGHTSAIL_SERVICE_NAME</span><span class=\"token punctuation\">:</span> amazon<span class=\"token punctuation\">-</span>lightsail<span class=\"token punctuation\">-</span>container<span class=\"token punctuation\">-</span>example <span class=\"token comment\"># 실제 lightsail에 올라갈 이미지 명</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and deploy\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">defaults</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">working-directory</span><span class=\"token punctuation\">:</span> ligthsail<span class=\"token punctuation\">-</span>example <span class=\"token comment\"># github project내에 배포할 대상 프로젝트 디렉토리</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout <span class=\"token comment\"># 해당 working-directory checkout (트리깅 브랜치 최신버전)</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n        \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install Utilities <span class=\"token comment\"># 필수 유틸리티 다운로드 </span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          sudo apt-get update\n          sudo apt-get install -y jq unzip</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install AWS Client <span class=\"token comment\"># AWS SDK 다운로드 (LightSail 이미지 푸시 및 배포를 위함)</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          curl \"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\" -o \"awscliv2.zip\"\n          unzip awscliv2.zip\n          sudo ./aws/install || true\n          aws --version\n          curl \"https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl\" -o \"lightsailctl\"\n          sudo mv \"lightsailctl\" \"/usr/local/bin/lightsailctl\"\n          sudo chmod +x /usr/local/bin/lightsailctl</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Configure AWS credentials <span class=\"token comment\"># 입력된 IAM 사용자 액세스키 &amp; 시크릿키 검증</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> aws<span class=\"token punctuation\">-</span>actions/configure<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>credentials@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">aws-region</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.AWS_REGION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">aws-access-key-id</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_ACCESS_KEY_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">aws-secret-access-key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_SECRET_ACCESS_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker Image <span class=\"token comment\"># Docker Buildkit 빌드</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> DOCKER_BUILDKIT=1 docker build <span class=\"token punctuation\">-</span>t $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.AWS_LIGHTSAIL_SERVICE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>release .\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Push and Deploy <span class=\"token comment\"># 이미지 푸시 및 배포</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          service_name=${{ env.AWS_LIGHTSAIL_SERVICE_NAME }}\n          aws lightsail push-container-image \\\n            --region ${{ env.AWS_REGION }} \\\n            --service-name ${service_name} \\\n            --label ${service_name} \\\n            --image ${service_name}:release\n          aws lightsail get-container-images --service-name ${service_name} | jq --raw-output \".containerImages[0].image\" > image.txt\n          jq --arg image $(cat image.txt) '.containers.app.image = $image' container.template.json > container.json\n          aws lightsail create-container-service-deployment --service-name ${service_name} --cli-input-json file://$(pwd)/container.json</span></code></pre></div>\n<p>위에 각 스텝마다 간단히 주석을 달아놨다.\n사실, AWS SDK를 직접 내려받아서 AWS CLI로 처리를 하는 것을 볼 수가 있다.</p>\n<p>위의 코드를 github action을 사용할 프로젝트에 <code class=\"language-text\">.github/workflows</code> 디렉토리 밑에 두면 실제로 액션이 수행된다.</p>\n<p>한번 main 브랜치에 푸시를 하면 이런식으로 github action이 동작하는 것을 볼 수 있다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzElEQVQoz6WR0WqEMBBFY6ImxiTGGHW7UrZ96P9/4inRLZTSh2ofDsNwYTiXEWO+E58M+Y4f10vk24NpfUWkZSOkFdn01NqdwKO0Q9uIi8uODRlhw0TbBYTUCGWuIzWq7REuzoRxRZZFGaq6u0xjPGIYF9btHTfMWD9hXEL3Ed2Pp+l8QnQusT0+jkUZZGNP1y12Ze6Vy6FiWOz+U/nHwTfckI9gf853/mr6fIr1eTeM80aYXvDphg0ztRlQOiBbR9X0VM3X/I0jU9rzCW+rxqHVwUX7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"github action\" title=\"github action\" src=\"/static/30332950704c42eb49efe97ffb800180/37523/github-action.png\" srcset=\"/static/30332950704c42eb49efe97ffb800180/e9ff0/github-action.png 180w,\n/static/30332950704c42eb49efe97ffb800180/f21e7/github-action.png 360w,\n/static/30332950704c42eb49efe97ffb800180/37523/github-action.png 720w,\n/static/30332950704c42eb49efe97ffb800180/302a4/github-action.png 1080w,\n/static/30332950704c42eb49efe97ffb800180/07a9c/github-action.png 1440w,\n/static/30332950704c42eb49efe97ffb800180/00e09/github-action.png 2195w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 14. Github Action 수행 결과 </em>\n</p>\n<p>하지만, 에러가 발생하는 것을 볼 수 있다.\n이 부분은 AWS CLI로 라이트세일 컨테이너 서비스 배포를 처리할 때 발생하는 템플릿 파일이 없어서 발생하는 에러이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">...</span>중략<span class=\"token punctuation\">...</span>\njq <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>arg image $(cat image.txt) '.containers.app.image = $image' container.template.json <span class=\"token punctuation\">></span> container.json <span class=\"token comment\"># container.tamplate.json이 없어서 에러 발생 </span>\n<span class=\"token punctuation\">...</span>중략<span class=\"token punctuation\">...</span></code></pre></div>\n<p>이 파일을 추가하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">{</span>\n  <span class=\"token key atrule\">\"containers\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token key atrule\">\"app\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token key atrule\">\"image\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token key atrule\">\"environment\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">\"APP_ENV\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"release\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token key atrule\">\"ports\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">\"80\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"HTTP\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token key atrule\">\"publicEndpoint\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token key atrule\">\"containerName\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"app\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token key atrule\">\"containerPort\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n    <span class=\"token key atrule\">\"healthCheck\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token key atrule\">\"healthyThreshold\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token key atrule\">\"unhealthyThreshold\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token key atrule\">\"timeoutSeconds\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n      <span class=\"token key atrule\">\"intervalSeconds\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n      <span class=\"token key atrule\">\"path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token key atrule\">\"successCodes\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"200-499\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 파일이 필요한 이유는 위 배포 스크립트에서 jq를 통해서 <code class=\"language-text\">container.template.json</code> 에 생성된 이미지 이름을 넣고, 아래의 명령을 수행하기 때문이다.</p>\n<p><code class=\"language-text\">aws lightsail create-container-service-deployment --service-name ${service_name} --cli-input-json file://$(pwd)/container.json</code></p>\n<p>따라서, aws cli로 배포를 진행할 때 해당 json으로 헬스 체크나 port등을 처리한다 볼 수 있다.</p>\n<p>Spring boot Application 기준으로 디렉토리 트리를 보자면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">.github\n  └── workflows\n       └── deploy.yml\nligthsail-example\n├── Dockerfile\n├── build.gradle\n├── container.template.json\n├── gradle\n├── gradlew\n├── gradlew.bat\n├── settings.gradle\n└── src</code></pre></div>\n<p>위와 같은 구조로 세팅을 하면 보면 된다.\n따라서, 이 글을 보면서 구축을 하려면 어플리케이션 디렉토리와 <code class=\"language-text\">.github/workflows</code> 디렉토리를 분리하고, 어플리케이션 디렉토리 최상단에 <code class=\"language-text\">Dockerfile</code> 과 <code class=\"language-text\">container.tamplate.json</code>을 위치시키면 된다고 보면된다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAwklEQVQoz52RyRKDIBBEJ5sQlUVQlKipMpVD/v8HO8WoWU5ZDq8aGmaYaqhuR9imhwsDVNWitOEnUo2tT4zxEeSXhmmTNKF9hHbdR1TVwdY92uGC0E9wYQS50EMqj9I2TK48ZFF9jSgsstwwsnQg20QUugbtJGiTgbYJ8Rd7UYJ4Ku2RHTUOUuEgV/2evVQQuZ0Hi+crB8u5LNmlPA2v49N/5Pqe73rXLOc0TDf47owqDPzTTDuyvnqevVdm3yyPrQ3vaQWk6g/TvV0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"deploy success\" title=\"deploy success\" src=\"/static/06c5a9e26da17259109c5eb6bd703e20/37523/deploy-success.png\" srcset=\"/static/06c5a9e26da17259109c5eb6bd703e20/e9ff0/deploy-success.png 180w,\n/static/06c5a9e26da17259109c5eb6bd703e20/f21e7/deploy-success.png 360w,\n/static/06c5a9e26da17259109c5eb6bd703e20/37523/deploy-success.png 720w,\n/static/06c5a9e26da17259109c5eb6bd703e20/302a4/deploy-success.png 1080w,\n/static/06c5a9e26da17259109c5eb6bd703e20/07a9c/deploy-success.png 1440w,\n/static/06c5a9e26da17259109c5eb6bd703e20/4a10c/deploy-success.png 2219w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 14. Github Action - 배포 성공 </em>\n</p>\n<p>설정이 정상적이라면 위와 같이 배포 성공했음을 알 수가 있을 것이다.\n그렇다면, 라이트세일 콘솔에서 제대로 반영됐는지 확인해보자.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 103.8888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAACvElEQVQ4y5VV247TMBDNB/MFfA1P/AEP8MILDyAQQiwLAi1Lm6Zt7okTx3f7oHE23XbbXYSlo3HcZHxm5sw0cc7BWosQQrQEYwyU0tBax73WJtrlNzr33oNWAE5skpclPn+9AhsGpOkGN79vsdvnWK3W2Gwy5HmBTZYhy7bY5znSTYZ1mkIpNTtyBtAcMAIheCTZbod3Hz5gGEcUZQU2jJBSRhbLRxdXmBnK7XekL55h9fI5nGBIKFRaFAKFQ8/aOkjjoAjWxWdlPbT1MM7D+hDhAyC1QV6UKMsq+kjOLg4BNTfY9gr5oCP2TCFtJ2SdwKad8DMf8KsYcFOOuN71uMo63FYczgckFBbnPLIzLsRDf2A976kolAo+crC+R1nVqJv2gKZp0bYtvHNIKOlX365R1TXayYAJjZprjNKgmQzKUYNrh05aGB+ezGk4DpmY1lU1oyxRFAWkEFEQdLP3DovECLSn9Nxjlk7i727tGMOf7R7rfYnbbYGmYxg5x8gncD5hHDmmScwQIqYIRxpcHMcq04EXHJAKUBpyaOC0wKWCETuSFUVkI3OPRSkHh7RqXuHNj1f4kn2cCxJCfPnYGmvBpwl104AxBqUkrLOXHfaixdvr1/h08z62HX1IoS0hLhBCRmZBT7BjDavl3HZLyPS0OIUHtHKQUkWnKnbL3DEz5r02JhZlwUWGQgj0rIfzDv+zlmKcOSQ2w8jBhTh58SngeP/QIelMywlWq4sMzpz9i6FzFnZisGKEowFg7f3MC+HRUB91SDKgOUhTo67r2Cl0tiTemHm4zvb8ssUeHHZswCrbI90VWGV5tPuiioOgrBr0PYuSIZB86JKHIZ84FMaBKQtuAnrpwKSNMzDcCXv5m/BHA2Lukrn5QnhYZaWQrtfYbbfo2jbK6JgFaY80u+sybLabg/68kSdM/wKhXmTN6RF8xwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"lightsail success\" title=\"lightsail success\" src=\"/static/4aa2309efce24a141012e31272b90c56/37523/lightsail-success.png\" srcset=\"/static/4aa2309efce24a141012e31272b90c56/e9ff0/lightsail-success.png 180w,\n/static/4aa2309efce24a141012e31272b90c56/f21e7/lightsail-success.png 360w,\n/static/4aa2309efce24a141012e31272b90c56/37523/lightsail-success.png 720w,\n/static/4aa2309efce24a141012e31272b90c56/8ea22/lightsail-success.png 1023w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 15. Lightsail 웹 콘솔 - 배포 성공 </em>\n</p>\n<p>주어진 Public domain으로 요청을 보냈을 때 (<code class=\"language-text\">api/v1/greeting</code>) 안녕하세요가 나오는지 확인해보자.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 18.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAcElEQVQY062ISw7CIAAFOZombqxiqXytx+cALIAlTFMWfvZ9yWQmTzzmJ7My3KXCWI/zr+EdawPWBZxf0dphjB9Wi8GHlRDeqEVznSTTTXI6XxAxRlJK1FrJuVBKGf4nf/7do8u3fxEcPNFao/d+GBuUKxNCKSFjvgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"api call success\" title=\"api call success\" src=\"/static/209cbb8b47d221e0efa28668507a3611/37523/api-call-success.png\" srcset=\"/static/209cbb8b47d221e0efa28668507a3611/e9ff0/api-call-success.png 180w,\n/static/209cbb8b47d221e0efa28668507a3611/f21e7/api-call-success.png 360w,\n/static/209cbb8b47d221e0efa28668507a3611/37523/api-call-success.png 720w,\n/static/209cbb8b47d221e0efa28668507a3611/d9217/api-call-success.png 904w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 16. API 호출 성공</em>\n</p>\n<p>위와 같이 정상적으로 나옴을 확인할 수 있었다.</p>\n<h2 id=\"step-3-정리\" style=\"position:relative;\"><a href=\"#step-3-%EC%A0%95%EB%A6%AC\" aria-label=\"step 3 정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 정리</h2>\n<p>이번 기회에 EC2와 달리 간단하게 설치할 수 있는 VPS 서비스인 LightSail CI/CD를 만들어보았다.</p>\n<p>물론, 라이트세일 인스턴스 서비스가 아닌 컨테이너 서비스를 활용하였다는 것을 잊으면 안된다.</p>\n<p>우리는 이 컨테이너 서비스에 이미지를 적재하기 위해서 아래와 같은 것들을 배웠다.</p>\n<ol>\n<li>싱글 빌드</li>\n<li>멀티스테이징 빌드</li>\n<li>Buildkit을 활용한 의존성 캐시 + 멀티스테이징 빌드</li>\n</ol>\n<p>3을 통해서 좀 더 빠르게 빌드를 할 수 있었고, 이 만들어진 Dockerfile을 적재하기 위해서\nGithub Action을 사용하고자 하였다.</p>\n<p>그 전에 먼저 IAM 사용자를 추가하여 보안성을 확보하였고, 해당 액세스 키랑 시크릿 키도 Github Secret을 통해서 처리되게끔 설정하였다.</p>\n<p>그 뒤에 Github Action의 배포 스크립트를 통해서 실제 배포를 진행하였다.\n많은 과정을 겪었는데, 한번 익숙해지면 금방 할 수 있지 않을까 싶다.</p>\n<hr>\n<h2 id=\"ps\" style=\"position:relative;\"><a href=\"#ps\" aria-label=\"ps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PS</h2>\n<p>위의 내용 중 상당 부분을 아래의 레포지토리를 참고하였습니다.</p>\n<ul>\n<li><a href=\"https://github.com/arch-inc/amazon-lightsail-containers-test\">arch-inc/amazon-lightsail-containers-test</a></li>\n</ul>\n<p>해당 레포지토리 작성자가 쓴 글도 보시면 매우 좋습니다.</p>\n<ul>\n<li><a href=\"https://zenn.dev/junkato/books/how-to-deploy-research-web-apps/viewer/introduction\">研究プロジェクトのWebアプリを気軽にデプロイする方法</a></li>\n</ul>\n<p>일어라 저는 파파고로 번역해서 읽었습니다.</p>\n<p>프로젝트 전체 예시는 아래에서 확인하실 수 있습니다.</p>\n<ol>\n<li><a href=\"https://github.com/brewagebear/blog-example/blob/main/.github/workflows/deploy.yml\">Github Action 배포 스크립트</a></li>\n<li><a href=\"https://github.com/brewagebear/blog-example/tree/main/ligthsail-example\">brewagebear/blog-example/lightsail-example</a></li>\n</ol>\n<p>모쪼록 긴 글이지만 읽어주셔서 감사합니다.</p>\n<hr>\n<h2 id=\"step-4-reference\" style=\"position:relative;\"><a href=\"#step-4-reference\" aria-label=\"step 4 reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 4. REFERENCE</h2>\n<ol>\n<li><a href=\"https://www.44bits.io/ko/keyword/amazon-lightsail\">아마존 라이트세일(Amazon Lightsail)이란?, 44BITS, 2021</a></li>\n<li><a href=\"https://wooncloud.tistory.com/96\">AWS Lightsail - 라이트세일을 소개합니다, 운클라우드, 2022</a></li>\n<li><a href=\"https://swiftcoding.org/all-about-amazon-lightsail-billing\">아마존 라이트세일 요금의 모든 것과 비용 관리 방법 (서버 및 리소스 가격 책정 방법), 스위프트코딩, 2020</a></li>\n<li><a href=\"https://github.com/moby/buildkit\">moby/buildkit, github</a></li>\n<li><a href=\"https://blukat.me/2021/07/docker-buildkit-speedup/\">Docker Buildkit으로 빌드 시간 단축하기, blukat29, 2021</a></li>\n<li><a href=\"https://earthly.dev/blog/compiling-containers-dockerfiles-llvm-and-buildkit/\">Compiling Containers – Dockerfiles, LLVM and BuildKit, Adam Gordon Bell, 2021</a></li>\n<li><a href=\"https://vsupalov.com/buildkit-cache-mount-dockerfile/\">How to Speed Up Your Dockerfile with BuildKit Cache Mounts, vsupalov, 2022</a></li>\n<li><a href=\"https://github.com/arch-inc/amazon-lightsail-containers-test\">arch-inc/amazon-lightsail-containers-test</a></li>\n<li><a href=\"https://zenn.dev/junkato/books/how-to-deploy-research-web-apps/viewer/introduction\">研究プロジェクトのWebアプリを気軽にデプロイする方法, Jun Kato, 2021</a></li>\n</ol>","excerpt":"개요 이직을 한 후에 너무 바쁘다보니 블로그 포스팅을 신경을 쓰지 못하였다.\n아직도 바쁘긴하지만, 그래도 여유가 조금씩 생기고 있어서 틈틈히 썼던 초안을 다듬어서 올려보려고 노력해보겠다. 이번 포스팅의 내용은 AWS Lightsail와 Github를 통한 CI/CD 구축 예시이다. AWS Lightsail과 Github를 이용한 CI/CD 파이프라인 구축 예시 STEP 1. AWS Lightsail란? STEP 2. AWS Lightsail과 Github를 이용한 CI/CD 파이프라인 구축 예시 STEP 2.1. Spring Boot Application Dockerize STEP 2.1.1. Docker Buildkit STEP 2.2 Lightsail 배포 전 사전 작업 STEP 2.2.1 IAM 계정 생성 STEP 2.2.2 Github Secret을 통한 보안 작업 STEP 2.3 Github Deploy.yml 파일 작성 STEP 3. 정리 STEP 4. REFERENCE…","frontmatter":{"date":"October 23, 2022","title":"AWS Lightsail과 Github를 이용한 CI/CD 파이프라인 구축 예시","categories":"개발 인프라","author":"개발한입","emoji":"💻"},"fields":{"slug":"/ligthsail-ci-cd-setup/"}},"next":{"id":"c46233c3-14c3-5e14-b09f-add2037e3923","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#step-1-%EC%A3%BC%EB%AC%B8---%EC%9E%AC%EA%B3%A0-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%97%90%EC%84%9C%EC%9D%98-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C\">STEP 1. 주문 &#x3C;-> 재고 서비스에서의 동시성 문제</a></p>\n</li>\n<li>\n<p><a href=\"#step-11-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%EC%A0%84%EB%9E%B5\">STEP 1.1 동시성 문제 해결 전략</a></p>\n<ul>\n<li><a href=\"#step-111-%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BDoptimistic-lock\">STEP 1.1.1 낙관적 락(Optimistic Lock)</a></li>\n<li><a href=\"#step-112-%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BDpessimitic-lock\">STEP 1.1.2 비관적 락(Pessimitic Lock)</a></li>\n<li><a href=\"#step-113-%EB%8B%A8%EC%9D%BC-%EC%93%B0%EB%A0%88%EB%93%9C-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%81%90-%EB%8F%84%EC%9E%85\">STEP 1.1.3 단일 쓰레드 메시지 큐 도입</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-2-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98distributed-transaction%EC%9D%B4%EB%9E%80\">STEP 2. 분산 트랜잭션(Distributed Transaction)이란?</a></p>\n</li>\n<li>\n<p><a href=\"#step-31-%EC%B5%9C%EC%A2%85%EC%A0%81-%EC%9D%BC%EA%B4%80%EC%84%B1eventaul-consistency%EB%9E%80\">STEP 3.1 최종적 일관성(Eventaul Consistency)란?</a></p>\n</li>\n<li>\n<p><a href=\"#step-32-%EC%8A%A4%ED%94%84%EB%A7%81-%EC%B9%B4%ED%94%84%EC%B9%B4-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC-%EB%B0%8F-%EC%9E%AC%EC%8B%9C%EB%8F%84-%EB%A7%A4%EC%BB%A4%EB%8B%88%EC%A6%98\">STEP 3.2 스프링 카프카 예외 처리 및 재시도 매커니즘</a></p>\n</li>\n</ul>\n</div>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p>사실 분산트랜잭션<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>과 아직 MSA<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>에 대해서는 모르는 부분이 너무나 많다.</p>\n<p>이 글을 쓰게된 이유는 주문 &#x3C;-> 재고 서비스 간의 동시성 제어(Concurrency Control)<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup>관련해서 궁금한 점이 생겼고 실제로 이 상황에서 어떻게 처리할 수 있을지 궁금해져서 찾게 되었다.</p>\n<p>그러다가 어쩌다 보니 분산 트랜잭션을 구현한 아티클을 보게 되었다.</p>\n<p><a href=\"https://github.com/YooYoungmo/article-tcc\">REST 기반의 간단한 분산 트랜잭션 구현</a>라는 글이였고, 작성자인 유영모님께서 아주 자세한 설명이 담긴 아티클과 예제 코드를 공유를 해주셔서 이를 기반으로 설명해보고자 한다.</p>\n<p>대부분의 내용은 오히려 유영모님의 TCC 패턴 시리즈 글을 보는 것이 도움이 될 것이라고 생각한다.</p>\n<ol>\n<li><a href=\"https://www.popit.kr/rest-%EA%B8%B0%EB%B0%98%EC%9D%98-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B5%AC%ED%98%84-1%ED%8E%B8/\">REST 기반의 간단한 분산 트랜잭션 구현 - 1편</a></li>\n<li><a href=\"https://www.popit.kr/rest-%EA%B8%B0%EB%B0%98%EC%9D%98-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B5%AC%ED%98%84-2%ED%8E%B8-tcc-cancel-timeout/\">REST 기반의 간단한 분산 트랜잭션 구현 - 2편 (TCC Cancel, Timeout)</a></li>\n<li><a href=\"https://www.popit.kr/rest-%EA%B8%B0%EB%B0%98%EC%9D%98-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B5%AC%ED%98%84-3%ED%8E%B8-tcc-confirmeventual-consistency/\">REST 기반의 간단한 분산 트랜잭션 구현 - 3편 TCC Confirm(Eventual Consistency)</a></li>\n<li><a href=\"https://www.popit.kr/rest-%EA%B8%B0%EB%B0%98%EC%9D%98-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B5%AC%ED%98%84-4%ED%8E%B8-rest-retry/\">REST 기반의 간단한 분산 트랜잭션 구현 - 4편 REST Retry</a></li>\n</ol>\n<p>이렇게 잘 설명된 글이 존재하는데 나는 어떤 글을 쓸 것인지 궁금해할 것이다.</p>\n<p>이번에 내가 다루고자하는 내용은 아래와 같다.</p>\n<ol>\n<li>동시성 문제가 발생한 이유</li>\n<li>해결 방법</li>\n<li>분산 트랜잭션은 무엇인지</li>\n<li>메시지를 소비할 수 없는 상황에서 처리할 수 있는 방법</li>\n</ol>\n<p>어려운 내용이다보니 틀린 내용이 많을 수도 있다.\n이 부분 감안하고 봐주시면 좋을 것 같다.</p>\n<h1 id=\"동시성-문제-해결-전략---스프링으로-구현한-tcc패턴\" style=\"position:relative;\"><a href=\"#%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%EC%A0%84%EB%9E%B5---%EC%8A%A4%ED%94%84%EB%A7%81%EC%9C%BC%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%9C-tcc%ED%8C%A8%ED%84%B4\" aria-label=\"동시성 문제 해결 전략   스프링으로 구현한 tcc패턴 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>동시성 문제 해결 전략 - 스프링으로 구현한 TCC패턴</h1>\n<ul>\n<li>STEP 1. 주문 &#x3C;-> 재고 서비스에서의 동시성 문제\n<ul>\n<li>STEP 1.1 동시성 문제 해결 전략\n<ul>\n<li>STEP 1.1.1 낙관적 락(Optimistic Lock)</li>\n<li>STEP 1.1.2 비관적 락(Pessimitic Lock)</li>\n<li>STEP 1.1.3 단일쓰레드 메시지 큐 도입</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>STEP 2. 분산 트랜잭션(Distributed Transaction)이란?</li>\n<li>STEP 3. 카프카를 사용한 TCC 패턴 적용\n<ul>\n<li>STEP 3.1 최종적 일관성(Eventaul Consistency)란?</li>\n<li>STEP 3.2 스프링 카프카 예외 처리 및 재시도 매커니즘</li>\n</ul>\n</li>\n<li>STEP 4. REFERENCE</li>\n</ul>\n<h2 id=\"step-1-주문---재고-서비스에서의-동시성-문제\" style=\"position:relative;\"><a href=\"#step-1-%EC%A3%BC%EB%AC%B8---%EC%9E%AC%EA%B3%A0-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%97%90%EC%84%9C%EC%9D%98-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C\" aria-label=\"step 1 주문   재고 서비스에서의 동시성 문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. 주문 &#x3C;-> 재고 서비스에서의 동시성 문제</h2>\n<p>이커머스 시스템을 단순화해서 생각해보자. 실제 비지니스 환경에서는 아래와 같이 진행될 것이다.</p>\n<ol>\n<li>사용자가 장바구니 담음</li>\n<li>사용자 결제 요청</li>\n<li>주문서 데이터 생성</li>\n<li>재고 처리</li>\n<li>결제 처리</li>\n</ol>\n<p>여기 흐름에서 궁금한 점은 만약 재고 처리하는 도중에 결품인 것을 확인된다면? 결제는 성공했는데 어떻게 처리할지 등이 궁금할 것이다.</p>\n<p>일단 이를 이해하기 앞 서 간단하게 주문 재고 서비스를 만든다고 가정하자.</p>\n<p>그렇다면, 주문이 되면 재고 서비스에 해당 상품의 재고값을 업데이트하는 식으로 처리할 수 있을 것이다.</p>\n<p>하지만, 멀티쓰레드 환경에서 하나의 상품에 대해서 다량의 주문 요청이 들어올 경우에 갱신분실(Lost Update) 문제가 발생 할 수 있다.</p>\n<p>예시 시나리오를 한번 봐보자.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACUUlEQVQoz51SXUtUURS9/yqyfI2MCkwHQhHyQaJCKioKHwzrrcAeUrCih7CHUkkoHWl0UPMDJU0jzVEStDFn1Jm51/t17j3n7L3izodCjy1Y7POw9mKtwzYgHRsINQAFkCrNEvmfecxIx+U3K6YidqSUVcbdZBZXhjPcPu+hd5PROi1w7YvA+00BvdaGg4VWhD/b8O6XwPWpAK3TPno3gfZFhRuTLh5+I2hGFAhaU9xoSDhc3Z/j2qECP16SfHrQ5hMDNj9ddjiYu8BbI6fYmz3PT5ZMrvpgcfWgzR3LzJdGQz7Zl+O6pOJAg5gZmmjSQGAC8BlFhPgPRLulhETjRlN8H2f6d7l51ELnD4mLcRs1n1y8WDGB1UbkZmqRmYwhP1cHbLTg2UqAc3EPsaTA7SWgMemj5qOpO1cjS5owbk25aBx1+OaMQE9Ko2HMRSzh4c26DaSuwvrahIO5Zhwk6xBMNaFr4RCxEReX+zO4k7DQMuagftjU3WtUMiyGFhbDswAE5QbyqEsF6Z5FzNe/ht03C+zsY7ulG9v33pZWKpWVmjCU0hC+YNt24Bxa8H0PWgYgIrAKygwhbAt+IYfAD6FCBQolvM9DyL/s4vyr5zpYX4sCjBusdTGI5/uc3dtDJpuB5x5CaX2UkImQ/72F7EYKdnobmhgBK+wP9CL96AH/6bhP4vtiJJ0wQBoV0whmoYC9bBau6yA6hSKJoiOLOgFEEGYBu+sp5HfSlTVVrCxlwojEkWGJ6vjnIiOtj0kVUtlYA4EAC8EchiAZ+lKps38BoGUYtUylGy4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"lost update\" title=\"lost update\" src=\"/static/4ea080f3ae40e8d02149db28ea05ebf5/37523/lost-update.png\" srcset=\"/static/4ea080f3ae40e8d02149db28ea05ebf5/e9ff0/lost-update.png 180w,\n/static/4ea080f3ae40e8d02149db28ea05ebf5/f21e7/lost-update.png 360w,\n/static/4ea080f3ae40e8d02149db28ea05ebf5/37523/lost-update.png 720w,\n/static/4ea080f3ae40e8d02149db28ea05ebf5/302a4/lost-update.png 1080w,\n/static/4ea080f3ae40e8d02149db28ea05ebf5/07a9c/lost-update.png 1440w,\n/static/4ea080f3ae40e8d02149db28ea05ebf5/033f0/lost-update.png 3536w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 1. 갱신 분실</em>\n</p>\n<p>위의 그림처럼 <strong>트랜잭션 A가 트랜잭션 B</strong> 전에 미리 처리가 된다면, 재고 값을 2에서 1로 업데이트하려고 하기 때문에 갱신 분실이 발생한다.</p>\n<p>이를 해결하는 방법은 여러가지가 있을 것이다. 그 중에서 낙관적 락(Optimistic Lock)<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup>, 비관적 락(Pessimistic Lock)<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup>이 대표적일 것이다.</p>\n<p>이번 챕터에서는 이러한 처리 방법의 장단점을 알아보고 메시지 큐를 통해서 처리하는 방법등을 알아보고자 한다.</p>\n<h2 id=\"step-11-동시성-문제-해결-전략\" style=\"position:relative;\"><a href=\"#step-11-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%EC%A0%84%EB%9E%B5\" aria-label=\"step 11 동시성 문제 해결 전략 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1 동시성 문제 해결 전략</h2>\n<h3 id=\"step-111-낙관적-락optimistic-lock\" style=\"position:relative;\"><a href=\"#step-111-%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BDoptimistic-lock\" aria-label=\"step 111 낙관적 락optimistic lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.1 낙관적 락(Optimistic Lock)</h3>\n<p>먼저, 낙관적 락이다.</p>\n<p>낙관적 락은 MVCC(Multi Version Concurrency Control)<sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup>처럼 버전을 명시하는 방식이다.\n이를 위해서 먼저, MVCC에 대해서 간략하게 이해를 하고 넘어가야할 필요가 존재한다.</p>\n<p>DB 벤더는 Mysql 기준으로 설명하도록 하겠다.</p>\n<p>MVCC는 Mysql InnoDB 스토리지 엔진 사용 시 언두로그를 활용하여 레코드 마다 여러개의 버전(Multi Version)을 동시에 관리하는 것을 뜻한다.</p>\n<p>이를 통해서 Mysql은 잠금없는 일관된 읽기(Non-Locking Consistent Read)를 구현한다.\n용어가 어려울 수 있는데 INSERT와 연결되지 않은 순수한 읽기는 다른 트랜잭션의 작업과 관계없이 항상 잠금을 대기하지 않고 읽는다는 뜻이다.</p>\n<p>즉, 어떤 트랜잭션에서 서울이라는 값을 경기로 업데이트 한 후 아직 커밋을 안했더라도 변경 전 값인 ‘서울’을 언두로그에 읽어서 일관되게 읽게끔 하는 방식이다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 406px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 114.44444444444446%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAACBklEQVQ4y6WVyaryQBCF8+ouxJWP4cIHcCeIK0EF51lwxnmex/r5CtobY6L38jc0lY6d0+fUqS4t+TIej4fG2+0mx+Px5Z3bsL4B3u93jfV6XSKRyBPQC9T6xszE2WwmnU5HLpfLC6gT2PICMxsNw8ViIaPR6O3AXzF0smMcDgdlORgMZDqdekr/KhmZlUpFwZjj8ViWy+XfAO0bS6WSxONxaTQasl6v3/bY9xItJ4D9mbwNh0Nl1mw2le1qtXoa46bIcjvJDKSRL5j1+30FJpfUJL9tNhuN1+v1laGz7oyzu91OWe73e3V4MpkoCOter6fseccBT8Dz+SypVEqlcBOy2ayk02kFIm/JZFJyuZzuiUajkkgk1GkKPZ/PK/PT6fQDiIRMJiPz+Vza7bZUq1Wp1WoaQ6GQBAIBCQaD4vf7xefzSTgc1o9hzEGxWOzFdYsEk2xzT+0D1sYUpMGqXC4/5bKGiEmRAtrdNfljskY28vjIyMQkcosRxowXl503w+427gJGhCEySZET6KUO3YrTPCMZlkSYAQg7Z4N4Y+hVpIB1u93nHW61WsrWDvin5kDNIXm73apkzMC8j4DGDEPfbgofA0akKRSLRQVz60a/7thuzD/2Q1yjHKgrqr5QKGi7ot7oNNwWpv16fWTItUEOTppCxgzeMckha3vx/teflJdkL8B/ITL1sLp3ZJoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"mvcc\" title=\"mvcc\" src=\"/static/2cf69e7ffd345d363b2c3c71945588cc/e33ef/mvcc.png\" srcset=\"/static/2cf69e7ffd345d363b2c3c71945588cc/e9ff0/mvcc.png 180w,\n/static/2cf69e7ffd345d363b2c3c71945588cc/f21e7/mvcc.png 360w,\n/static/2cf69e7ffd345d363b2c3c71945588cc/e33ef/mvcc.png 406w\" sizes=\"(max-width: 406px) 100vw, 406px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>Real MySQL 8.0, p.103, 백은빈, 이성욱 저</em>\n</p>\n<p>낙관적 락은 MVCC와 비슷하게 처리된다. 버전을 통해서 위의 상황같이 동시에 작업이 들어와도 Version이 다를 경우에는 트랜잭션이 어보트되서 갱신분실을 막을 수가 있다.</p>\n<p>MVCC와 낙관적 락의 어떻게 보면 문제 해결 전략자체는 비슷하다고 볼 수 있으나 MVCC는 언두 레코드 자체에 잠금을 걸 수 없는 문제가 있어서 순수한 읽기가 아닌 <code class=\"language-text\">SELECT ~ FOR UPDATE</code> 와 같은 구문에는 원본 레코드의 값을 가져와서 팬텀 리드가 발생할 수 있다.</p>\n<p>아래와 비슷하게 처리된다고 볼 수 있다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 642px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 98.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAACTElEQVQ4y42UW29BURCF/XESwpsX0b8gHjwhHiReELcUIXGNllKXFqV1qbtpvp3sk6Ol7STbPkf2WbNmzZpt2W63slgsZL1ey3K5lM/PTyHO57NaOvS7/u90Oqnv+Ga1Wqn9cDiIZTKZSDqdlpeXF7X6/f4PgO9LR7FYlEqlIm9vbzIYDGQ+n4vl/f1dqtWqNJtN9ScJNOCt2O12ilW9XpdSqSRPT08yHA5ls9mIRR8ajUYX5RH7/V6m06liQGLk4KPZbKYA2KlIkyAsWo/xeGxoQ6CPx+MRu90uNptNrFaruN1uabVahm6dTkeV/PHxYRAxAF9fXy/Y0SQ0SiQSEolEJJvNSjwel4eHBwUGAdg9Pj4q7W4CmuN4PKqyKAk3IAHlAwhTGKI9ZwxAzajdbsvz87PqNCUA4vP5xOv1yt3dnVq8ox32QEt2ElwFrNVqks/nVUl0jz0Wi0kwGBS/3y+hUEjC4fBF8wga9aNkHtBDG5ySyJzL5SQajUogEJBkMqk0pOvm5nH2gqHO1Ov11GGykZVO3t/fq2ZkMhm1s8wdvQnIA4CA8YFmeivME3MV0OzD/8S/AL/7EMvgsVQqpUqmfKyCfcxBJb/6UIvNqDEZLpdLTYvD4RCn0ymNRsO4XWgkjuDsnwxhwmWBcWHX7XaVkQGBERJhtXK5fMmQHwAxtJkhgDQKRoVCQd0oeJMklMl5ABnPq7bRf/7WCHTl6iIZZTMt2moGIDYBjIxMAaPFM0x4RwrK/MtGBqCeDMysPah3vRAdZrducjPoF50R5n4raqjCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"phantom read\" title=\"phantom read\" src=\"/static/67bd98f2fc9f679c7281ff5ce37a4f18/1bba8/phantom-read.png\" srcset=\"/static/67bd98f2fc9f679c7281ff5ce37a4f18/e9ff0/phantom-read.png 180w,\n/static/67bd98f2fc9f679c7281ff5ce37a4f18/f21e7/phantom-read.png 360w,\n/static/67bd98f2fc9f679c7281ff5ce37a4f18/1bba8/phantom-read.png 642w\" sizes=\"(max-width: 642px) 100vw, 642px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>Real MySQL 8.0, p.182, 백은빈, 이성욱 저</em>\n</p>\n<p>그렇다면 낙관적 락은 어떻게 처리되는가?</p>\n<p>실제로 버전 컬럼이 존재하고, 이 버전을 토대로 트랜잭션이 진행되는데 먼저 진행된 트랜잭션으로 인해 버전이 변경되었고, 다음 트랜잭션은 이전 버전을 기준으로 수행 되기때문에 이 트랜잭션은 어보트된다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACXklEQVQoz51STWsTURSdvTsX3bkRxJ8gVrsUrKigJWitXaiUolKwdNeFIrhS1IUf1I1Q3GhbrFhISkyaxtia2m9obC0Wv6qZScbJZD5f5r13j8w0TdGlBw738R6ce869T4GtW/BNwU2NgxgH0CD9U3coOUD1M3GSETaDIGhW+nMGLo6XqG+ihMF1gZ4pH5ff+nix4UOs9qM814Pax348/+zjSo6h552HZxvA9XmOq1kHNxYkBEEAgBAyrrQnbWoZ0elM0qFbS4IOj1bpwIhFd5ZsYvkT9DVxiNzp43R7sULNL01qGbXo5hLR6Tc1OjikU1uaExOQRAQhZVYBqwDCIrg6AAf/AQrNRQ6lzCid8RKODP2k9jEVd5cZTiZstI45eLJSAQod0KdOoZiN4Xe+DVjvwv0VhmNxF7G0j95FoCPtofV1RdwrhJJyUrmWc3A+ZVPv+xoG1iTOpRzEki4GP1nAWjfM2U6U8xdQTreB5TrxcK6KWMLB2eEi+lI2ujIeYuOWeLRWF4xM+ybBrQBg9QRBI8s2fgzMYyb2FNbwNPBdxbdLD/Cl+zGwqWErsgyXMqlwLuB7PlmWDbtqwvNciIBBSgnirEHfNODqJTCXQYZe6g0p+jcQohZASpFRSIjIiOt5pGoaimoRrlMFF6LhMNygvlrAr5kpmAsfYGVTMCbiMDLjMFIJEiVNRoE5n1QgBbZFQ1QMA5qqwnHsSIhIRhW8PobCMmb3N2Fi725k9zUhv2cXWOIVj3IzllQojCYEbZHvTC4UE+JvhndBACprkCUVshRVIt8L372gVjv6B2zeEmbUw4btAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"optimistic lock\" title=\"optimistic lock\" src=\"/static/ad08b63c38b34d0fc55bed818ecfb3a8/37523/optimistic-lock.png\" srcset=\"/static/ad08b63c38b34d0fc55bed818ecfb3a8/e9ff0/optimistic-lock.png 180w,\n/static/ad08b63c38b34d0fc55bed818ecfb3a8/f21e7/optimistic-lock.png 360w,\n/static/ad08b63c38b34d0fc55bed818ecfb3a8/37523/optimistic-lock.png 720w,\n/static/ad08b63c38b34d0fc55bed818ecfb3a8/302a4/optimistic-lock.png 1080w,\n/static/ad08b63c38b34d0fc55bed818ecfb3a8/07a9c/optimistic-lock.png 1440w,\n/static/ad08b63c38b34d0fc55bed818ecfb3a8/033f0/optimistic-lock.png 3536w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 2. 낙관적 락</em>\n</p>\n<p>낙관적 락은 이름 그대로 낙관적인 락킹방법이다.</p>\n<blockquote>\n<p>먼저 자원에 락을 걸어서 선점하지말고 충돌 날 때 처리하자</p>\n</blockquote>\n<p>라는 <strong>낙관적인</strong> 방법론에서 탄생한 기법이라고 볼 수 있다.</p>\n<p>그렇다면 이 낙관적 락으로 처리를 못할 케이스도 존재할까?</p>\n<p>위에서 설명한 흐름을 다시 가져와보자.</p>\n<ol>\n<li>사용자가 장바구니 담음</li>\n<li>사용자 결제 요청</li>\n<li>주문서 데이터 생성</li>\n<li>재고 처리</li>\n<li>결제 처리</li>\n</ol>\n<p>결제 요청 후에 재고 처리할 때, 만약 결제 처리가 API를 통해서 이뤄진다면 이 순서대로 이뤄지는 것이 아닐 수도 있다.</p>\n<p>즉, 이미 결제가 성공된부분은 어떻게 처리할 것인가? 에 대한 문제가 존재한다.</p>\n<p>이를 위해 원자적으로 프로세스를 순차적으로 처리하는 방식을 쓸 수 있다.\n이 때 사용할 수 있는 것이 비관적 락이다.</p>\n<h3 id=\"step-112-비관적-락pessimitic-lock\" style=\"position:relative;\"><a href=\"#step-112-%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BDpessimitic-lock\" aria-label=\"step 112 비관적 락pessimitic lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.2 비관적 락(Pessimitic Lock)</h3>\n<p>비관적 락은 말 그대로 직접 락을 걸어서 하나의 작업만 처리되게끔 보장하는 것이다.</p>\n<p>하지만, 락을 직접 걸기 때문에 만약 고객들이 몰리는 상황에서는 느린 주문 경험을 사용자가 얻게 될 것이다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACBUlEQVQoz1VSO2/UQBD270IJFUjpoEBIVFCCACHxaECCigbq0FBBhMSjzul0QeScJol45AogKThEjlzOxud7+bmv70Nr+3LOSJ93Z3bmm9nP61BGM1Jokoo0qlwtoFDtUfkl5nmm7ls7klKecR588nmt4eHxbsK1LnjLTXijnfBdN6Pef8Tgy22Knw/5tpvz+pbknfaMT/bAjWPy7o7kTTfm6gHsQNTaNJwrzQmW3//DpfURnnY0zrkKyy2J550p8t2LOGyeRbp9Ac86MZY+EivtDJddYO2Xwfn1DEsfhrj/GaYgNMZ1WBqqldM3beYbnSJ0EqxM7xxw9LJFKlkP2zRtP8aYTScMRwyCIaRSxdHf1y79RqfIkjojjCa0KiqDrX3+ftGkSkTJoo2disaUVzbGtB2RJMzjGJCSWggqWkiaXFCJlFqkhJKE0rWZUDSB1iWU0jZWEDJNiMAHAp9p7w/7e9/o//hONfTI2Yhq5JNKMZeSg36fg6MeZ1F0SidovSCEEEQSA0lMS848ItOYec9j1vMYhz7TeMosTalkxiQaM4piClsHlPMuCDedeqP5Jg1Cbl9d5dd7rxj4Aw5Dj6GdmJrRbELP8zkej+uEZnHlUgdUWhS00WTK48Mep8Pw1F+2OYu2qGuoKsKWA/uEUFohdvmkFiTGnKA4r/llybwOqZRy5T8E2DnJ6QBD9wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"pessimitic lock\" title=\"pessimitic lock\" src=\"/static/1530537281300df4914cb9020ae51d5a/37523/pessimitic-lock.png\" srcset=\"/static/1530537281300df4914cb9020ae51d5a/e9ff0/pessimitic-lock.png 180w,\n/static/1530537281300df4914cb9020ae51d5a/f21e7/pessimitic-lock.png 360w,\n/static/1530537281300df4914cb9020ae51d5a/37523/pessimitic-lock.png 720w,\n/static/1530537281300df4914cb9020ae51d5a/302a4/pessimitic-lock.png 1080w,\n/static/1530537281300df4914cb9020ae51d5a/07a9c/pessimitic-lock.png 1440w,\n/static/1530537281300df4914cb9020ae51d5a/033f0/pessimitic-lock.png 3536w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 3. 비관적 락</em>\n</p>\n<p>그렇다면 이 비관적 락처럼 하나의 작업만 처리하지만 보다 빠르게 처리할 수 없는 방법이 없을까?</p>\n<p>바로, 단일 쓰레드 메시지 큐(Redis와 같은 것들)을 도입함으로써 해결 할 수 있다.</p>\n<h3 id=\"step-113-단일-쓰레드-메시지-큐-도입\" style=\"position:relative;\"><a href=\"#step-113-%EB%8B%A8%EC%9D%BC-%EC%93%B0%EB%A0%88%EB%93%9C-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%81%90-%EB%8F%84%EC%9E%85\" aria-label=\"step 113 단일 쓰레드 메시지 큐 도입 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.3 단일 쓰레드 메시지 큐 도입</h3>\n<p>Redis가 6.0 부터 Thread I/O를 제공하여 멀티쓰레드로 돌아가나? 라고 생각할 수 있지만 대부분의 명령들은 메인쓰레드(싱글쓰레드)에서 동작을 한다.</p>\n<p>따라서, 원자적인 작업을 지원한다. 또한, 단일 쓰레드여서 불필요한 락이나 컨텍스트 스위칭과 같은 부분에 대해서 고려하는 점이 최소화되다보니 비관적 락을 쓰는거보다 빠르게 처리할 수 있다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB5ElEQVQoz32SvWsUURTFF7XQyiqNoIh2kiZiZWHt/xGwsklhJZheOxsJUbEQGzGgxWLWoFGRmODCriBDAjubZHazu+MO2czOx753594j82YmuyGJF+68x2Pu751zZkrM7DNzIiKkNZGKAgLFJKOQVBRSpECxAoUx0zBUFMZizsJIEScJMQtxVi2t9e0SAEha6YYJVtvDsuXio9VDfbsH3/kOt/EJ/e1vcHc20Gssw7Ur2He3wGbIPBIzzlwuFTzNhilPLZEzC/ty7nkg89Wh4Oe02EsXxF29KaM/96SzdF7ab88KO4vmfWGdjnMO/DpWmGlEMPDRsR10my34PQ/K2kK/vg6/Vod22ojVDnjUgVCcactmC4VfxkAiA4xfPYN9/SKa01Poz81h5c5jvLw2i9eXZmE/+gBV+MvmirUArh5TmHT3oH6tQVXXoe0mDmq7GGw04P3YRFBzEA08aM8HR+oQejIwV6jfvIAzcwWtmasIF54YRQSNYK+LtVvz+HzjASqX76Px8F0GZD4FyCZX8G4T0UrZNDU2kV6TsIY6CPC3XEevXEP3fRXD3w4m3B3JsLB7aPtIpWcnHE9kOPmVj2doLCRJ1une/GmSZZXwuHNHeYaUAyuliVtO0fH/mrAXaa3v/gOtKzRWrse6WwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"single thread queue\" title=\"single thread queue\" src=\"/static/4a8d6b59a835d846a1d5789445c1af16/37523/single-thread-queue.png\" srcset=\"/static/4a8d6b59a835d846a1d5789445c1af16/e9ff0/single-thread-queue.png 180w,\n/static/4a8d6b59a835d846a1d5789445c1af16/f21e7/single-thread-queue.png 360w,\n/static/4a8d6b59a835d846a1d5789445c1af16/37523/single-thread-queue.png 720w,\n/static/4a8d6b59a835d846a1d5789445c1af16/302a4/single-thread-queue.png 1080w,\n/static/4a8d6b59a835d846a1d5789445c1af16/07a9c/single-thread-queue.png 1440w,\n/static/4a8d6b59a835d846a1d5789445c1af16/033f0/single-thread-queue.png 3536w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 4. 단일 쓰레드 메시지 큐</em>\n</p>\n<p>그래서 최종적으로 아래와 같은 흐름대로 처리할 수 있다.</p>\n<ol>\n<li>사용자가 장바구니 담음</li>\n<li>사용자 결제 요청</li>\n<li>주문서 데이터 생성 및 큐에 적재</li>\n<li>결제 처리 &#x26; 재고 처리 (각각 따로 처리)</li>\n<li>결품이 발생하면 해당 주문서를 취소처리</li>\n</ol>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACLUlEQVQoz3VTz2tTQRB+V/8FwZNgD6WCVLBq6EUR8agievHiqR4VwYCXSKEnY70EUbAi/moptVar0ChJicUePHhoQUPyyI+2SZvU/H6+t7Mzn+zLa4qUDnw7u7Dzzew3sxZr3WSlNCtFrImY2YeIkNaaXNclz/N8uMolYkWkVe+eH6cUs/LWlOOcstA1wY6J9A6e56FarWJ7u4p6rQEQ9jNtFgY+WVzISefdW2nPvBH6+UN8SmExFiTy4fJfmS9My0z2pcSL70WBhJo1ac9OmljuzE5C2ZlFS8c/oBTqk+LQYbjRSLdIrQ2rD2Y/OcruBs58HsDx6UO4lBhGDS007VXkQ/1iDx3RhVA/2rNTCYvqHbh2SbxsHl6pBmHuwhAyg83ePMdVaK1toFHMo71eAXQgjFKA8rTxTJS0CuMLSPTdkS+D97By89W+IjWXMkgeDWNu4BaWTkbg2pWe+BLQs0jSonIDTq4uevQhqoOnkb14Fm7kNjYnUli+PI5vV6LIjc1DHI1OugTnVwFOpgL2KOihL43RyMiTtL5ufcTw4jG5fv8Ant84iHR4BFtPRpGfS+H73adIhR8j/SKO1mYW69fOIX3hBMojVwFNCDooPqGpkDlh/W6sSGx1DI/sB5KgZT8r/TdHgVTNP2g9i6EWi6L9egIwjdsl5IAwuWcOmZR/GSwQYh/QvEdTCWY2eDYFhAsWC4NYiYE2lUtPl10g8EQ97HyAYF6Nd5RS5/8BussgLNx3j2oAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"single thread queue fail\" title=\"single thread queue fail\" src=\"/static/704d708ad979064dd1da40342c0f275d/37523/single-thread-queue-fail.png\" srcset=\"/static/704d708ad979064dd1da40342c0f275d/e9ff0/single-thread-queue-fail.png 180w,\n/static/704d708ad979064dd1da40342c0f275d/f21e7/single-thread-queue-fail.png 360w,\n/static/704d708ad979064dd1da40342c0f275d/37523/single-thread-queue-fail.png 720w,\n/static/704d708ad979064dd1da40342c0f275d/302a4/single-thread-queue-fail.png 1080w,\n/static/704d708ad979064dd1da40342c0f275d/07a9c/single-thread-queue-fail.png 1440w,\n/static/704d708ad979064dd1da40342c0f275d/033f0/single-thread-queue-fail.png 3536w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 5. 단일 쓰레드 메시지 큐 - 실패 시나리오</em>\n</p>\n<p>이러한 방식으로도 접근 할 수 있다고 생각한다.</p>\n<p>기본적으로 어떤 방식으로 주문 &#x3C;-> 재고 서비스 간에서 동시성 제어를 할 수 있는지 알아보았다.</p>\n<p>서론에서도 말했지만, 틀린 내용이 존재할 수 있다고 생각하니 이 부분 양해바란다.</p>\n<p>위 방식은 어떻게 보면 최종적 일관성과 분산 트랜잭션 방식을 사용한 것인데 각각 서비스들이 분산된 환경에서 이 트랜잭션들을 처리하는 방법을 알기 위해 분산 트랜잭션과 최종적 일관성에 대해 알아보고자 한다.</p>\n<h2 id=\"step-2-분산-트랜잭션distributed-transaction이란\" style=\"position:relative;\"><a href=\"#step-2-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98distributed-transaction%EC%9D%B4%EB%9E%80\" aria-label=\"step 2 분산 트랜잭션distributed transaction이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2. 분산 트랜잭션(Distributed Transaction)이란?</h2>\n<p>이 부분은 <a href=\"https://dataintensive.net/\">DDIA(Designing Data-Intensive Applications, 데이터 중심 어플리케이션 설계)</a>라고 부르는 책의 9장을 많이 참고하였다.</p>\n<p>처음에 분산 트랜잭션을 이해할 때는 DB가 분산되어 있는 상황에서 해당 트랜잭션을 관리하는 것으로 알고 있었다.</p>\n<p>그러나 수 많은 예시들 TCC패턴이나 사가(Saga)패턴을 보면 메시지를 발급해서 커밋 롤백 처리를 하는 것도 보았다.</p>\n<p>정확한 예시는 이 책을 보고 알게되었는데 크게 분산 트랜잭션은 두 가지로 분류된다.</p>\n<ol>\n<li>데이터베이스 내부 분산 트랜잭션</li>\n</ol>\n<ul>\n<li>어떤 분산 데이터베이스(복제나 파티셔닝을 사용하는)는 데이터베이스 노드 사이의 내부 트랜잭션을 지원한다. 이 경우 트랜잭션에 참여하는 모든 노드는 동일한 데이터베이스 소프트웨어를 실행한다. (즉 전자의 예시)</li>\n</ul>\n<ol start=\"2\">\n<li>이종 분산 트랜잭션</li>\n</ol>\n<ul>\n<li>두 가지 다른 벤더의 데이터베이스 혹은 카프카와 레디스와 같은 메시지 큐와 데이터베이스 사이의 트랜잭션 등으로 구성된 환경에서의 트랜잭션 (후자의 예시)</li>\n</ul>\n<p>이번에 주로 다룰 내용은 이종 분산 트랜잭션이다.</p>\n<p>메시지 큐를 통해서 재고차감 메시지를 발급하고 이를 컨슘하는 시스템이라 보면 될 것 같다.</p>\n<p>이제 이에 대해서 설명하고자 한다.</p>\n<h1 id=\"step-3-카프카를-사용한-tcc-패턴-적용\" style=\"position:relative;\"><a href=\"#step-3-%EC%B9%B4%ED%94%84%EC%B9%B4%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C-tcc-%ED%8C%A8%ED%84%B4-%EC%A0%81%EC%9A%A9\" aria-label=\"step 3 카프카를 사용한 tcc 패턴 적용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 카프카를 사용한 TCC 패턴 적용</h1>\n<h2 id=\"step-31-최종적-일관성eventaul-consistency란\" style=\"position:relative;\"><a href=\"#step-31-%EC%B5%9C%EC%A2%85%EC%A0%81-%EC%9D%BC%EA%B4%80%EC%84%B1eventaul-consistency%EB%9E%80\" aria-label=\"step 31 최종적 일관성eventaul consistency란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.1 최종적 일관성(Eventaul Consistency)란?</h2>\n<p>이 부분은 서두에서 말한 것과 같이 대부분의 코드와 매커니즘을 유용모님께서 작성한 컬럼에서 가져왔다.</p>\n<p>원래 이 코드 자체에도 주문, 재고, 결제 서비스가 존재하지만 나는 여기서 주문, 재고 서비스만 가져왔다.</p>\n<p>자세한 부분은 <a href=\"https://github.com/YooYoungmo/article-tcc\">REST 기반의 간단한 분산 트랜잭션 구현</a>을 참고하자.</p>\n<p>여기서 중점적으로 볼 사항은 <strong>최종적 일관성(Eventual Consistency)</strong><sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup>이다.</p>\n<p>위에서 말한거처럼 만약, 각각 서비스들이 외부 API로 처리될 경우에 결제가 실패할 경우에는 재고를 다시 늘려줘야하고, 결제가 성공했으나 결품일 경우에는 결제 취소를 해줘야할 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://www.popit.kr/wp-content/uploads/2018/07/image2018-7-30_13-44-21-1024x661.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://www.popit.kr/rest-%EA%B8%B0%EB%B0%98%EC%9D%98-%EA%B0%84%EB%8B%A8%ED%95%9C-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B5%AC%ED%98%84-3%ED%8E%B8-tcc-confirmeventual-consistency/\">REST 기반의 간단한 분산 트랜잭션 구현, 유영모, 2018</a></em>\n</p>\n<p>이때 카프카와 같은 메시지 브로커를 둬서 처리할 수가 있다. 최종적 일관성에 대한 내용도 본문에 존재하지만, 여기서도 간략하게 설명하자면 분산 시스템 환경에서는 일관성이 일시적으로 깨질 수 있는 상황들이 존재한다.</p>\n<p>단일 시스템 환경에서는 강력한 트랜잭션으로 묶어서 관리가 되기때문에 <strong>강한 일관성(Strong Consistency)</strong> 으로 묶일 수 있다.</p>\n<p>하지만, 분산 시스템에서는 이렇게 강한 일관성을 유지하려면 확장성과 성능의 문제가 생긴다.\n아래의 그림을 참고해보자.</p>\n<p align=\"center\">\n    <img src=\"https://cloud.google.com/datastore/docs/articles/images/balancing-strong-and-eventual-consistency-with-google-cloud-datastore/strong-consistency.png?hl=ko\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://cloud.google.com/datastore/docs/articles/balancing-strong-and-eventual-consistency-with-google-cloud-datastore?hl=ko\">Conceptual Depiction of Replication with Strong Consistency, Google Cloud</a></em>\n</p>\n<p>강한 일관성은 어떤 데이터를 최신 데이터로 복제를 수행할 때 항상 최신값을 유지하지만 복제가 완료될 동안에는 클라이언트가 접근을 할 수 없는 문제가 발생한다.</p>\n<p>그에 반해 최종적 일관성의 흐름은 아래와 같다.</p>\n<p align=\"center\">\n    <img src=\"https://cloud.google.com/datastore/docs/articles/images/balancing-strong-and-eventual-consistency-with-google-cloud-datastore/eventual-consistency.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://cloud.google.com/datastore/docs/articles/balancing-strong-and-eventual-consistency-with-google-cloud-datastore?hl=ko\">Conceptual Depiction of Replication with Eventual Consistency, Google Cloud</a></em>\n</p>\n<p>최신 값이 복제 중이지만 클라이언트는 오래된 값을 볼 수가 있다. 이렇게 함으로써 보다 유연한 확장이 가능하고, 성능도 어느정도 확보를 할 수 있다.</p>\n<p>위의 아티클에도 설명이 되어있지만, <strong>최종적 일관성은 몇 명이 좋아요를 눌렀는지?</strong> 와 같은데에서 사용할 수 있고, 강한 일관성은 <strong>게이머가 한 전투 세션에서 획득한 경험치</strong>와 같은 것으로 볼 수 있다.</p>\n<p>즉, 적절한 트레이드 오프가 필요하고 분산 환경에서는 성능과 확장성 때문에 이러한 최종적 일관성을 적절하게 수용하고 있다고 볼 수 있다.</p>\n<p><strong>결국 지금은 일관성이 깨졌지만, 언젠가는 일관성이 맞춰진다</strong>는 것이 최종적 일관성의 모토라고 볼 수 있을 것같다.</p>\n<p>이를 실제 비즈니스 세계에 대입을 하면 요즘날 구독 서비스라고 볼 수도 있을 것 같다.</p>\n<p>유영모님도 나와 비슷한 경험을 원문에 적어두었는데 내가 겪은 최종적 일관성의 경험은 스포티파이를 이용하면서 였다.</p>\n<p>원래 결제되던 카드의 만료기한이 다되었고 귀찮아서 변경을 안했는데 계속 결제 재시도와 이메일로 알림이 왔었다.</p>\n<p>하지만 서비스는 계속 되길래 그냥 썼었는데 어느 순간 재시도도 멈췄고 서비스 자체도 이용을 못하게 막았다.</p>\n<p>그 후에 내가 다시 새로운 카드로 결제를 해서 서비스를 이용할 수 있었다.</p>\n<p>즉, <strong>이 사용자가 결제가 제대로 이뤄지진 않았지만 언젠가 다시 결제를 하겠지</strong>라는 개념이라 볼 수 있고, 이것이 최종적 일관성이 아닐까 생각이 든다.</p>\n<p>아무튼, 위와 같이 카프카를 둬서 최종적 일관성을 유지할 수 있게끔 처리를 하였다고 볼 수 있다.</p>\n<p>하지만 기존 코드에서는 아쉽게도 서비스 단에서 잘못된 메시지가 발급될 경우에 대한 처리가 되어있지는 않았다. (현 재고보다 많은 수량의 주문이 요청이 오면 -로 재고가 잡혀버린다.)</p>\n<p>이 부분을 어떻게 처리할까 궁금했고, 사실 대부분의 코드는 비슷하고 이러한 처리 부분만 변경했다고 볼 수 있다고 생각한다.</p>\n<p>이제 이 부분에 대한 내용을 끝으로 이 포스팅을 마무리 지으려고 한다.</p>\n<h2 id=\"step-32-스프링-카프카-예외-처리-및-재시도-매커니즘\" style=\"position:relative;\"><a href=\"#step-32-%EC%8A%A4%ED%94%84%EB%A7%81-%EC%B9%B4%ED%94%84%EC%B9%B4-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC-%EB%B0%8F-%EC%9E%AC%EC%8B%9C%EB%8F%84-%EB%A7%A4%EC%BB%A4%EB%8B%88%EC%A6%98\" aria-label=\"step 32 스프링 카프카 예외 처리 및 재시도 매커니즘 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.2 스프링 카프카 예외 처리 및 재시도 매커니즘</h2>\n<p>카프카와 같은 메시지브로커에는 데드레터 큐<sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup>라는 개념이 존재한다.</p>\n<p>이는 올바르게 처리되지 못한 메시지를 저장하기 위한 큐라고 볼 수 있다.</p>\n<p>즉, 올바르게 처리되지 못한 메시지를 데드레터라고 볼 수 있다.</p>\n<p>이를 테면, 우리 서비스에는 원래 적용되지 않았던 가용 재고보다 많은 재고의 요청 메시지가 제공된다면 이는 익셉션을 발생시킬 것이다. 이를 단순하게 커밋을 처리할 수 있지만, 이를 바로 커밋하기 보다는 데드레터 큐에 발급해서 로그를 남기는 용도로도 활용할 수 있을 것이다.</p>\n<p>또한, 네트워크 순단이나 기타 등의 문제로 올바른 메시지여도 처리를 못하는 케이스들이 존재할 것이다.</p>\n<p>이를 위해서 백오프를 둬서 재시도를 처리해야하고, 이때 처리가 안된다면 데드레터 큐로 옮기는 것이 올바를 것이다.</p>\n<p>정리를 하자면 아래와 같을 것이다.</p>\n<ol>\n<li>카프카에서 재고 차감 요청 발급</li>\n<li>네트워크 순단 혹은 잘못된 요청이 들어온 경우 익셉션이 발생</li>\n<li>백오프 처리</li>\n<li>백오프 처리까지 못한 경우 데드레터 큐에 발급</li>\n</ol>\n<p>참고로, <a href=\"https://daddyprogrammer.org/post/15087/kafka-consumer-retry-deadletter/\">Kafka Consumer retry 및 deadletter 처리 방법</a>와 같은 좋은 아티클이 존재하였지만, 스프링 카프카 버전이 올라감에 따라 <code class=\"language-text\">retryTemplate</code> 과 <code class=\"language-text\">recoveryRollback</code> 등의 기능들이 <em>deprecated</em> 되었다.</p>\n<p>이 예제의 버전 기준은 <code class=\"language-text\">spring-kafka 2.8.5</code> 라고 말씀드릴 수 있다.</p>\n<p>먼저, <code class=\"language-text\">KafkaListener</code>에 사용할 <code class=\"language-text\">ContainerFactory</code>의 설정이 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 중략 <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KafkaListenerContainerFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ConcurrentMessageListenerContainer</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">kafkaListenerContainerFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ConcurrentKafkaListenerContainerFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcurrentKafkaListenerContainerFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        factory<span class=\"token punctuation\">.</span><span class=\"token function\">setConsumerFactory</span><span class=\"token punctuation\">(</span><span class=\"token function\">consumerFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        factory<span class=\"token punctuation\">.</span><span class=\"token function\">setCommonErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token function\">kafkaListenerErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        factory<span class=\"token punctuation\">.</span><span class=\"token function\">getContainerProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAckMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AckMode</span><span class=\"token punctuation\">.</span>MANUAL_IMMEDIATE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> factory<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CommonErrorHandler</span> <span class=\"token function\">kafkaListenerErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">DefaultErrorHandler</span> defaultErrorHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultErrorHandler</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">DeadLetterPublishingRecoverer</span><span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">,</span> DEAD_TOPIC_DESTINATION_RESOLVER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">FixedBackOff</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        defaultErrorHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setCommitRecovered</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        defaultErrorHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setAckAfterHandle</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        defaultErrorHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setResetStateOnRecoveryFailure</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> defaultErrorHandler<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ConsumerFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">consumerFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultKafkaConsumerFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">buildConsumerProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 중략 <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이 설정 부분에서 컨테이너 팩토리에 <code class=\"language-text\">CommonErrorHandler</code>와 <code class=\"language-text\">ConsumerFactory</code>를 주입해준 것을 볼 수 있다. 또한, <code class=\"language-text\">AckMode.MANUAL_IMMEDIATE</code>로 두었는데 이는 <a href=\"https://docs.spring.io/spring-kafka/reference/html/#committing-offsets\">committing-offsets</a> 부분에 자세히 나와있다.</p>\n<p>각 옵션의 값은 아래와 같다.</p>\n<ul>\n<li>Spring Kafka 수동 커밋 옵션 설명</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>구분</th>\n<th>내용</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>RECORD</td>\n<td>리스너가 오프셋 처리 후 반환 시 커밋</td>\n</tr>\n<tr>\n<td>BATCH</td>\n<td>poll()에 의해 반환된 모든 레코드가 처리되면 오프셋을 커밋 (enable.auto.commit = false 시 기본 값)</td>\n</tr>\n<tr>\n<td>TIME</td>\n<td>poll()에 의해 반환된 모든 레코드가 처리되고, 마지막 커밋 이후의 ackTime이 초과되면 오프셋을 커밋</td>\n</tr>\n<tr>\n<td>COUNT</td>\n<td>poll()에 의해 반환된 모든 레코드가 처리되고, 마지막 커밋 이후의 ackCount 레코드를 받으면 오프셋을 커밋</td>\n</tr>\n<tr>\n<td>COUNT_TIME</td>\n<td>TIME 및 COUNT와 유사하지만 두 조건 중 하나가 true인 경우 커밋</td>\n</tr>\n<tr>\n<td>MANUAL</td>\n<td>메시지 리스너에서 acknowledge()로 처리됨을 알리며, 그 후 BATCH와 동일한 의미가 적용. (poll() 처리 이후에 커밋이 된다.)</td>\n</tr>\n<tr>\n<td>MANUAL_IMMEDIATE</td>\n<td>리스너에서 Acknowledgement.acknowledge() 메서드를 호출하면 즉시 오프셋을 커밋. (poll()의 모든 레코드가 아니라 단일 레코드 커밋)</td>\n</tr>\n</tbody>\n</table>\n<p>따라서, 메시지가 요청이 들어올 때마다 <code class=\"language-text\">Acknowledgement.acknowledge()</code> 을 호출해서 직접 커밋을 수행한다.  <code class=\"language-text\">ConsumerFactory</code>는 빌드 설정값을 받아서 컨슈머 팩토리를 만드는 부분이다.</p>\n<p>예외 처리의 핵심은 <code class=\"language-text\">factory.setCommonErrorHandler(kafkaListenerErrorHandler());</code> 부분이다.</p>\n<p>이 메서드만 따로 때서 다시 봐보자.</p>\n<ul>\n<li>kafkaListenerErrorHandler()</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CommonErrorHandler</span> <span class=\"token function\">kafkaListenerErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">DefaultErrorHandler</span> defaultErrorHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultErrorHandler</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">DeadLetterPublishingRecoverer</span><span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">,</span> DEAD_TOPIC_DESTINATION_RESOLVER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">FixedBackOff</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        defaultErrorHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setCommitRecovered</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        defaultErrorHandler<span class=\"token punctuation\">.</span><span class=\"token function\">setResetStateOnRecoveryFailure</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> defaultErrorHandler<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 <code class=\"language-text\">DefaultErrorHandler</code>를 만들 때, <code class=\"language-text\">DeadLetterPublishingRecoverer</code>와 <code class=\"language-text\">FixedBackOff</code>를 설정하는 것을 볼 수 있다.</p>\n<p>이 코드가 위에서 말한 예외처리의 핵심 코드이다.</p>\n<p><code class=\"language-text\">DeadLetterPublishingRecoverer</code>는 <code class=\"language-text\">KafkaTemplate</code>과 <code class=\"language-text\">BiFunction</code> 을 주입받을 수 있다.\n위에서 나온 코드의 <code class=\"language-text\">DEAD_TOPIC_DESTINATION_RESOLVER</code>는 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">BiFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ConsumerRecord</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TopicPartition</span><span class=\"token punctuation\">></span></span>\n        DEAD_TOPIC_DESTINATION_RESOLVER <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>cr<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[Send to dead letter topic]: {} - [Exception message] : {}\"</span> <span class=\"token punctuation\">,</span> cr<span class=\"token punctuation\">.</span><span class=\"token function\">topic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TopicPartition</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dlt-\"</span> <span class=\"token operator\">+</span> cr<span class=\"token punctuation\">.</span><span class=\"token function\">topic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cr<span class=\"token punctuation\">.</span><span class=\"token function\">partition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">DeadLetterPublishingRecoverer</code>뒤에 인자가 없을 경우에는 기본 값으로 설정되서 아래의 값으로 세팅된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">BiFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ConsumerRecord</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TopicPartition</span><span class=\"token punctuation\">></span></span>\n\t\tDEFAULT_DESTINATION_RESOLVER <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>cr<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TopicPartition</span><span class=\"token punctuation\">(</span>cr<span class=\"token punctuation\">.</span><span class=\"token function\">topic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\".DLT\"</span><span class=\"token punctuation\">,</span> cr<span class=\"token punctuation\">.</span><span class=\"token function\">partition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>나는 여기서 로깅과 데드레터큐의 토픽네임을 변경하기 위해 커스텀했다고 보면 될 것 같다.\nDeadLetterPublishingRecoverer는 말 그대로 데드레터를 발급하는 리커버러(복구자)라고 볼 수 있을 것 같다.</p>\n<p>아마 스프링 카프카 도메인에서 <code class=\"language-text\">Recoverer</code>는 메시지를 처리하는 중에 어떠한 문제가 발생했을 때 복구하는 용도로 사용되는 것 같다.</p>\n<p>그리고 백오프를 볼 차례인데 <code class=\"language-text\">new FixedBackOff(1000, 3)</code> 와 같이 두었는데 <code class=\"language-text\">FixedBackOff</code>는 말 그대로 고정값 백오프를 처리하는 객체이다. 나는 1초마다 최대 3번의 재시도를 하게끔 두었다.</p>\n<p>백오프 중에서는 지수 백오프(Exponential Backoff)<sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup>도 많이 사용하니 참고해보자.</p>\n<p>스프링 카프카에서는 지수 백오프를 <a href=\"https://docs.spring.io/spring-kafka/docs/current/api/org/springframework/kafka/support/ExponentialBackOffWithMaxRetries.html\">ExponentialBackOffWithMaxRetries</a> 객체를 활용하여 구현할 수 있다.</p>\n<p>그 후에 에러 핸들러의 옵션들에 대해서는 다음과 같다.</p>\n<ol>\n<li>defaultErrorHandler.setCommitRecovered(true)\n<ul>\n<li>리커버리가 되면 오프셋 커밋 처리</li>\n</ul>\n</li>\n<li>defaultErrorHandler.setResetStateOnRecoveryFailure(false)\n<ul>\n<li>복구 실패한 메시지에 대해서 다음 시도에 재시도할 건지?\n<ul>\n<li>(서비스 재부팅이 잦은 개발환경에서는 끄는게 마음이 편한듯)</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<p>자세한 코드는 <a href=\"https://github.com/brewagebear/blog-example/tree/main/tcc-pattern-example\">BrewageBear - tcc-pattern-example</a>을 확인해보고 실행을 해보자.</p>\n<p>먼저, 해당 프로젝트 폴더로 진입 후에 <code class=\"language-text\">cd infrastructure &amp;&amp; docker-compose up -d</code> 명령어를 치자\n그렇다면, 아래와 같이 제대로 카프카 클러스터가 뜨는 것을 확인할 수 있다.</p>\n<p>다음에는 <code class=\"language-text\">order-service</code> 와 <code class=\"language-text\">stock-service</code>를 실행한다.\n<code class=\"language-text\">stock-service</code>는 카프카 클러스터가 안뜬 상황이면 계속해서 에러로그를 내뿜을 것이다.</p>\n<p>그 이후에는 이제 <code class=\"language-text\">sample</code> 폴더로 들어가서 요청을 직접 수행해보자.\n실제 확정 처리는 아래와 같이 요청 값에 따라서 id를 주어서 처리할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">PUT http://localhost:8888/api/v1/stocks/{재고 확정 요청 id}\nContent-Type: application/json</code></pre></div>\n<ul>\n<li>정상적인 요청</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">POST http://localhost:8887/api/v1/orders\nContent-Type: application/json\n\n{\n  &quot;orderId&quot;: &quot;1&quot;,\n  &quot;productId&quot;: &quot;2&quot;,\n  &quot;qty&quot;: 1,\n  &quot;paymentAmt&quot;: 1\n}</code></pre></div>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 12.222222222222221%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAfklEQVQI1z3NSw6CMABFUfYjVNDE0o+NCRKEgUARagjufxnXUBMHZ/IG9yWFdJSmxtgGZepIqor8dEXklkOmyI6aVKi49WPATyv98GYYf559oO08j3YgcbcObRukusdYqWsuZRXtgT0ockMqNMXZ4V8rc9hYwod52f6meBL4AukDR2wJsx+RAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"valid stock confirm\" title=\"valid stock confirm\" src=\"/static/69b62d1e949043e9c670df3c7af8a6f3/37523/valid-stock-confirm.png\" srcset=\"/static/69b62d1e949043e9c670df3c7af8a6f3/e9ff0/valid-stock-confirm.png 180w,\n/static/69b62d1e949043e9c670df3c7af8a6f3/f21e7/valid-stock-confirm.png 360w,\n/static/69b62d1e949043e9c670df3c7af8a6f3/37523/valid-stock-confirm.png 720w,\n/static/69b62d1e949043e9c670df3c7af8a6f3/302a4/valid-stock-confirm.png 1080w,\n/static/69b62d1e949043e9c670df3c7af8a6f3/07a9c/valid-stock-confirm.png 1440w,\n/static/69b62d1e949043e9c670df3c7af8a6f3/742d3/valid-stock-confirm.png 2550w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 6. 재고 차감 확정이 정상적으로 처리 된 경우 - 카프카</em>\n</p>\n<p>위의 그림과 같이 <code class=\"language-text\">dlt-stock-adjustment</code> 토픽에는 메시지가 생성이 안됐고, 오프셋 커밋이 정상적으로 처리됨을 볼 수 있다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxUlEQVQoz31RC2+bMBjk//+vVeqSpekaSmIeJoBJSA0GQga2SW6ySSpWVbN0+h7+fL6zHZZ4cF+f4HsrvK6esFn/wNZ9xu+XqVfzADUn36IsfPCjj1Pu2/wsIjh5FmO9crFcEPxaRnDfQmzfAywXHtYvMQ4sgSgpKh5/AUUYRAh8Cs9NQaMENQ/hXM4f2O8jBMEWuCkAV4yjBGN7G8dRQSsFrf+FUhKcF2iaCloP0FqiFTGcWhwRxxRBEEBKCa01hqFHmiYYhmEiUF9wJyw5R1lyO2fqtorhNOIIGkUgZAcpJwJDmCR7yDuhGZ7D9OTQo20b1KLC0PdQakBbUTh1dQCl5i18OzxqbYmMwscF3ykc7oRClHfCu8K2LhBTCt8nM0Jjef9fQrNn7Aqj8GHZvqFRGEXwCfm0+LD8uNkcnsP0+v6PtVtVpc2VnFmO49h+zPU6WigpkecZbtcrpnWbxSk3c5dLh7oWVsCo1aRQlDnCMIC72eB0OtlfNoSEEGRZ9ok0TcEYs8gZs7W1XFXous46swo/igje5ife357huQtc2hxdk4MXIQ7ZDke2Q5H7OGRbFDmx9ZFNsakStCJF1zCLs6D4CxlxPxfPXYTSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"valid stock db\" title=\"valid stock db\" src=\"/static/7754543e16766f149765f51b37c4149f/37523/valid-stock-db.png\" srcset=\"/static/7754543e16766f149765f51b37c4149f/e9ff0/valid-stock-db.png 180w,\n/static/7754543e16766f149765f51b37c4149f/f21e7/valid-stock-db.png 360w,\n/static/7754543e16766f149765f51b37c4149f/37523/valid-stock-db.png 720w,\n/static/7754543e16766f149765f51b37c4149f/302a4/valid-stock-db.png 1080w,\n/static/7754543e16766f149765f51b37c4149f/62a6a/valid-stock-db.png 1122w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 7. 재고 차감 확정이 정상적으로 처리 된 경우 - 데이터베이스</em>\n</p>\n<p>또한, DB에도 정상적으로 재고 처리되었음을 확인할 수 있다.</p>\n<ul>\n<li>비정상적인 요청</li>\n</ul>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 15.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAsUlEQVQI1z2O3VKCUBhFeZySTEERYjAEc5LgcA4if1qavv87rIbPmS7WrH23tuX6MZ6fsvA2uMsYZ/HOdBYyeQl4mqwEexqgTEtVD2jTYape/JXX7LOKfWb4zIxsa5MWbHeaZKtIP0rxOs5YrhKJjDHPT2i6H87fd4bTL6fzjX640vUXqkNPqRsJaNNivYU7efY6j5i7a2ZOJDzb/v/D8W2hGkrdosqHHzQU6khe1OKRP3i0bC/9egw9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"invalid stock confirm\" title=\"invalid stock confirm\" src=\"/static/2f962187bbfa0aa88f3cc448e435a5da/37523/invalid-stock-confirm.png\" srcset=\"/static/2f962187bbfa0aa88f3cc448e435a5da/e9ff0/invalid-stock-confirm.png 180w,\n/static/2f962187bbfa0aa88f3cc448e435a5da/f21e7/invalid-stock-confirm.png 360w,\n/static/2f962187bbfa0aa88f3cc448e435a5da/37523/invalid-stock-confirm.png 720w,\n/static/2f962187bbfa0aa88f3cc448e435a5da/302a4/invalid-stock-confirm.png 1080w,\n/static/2f962187bbfa0aa88f3cc448e435a5da/07a9c/invalid-stock-confirm.png 1440w,\n/static/2f962187bbfa0aa88f3cc448e435a5da/97808/invalid-stock-confirm.png 3022w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em>그림 8. 재고 차감 확정이 비정상적으로 처리 된 경우 - 데드레터 발급</em>\n</p>\n<p>위의 그림과 같이 <code class=\"language-text\">dlt-stock-adjustment</code> 토픽에 비정상적인 메시지가 생성됐고, 오프셋 커밋이 정상적으로 처리됨을 볼 수 있다.</p>\n<p>이때, 비정상적인 요청은 오프셋을 커밋을 하는 이유는 데드레터 큐에 이미 발급을 했기 때문에 커밋처리를 한다.</p>\n<p>자세한 매커니즘은 <code class=\"language-text\">SeekUtils.seekOrRecover()</code>의 내부 메서드의 흐름을 파악해보면 알 수 있을 것이다.\n이로써 간단하게 카프카 사용 시에 위와 같은 에러 처리 시에 데드레터로 처리하는 방법을 알아 보았다.</p>\n<h1 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h1>\n<p>동시성 문제의 발생원인부터 어떻게하면 이를 처리할 수 있는지에 대한 각각의 매커니즘과 분산 트랜잭션까지 알아보았다.</p>\n<p>그리고 분산 트랜잭션에서 카프카를 사용할 때 서비스레이어 단에서 익셉션이 발생한 경우에 데드레터까지 처리하는 방법을 알아보았다.</p>\n<p>추가로 이 예제를 좀 더 발전 시켜서 배치를 붙여볼까 생각중이다.</p>\n<p>포스팅이 언제가 될지 모르기 때문에 위와 관련된 내용이 궁금하신 분들은 아래의 아티클을 추천한다.</p>\n<p><a href=\"https://blog.devgenius.io/exceptions-and-retry-policy-in-kafka-6f0d3cf2c330\">Exceptions and Retry Policy in Kafka</a> 카프카 어플리케이션에서 발생할 수 있는 에러들의 정의와 데드레터 등 다양한 내용을 담고 있다.</p>\n<p>이 중에서 내가 다음에 배치를 붙여서 작업할 내용은</p>\n<p align=\"center\">\n    <img src=\"https://miro.medium.com/max/1400/1*CJTVh1_CQuR-r4_7RUHhtQ.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://blog.devgenius.io/exceptions-and-retry-policy-in-kafka-6f0d3cf2c330\">Exceptions and Retry Policy in Kafka, Victor Alekseev, 2021</a></em>\n</p>\n<p>위의 그림 중에 딜레이가 발생한 메시지나 실패한 메시지를 배치 처리를 통해서 재시도하는 처리를 해보려고 한다.</p>\n<p>긴 글 읽어주셔서 감사합니다.</p>\n<h1 id=\"레퍼런스\" style=\"position:relative;\"><a href=\"#%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4\" aria-label=\"레퍼런스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>레퍼런스</h1>\n<ol>\n<li><a href=\"http://jaynewho.com/post/44\">동시성 문제 - 비즈니스 애플리케이션 (Part 3)</a></li>\n<li><a href=\"https://servicecomb.apache.org/docs/distributed_saga_3/\">Eventual Data Consistency Solution in ServiceComb - part 3</a></li>\n<li><a href=\"https://daddyprogrammer.org/post/15087/kafka-consumer-retry-deadletter/\">Kafka Consumer retry 및 deadletter 처리 방법</a></li>\n<li><a href=\"https://blog.devgenius.io/exceptions-and-retry-policy-in-kafka-6f0d3cf2c330\">Exceptions and Retry Policy in Kafka</a></li>\n</ol>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\"><a href=\"https://en.wikipedia.org/wiki/Distributed_transaction\">Distributed transaction</a><a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-2\"><a href=\"https://en.wikipedia.org/wiki/Microservices\">Microservices</a><a href=\"#fnref-2\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-3\"><a href=\"https://en.wikipedia.org/wiki/Concurrency_control\">Concurrency Control</a><a href=\"#fnref-3\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-4\"><a href=\"https://en.wikipedia.org/wiki/Optimistic_concurrency_control\">Optimistic Concurrency Control</a><a href=\"#fnref-4\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-5\"><a href=\"https://en.wikipedia.org/wiki/Lock_(computer_science)\">Database locks - Pessimistic locking</a><a href=\"#fnref-5\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-6\"><a href=\"https://en.wikipedia.org/wiki/Multiversion_concurrency_control\">Multiversion Concurrency Control</a><a href=\"#fnref-6\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-7\"><a href=\"https://en.wikipedia.org/wiki/Eventual_consistency\">Eventual Consistency</a><a href=\"#fnref-7\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-8\"><a href=\"https://en.wikipedia.org/wiki/Dead_letter_queue\">Dead Letter Queue</a><a href=\"#fnref-8\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-9\"><a href=\"https://en.wikipedia.org/wiki/Exponential_backoff\">Exponential Backoff</a><a href=\"#fnref-9\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","frontmatter":{"date":"June 11, 2022","title":"동시성 문제 해결 전략 - 스프링으로 구현한 TCC패턴","categories":"개발 인프라","author":"개발한입","emoji":"💻"},"fields":{"slug":"/concurrency-distributed-transaction-with-tcc/"}},"prev":{"id":"e998a957-d71c-5e82-94b1-2e6d9da2e186","html":"<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 128.33333333333331%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAaABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAEDBQIE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdaziiPehWfOgAP/xAAbEAACAwADAAAAAAAAAAAAAAABAwIREgAgIf/aAAgBAQABBQLdSDI1zJvVsHgayUwhVHp//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAHhAAAQMEAwAAAAAAAAAAAAAAAQACERASMUEgIeH/2gAIAQEABj8C9XZihygwOmd0DQxwuV2NY4//xAAeEAEAAgEEAwAAAAAAAAAAAAABABExIUFRYRBxkf/aAAgBAQABPyFuYzvKNAuFg2WTWro9kCoELVIKC17ZY8+5rXqMwMMqPyEo48//2gAMAwEAAgADAAAAEF/FDP/EABURAQEAAAAAAAAAAAAAAAAAACAx/9oACAEDAQE/EKP/xAAVEQEBAAAAAAAAAAAAAAAAAAABIP/aAAgBAgEBPxBQj//EAB4QAQACAgMAAwAAAAAAAAAAAAEAESExQVFxEJGh/9oACAEBAAE/ENZwRhMD1BDy4GGACCJYnMTebKVg+yXeoD0mxK/e2Oi09GFVdwNJaoccYYK5NNwA34t9gAxAGwC7Q38AGgJ//9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"book\" title=\"book\" src=\"/static/f4f6fe8b15134e4dd75cbe77ae3aeaa3/80e3c/book.jpg\" srcset=\"/static/f4f6fe8b15134e4dd75cbe77ae3aeaa3/4ec73/book.jpg 180w,\n/static/f4f6fe8b15134e4dd75cbe77ae3aeaa3/158ba/book.jpg 360w,\n/static/f4f6fe8b15134e4dd75cbe77ae3aeaa3/80e3c/book.jpg 720w,\n/static/f4f6fe8b15134e4dd75cbe77ae3aeaa3/b701e/book.jpg 934w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p>벌써, 1년 6개월 정도 진행 중인 스터디가 있다. 간단하게 삼색볼펜법<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>을 통해서 완독을 하는 스터디이다.\n읽은 책의 목록은 아래와 같다.</p>\n<ol>\n<li><a href=\"http://www.yes24.com/Product/Goods/74219491\">오브젝트</a></li>\n<li><a href=\"http://www.yes24.com/Product/Goods/77283734\">클린아키텍처</a></li>\n<li><a href=\"http://www.yes24.com/Product/Goods/4667932\">대규모 서비스를 지탱하는 기술</a></li>\n<li><a href=\"http://www.yes24.com/Product/Goods/104491433\">소프트웨어 아키텍처 101</a></li>\n<li><a href=\"http://www.yes24.com/Product/Goods/59566585\">데이터 중심 어플리케이션 설계</a></li>\n<li><a href=\"http://www.yes24.com/Product/Goods/11681152\">클린코드</a></li>\n<li><a href=\"http://www.yes24.com/Product/Goods/65551284\">이펙티브 자바</a></li>\n</ol>\n<p>다른 도메인의 현직 개발자분들과 같은 책을 읽으면서 서로 궁금한 부분이나 토론을 통해서 진행하면서 많은 인사이트를 얻게된 스터디라고 생각이 든다.</p>\n<p>현재 우리가 읽고 있는 책은 <a href=\"http://www.yes24.com/Product/Goods/99423020\">이벤트 기반 마이크로서비스 구축</a>이라는 책이다.\n이직 한 후에 재직 중인 회사의 서비스가 매우 비슷한 아키텍처로 되어있고, 흥미롭게 볼 수 있었다.</p>\n<p>그런데 읽다보니 스트리밍 시스템 <sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup> 이라는 내용이 자주나오는 것을 확인하였다.\n이 부분에 대해서 다른 스터디원 한분이 아래와 같은 질문을 하였다.</p>\n<blockquote>\n<p>배치 프로세싱과 스트리밍 프로세싱은 정확히 어떤 부분이 다른걸까요?</p>\n</blockquote>\n<p>사실 이 부분은 어렴풋한 차이만 말을 할 수 있었고, 이 부분에 대해서 정확하게 나 또한 말을 할 수 없었다.\n더 나아가 스트리밍 시스템과 기존 어플리케이션, 백엔드 서비스와의 차이도 알고 싶었고 이벤트 주도 아키텍처(Event-Driven Architecture) <sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup> 와 스트리밍 시스템도 차이를 가지는가에 대해서 궁금하였다.</p>\n<p>이번 포스팅은 위에 대한 궁금증을 해소하고, 간단한 스트리밍 시스템의 예시를 들어보고자 한다.</p>\n<h1 id=\"스트리밍-시스템-톺아보기\" style=\"position:relative;\"><a href=\"#%EC%8A%A4%ED%8A%B8%EB%A6%AC%EB%B0%8D-%EC%8B%9C%EC%8A%A4%ED%85%9C-%ED%86%BA%EC%95%84%EB%B3%B4%EA%B8%B0\" aria-label=\"스트리밍 시스템 톺아보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>스트리밍 시스템 톺아보기</h1>\n<ul>\n<li>STEP 1. 분산 시스템(Distribution System)의 대두\n<ul>\n<li>STEP 1.1 이벤트 주도 아키텍처(Event-Driven Architecture)란?\n<ul>\n<li>STEP 1.1.1 메시지와 이벤트</li>\n<li>STEP 1.1.2 정리</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>STEP 2. 스트리밍 시스템(Streaming System)이란?\n<ul>\n<li>STEP 2.1 Bounded Data vs Unbounded Data</li>\n<li>STEP 2.2 Stream Processing</li>\n<li>STEP 2.3 스트리밍 시스템 vs 전통적인 아키텍처\n<ul>\n<li>STEP 2.3.1 어플리케이션(Application)</li>\n<li>STEP 2.3.2 백엔드 서비스(Back-End Service)</li>\n<li>STEP 2.3.3 배치 프로세싱(Batch Processing)</li>\n</ul>\n</li>\n<li>STEP 2.4 정리</li>\n</ul>\n</li>\n<li>STEP 3. 간단한 스트리밍 시스템</li>\n<li>STEP 4. REFERENCE</li>\n</ul>\n<h2 id=\"step-1-분산-시스템distribution-system의-대두\" style=\"position:relative;\"><a href=\"#step-1-%EB%B6%84%EC%82%B0-%EC%8B%9C%EC%8A%A4%ED%85%9Cdistribution-system%EC%9D%98-%EB%8C%80%EB%91%90\" aria-label=\"step 1 분산 시스템distribution system의 대두 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. 분산 시스템(Distribution System)의 대두</h2>\n<p>먼저, 이벤트 주도 아키텍처가 탄생한 배경에 대해서 아는 것이 중요하다고 생각한다.\n이 내용은 <strong>내 개인적인 생각이기때문에 당연히 틀릴 수 있는 부분이라고 생각하니</strong>, 다양한 책들을 통해서 왜 이러한 아키텍처가 대두되어왔는가에 대해서 생각하는 것이 중요하다고 본다.</p>\n<p>먼저, 이전에 작성했던 <a href=\"https://brewagebear.github.io/concurrency-distributed-transaction-with-tcc/\">개발한입 - 동시성 문제 해결 전략 - 스프링으로 구현한 TCC 패턴</a> 글을 보면, 우리는 분산 트랜잭션의 핸들링의 어려움을 겪고 있고, 이에 대해서 SAGA<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup> 패턴이나 TCC패턴, Two-Phase Commit<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup> 등이 나오게 되었다.</p>\n<p>위 포스팅에서 작성하지 않는 부분이 있는데 바로 <strong>왜 분산 시스템으로 가게되었는가?</strong> 이다.</p>\n<p>이 내용은 <a href=\"https://d2.naver.com/helloworld/206816\">Naver D2- 확장성 있는 웹 아키텍처와 분산 시스템</a> 에 매우 잘나와있다. 자세한 내용은 해당 본문을 참고하도록 하고, 여기서는 중요한 부분들만 짚어보도록 하자.</p>\n<blockquote>\n<p>일단, 분산 시스템이 대두된 원인은 단순했던 웹서비스가 <strong>서비스의 사용자 증가 혹은 복잡도가 증대</strong>되면서 신뢰성(Reliability)이나 확장성(Scalability), 가용성(Availability)등을 확보하기위함이라고 볼 수 있다.</p>\n</blockquote>\n<p>즉, 기존의 아키텍처로는 해결이 안되기 때문에 <strong>분산 시스템을 사용하자</strong>라는 개념이 대두된 것이다.\n네이버 D2 글에서는 이미지 호스팅 서비스를 예시를 들어서 이 서비스가 어떻게 진화해나가는 지 잘 서술되어있다.</p>\n<p>우리가 초점으로 볼 부분은 쓰기에 대한 부하를 감당하기 위해서 위 본문에서는 큐를 도입했는데 이 내용을 주로 보고자 한다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/VUffWgC.png\">\n</p>\n<p align=\"center\">\n<em>그림 1. 전통적인 클라이언트-서버의 요청 구조 (동기식 처리)</em>\n</p>\n<p>위는 전통적인 클라이언트-서버 구조의 요청, 응답 구조이며, 아래와 같다.</p>\n<ol>\n<li>클라이언트는 서버에게 요청을 보낸다.</li>\n<li>서버는 해당 요청을 읽은 후 알맞은 응답을 보낸다.</li>\n<li>이는 <strong>동기적(Synchronous)</strong> 으로 처리된다.</li>\n</ol>\n<p>동기적 요청에 대해 이해가 안간다면 <a href=\"https://brewagebear.github.io/fundamental-nio-and-io-models/#step-41-io-%EB%AA%A8%EB%8D%B8\">개발한입 - 자바 NIO의 동작원리 및 IO 모델(STEP 4.1 I/O 모델) </a>을 참고해보자.</p>\n<p>이러한 구조로 가게 되었을 경우에 당연히 서버쪽에 많은 요청이 들어오게 될 경우 병목현상(Bottlenack)<sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup> 이 발생할 수 있으며, 병목현상이 발생할 경우 블록킹이 되기에 응답지연과 같은 문제가 발생하여 클라이언트의 경험이 상당히 저하가될 수 있다.</p>\n<p>이를 해결하기 위해서 비동기적 처리를 할 수 있지만 이는 구현하기 까다롭다는 문제가 있다. 이때 우리는 메시지 브로커(Message-Broker)<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup> 를 활용하여 처리할 수 있다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/r6VbbXt.png\">\n</p>\n<p align=\"center\">\n<em>그림 2. 메시지 브로커를 통한 비동기식 처리</em>\n</p>\n위와 같이 처리함으로써 서버 요청을 부하를 메시지 브로커를 통해서 줄일 수 있으며, 비동기식(Ansychronous) 처리가 가능하므로  클라이언트는 작업요청을 보낸 후 기다리지 않고 다른 작업을 진행하다가 응답을 통해서 처리가 가능하다는 장점이 있다. \n<p>핵심적인 차이는 <strong>동기적 처리가 아닌 비동기적인 처리</strong>를 할 수 있으며, 메시지브로커를 통해서 클라이언트-서버간의 <strong>결합도(Coupling)을 줄일 수 있다는 점</strong>이다.</p>\n<p>갑자기 메시지 브로커 이야기를 하게되었는데 이벤트 주도 아키텍처를 알기 위해서는 위의 핵심 내용이 필요하기 때문이다.</p>\n<p>이제, 이벤트 주도 아키텍처에 대해서 알아보자.</p>\n<h3 id=\"step-11-이벤트-주도-아키텍처event-driven-architecture란\" style=\"position:relative;\"><a href=\"#step-11-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%A3%BC%EB%8F%84-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98event-driven-architecture%EB%9E%80\" aria-label=\"step 11 이벤트 주도 아키텍처event driven architecture란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1 이벤트 주도 아키텍처(Event-Driven Architecture)란?</h3>\n<p>위에서 간단하게 쓰기 부하에 대해서 동기식 처리에 대한 단점이 존재하여, 메시지 브로커를 통해서 비동기식 처리로 변경하는 부분에 대해서 설명하였다.</p>\n<p>이벤트 주도 아키텍처를 설명하기 전에 아래와 같이 가정을 해보자.</p>\n<blockquote>\n<p>우리 서비스는 이제 메시지 브로커 도입을 통해서 비동기식 방식으로 처리가 잘 이루어지고 있었다.</p>\n<p>하지만 서비스가 성장함에 따라 서버 내에 어떤 서비스(Bear Service)에 대한 처리가 느려지는 문제가 대두 되었다.</p>\n</blockquote>\n<p>이에 reply 메시지 브로커에 인입되는 메시지처리 속도가 느려졌고, 이에 사용자 경험은 또다시 떨어지게 되었다. 수많은 토론 끝에 내린 결론은 메시지 처리가 느린 서비스를 독립적인 모듈화를 시켜서 스케일 아웃을 진행하는 것이었다.</p>\n<blockquote>\n</blockquote>\n<p>이 구조로 갈 경우 주요한 이슈는 독립된 모듈 서비스에서 처리한 내용을 다시 원래 서비스에서 받아서 처리를 해서 다시 클라이언트에 가야하는 구조이라는 점이다.</p>\n<p align=\"center\">\n <img src=\"https://i.imgur.com/ha2WARw.png\">\n</p>\n<p align=\"center\">\n<em>그림 3. 복잡해진 아키텍처와 응답 처리 문제</em>\n</p>\n<p>위의 경우에도 서버가 만약 동기식 요청을 해당 서비스에서 던지게 될 경우에는 또 다시 블록킹이 발생할 수 있다.\n아주 단순하게 생각하면 저 부분에도 메시지 브로커를 도입하면 된다.</p>\n<p align=\"center\">\n\t<img src=\"https://i.imgur.com/TQKtavo.png\">\n</p>\n<p align=\"center\">\n<em>그림 4. 메시지 브로커를 통한 복잡한 아키텍처의 문제 해결</em>\n</p>\n<p>이렇게 하면서 얻는 이점은 서버와 분리된 서비스간의 결합도가 낮아지고, 비동기식 처리가 가능하다는 점이다.\n여기까지 봤을 때 눈치를 채었는가?</p>\n<blockquote>\n<p>이벤트 주도 아키텍처는 위와 같이 각 모듈간의 결합도를 낮추고, 비동기 처리를 통해서 해당 요청들을 알맞은 책임에게 던질 수 있는 아키텍처를 말한다.</p>\n</blockquote>\n<h3 id=\"step-111-메시지message와-이벤트event\" style=\"position:relative;\"><a href=\"#step-111-%EB%A9%94%EC%8B%9C%EC%A7%80message%EC%99%80-%EC%9D%B4%EB%B2%A4%ED%8A%B8event\" aria-label=\"step 111 메시지message와 이벤트event permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.1 메시지(Message)와 이벤트(Event)</h3>\n<p>그렇다면? 이벤트 주도 아키텍처의 이벤트(Event)는 무엇을 뜻하는 것일까?\n이벤트는 수 많은 내용을 포함하고 있다. 마우스를 움직이는 것이나 버튼을 클릭하는 것 혹은 요청을 보내는 것 등등.. 컴퓨팅 영역에서는 어떤 input 자체를 이벤트라고 뜻할 수 있다고 본다.</p>\n<p>여기서 또 궁금한 점이 생겼다. 그렇다면 메시지와 이벤트는 무엇이 다른것일까?\n구글링을 하면서 Akka<sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup> 프레임워크의 개발사인 Lightbend<sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup>의 공식 문서에서 이를 다루는 것을 확인하였다.</p>\n<blockquote>\n<p>A Message is some data sent to a specific address. In Message Driven systems, each component has a unique address other components can send messages to. Each of these components, or recipients, awaits messages and reacts to them.</p>\n<p>An Event is some data emitted from a component for anyone listening to consume.</p>\n</blockquote>\n<p>위의 내용을 요약하면 메시지는 택배기사가 택배를 정해진 위치에 배송하는 것과 유사하며, 이벤트는 해당 이벤트에 대한 내용을 구독하고 있는 모든 사용자를 위해 방출되는 데이터라고 볼 수 있다.</p>\n<p>하지만, 대부분의 이벤트 주도 아키텍처를 보면 메시지 브로커든 메시지 큐 등을 사용한 내용을 볼 수 있다.</p>\n<p>사실, 엄밀히 따져서 메시지는 송신 주체와 수신 주체가 명확한 것이고 이벤트는 그것이 명확하지 않은 것이다.\n즉, 이벤트가 더 추상화된 상위개념이고 메시지는 이 이벤트를 담아서 송신과 수신을 처리해주는 녀석이라고 볼 수 있다.</p>\n<p>이해가 안될 수 있으니 아래와 같이 볼 수 있다고 생각한다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/O0RZZ5u.png\">\n</p>\n<p align=\"center\">\n<em>그림 4. 메시지와 이벤트</em>\n</p>\n따라서, 목적지와 수신지를 처리하기 위해서는 메시지가 필요하고, 메시지안에 이벤트가 담기는 형식이라고 생각한다. 자세한 내용은 [LightBend - Events ars messages](https://developer.lightbend.com/docs/akka-guide/concepts/message-driven-event-driven.html#_events_are_messages) 내용을 읽어보도록 하자. 여기서도 메시지 주도 아키텍처는 보다 시스템 구성 요소적인 측면이 강하고, 이벤트 주도 아키텍처가 보다 추상화된 내용이라고 말한다. \n<blockquote>\n<p>즉, 메시지 주도 아키텍처로도 이벤트 주도 아키텍처를 구현할 수 있다.\nSo, using Message Driven tools we can build an Event Driven system.</p>\n</blockquote>\n<p>좀 더 상세한 차이를 이해하고 싶다면 아래의 아티클을 추천한다.</p>\n<ul>\n<li><a href=\"https://medium.com/event-driven-utopia/using-commands-events-and-queries-in-microservices-communication-3573f1fcfafe\">Medium - Using Commands, Events, and Queries in Microservices Communication</a></li>\n</ul>\n<h3 id=\"step-112-이벤트-주도-아키텍처-정리\" style=\"position:relative;\"><a href=\"#step-112-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%A3%BC%EB%8F%84-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98-%EC%A0%95%EB%A6%AC\" aria-label=\"step 112 이벤트 주도 아키텍처 정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1.1.2 이벤트 주도 아키텍처 정리</h3>\n<p>결국 핵심은 발전해가고 복잡해지는 소프트웨어 아키텍처에서 개선점들이 생겨나면서 이러한 아키텍처가 생긴 것이라고 볼 수 있다. 파티셔닝과 샤딩, 프록시, 캐시등을 제외하고 해당 글에서 다룬 내용을 토대로 시스템 발전 과정의 히스토리를 봐보자.</p>\n<ul>\n<li><strong>분산 아키텍처는 왜 대두되었는가?</strong>\n<ul>\n<li>이유 : 기존 모놀리틱 시스템의 문제점들이 점점 발생 (복잡도 증대 및 유지보수의 어려움)</li>\n<li>결론 : 각각의 서비스를 독립적으로 분리시키자 (SOA, MSA 등이 대두)</li>\n</ul>\n</li>\n<li><strong>하지만 동기적인 API 요청의 단점이 존재하였다.</strong>\n<ul>\n<li>이유 : 요청을 서버에서 처리하는 동안 클라이언트는 블록킹이 발생한다.</li>\n<li>결론 : 비동기적인 처리를 하자 -> 구현의 복잡도를 낮추고 결합도를 낮추기 위해 메시지 브로커 등을 도입</li>\n</ul>\n</li>\n</ul>\n<p>따라서 핵심은 이벤트 브로커나 메시지 브로커등에 이벤트를 발생해서 비동기적으로 처리하여 각 서비스간의 결합도를 낮추고, 블록킹을 줄인 시스템이 이벤트 주도 아키텍처라 볼 수 있다.</p>\n<p>위의 내용은 많은 내용이 생략이 되었고, 본문에서 다룬 내용을 다시 재정리한 내용이다.\n따라서 꼭 아래의 글을 읽기를 추천한다.</p>\n<ol>\n<li><a href=\"https://d2.naver.com/helloworld/206816\">Naver D2- 확장성 있는 웹 아키텍처와 분산 시스템</a></li>\n<li><a href=\"https://medium.com/dtevangelist/event-driven-microservice-%EB%9E%80-54b4eaf7cc4a\">Medium - Event Driven Architecture란?</a></li>\n</ol>\n<h2 id=\"step-2-스트리밍-시스템\" style=\"position:relative;\"><a href=\"#step-2-%EC%8A%A4%ED%8A%B8%EB%A6%AC%EB%B0%8D-%EC%8B%9C%EC%8A%A4%ED%85%9C\" aria-label=\"step 2 스트리밍 시스템 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2. 스트리밍 시스템</h2>\n<p>먼저, 스트리밍 시스템을 이해하기 위해서는 유한 데이터(Bounded Data)와 무한 데이터(Unbounded Data)를 알아야한다.</p>\n<p>개인적으로 이 번역은 매우 잘못되어있다고 생각이 드는데 실제 번역서 중에서 Unbounded Data를 무한 데이터로 해놓은 책이 매우 많아서 이해하기가 매우 힘들었다.</p>\n<p>무한 데이터란 무엇인가? 사실 원어인 Unbounded Data를 보았을 때는 무엇인가 Bound가 결정되지 않은 즉, 언제 시작되고 언제 끝날지 모르는 그리고 실시간성 로그 데이터들이라고 볼 수 있다. 하지만, 번역서 중에는 이 내용을 원어가 없이 표기한 책이 많았고 이 때문에 어려움을 많이 겪었다.</p>\n<p>그래서 이 포스팅에서는 유한, 무한데이터보다는 원어 표기인 Bounded Data, Unbouned Data의 표기를 따르도록 하겠다.</p>\n<p>그렇다면? Bounded Data와 Unbounded Data는 무슨 차이일까?</p>\n<h3 id=\"step-21-bounded-data-vs-unbounded-data\" style=\"position:relative;\"><a href=\"#step-21-bounded-data-vs-unbounded-data\" aria-label=\"step 21 bounded data vs unbounded data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1 Bounded Data vs Unbounded Data</h3>\n<p>이 내용은 <a href=\"http://www.yes24.com/Product/Goods/59566585\">멧돼지책(데이터 중심 어플리케이션 설계)</a>에도 나오는 내용이다.</p>\n<blockquote>\n<p>In reality, a lot of data is unbounded because it arrives gradually over time: your users produced data yesterday and today, and they will continue to produce more data tomorrow. Unless you go out of business, this process never ends, and so the dataset is never “complete” in any meaningful way.\n— Martin Kleppmann, Designing Data-Intensive Applications</p>\n</blockquote>\n<p><strong>즉, Unbounded Data는 데이터의 수가 정해져(unbounded)있지않고, 계속 변경될 수 있는 데이터</strong>를 말한다.</p>\n<ul>\n<li>이는 증권 거래 체결 내역이나 인스타그램의 피드 그리고 실시간 데이터 로그등이 속한다고 볼 수 있다.</li>\n</ul>\n<p>그렇다면 <strong>Bounded Data는 무엇일까? 데이터의 수가 정해진 데이터</strong>를 뜻한다.</p>\n<ul>\n<li>주간 정산 데이터, 월간 사용자 수 통계 등</li>\n</ul>\n<p>내가 제일 헷갈린 것이 <strong>Bounded</strong> 개념이였는데 시간을 일정 바운드로 둔다면, 실시간 로그들도 일정 바운드에 갇히게 되는 것 아닌가? 라고 생각하였다. 그렇게 생각하다보니 이해가 어려웠는데 핵심은 <strong>데이터의 수</strong>라고 보면될 것 같다.</p>\n<p>즉, <strong>데이터 수나 변경에 열려있는 것이 Unbounded data 데이터, 닫혀있는 것이 Bounded data라 보면 될 것 같다</strong>.</p>\n<p>그렇다면 위에서 다뤘던 이벤트는 Bounded Data일까? Unbounded Data일까?\n이벤트는 언제 발생할지 모르고 동일한 이벤트여도 이전 이벤트와 동일한 데이터 수를 가진다고 기대할 수 없으므로 <strong>Unbounded Data</strong>에 가깝다고 볼 수 있다.</p>\n<p>자 이제 Unbounded Data와 Bounded Data를 차이를 알았다.\n그렇다면 이제 다시 스트리밍 시스템에 대해 알기 위해서 스트리밍 프로세싱에 대해 알아보자.</p>\n<h3 id=\"step-22-stream-proccesing\" style=\"position:relative;\"><a href=\"#step-22-stream-proccesing\" aria-label=\"step 22 stream proccesing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2 Stream Proccesing</h3>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/MrymtMY.jpg\">\n</p>\n<p align=\"center\">\n<em>그림 5. Grokking Streaming Systems : Real-time event Processing</em>\n</p>\n이 부분부터는 [이벤트 기반 마이크로 서비스 구축](http://www.yes24.com/Product/Goods/99423020)보다는 [Grokking Streaming Systems: Real-time event processing](https://a.co/d/9zb7Tml) 책을 많이 참고하였다.\n<p>이 책에서는 스트리밍 프로세스를 아래와 같이 정의한다.</p>\n<blockquote>\n<p>Stream Proccssing has been one of the most popular technologies in the recent years in the big data domain. Streaming systems are the computer systems that process continuous event streams.\n— Josh Fischer, Grokking Streaming Systtems : Real-time event Processing p.31</p>\n</blockquote>\n<p>즉, 지속적으로 발생하는 이벤트 스트림을 처리하는 작업이 바로 스트리밍 시스템이다.\n그림으로 보면 아래와 같다고 볼 수 있다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/8VcZArn.jpg\">\n</p>\n<p align=\"center\">\n<em>그림 6. 스트리밍 시스템 예시, Grokking Streaming Systems : Real-time event Processing, p.36</em>\n</p>\n이벤트 주도 아키텍처는 이벤트를 통해서 처리되는 아키텍처라고 위에서 설명을 하였다. 그렇다면, 이벤트 주도 아키텍처와 스트리밍 시스템의 차이는 무엇인가? \n<p>틀린 생각일 수도 있지만 개인적으로 <strong>스트리밍 시스템 ⊂ 이벤트 주도 아키텍처</strong>와 같은 부분집합이라고 보면 될 것 같다. 즉, 이벤트 주도 아키텍처 내부에 지속적으로 발생하는 이벤트 스트림을 처리하는 스트리밍 시스템이 속하는 것이라 생각한다.</p>\n<p>이제 얼추 어떤 느낌인지 감이 올 것이라고 판단된다.\n그렇다면 이 포스팅의 목적이였던 <strong>스트리밍 시스템과 기존 시스템의 차이</strong>를 알 시간이 왔다고 생각한다.\n이에, 전통적인 시스템들과 스트리밍 시스템을 비교해보고자 한다.</p>\n<h3 id=\"step-23-스트리밍-시스템-vs-전통적인-아키텍처\" style=\"position:relative;\"><a href=\"#step-23-%EC%8A%A4%ED%8A%B8%EB%A6%AC%EB%B0%8D-%EC%8B%9C%EC%8A%A4%ED%85%9C-vs-%EC%A0%84%ED%86%B5%EC%A0%81%EC%9D%B8-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\" aria-label=\"step 23 스트리밍 시스템 vs 전통적인 아키텍처 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3 스트리밍 시스템 vs 전통적인 아키텍처</h3>\n<h4 id=\"step-231-어플리케이션application\" style=\"position:relative;\"><a href=\"#step-231-%EC%96%B4%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98application\" aria-label=\"step 231 어플리케이션application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3.1 어플리케이션(Application)</h4>\n<p>여기서 말하고자하는 어플리케이션의 정의는 아래와 같다.</p>\n<blockquote>\n<p>An application is a computer program that users intract with directly\n— Josh Fischer, Grokking Streaming Systtems : Real-time event Processing p.38</p>\n</blockquote>\n<p>즉, 게임이 될수도 있고 어떤 GUI 환경의 프로그램도 될 수 있다.\n이 책에서는 어플리케이션의 특징을 아래와 같이 꼽는다.</p>\n<ul>\n<li>어플리케이션은 시작점(Starting point)을 갖는다. (어플리케이션 시작 시)</li>\n<li>어플리케이션은 종료점(Ending point)를 갖는다.(어플리케이션 종료 시)</li>\n<li>그리고 메인 루프(Main loop)을 갖는데 메인 루프는 아래의 세가지 단계로 나눠진다.\n<ol>\n<li>사용자의 입력을 받는다.</li>\n<li>로직을 수행한다.</li>\n<li>결과를 보여준다.</li>\n</ol>\n</li>\n</ul>\n<p>그림으로 보면 아래와 같다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/DWxq6Ts.png\">\n</p>\n<p align=\"center\">\n<em>그림 7. 어플리케이션 구조 예시, Grokking Streaming Systems : Real-time event Processing, p.39</em>\n</p>\n<h4 id=\"step-232-백엔드-서비스backend-services\" style=\"position:relative;\"><a href=\"#step-232-%EB%B0%B1%EC%97%94%EB%93%9C-%EC%84%9C%EB%B9%84%EC%8A%A4backend-services\" aria-label=\"step 232 백엔드 서비스backend services permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3.2 백엔드 서비스(Backend Services)</h4>\n<p>다음으로 볼 아키텍처는 백엔드 서비스이다. 백엔드 서비스에 대해서는 이 책에서는 아래와 같이 정의를 내린다.</p>\n<blockquote>\n<p>A backend service is a computer program that runs behind the scenes.\n— Josh Fischer, Grokking Streaming Systtems : Real-time event Processing p.40</p>\n</blockquote>\n<p>즉, 뒷단에서 작업을 하는 컴퓨터 프로그램이라고 정의를 내리고 있다.\n어플리케이션과 다른 부분은 사용자와 직접적으로 상호작용(interaction)이 이뤄지지 않는다는 점이다.\n대신, 요청에 따라 특정 작업을 수행한다.</p>\n<p>백엔드 서비스는 대부분의 시간을 <strong>요청을 받는 것과 요청을 처리하는 것</strong>에 보낸다.\n이 책에서는 백엔드 서비스의 특징을 아래와 같이 꼽는다.</p>\n<ul>\n<li>백엔드 서비스는 요청을 받는다.</li>\n<li>백엔드 서비스는 요청을 파싱한다.</li>\n<li>파싱된 요청에 따라서 적절한 작업을 수행한다.</li>\n<li>최종적으로 응답의 결과를 보낸다.</li>\n</ul>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/g7MiNPh.png\">\n</p>\n<p align=\"center\">\n<em>그림 8. 전통적인 백엔드 서비스 구조 예시, Grokking Streaming Systems : Real-time event Processing, p.40</em>\n</p>\n<p>위와 같이 서비스는 필요한 작업을 다른 서비스(위의 그림에는 Storage가 된다)에 요청을 보내고 종합하는 식으로도 처리하기도 한다.</p>\n<p>어플리케이션과 동일하게 메인 루프(Main loop)가 존재하지만 요청에 따라 다른 작업을 처리할 필요성이 존재한다. (다양한 요청이 들어올 수 있기때문에) 어플리케이션은 주로 사용자가 단독으로 프로그램을 수행할 가능성이 많지만 백엔드 서비스의 경우에는 많은 사용자들이 요청을 보내고, 또한 요청 자체가 같은 시간에 도착할 수도 있는 동시성 문제가 존재한다.</p>\n<p>이에 대부분의 백엔드 서비스는 멀티 쓰레딩기법을 활용하는 특징을 갖는다. 이를 통해 새로운 요청이 들어오면 쓰레드를 통해서 특정 작업을 통해 수행하도록하여 위와 같은 한계를 극복하였다.</p>\n<p>이렇게 함으로써 메인 루프의 처리량을 쓰레드에 위임하여 보다 빠르게 요청을 응답하게 할 수 있는 것이다.\n따라서, 요즘날의 백엔드 서비스는 아래와 같은 구조를 갖는다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/RD7WLsT.png\">\n</p>\n<p align=\"center\">\n<em>그림 9. 현대의 백엔드 서비스 구조 예시, Grokking Streaming Systems : Real-time event Processing, p.42</em>\n</p>\n<h4 id=\"step-233-배치-프로세싱batch-processing\" style=\"position:relative;\"><a href=\"#step-233-%EB%B0%B0%EC%B9%98-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8B%B1batch-processing\" aria-label=\"step 233 배치 프로세싱batch processing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3.3 배치 프로세싱(Batch Processing)</h4>\n<p>앞에서 본 어플리케이션과 백엔드 서비스는 사용자의 응답 (혹은 요청)에 최대한 빠르게 응답할 수 있게 설계된 아키텍처라고 생각할 수 있다. 그러나, 배치 프로세싱은 어떤 요청을 처리하기 위해 고안된 아키텍처는 아니다.</p>\n<p>배치 프로세스는 <strong>어떤 작업을 스케줄 시간 혹은 리소스가 허용되었을 때 수행하는 아키텍처</strong>이다.\n주로 배치 프로세스는 대용량 데이터를 처리하기 위해서 사용하곤 한다.</p>\n<p>전통적인 배치 프로세싱의 구조는 아래와 같다고 볼 수 있다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/N4LpZmz.png\">\n</p>\n<p align=\"center\">\n<em>그림 10. 배치 프로세싱 구조 예시, Grokking Streaming Systems : Real-time event Processing, p.44</em>\n</p>\n<p>위의 그림처럼 일정 스케줄이든 어떤 트리거를 통해서 배치 프로세싱이 수행된다면 나눠진 단계별로 배치 프로세싱이 수행된다. 그 과정속에서 데이터베이스나 스토리지 시스템을 통해서 각 단계별 내용을 바로 반영을 하고 다음 단계에서는 이전의 결과가 담겨있는 스토리지 데이터를 참고로 계속해서 작업을 수행한다.</p>\n<p>배치 프로세싱은 모든 단계가 완료되면 끝난다.\n보면 알겠지만 이 배치 프로세싱의 최대의 단점은 **지연시간(latencty)**이다.</p>\n<p>이것을 풀어쓰자면 배치 프로세싱은 시작하기 전에 매시간 또는 매일과 같이 일정한 간격으로 데이터를 수집하고 배치로 저장해야하고, 특정 시간대에 수집된 모든 이벤트는 처리할 기간이 끝날 때까지 기다려야 한다는 점이다.</p>\n<p>문제는 <strong>이 단점을 수용할 수 없는 케이스들이 존재한다는 점</strong>이다.\ne.g) 서버 실시간 모니터링 시스템, 장애 알림 솔루션 등..</p>\n<p>이러한 사용사례(use-case)들의 특징은 데이터가 받자마자 즉각적으로 처리되는 것을 요구사항으로 갖는다는 점이다. 즉, 실시간이든 준실시간이든 최대한 실시간으로 처리되길 희망하는 사용사례들이다.</p>\n<p>위의 한계를 극복하기 위해서 탄생한 것이 바로 <strong>스트리밍 시스템</strong>이다.</p>\n<h3 id=\"step-24-정리\" style=\"position:relative;\"><a href=\"#step-24-%EC%A0%95%EB%A6%AC\" aria-label=\"step 24 정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.4 정리</h3>\n<p>배치 프로세싱과 스트리밍 시스템의 차이를 예시를 들면 아래와 같다.</p>\n<ul>\n<li>배치 프로세싱 : 우체국</li>\n<li>스트리밍 시스템 : 공장의 조립 라인</li>\n</ul>\n<p>배치 프로세싱은 우체국과 같이 많은 우편들을 수집한 뒤에 분류 혹은 적절한 사업소에 배치 작업을 한 뒤에 최종 배달지에서는 정해진 배달 시간에 따라서 전송을 한다.</p>\n<p>스트리밍 시스템은 공장의 조립 라인과 같이 여러 단계를 거쳐 단계 마다 새로운 부품을 조립하여 최종 제품을 생산해낸다.</p>\n<p>전통적인 스트리밍 시스템의 구조는 아래의 그림과 같다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/CewfQLq.png\">\n</p>\n<p align=\"center\">\n<em>그림 11. 전통적인 스트리밍 시스템 구조 예시, Grokking Streaming Systems : Real-time event Processing, p.48</em>\n</p>\n거의 배치 프로세싱의 구조와 흡사한 것으로 볼 수 있다.\n가장 큰 차이는 각 단계는 새로운 데이터가 들어오면 다음 단계로 처리하는 작업을 계속해서 수행하며, 각 이벤트들은 다음 단계로 처리가 되자마자 전달되어 모든 단계가 끝난 후에 최종 결과가 스토리지 시스템에 적재됨을 볼 수 있다.\n<p>비슷한 구조지만 가장 큰 차이점은 아래와 같다.</p>\n<ol>\n<li>배치 프로세싱\n<ul>\n<li>각 단계가 독립적으로 수행되며, 같은 단계여도 서로 독립적으로 수행된다.\n<ul>\n<li>즉, 같은 시간에 모든 단계가 동작하지 않는다.(1번 단계 수행 후 스토리지 저장이 끝난 후 2번 단계가 수행된다. 이는 수행 윈도우를 증가하게 된다.)</li>\n</ul>\n</li>\n<li>장점으로는 각 단계가 독립적으로 수행되므로 페일오버처리하기가 쉽다.</li>\n</ul>\n</li>\n<li>스트리밍 시스템\n<ul>\n<li>각 단계가 거의 같은 시간에 동작한다. (즉각적으로 전단계에서 발생한 일을 처리하므로)\n<ul>\n<li>따라서, 이벤트가 처리되면 준실시간으로 처리될 수 있다.</li>\n</ul>\n</li>\n<li>단계는 Steaming처럼 Upstream에서 Downstream으로 흐르고, 독립적이지 않기에 페일오버 처리하기가 복잡하다. 따라서, 배치 프로세싱과 달리 실패 시에 별도의 처리가 없다면 핸들링이 어렵다.</li>\n</ul>\n</li>\n</ol>\n<p>위의 내용을 표로 정리하면 아래와 같다.</p>\n<table>\n<thead>\n<tr>\n<th>어플리케이션</th>\n<th>백엔드서비스</th>\n<th>배치 프로세싱</th>\n<th>스트리밍 시스템</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>사용자 인풋에 따라 처리</td>\n<td>요청을 처리</td>\n<td>데이터를 처리</td>\n<td>데이터를 처리</td>\n</tr>\n<tr>\n<td>사용자와 즉각적인 상호작용</td>\n<td>사용자 혹은 다른 서비스와 상호작용</td>\n<td>스케줄 시간 혹은 데이터에 따른 상호작용</td>\n<td>데이터에 따른 상호작용</td>\n</tr>\n<tr>\n<td>사용자에 의한 시작과 끝남</td>\n<td>긴 동작을 하는 프로세스들의 집합</td>\n<td>스케줄 시간에 따른 시작과 끝남</td>\n<td>긴 동작을 하는 단계들의 집합</td>\n</tr>\n<tr>\n<td>싱글 메인 루프</td>\n<td>싱글 메인 루프와 쓰레드들</td>\n<td>여러 단계의 프로세스들</td>\n<td>여러 단계의 프로세스들</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"step-3-간단한-스트리밍-시스템\" style=\"position:relative;\"><a href=\"#step-3-%EA%B0%84%EB%8B%A8%ED%95%9C-%EC%8A%A4%ED%8A%B8%EB%A6%AC%EB%B0%8D-%EC%8B%9C%EC%8A%A4%ED%85%9C\" aria-label=\"step 3 간단한 스트리밍 시스템 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 간단한 스트리밍 시스템</h2>\n<p>이 책에서는 IoT 센서에 대한 예시를 다룬다.\n어떤 다리에 IoT 센서가 있고 트럭인지 버스인지 등을 파악하는 센서가 있다고 가정한다.</p>\n<p>기존 시스템은 백엔드 서비스로 이루어져있었으나 휴일에 많은 트래픽이 몰려서 처리하기 어려운 상황이 놓였었다. 위에서도 설명했듯이 보통의 백엔드 서비스들은 동기적인 처리를 한다.</p>\n<p>즉, 아래와 같이 처리가 된다. 이 경우에는 트래픽이 몰릴 경우 점점 사용자의 응답은 느려질 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/1k3EOQu.png\">\n</p>\n<p align=\"center\">\n<em>그림 12. 동기적 백엔드 서비스 모델, Grokking Streaming Systems : Real-time event Processing, p.66</em>\n</p>\n<p>이 책에서도 동일하게 위에서 설명한 것과 같이 비동기적 처리를 위해서 큐를 도입해서 처리하고자 한다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/c90wSPc.png\">\n</p>\n<p align=\"center\">\n<em>그림 13. 큐를 통한 비동기 처리 도입, Grokking Streaming Systems : Real-time event Processing, p.69</em>\n</p>\n<p>그렇다면, 실제 스트리밍 시스템 내부에는 어떤 원리로 동작을 시키는 지 확인 해보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/TdPTbPM.png\">\n</p>\n<p align=\"center\">\n<em>그림 14. 스트리밍 시스템 내부 도식화, Grokking Streaming Systems : Real-time event Processing, p.74</em>\n</p>\n<p>위와 같이 큰 틀로 볼 수 있다.</p>\n<ul>\n<li>Source executor : 이벤트가 발생되는 주체로 볼 수 있으며, 발생된 이벤트들은 큐를 통해서 발송된다.</li>\n<li>Operator executor : 위에서 봤던 전통적인 스트리밍 시스템 구조의 단계에 해당한다고 볼 수 있으며, 이벤트를 알맞게 처리하는 작업을 수행한다.</li>\n</ul>\n<p>이 내용을 좀 더 깊게 들어가면 아래와 같은 그림으로 볼 수 있다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/LmtBDV6.png\">\n</p>\n<p align=\"center\">\n<em>그림 15. 스트리밍 엔진 내부 도식화, Grokking Streaming Systems : Real-time event Processing, p.77</em>\n</p>\n<p>보다 복잡해진 그림을 볼 수 있다. 이를 다시 분해해서 설명하기 위해 아래와 같이 추상화를 해보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/ynWz1zz.png\">\n</p>\n<p align=\"center\">\n<em>그림 16. 스트리밍 엔진 내부 도식 추상화, Grokking Streaming Systems : Real-time event Processing, p.78</em>\n</p>\n<p>아주 간단하게 <code class=\"language-text\">Source -> Stream -> Operator</code>의 구조로 추상화를 시킬 수가 있음을 확인할 수 있다.\n여기서 이제 스트리밍 시스템의 5가지 주요 요소를 뽑을 수 있다.</p>\n<ol>\n<li>Job : <code class=\"language-text\">Source -> Stream -> Operator</code> 을 한데 묶은 구조로 다른 말로는 <strong>파이프라인(pipeline)</strong><sup id=\"fnref-10\"><a href=\"#fn-10\" class=\"footnote-ref\">10</a></sup>이라고도 한다. 스트리밍 시스템의 구현체라고 볼 수 있다.</li>\n<li>Source : 외부세계의 데이터를 스트리밍 시스템으로 가져오는 역할을 한다. 이를 <code class=\"language-text\">entry point</code>라고 부르기도 한다.</li>\n<li>Stream : Source에서 전달 받은 이벤트를 Operator에 전달하는 역할을 한다.</li>\n<li>Event : 스트림 내에 더이상 나눌 수 없는 최소 단위의 데이터들을 뜻하며, <code class=\"language-text\">tuple, element, message</code>등등으로도 부르기도 한다.</li>\n<li>Operator : 스트림으로 부터 전달 받은 데이터를 변환하거나 어떠한 로직을 처리하는 역할을 수행한다.</li>\n</ol>\n<p>그림으로 보면 아래와 같다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/10c83Zu.png\">\n</p>\n<p align=\"center\">\n<em>그림 17. 스트리밍 시스템 구성요소, Grokking Streaming Systems : Real-time event Processing, p.79</em>\n</p>\n<p>위와 같은 간단한 스트리밍 시스템을 알아보았다.\n글이 길어진 관계로 실제 구현 내용은 아래의 링크로 대체하겠다.</p>\n<ul>\n<li><a href=\"https://github.com/nwangtw/GrokkingStreamingSystems\">Github - nwangtw/GrokkingStreamingSystems</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=A1YC_AC0qf8\">Youtube - Hello Streaming 101</a></li>\n</ul>\n<p>특히, 유튜브 영상은 현재 다뤘던 포스팅의 내용을 전부 다루고 있으니 참고해보길 바란다.\n긴 글 읽어주셔서 감사합니다.</p>\n<h2 id=\"step-4-레퍼런스\" style=\"position:relative;\"><a href=\"#step-4-%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4\" aria-label=\"step 4 레퍼런스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 4. 레퍼런스</h2>\n<ol>\n<li><a href=\"https://d2.naver.com/helloworld/206816\">Naver D2- 확장성 있는 웹 아키텍처와 분산 시스템</a></li>\n<li><a href=\"https://medium.com/dtevangelist/event-driven-microservice-%EB%9E%80-54b4eaf7cc4a\">Medium - Event Driven Architecture란?</a></li>\n<li><a href=\"https://developer.lightbend.com/docs/akka-guide/concepts/message-driven-event-driven.html\">Lightbend Document -Message Driven vs Event Driven</a></li>\n<li><a href=\"https://stackoverflow.com/questions/1659351/message-driven-vs-event-driven-approaches-to-application-integration\">StackOverflow - message driven vs event driven approaches to application integration</a></li>\n<li><a href=\"https://medium.com/event-driven-utopia/using-commands-events-and-queries-in-microservices-communication-3573f1fcfafe\">Medium - Using Commands, Events, and Queries in Microservices Communication</a></li>\n<li><a href=\"https://bcho.tistory.com/1119\">조대협 - 실시간 빅데이타 처리를 위한 스트리밍 처리의 개념</a></li>\n<li><a href=\"https://medium.com/event-driven-utopia/making-sense-of-unbounded-data-4abdfa0edad2\">Medium -Making Sense of Unbounded Data</a></li>\n</ol>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\"><a href=\"http://egloos.zum.com/agile/v/3684946\">http://egloos.zum.com/agile/v/3684946</a><a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-2\"><a href=\"https://en.wikipedia.org/wiki/Stream_processing\">https://en.wikipedia.org/wiki/Stream_processing</a><a href=\"#fnref-2\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-3\"><a href=\"https://en.wikipedia.org/wiki/Event-driven_architecture\">https://en.wikipedia.org/wiki/Event-driven_architecture</a><a href=\"#fnref-3\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-4\"><a href=\"https://microservices.io/patterns/data/saga.html\">https://microservices.io/patterns/data/saga.html</a><a href=\"#fnref-4\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-5\"><a href=\"https://en.wikipedia.org/wiki/Two-phase_commit_protocol\">https://en.wikipedia.org/wiki/Two-phase_commit_protocol</a><a href=\"#fnref-5\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-6\"><a href=\"https://en.wikipedia.org/wiki/Bottleneck_(network)\">https://en.wikipedia.org/wiki/Bottleneck_(network)</a><a href=\"#fnref-6\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-7\"><a href=\"https://en.wikipedia.org/wiki/Message_broker\">https://en.wikipedia.org/wiki/Message_broker</a><a href=\"#fnref-7\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-8\"><a href=\"https://akka.io/\">https://akka.io/</a><a href=\"#fnref-8\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-9\"><a href=\"https://www.lightbend.com/\">https://www.lightbend.com/</a><a href=\"#fnref-9\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-10\"><a href=\"https://en.wikipedia.org/wiki/Pipeline_(software)\">https://en.wikipedia.org/wiki/Pipeline_(software)</a><a href=\"#fnref-10\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","frontmatter":{"date":"January 09, 2023","title":"스트리밍 시스템 톺아보기","categories":"개발","author":"개발한입","emoji":"💻"},"fields":{"slug":"/overview-streaming-system/"}},"site":{"siteMetadata":{"siteUrl":"https://brewagebear.github.io","comments":{"utterances":{"repo":"brewagebear/blog-comments"}}}}},"pageContext":{"slug":"/ligthsail-ci-cd-setup/","nextSlug":"/concurrency-distributed-transaction-with-tcc/","prevSlug":"/overview-streaming-system/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}