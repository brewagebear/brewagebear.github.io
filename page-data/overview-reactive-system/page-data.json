{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/overview-reactive-system/",
    "result": {"data":{"cur":{"id":"5c0b255f-8197-5d9a-88fe-29ede82e6c42","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#step-2-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8B%9C%EC%8A%A4%ED%85%9C%EA%B3%BC-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D\">STEP 2. 리액티브 시스템과 리액티브 프로그래밍</a></p>\n<ul>\n<li>\n<p><a href=\"#step-21-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8B%9C%EC%8A%A4%ED%85%9C%EC%9D%B4%EB%9E%80\">STEP 2.1 리액티브 시스템이란?</a></p>\n</li>\n<li>\n<p><a href=\"#step-22-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%B4%EB%9E%80\">STEP 2.2 리액티브 프로그래밍이란?</a></p>\n</li>\n<li>\n<p><a href=\"#step-221-blocking-io%EC%97%90%EC%84%9C-non-blocking-io%EB%A1%9C\">STEP 2.2.1 Blocking I/O에서 Non-Blocking I/O로</a></p>\n<ul>\n<li><a href=\"#step-2211-%EB%B8%94%EB%A1%9D%ED%82%B9-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\">STEP 2.2.1.1 블록킹 시나리오</a></li>\n<li><a href=\"#step-2212-%EC%BD%9C%EB%B0%B1-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\">STEP 2.2.1.2 콜백 시나리오</a></li>\n<li><a href=\"#step-2213-future-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\">STEP 2.2.1.3 Future 시나리오</a></li>\n<li><a href=\"#step-2214-completablefuture-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\">STEP 2.2.1.4 CompletableFuture 시나리오</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-222-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%98-%ED%8A%B9%EC%A7%95\">STEP 2.2.2 리액티브 프로그래밍의 특징</a></p>\n<ul>\n<li><a href=\"#step-2221-%EB%AA%85%EB%A0%B9%ED%98%95-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%ED%8C%A8%EB%9F%AC%EB%8B%A4%EC%9E%84-vs-%EC%84%A0%EC%96%B8%ED%98%95-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%ED%8C%A8%EB%9F%AC%EB%8B%A4%EC%9E%84\">STEP 2.2.2.1 명령형 프로그래밍 패러다임 vs 선언형 프로그래밍 패러다임</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-223-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%98-%EA%B5%AC%EC%84%B1\">STEP 2.2.3 리액티브 프로그래밍의 구성</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-23-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8A%A4%ED%8A%B8%EB%A6%BC%EC%A6%88\">STEP 2.3 리액티브 스트림즈</a></p>\n<ul>\n<li><a href=\"#step-231-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8A%A4%ED%8A%B8%EB%A6%BC%EC%A6%88-%EA%B5%AC%EC%84%B1%EC%9A%94%EC%86%8C\">STEP 2.3.1 리액티브 스트림즈 구성요소</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-3-project-reactor\">STEP 3. Project Reactor</a></p>\n<ul>\n<li><a href=\"#step-31-cold-sequence--hot-sequence\">STEP 3.1 Cold Sequence &#x26; Hot Sequence</a></li>\n<li><a href=\"#step-311-cold-sequence\">STEP 3.1.1 Cold Sequence</a></li>\n<li><a href=\"#step-311-hot-sequence\">STEP 3.1.1 Hot Sequence</a></li>\n<li><a href=\"#step-32-sinks\">STEP 3.2 Sinks</a></li>\n<li><a href=\"#step-32-sinks-%ED%8A%B9%EC%A7%95\">STEP 3.2 Sinks 특징</a></li>\n<li><a href=\"#step-33-%EB%B0%B0%EC%95%95backpressure\">STEP 3.3 배압(Backpressure)</a></li>\n<li><a href=\"#step-331-%EB%B0%B0%EC%95%95-%EC%A0%84%EB%9E%B5\">STEP 3.3.1 배압 전략</a></li>\n<li><a href=\"#step-34-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC\">STEP 3.4 스케줄러</a></li>\n<li><a href=\"#step-341-%EC%93%B0%EB%A0%88%EB%93%9C%EC%9D%98-%EC%A2%85%EB%A5%98\">STEP 3.4.1 쓰레드의 종류</a></li>\n<li><a href=\"#step-342-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC%EC%9D%98-%EB%8F%99%EC%9E%91-%EC%9B%90%EB%A6%AC\">STEP 3.4.2 스케줄러의 동작 원리</a></li>\n<li><a href=\"#step-342-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC%EC%9D%98-%EC%A2%85%EB%A5%98\">STEP 3.4.2 스케줄러의 종류</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p>사실 예전부터 리액티브 시스템과 스트림즈에 대한 글은 준비를 하고 있었다.\n초안까지 어느정도 만들어 둔 상태였는데 다 갈아엎고 다시 쓰게되었다.</p>\n<p>그 이유는 바로 아래의 책 때문이다.</p>\n<p align=\"center\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 132.7777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAbABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQD/2gAMAwEAAhADEAAAAfW6aIuqmM9wQF//xAAcEAABBAMBAAAAAAAAAAAAAAACABAREgEDITH/2gAIAQEAAQUCLZBtXtkPhNh4hf/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABcQAAMBAAAAAAAAAAAAAAAAABEgITD/2gAIAQEABj8CCTD/xAAbEAEAAgMBAQAAAAAAAAAAAAABABEQITFBUf/aAAgBAQABPyEUSgdco2WPjAQnefJvwuCjILUdbZ//2gAMAwEAAgADAAAAEGcHsP/EABYRAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPxCoir//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxAh/8QAGxABAAIDAQEAAAAAAAAAAAAAAQARITFBENH/2gAIAQEAAT8QfKgIFF9uGQRuBRu4lMR2OoSbV7Hdc4UzKALK0F6hYplXcL8lOd7Dx5VdjbP/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"book\" title=\"book\" src=\"/static/f688886d2561b944e321d6c2e9b5964e/80e3c/book.jpg\" srcset=\"/static/f688886d2561b944e321d6c2e9b5964e/4ec73/book.jpg 180w,\n/static/f688886d2561b944e321d6c2e9b5964e/158ba/book.jpg 360w,\n/static/f688886d2561b944e321d6c2e9b5964e/80e3c/book.jpg 720w,\n/static/f688886d2561b944e321d6c2e9b5964e/fc6fd/book.jpg 902w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</p>\n<p align=\"center\">\n    <em><a href=\"https://www.yes24.com/Product/Goods/118202569\">그림 1. 스프링으로 시작하는 리액티브 프로그래밍, 황정식 저, 2023</a></em>\n</p>\n<p>사실 국내 번역서 중에서 리액티브 프로그래밍을 좀 잘 다룬 책은 찾기가 힘들었었다.\n그래서, 원래 초안은 아래의 책을 참고하고, 공식문서들을 참고해서 작성하고 있었다.</p>\n<ul>\n<li><a href=\"https://www.amazon.com/Hands-Reactive-Programming-Spring-cloud-ready-ebook/dp/B076QCBXZ2\">Hands-On Reactive Programming in Spring 5, Igor Lozynskyi, 2018</a></li>\n</ul>\n<p>이 책도 매우 잘쓰여진 책이라고 볼 수 있다. 하지만 위 책과 비교하면 저 원서의 경우에는 거시적인 관점에서 작성되었다면, 황정식님께서 작성하신 책은 미시적인 관점의 책이라고 볼 수 있다.</p>\n<p>이 포스팅의 내용 대부분은 두 가지 책과 공식문서를 참고하였다.</p>\n<p>예시 코드는 아래의 레포지토리들을 참고바란다.</p>\n<ol>\n<li><a href=\"https://github.com/brewagebear/blog-example/tree/main/reactive-examples\">blog-exampl/reactive-examples</a></li>\n<li><a href=\"https://github.com/PacktPublishing/Hands-On-Reactive-Programming-in-Spring-5\">Hands-On-Reactive-Programming-in-Spring-5</a></li>\n<li><a href=\"https://github.com/bjpublic/Spring-Reactive\">String-Reactive</a></li>\n</ol>\n<h2 id=\"step-2-리액티브-시스템과-리액티브-프로그래밍\" style=\"position:relative;\"><a href=\"#step-2-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8B%9C%EC%8A%A4%ED%85%9C%EA%B3%BC-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D\" aria-label=\"step 2 리액티브 시스템과 리액티브 프로그래밍 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2. 리액티브 시스템과 리액티브 프로그래밍</h2>\n<h3 id=\"step-21-리액티브-시스템이란\" style=\"position:relative;\"><a href=\"#step-21-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8B%9C%EC%8A%A4%ED%85%9C%EC%9D%B4%EB%9E%80\" aria-label=\"step 21 리액티브 시스템이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1 리액티브 시스템이란?</h3>\n<p>요즘날 프로그래밍 세계에서는 리액티브라는 말이 수도 없이 많이 거론되고 있다.\n하지만, 정작 리액티브(Reactive)라는 단어 자체에 대한 모호함때문에 정확히 어떠한 시스템인지 감을 잡기가 힘들다.</p>\n<p>실생활의 예에서 찾아보자. 예능이나 토크쇼 프로그램을 보면 MC들이 게스트들에게 리액션을 잘한다고 한다.\n그렇다면 리액션은 어떤 것일까? 화자의 얘기를 청취하고 맞장구를 잘 쳐주는 행위를 리액션이라고 볼 수 있을 것이다.</p>\n<p>리액티브 시스템도 그런 맥락에서 보면, <strong>반응을 잘하는 시스템</strong>이라고 볼 수 있을 것이다.\n하지만, 아직까지도 모호하다. 반응을 잘한다는 뜻은 어떤 것일까?</p>\n<p>아마도 소프트웨어 엔지니어의 관점에서 본다면 클라이언트의 요청에 대해서 빠르게 응답해주는 시스템일 것이다.\n이를 한 문장으로 정리하면 아래와 같다고 볼 수 있을 것이다.</p>\n<blockquote>\n<p>클라이언트의 요청에 즉각적으로 응답함으로써 지연 시간을 최소화하는 시스템</p>\n<ul>\n<li>스프링으로 시작하는 리액티브 프로그래밍, Kevin, p.28 -</li>\n</ul>\n</blockquote>\n<p>그렇다면 리액티브 시스템은 기존 시스템과 어떠한 차이를 통해서 위에서 말한 목표를 이루고자하는 것일까?\n이를 알기 위해서는 리액티브 선언문을 봐야한다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/QSlsWcn.png\">\n</p>\n<p align=\"center\">\n    <em>그림 2. 리액티브 선언문</em>\n</p>\n<p>위 도표를 설명하면 아래와 같다.</p>\n<ul>\n<li>MEANS(방법) : 리액티브 시스템에서 주요 통신 수단을 무엇을 사용할지를 표현한 것으로, 비동기 메시지 기반으로 동작한다.</li>\n<li>FORM(형태) : 비동기 메시지 통신 기반하에 시스템의 변화하는 작업량에 탄력적으로 대응하고, 장애가 발생하더라도 응답성을 유지하는 것을 뜻한다.\n<ul>\n<li>Elasticity(탄력성) : 유입되는 입력이 많든 적든 간에 시스템이 요구하는 응답성을 일정하게 유지</li>\n<li>Resilient(회복성) : 비동기 메시지 기반 통신을 이용하여 낮아진 결합도 덕분에 장애가 발생해도 전체 시스템은 응답 가능하며, 장애가 발생한 부분만 복구하면 된다.</li>\n</ul>\n</li>\n<li>VALUE(가치) : 위에서 나온 MEANS + FORM을 통해서 즉각적으로 응답 가능한 시스템을 구축할 수 있음을 의미</li>\n</ul>\n<p>선언문의 내용을 정리하면, <strong>비동기 메시지 기반 통신을 활용하여 탄력성과 회복성을 토대로 시스템이 요구하는 일정 수치의 응답성을 유지하는 견고한 시스템</strong>이라고 볼 수 있을 것이다.</p>\n<p>이 부분에 대해서 아직도 안 와닿는 독자분들이 계실꺼라 생각하여, 간단한 예시를 설명해보겠다.</p>\n<p>필자는 미국에서 수입대행을 하는 작은 직구 스토어를 개업을 하였다.\n시간이 갈수록 장사는 꽤 잘되었고, 시간당 약 1000명의 사용자가 방문하게 되었다.</p>\n<p>그래서 필자는 클라우드 환경에 Tomcat 서버를 구축하였고, 쓰레드 풀은 500개 정도로 할당해두었다.\n대다수의 사용자의 요청의 평균 응답 시간은 약 250밀리초였다.</p>\n<p><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi><mi>P</mi><mi>S</mi><mo stretchy=\"false\">(</mo><mi>T</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext> </mtext><mi>P</mi><mi>e</mi><mi>r</mi><mtext> </mtext><mi>S</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mn>500</mn><mn>0.25</mn></mfrac><mo>≈</mo><mn>2</mn><mo separator=\"true\">,</mo><mn>000</mn></mrow><annotation encoding=\"application/x-tex\">TPS(Transaction\\ Per \\ Second) = {500 \\over 0.25} \\approx 2,000</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">TPS</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">an</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\">eco</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1901em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8451em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">0.25</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">500</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≈</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">000</span></span></span></span></span></p>\n<p>위와 같은 공식에 따라 초당 2,000명의 요청이 처리가 가능하였다.\n따라서, 해당 서버는 평균적인 부하에는 충분해보였다.</p>\n<p>그러나 이 시스템은 실패하였다. 그 원인은 바로 <strong>블랙 프라이데이</strong>였다. 블랙 프라이데이때 예상치 못한 고객들이 몰리기 시작하였으며, 서버는 평균부하보다 심한 부하를 겪게되었고, 이에 따라 점차적으로 쓰레드 풀이 고갈되어 매우 큰 장애가 발생하였다.</p>\n<p>이 예시는 필자가 뇌피셜로 작성한 글이 아니라 실제로 아마존과 월마트도 겪었던 문제였다.</p>\n<ol>\n<li><a href=\"https://www.cnet.com/tech/tech-industry/amazon-com-hit-with-outages/\">Amazon.com hit with outages - CNET</a></li>\n<li><a href=\"https://www.forbes.com/sites/kellyclay/2013/08/19/amazon-com-goes-down-loses-66240-per-minute/?sh=2b7f445b495c\">Amazon.com Goes Down, Loses $66,240 Per Minute - Forbes</a></li>\n<li><a href=\"https://techcrunch.com/2011/11/25/walmart-black-friday/?guccounter=1\">Walmart’s Black Friday Disaster : Website Crippled, Violence In Stores - TechCrunch</a></li>\n</ol>\n<p>이제 우리는 <strong>어떻게 응답해야할 것인가?</strong> 를 고민하게 되었다. 위의 예시와 같이 오늘날 어플리케이션은 사용자의 요청에 대한 응답에 영향을 줄 수 있는 어떠한 변화에도 반응을 해야하는 것이다.</p>\n<p>이것이 바로 리액티브 시스템이 지향하고자하는 가치이다.\n그렇다면 탄력성은 무엇인가? 위 예시에서 만약, 사용자가 많아졌을 때 어플리케이션의 수용능력이 증가가 되었으면 어땠을까? 버틸 수도 있지 않았을까?</p>\n<p>이것이 바로 <strong>탄력성(Elastcity)</strong> 이다. 수요가 증가했을 때 시스템을 확장하고, 수요가 감소되었을 때 시스템을 축소하는 등 탄력적으로 운영하는 것이다. 그렇다면 <strong>회복성(Resilience)</strong> 는 어떤식으로 이뤄질 수 있을까? 바로 시스템의 기능적 구성 요소(Component) 사이에 격리를 적용하여 달성할 수 있다.</p>\n<p>스토어 예시를 들었는데 스토어에는 다양한 기능이 존재한다. 상품 상세 페이지를 보여주는 기능, 리뷰를 보여주는 기능 등 말이다.\n만약, 리뷰를 보여주는 기능이 장애가 발생하더라도 상품 상세 페이지를 보여주는 기능이나 결제 기능은 멀쩡하다면 고객은 충분히 계속해서 주문을 수행할 수 있을 것이다.</p>\n<p>리액티브 시스템이 지향하는 가치를 추구하고자하면 이 두가지 특성이 필요충분조건이라 볼 수 있다. 이러한 특성을 얻기 위해서 메시지-주도(Message-Driven) 통신을 사용하는 것이다.  왜 메시지-주도 방식이 이와 연관이 되어있는지 궁금하다면 아래의 글을 참고해보자.</p>\n<ul>\n<li><a href=\"https://brewagebear.github.io/overview-streaming-system/\">스트리밍 시스템 톺아보기</a></li>\n</ul>\n<p>이런 리액티브 시스템의 가치는 다양한 곳에서 사용되고 있다. 위에서 얘기한 스트리밍 시스템의 예시를 보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/LPcUSMs.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://www.amazon.com/Hands-Reactive-Programming-Spring-cloud-ready-ebook/dp/B076QCBXZ2\"> 그림 3. 스트리밍 시스템 아키텍처(Hands-On Reactive Programming in Spring 5, Igor Lozynskyi, 2018, p.71)</a></em>\n</p>\n<p>스트리밍 아이켁처는 데이터 처리와 변환의 흐름을 중점적으로 바라보는 아키텍처로 준 실시간에 해당하는 응답을 내려줘야하기 때문에, 낮은 지연시간과 높은 처리량을 지니는 특성을 가진다. 이러한 효과적인 작업량을 처리하기 위해서 배압(Backpressure)라는 기능을 통해서 해당 아키텍처가 해결하고자하는 문제를 해결할 수 있으며, 메시지는 신뢰할 수 있는 브로커(e.g 카프카)와 같은 것을 토대로 메시지 기반 통신을 통해서 해당 가치를 달성할 수 있다.</p>\n<p>이 뿐만 아니라 위에서 얘기한 스토어 예시에 적용하자면 아래와 같은 그림처럼 볼 수 있을 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/lMd9dhJ.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://www.amazon.com/Hands-Reactive-Programming-Spring-cloud-ready-ebook/dp/B076QCBXZ2\"> 그림 4. 마이크로 서비스 아키텍처(Hands-On Reactive Programming in Spring 5, Igor Lozynskyi, 2018, p.69)</a></em>\n</p>\n<p>위에서 언급한 탄력성과 회복성을 극대화하기 위해서 마이크로서비스 패턴을 적용하였고, Kafka같은 브로커를 이용하여 외부 시스템(PG, 펌뱅킹)의 영향도를 최소화신키는 아키텍처로 구성하여, 다시 재시도하는 처리작업까지 해두었다. 이 뿐만 아니라 데이터베이스도 마스터-슬레이브 구조<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> 를 채택하였다.</p>\n<p>이런식으로 리액티브 시스템의 가치는 단순하게 리액터(Reactor)<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup> , 스프링 클라우드 스트림(Spring Cloud Streams)<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup> 나 스프링 웹플럭스(Spring Webflux)<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup> 같은 기술에 국한된 개념이 아닌 것이다.</p>\n<h3 id=\"step-22-리액티브-프로그래밍이란\" style=\"position:relative;\"><a href=\"#step-22-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%B4%EB%9E%80\" aria-label=\"step 22 리액티브 프로그래밍이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2 리액티브 프로그래밍이란?</h3>\n<p>위에서는 리액티브 시스템에서 알아보았다. 그런데 이러한 시스템을 어떻게 프로그래밍적으로 구현할 수 있을까?\n그거에 대한 해결책이 바로 리액티브 프로그래밍이다.</p>\n<blockquote>\n<p>리액티브 시스템을 구축하는 데 필요한 프로그래밍 모델이 리액티브 프로그래밍이다.</p>\n<ul>\n<li>스프링으로 시작하는 리액티브 프로그래밍, 황정식 저, p.30 -</li>\n</ul>\n</blockquote>\n<p>리액티브 프로그래밍의 특징을 설명하기 앞서 코드의 변화과정을 살펴볼 필요가 있다.\n스프링 프레임워크와 자바 진영의 변화점에 대해서 중점적으로 살펴볼 것이다.</p>\n<h3 id=\"step-221-blocking-io에서-non-blocking-io로\" style=\"position:relative;\"><a href=\"#step-221-blocking-io%EC%97%90%EC%84%9C-non-blocking-io%EB%A1%9C\" aria-label=\"step 221 blocking io에서 non blocking io로 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.1 Blocking I/O에서 Non-Blocking I/O로</h3>\n<p>아래와 같은 코드가 있다고 가정해보자.</p>\n<h4 id=\"step-2211-블록킹-시나리오\" style=\"position:relative;\"><a href=\"#step-2211-%EB%B8%94%EB%A1%9D%ED%82%B9-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"step 2211 블록킹 시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.1.1 블록킹 시나리오</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ShoppingCardService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Output</span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BlockingShoppingCardService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ShoppingCardService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token annotation punctuation\">@Override</span>  \n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Output</span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token punctuation\">}</span>  \n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrdersService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ShoppingCardService</span> shoppingCardService<span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ShoppingCardService</span> shoppingCardService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>shoppingCardService <span class=\"token operator\">=</span> shoppingCardService<span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>  \n  \n\t<span class=\"token keyword\">void</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token class-name\">Input</span> input <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Input</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token class-name\">Output</span> output <span class=\"token operator\">=</span> shoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>shoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSimpleName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" execution completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">BlockingShoppingCardService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">BlockingShoppingCardService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Total elapsed time in millis is : \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>아주 단순하게 구현된 코드로 <code class=\"language-text\">OrderService</code>에서 <code class=\"language-text\">ShoppingCardService</code>를 호출한다고 생각해서 짠 코드이다.\n<code class=\"language-text\">BlockingShoppingCardService</code>는 I/O 작업같이 장 시간 소요되는 작업이 있다 가정해보자.</p>\n<p>결과를 보면 2번의 <code class=\"language-text\">Thread.sleep(1000)</code> 이 호출될 것이며, 대략 2초정도 걸릴 것이다.\n<code class=\"language-text\">calculate()</code> 메서드를 처리하기 위해 전달된 쓰레드는 당연히 블록킹이 될 것이고, 이 쓰레드는 1초동안 아무것도 하지 못하게 된다.</p>\n<p>따라서, <code class=\"language-text\">OrderService</code>에서 <code class=\"language-text\">ShoppingCardService</code>에 요청 이후에 다른 작업을 하고 싶으면 추가적인 쓰레드 할당이 필요한 상황이다.\n이 문제를 어떻게 해결할 수 있을까?</p>\n<p>바로, 콜백을 통해서 해결할 수 있다.</p>\n<h4 id=\"step-2212-콜백-시나리오\" style=\"position:relative;\"><a href=\"#step-2212-%EC%BD%9C%EB%B0%B1-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"step 2212 콜백 시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.1.2 콜백 시나리오</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ShoppingCardService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">void</span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> value<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Consumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> consumer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 비동기 서비스</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AsyncShoppingCardService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ShoppingCardService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token annotation punctuation\">@Override</span>  \n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> value<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Consumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> consumer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span>  \n\t\t\tconsumer<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 동기 서비스 </span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SyncShoppingCardService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ShoppingCardService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token annotation punctuation\">@Override</span>  \n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> value<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Consumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> consumer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\tconsumer<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrdersService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ShoppingCardService</span> shoppingCardService<span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ShoppingCardService</span> shoppingCardService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>shoppingCardService <span class=\"token operator\">=</span> shoppingCardService<span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>  \n  \n\t<span class=\"token keyword\">void</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token class-name\">Input</span> input <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Input</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\tshoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> output <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>shoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSimpleName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" execution completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">OrdersService</span> ordersServiceAsync <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncShoppingCardService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token class-name\">OrdersService</span> ordersServiceSync <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SyncShoppingCardService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tordersServiceAsync<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\tordersServiceAsync<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\tordersServiceSync<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Total elapsed time in millis is : \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Consumer&lt;T></code> 타입으로 콜백을 생성하여, 비동기 서비스와 동기 서비스를 작업하였다.\n<code class=\"language-text\">SyncShoppingCardService()</code>는 블록킹 작업이 없다 가정하고, 바로 콜백에 리턴되게끔 설계되었다.\n<code class=\"language-text\">ASyncShoppingCardService()</code>는 블록킹 작업이 존재해도, 새로운 쓰레드로 감싸서 <code class=\"language-text\">OrderService</code>에서 콜백을 기다리는 동안 다른 작업을 수행할 수 있게끔 해준다.</p>\n<p>기존 2초에서 필자의 노트북 기준으로 6밀리초로 성능이 대폭 좋아지긴했지만, 위 방식도 치명적인 단점이 존재한다.</p>\n<p>첫번째로는 멀티쓰레딩 환경에서의 공유 변수관련한 높은 이해도를 개발자에게 요구한다.\n두번째로는 바로 콜백 지옥(Callback Hell)로 빠질 수 있는 문제가 존재한다.</p>\n<ul>\n<li><a href=\"http://callbackhell.com/\">참고 : Callback hell</a></li>\n</ul>\n<p>그렇다면, 비동기의 장점을 누리면서 위의 단점을 해결할 수는 없을까? 이 부분은 자바의 <code class=\"language-text\">Future</code>를 통해서 어느정도 해결할 수 있다.</p>\n<h4 id=\"step-2213-future-시나리오\" style=\"position:relative;\"><a href=\"#step-2213-future-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"step 2213 future 시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.1.3 Future 시나리오</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ShoppingCardService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// FutureShoppingCardService.java</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token annotation punctuation\">@Override</span>  \n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">FutureTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> future <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FutureTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\t \n\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token keyword\">return</span> future<span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token comment\">// OrderService.java</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Input</span> input <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Input</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> shoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>shoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSimpleName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" execution completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\tresult<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">ExecutionException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">OrdersService</span> ordersService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FutureShoppingCardService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tordersService<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\tordersService<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Total elapsed time in millis is : \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Future</code>는 리턴 값이 사용 가능한지 또는 그 리턴 값을 가져오기 위해 블록킹을 해야하는 지 등을 파악할 수 있게 하는 클래스이다.\n위 코드에서는 생략했지만, <code class=\"language-text\">return future;</code> 문이 끝나고 <code class=\"language-text\">OrdersService</code>에서는 <code class=\"language-text\">.get()</code> 메서드를 통해서 실제 값을 가져오게끔한다.\n실제 동작하면 대략 2초가 걸리는 것을 확인할 수 있는데 이는 <code class=\"language-text\">.get()</code> 메서드가 결과값을 받을때까지 대기하는 블록킹 메서드이기 때문이다.\n<code class=\"language-text\">.isDone()</code> 메서드같은 것을 활용하면 즉시 반환할 수도 있다.</p>\n<p><code class=\"language-text\">Future</code>를 통해서 콜백 지옥이라는 문제점과 멀티 쓰레딩의 복잡성을 개발자가 몰라도 되게끔 처리된 것처럼 보인다.\n그러나, 결과를 얻기 위해서 현재 쓰레드를 블록(<code class=\"language-text\">.get()</code>) 하고 동기화해야되는 불편함이 존재하여 확장성이 감소된다.</p>\n<p>이러한 문제때문에 Java 8부터는 <code class=\"language-text\">CompletableFuture</code>와 같은 <code class=\"language-text\">CompletionStage</code><sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup>를 제공하기 시작했다.</p>\n<h4 id=\"step-2214-completablefuture-시나리오\" style=\"position:relative;\"><a href=\"#step-2214-completablefuture-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"step 2214 completablefuture 시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.1.4 CompletableFuture 시나리오</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ShoppingCardService</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">CompletableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token annotation punctuation\">@Override</span>  \n<span class=\"token keyword\">public</span> <span class=\"token class-name\">CompletableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Output</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Input</span> input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">supplyAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token punctuation\">}</span>  \n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Input</span> input <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Input</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tshoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">calculate</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">thenAccept</span><span class=\"token punctuation\">(</span>v <span class=\"token operator\">-></span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>shoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSimpleName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" execution completed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>shoppingCardService<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSimpleName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" calculate called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">OrdersService</span> ordersService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrdersService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CompletableFutureShoppingCardService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tordersService<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\tordersService<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Total elapsed time in millis is : \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">CompletableFuture</code>의 장점은 수행 후 <code class=\"language-text\">thenAccept()</code> 나 <code class=\"language-text\">thenCombine()</code> 메서드와 같은 메서드들과 체이닝을 이룰 수 있고, 자바8 이후에 나온 람다표현식과도 찰떡궁합처럼 쓰일 수 있다. 또한, <code class=\"language-text\">Future</code>와 다르게 결과를 기다리지 않고 결과가 실제 사용가능할 때 처리할 수 있는 기능도 제공한다.  하지만, 스프링 진영에서는 하위호환성을 위해서 <code class=\"language-text\">CompletionStage</code> 를 지원하지 않고, <code class=\"language-text\">ListenableFuture</code><sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup>를 제공하였다.</p>\n<p>그에 대표적인 녀석이 <code class=\"language-text\">AsyncRestTemplate</code><sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup> 이다.  이 클래스는 비동기 호출을 처리하기 위해 다시 콜백을 사용하였고, 내부적으로 별도 쓰레드에서 블록킹하는 작업 등이 존재하였다. 또한, Spring MVC는 Servlet API에 의존적으로 동작하여 모든 구현에 쓰레드 당 요청(Request per Thread)<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup> 을 의무화하였다.</p>\n<p>이러한 문제는 SpringFramework 5의 <code class=\"language-text\">WebClient</code><sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup> 의 도입으로 해소가 되는 듯하였다. 이를 통해서 논블록킹 통신을 충분히 가능케 하였고, Servlet 또한, 3에서는 비동기 클라이언트-서버 커뮤니케이션<sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup>을 지원하고 3.1에서는 논블록킹 쓰기 작업<sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup>을 지원하였다.\n이로써, 서블릿을 사용하는 애플리케이션의 모든 과정에서 논블록킹한 작업이 가능해졌다.</p>\n<p>하지만 3.1에서 지원하는 API는 Spring MVC와 궁합이 맞지 않았는데, 동기식(<code class=\"language-text\">Filter</code>, <code class=\"language-text\">Servlet</code>) 나 블록킹( <code class=\"language-text\">getParameter, getPart</code>) 작업 등이 존재하였기 때문에 논블록킹 I/O를 지원하려면 나머지 API들이 문제가 생겼다.</p>\n<p>이러한 문제를 해결하기 위해서는 많은 부분을 수정해야됐었는데 하나같이 전부 어려운 문제들이었다. 또한, JVM의 쓰레드 당 일반적인 크기는 1,024KB인데 64,000개의 동시 요청이 들어오는 상황이면 대략적으로 64GB의 메모리가 사용될 수 있다. 그러나 이러한 문제를 해결하기 위해 제한된 수로 쓰레드 풀로 설정할 경우에는 클라이언트 응답이 지연이 되는 문제가 있었다.</p>\n<p>더군다나 리액티브 선언문에서 논블록킹 연산을 권장하고 있는데 이는 스프링 생태계에서는 어찌보면 누락이 되었다. 추가로 이때까지만 해도 스프링은 반응형 서버인 Netty같은 것과 통합이 잘 되어있지가 않았다.</p>\n<p>이러한 문제를 해결하기 위해 스프링 진영에서는 <strong>반응형 프로그래밍</strong>을 꺼내들었고, 반응형 서버와 통합을 시도하였다.\n그것이 바로 <code class=\"language-text\">Spring WebFlux</code>이다.</p>\n<p>하지만, 이 포스팅의 중점은 <code class=\"language-text\">Spring WebFlux</code>가 구현한 리액티브 스트림즈(Reactive Streams)에 초점이 맞춰져있어서 그 부분에 대해서 좀 더 다루고자한다.</p>\n<p>위에 내용은 자바 개발자가 친숙한 스프링 웹플럭스의 출범 이유에 대해서 다뤘다고 보면될 것 같다.\n결국, <code class=\"language-text\">Spring WebFlux</code>도 리액티브 스트림즈 구현체기 때문에 리액티브 프로그래밍과 리액티브 스트림즈에 대해 이해를 하면 좀 더 접근이 쉬울 것이다.</p>\n<p>자 이제, 왜 리액티브 프로그래밍이 대두가 되게 되었는지 알게되었다. 이제 본격적으로 리액티브 프로그래밍의 특징을 알아보자.</p>\n<h3 id=\"step-222-리액티브-프로그래밍의-특징\" style=\"position:relative;\"><a href=\"#step-222-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%98-%ED%8A%B9%EC%A7%95\" aria-label=\"step 222 리액티브 프로그래밍의 특징 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.2 리액티브 프로그래밍의 특징</h3>\n<p>위에서는 리액티브 프로그래밍의 정의에 대해서 아래와 같이 설명했었다.</p>\n<blockquote>\n<p>리액티브 시스템을 구축하는 데 필요한 프로그래밍 모델이 리액티브 프로그래밍이다.</p>\n<ul>\n<li>스프링으로 시작하는 리액티브 프로그래밍, 황정식 저, p.30 -</li>\n</ul>\n</blockquote>\n<p>자세한 정의는 <a href=\"https://en.wikipedia.org/wiki/Reactive_programming\">위키피디아</a>에 아래와 같이 정의되어있었다.</p>\n<blockquote>\n<p>In <a href=\"https://en.wikipedia.org/wiki/Computing\" title=\"Computing\">computing</a>, <strong>reactive programming</strong> is a <a href=\"https://en.wikipedia.org/wiki/Declarative_programming\" title=\"Declarative programming\">declarative</a> <a href=\"https://en.wikipedia.org/wiki/Programming_paradigm\" title=\"Programming paradigm\">programming paradigm</a> concerned with <a href=\"https://en.wikipedia.org/wiki/Stream_(computing)\" title=\"Stream (computing)\">data streams</a> and the propagation of change.</p>\n</blockquote>\n<p>여기서 2가지를 볼 수 있는데</p>\n<ol>\n<li>데이터 스트림즈와 변화의 전파(Data Streams and the propagation of change)</li>\n<li>선언형 프로그래밍 패러다임(Declarative Programming Paradigm)</li>\n</ol>\n<p>1번에 대해서 설명하자면 데이터 스트림(Data Stream)은 데이터가 지속적으로 발생하는 흐름을 뜻한다.\n변화의 전파(Propagation of Change)는 지속적으로 데이터가 발생할 때마다 이것을 변화하는 이벤트로 보고, 이벤트를 발생시키면서 데이터를 계속적으로 전달하는 것을 의미한다.</p>\n<p>이 부분은 이전에 다뤘던 <a href=\"https://brewagebear.github.io/overview-streaming-system/\">스트리밍 시스템 톺아보기</a>에 이벤트 주도 아키텍처를 설명하기 위해 작성된 부분을 보면 이해할 수 있을 것이다.</p>\n<p>그렇다면, 선언형 프로그래밍 패러다임은 무엇일까? 이는 코드로 보여주고자 한다.</p>\n<h4 id=\"step-2221-명령형-프로그래밍-패러다임-vs-선언형-프로그래밍-패러다임\" style=\"position:relative;\"><a href=\"#step-2221-%EB%AA%85%EB%A0%B9%ED%98%95-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%ED%8C%A8%EB%9F%AC%EB%8B%A4%EC%9E%84-vs-%EC%84%A0%EC%96%B8%ED%98%95-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%ED%8C%A8%EB%9F%AC%EB%8B%A4%EC%9E%84\" aria-label=\"step 2221 명령형 프로그래밍 패러다임 vs 선언형 프로그래밍 패러다임 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.2.1 명령형 프로그래밍 패러다임 vs 선언형 프로그래밍 패러다임</h4>\n<p>명령형 프로그래밍 패러다임은 기존 우리가 사용하던 코드라 보면 될 것이다.<br>\n1부터 100까지 숫자 중에서 짝수 합을 구하는 프로그램을 짜본다하면 아래와 같이 짤 수 있을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">int</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tsum <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>sum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2550</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러한 방식이 명령형 프로그래밍이다. 그렇다면 선언형 프로그래밍은 어떤식으로 작성하는 것일까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">int</span> sum <span class=\"token operator\">=</span> <span class=\"token class-name\">IntStream</span><span class=\"token punctuation\">.</span><span class=\"token function\">rangeClosed</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>number <span class=\"token operator\">-></span> number <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token operator\">::</span><span class=\"token function\">sum</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>sum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2550</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>리액티브 프로그래밍은 아니지만, 우리가 자주 사용하는 자바 스트림 또한 선언형 프로그래밍이다.</p>\n<p>가장 큰 차이를 보이는 부분은 <code class=\"language-text\">for</code>문과  <code class=\"language-text\">if</code>문의  존재유무일 것이다.</p>\n<p>명령형 프로그래밍은 <code class=\"language-text\">for</code>와 <code class=\"language-text\">if</code>를 통해서 “1 ~ 100 짝수 합”이라는 결론을 도출하기 위해서 컴퓨터가 처리할 수 있는 명령을 설명하는 식으로 작성되어왔다.\n그러나, 선언형 프로그래밍은 <code class=\"language-text\">rangeClosed()</code>, <code class=\"language-text\">filter()</code>, <code class=\"language-text\">reduce()</code> 메서드를 통해서 원하는 결과를 지정한다는 차이가 존재한다는 점이다.</p>\n<p>이를 보완하면 <code class=\"language-text\">rangeClosed()</code>에는 내가 원하는 숫자의 바운더리를 지정하고, <code class=\"language-text\">filter()</code> 메서드를 통해서 <code class=\"language-text\">number % 2 ==0</code>인 결과를 필터링하고, <code class=\"language-text\">reduce()</code> 메서드를 통해 실제로 값을 더한다.\n이것이 명령형 프로그래밍과 선언형 프로그래밍의 차이이다.</p>\n<p>잘 이해가 안간다면 아래의 글을 참고하자.</p>\n<ul>\n<li><a href=\"https://www.linkedin.com/pulse/imperative-vs-declarative-programming-javascript-yehuda-margolis/\">Imperative vs Declarative Programming in JavaScript</a></li>\n</ul>\n<p>추가적으로 메서드 체이닝(<code class=\"language-text\">rangeClosed(..).filter(..).reduce(..)</code>) 과 같이 <strong>코드가 간결해지고 가독성도 높아진다는 장점</strong>도 있다.</p>\n<blockquote>\n<p>💡 이 부분은 다소 오해의 소지를 불러올 수 있는데, 코드 자체를 <strong>쉽게 이해하는 것</strong>은 <code class=\"language-text\">for</code>문이 더 나을 수 있다.\n그리고 메서드 체이닝의 길이가 길어질수록 오히려 가독성이 떨어지는 상황도 있으므로 대한 컨벤션을 적절하게 정한 후 사용하는 것이 올바르다 생각한다.</p>\n<p>예를 들어, 복잡한 도메인 로직인 경우에는 선언형 프로그래밍을 사용하여 작성할 경우 오히려 동료가 이해를 못할 수 있으니 모두가 이해할 수 있는 명령형 프로그래밍으로 작성을 하고,  단순 로직인데 명령형 프로그래밍을 쓰면 지저분해지는데 선언형 프로그래밍을 사용하면 3줄 이내로 끝나는 케이스는 후자가 나을 수도 있다. 모든 것은 트레이드-오프이다.</p>\n</blockquote>\n<p>또한, <code class=\"language-text\">filter(number -> number % 2 == 0)</code> 와 같이 람다와 같은 함수형 프로그래밍으로 구성된다는 특징이 있다.</p>\n<p>정리를 하면 아래와 같다.</p>\n<ol>\n<li>선언형 프로그래밍은 원하는 결과를 지정하는데 중점을 주는 패러다임이다.</li>\n<li>메서드 체이닝을 통해서 코드가 간결해지고 가독성이 높아진다.</li>\n<li>람다와 같은 함수형 프로그래밍을 통해서 장점을 극대화 시킨다.</li>\n</ol>\n<h3 id=\"step-223-리액티브-프로그래밍의-구성\" style=\"position:relative;\"><a href=\"#step-223-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%98-%EA%B5%AC%EC%84%B1\" aria-label=\"step 223 리액티브 프로그래밍의 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2.3 리액티브 프로그래밍의 구성</h3>\n<p>리액티브 프로그래밍의 구성 요소는 크게 아래의 4가지와 같다.</p>\n<table>\n<thead>\n<tr>\n<th>구성요소</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Publisher</td>\n<td>입력으로 들어오는 데이터를 제공하는 역할</td>\n</tr>\n<tr>\n<td>Subscriber</td>\n<td>Publisher가 제공한 데이터를 전달받아서 사용하는 주체</td>\n</tr>\n<tr>\n<td>Data Source</td>\n<td>Publisher의 입력으로 들어오는 원천 데이터(엄밀히 따지면 다르긴한데 Data Stream이라 표기하기도 함)</td>\n</tr>\n<tr>\n<td>Operator</td>\n<td>요구사항에 맞게 Publisher &#x3C;-> Subscriber 사이에서 가공처리를 하는 역할</td>\n</tr>\n</tbody>\n</table>\n<p>그렇게 어려운 내용은 아니니 위의 표로 설명이 가능하다고 생각한다.</p>\n<p>그러나 이러한 구성 요소가 필요한다 정도만 있었고 이를 구현한 라이브러리나 생태계는 부족했던 상황이었다.\n2007년에 MS에서는 Rx 라이브러리<sup id=\"fnref-10\"><a href=\"#fn-10\" class=\"footnote-ref\">10</a></sup>를 세상에 내놓았고, 이 라이브러리는 인기를 얻기 시작하였다.</p>\n<p>이러한 인기 덕에 MS에서는 Rx.NET을 오픈소스로 공개하였고, Rx가 가진 아이디어는 MS뿐만 아니라 전세계로 퍼지게 되었다.\n넷플릭스는 이러한 Rx.NET을 RxJava<sup id=\"fnref-11\"><a href=\"#fn-11\" class=\"footnote-ref\">11</a></sup>로 포팅을 하였고 2013년에 오픈소스로 공개를 하였다.</p>\n<p>이러한 영향을 받아서 리액티브 프로그래밍의 수요가 증가하면서 다양한 라이브러리들이 나오게 되었다.\n반응형 서버인 Vert.x<sup id=\"fnref-12\"><a href=\"#fn-12\" class=\"footnote-ref\">12</a></sup>는 초기에 콜백 기반 통신만 지원했지만, 이후에는 자체 솔루션을 만들어서 RxJava의 아이디어를 차용하였다.</p>\n<ul>\n<li>참고 : <a href=\"https://vertx.io/docs/vertx-reactive-streams/java/\">https://vertx.io/docs/vertx-reactive-streams/java/</a></li>\n</ul>\n<p>이렇게 리액티브 프로그래밍 생태계가 풍성해지고 있었지만 자바 진영에서는 몇 가지 문제점이 존재하였다. 다양한 리액티브 라이브러리를 함께 사용하고자 하면 충돌이 발생하거나 예기치 않는 동작이 발생하는 등 문제가 발생하였다. (데이터 스트림은 유기적으로 흘러야하는데 서로 구현한 방식이 다르다보니 문제가 발생)</p>\n<p>이에 표준 라이브러리의 필요성에 대해서 이야기가 되기 시작하였고, Netlix와 Pivotal, Lightbend의 엔지니어들이 리액티브 스트림즈라는 표준 라이브러리를 개발하였다.</p>\n<p>2015년 4월에 리액티브 스트림즈가 공식 릴리즈 되었고, 2017년 9월에 이 표준의 사용 원칙을 그대로 포팅한 것이 바로 <a href=\"https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/Flow.html\">Flow API</a>이다.\n이로써 리액티브 스트림즈가 자바의 공식 기능이 되었다.</p>\n<h2 id=\"step-23-리액티브-스트림즈\" style=\"position:relative;\"><a href=\"#step-23-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8A%A4%ED%8A%B8%EB%A6%BC%EC%A6%88\" aria-label=\"step 23 리액티브 스트림즈 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3 리액티브 스트림즈</h2>\n<p>위에서는 리액티브 프로그래밍과 리액티브 스트림즈가 왜 대두 되었는지에 대해서 설명하였다.\n한마디로 정의하면 아래와 같을 것이다.</p>\n<blockquote>\n<p>데이터 스트림을 Non-Blocking이면서 비동기적인 방식으로 처리하기 위한 리액티브 라이브러리의 표준사양</p>\n<ul>\n<li>스프링으로 시작하는 리액티브 프로그래밍, 황정식 저, p.39 -</li>\n</ul>\n</blockquote>\n<p>지금부터는 리액티브 스트림즈의 구성요소에 대해서 설명하고자 한다.</p>\n<h3 id=\"step-231-리액티브-스트림즈-구성요소\" style=\"position:relative;\"><a href=\"#step-231-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8A%A4%ED%8A%B8%EB%A6%BC%EC%A6%88-%EA%B5%AC%EC%84%B1%EC%9A%94%EC%86%8C\" aria-label=\"step 231 리액티브 스트림즈 구성요소 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3.1 리액티브 스트림즈 구성요소</h3>\n<p>구성요소는 거의 리액티브 프로그래밍의 구성요소에서 봤던 내용과 흡사하다.</p>\n<table>\n<thead>\n<tr>\n<th>구성요소</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Publisher</td>\n<td>데이터를 생성 후 방출(Emit)하는 역할</td>\n</tr>\n<tr>\n<td>Subscriber</td>\n<td>구독한 Publisher로 부터 방출된 데이터를 전달받아 처리하는 역할</td>\n</tr>\n<tr>\n<td>Subscription</td>\n<td>Publisher에 요청할 데이터의 개수를 지정하고, 구독을 취소하는 역할</td>\n</tr>\n<tr>\n<td>Processor</td>\n<td>Publisher와 Subscriber의 기능을 모두 갖고 있는 구성요소</td>\n</tr>\n</tbody>\n</table>\n<p>구성요소간 흐름을 알기 위해서 간단한 코드를 가져왔다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux <span class=\"token operator\">=</span> <span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"World\"</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tflux<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>log<span class=\"token operator\">::</span><span class=\"token function\">info</span><span class=\"token punctuation\">,</span>  \n\t\t\t\t\terror <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n\t\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"complete\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 <code class=\"language-text\">Flux</code>가 무엇이고, <code class=\"language-text\">subscribe()</code> 메서드가 무엇인지는 중요하지 않다.\n해당 코드를 동작한 후 로그를 보면 아래와 같이 나온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">14:13:08.483 [main] INFO reactor.Flux.Array.1 -- | onSubscribe([Synchronous Fuseable] FluxArray.ArraySubscription)\n14:13:08.485 [main] INFO reactor.Flux.Array.1 -- | request(unbounded)\n14:13:08.485 [main] INFO reactor.Flux.Array.1 -- | onNext(Hello)\n14:13:08.485 [main] INFO reactive.Example1 -- Hello\n14:13:08.485 [main] INFO reactor.Flux.Array.1 -- | onNext(World)\n14:13:08.485 [main] INFO reactive.Example1 -- World\n14:13:08.486 [main] INFO reactor.Flux.Array.1 -- | onComplete()\n14:13:08.486 [main] INFO reactive.Example1 -- complete</code></pre></div>\n<p>어떤식으로 동작하는 것일까? <code class=\"language-text\">Processor</code>를 제외한 3가지 구성요소의 인터페이스 메서드를 확인해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Publisher</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Subscriber</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Subscriber</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onSubscribe</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Subscription</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onNext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Subscription</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드와 함께 로그의 흐름을 같이 보면 아래와 같은 흐름으로 플로우가 흘러간다.</p>\n<ol>\n<li><code class=\"language-text\">Publisher.subscribe()</code> 메서드를 사용하여 <code class=\"language-text\">Subscriber</code>를 등록한다.</li>\n<li><code class=\"language-text\">Subscriber.onSubscribe()</code> 메서드를 통해 <code class=\"language-text\">Subscription</code>을 <code class=\"language-text\">Publisher</code>에 전달하며, 이 과정에서 <code class=\"language-text\">request()</code> 메서드를 사용하여 가져올 데이터의 개수를 결정한다.</li>\n<li><code class=\"language-text\">Publisher</code>는 <code class=\"language-text\">request()</code> 메서드에서 지정한 개수만큼 데이터를 <code class=\"language-text\">Subscriber</code>에게 방출한다. 이때, 데이터 방출에는 <code class=\"language-text\">onNext()</code> 메서드가 사용된다.</li>\n<li>데이터 방출이 정상적으로 완료되면 <code class=\"language-text\">onComplete()</code> 메서드가 호출되며, 에러가 발생한 경우 <code class=\"language-text\">onError()</code> 메서드가 실행된다.</li>\n</ol>\n<p>그림으로 보면 아래와 같다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/3cD1Zk4.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://engineering.linecorp.com/ko/blog/reactive-streams-with-armeria-1\"> 그림 5. 리액티브 스트림즈 구성요소간 연관관계( Armeria로 Reactive Streams와 놀자!-1, lkhun Um, 2020)</a></em>\n</p>\n<p>이제 다시 로그와 코드를 보기바란다.</p>\n<p>코드에서 <code class=\"language-text\">Flux</code>는 <code class=\"language-text\">Publisher</code>로 간주될 수 있다.  그리고 <code class=\"language-text\">Subscriber</code>는 로그를 출력하는 부분으로 볼 수 있다.\n<code class=\"language-text\">request()</code> 메서드에 대한 별도의 처리가 없었기 때문에 “unbounded” 요청이 발생했다. 이것은 무한 스트림을 의미한다.</p>\n<p>따라서 <code class=\"language-text\">Flux</code>에 포함된 “Hello”와 “World”라는 두 개의 데이터가 순차적으로 방출될 것이다.\n각 데이터가 방출될 때마다 자동으로 <code class=\"language-text\">OnNext()</code> 메서드가 호출된다. 그리고 에러 없이 모든 데이터가 방출되면 여기서 세 번째 파라미터로 전달된 “complete”가 출력된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">flux<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>log<span class=\"token operator\">::</span><span class=\"token function\">info</span><span class=\"token punctuation\">,</span>  \n               error <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// error</span>\n               <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"complete\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// complete</span></code></pre></div>\n<h2 id=\"step-3-project-reactor\" style=\"position:relative;\"><a href=\"#step-3-project-reactor\" aria-label=\"step 3 project reactor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. Project Reactor</h2>\n<p>위에서는 리액티브 스트림즈의 구성요소에 대해서 알아보았다. 이제 이 리액티브 스트림즈의 구현체 중에 하나인 Project Reactor<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>에 대해서 알아보고자 한다. Reactor는 스프링 프레임워크 팀 주도하에 개발된 구현체이다. 실제 WebFlux의 코어는 이 Reactor가 담당한다.</p>\n<p>아래의 코드를 다시봐보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux <span class=\"token operator\">=</span> <span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"World\"</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token operator\">::</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tflux<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>log<span class=\"token operator\">::</span><span class=\"token function\">info</span><span class=\"token punctuation\">,</span>  \n\t\t\t\t\terror <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n\t\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"complete\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>리액터에서는 <code class=\"language-text\">Publisher</code>를 크게 2가지를 제공한다.</p>\n<ol>\n<li><code class=\"language-text\">Flux</code> : 0개부터 N개의 데이터를 방출할 수 있는 <code class=\"language-text\">Publisher</code></li>\n<li><code class=\"language-text\">Mono</code> : 0개부터 1개의 데이터를 방출할 수 있는 <code class=\"language-text\">Publisher</code></li>\n</ol>\n<p>위의 코드에서는 <code class=\"language-text\">Flux.just(..)</code> 메서드를 통해서 데이터를 제공하는 것을 볼 수 있다. 여기서 “Hello” 와 “World”가 <strong>데이터 소스(Data Source)</strong> 라 볼 수 있다.  <code class=\"language-text\">Subscriber</code>는 <code class=\"language-text\">flux.subscribe(log::info)</code> 이 부분의 <code class=\"language-text\">log::info</code>라 보면된다. 이를 람다로 바꾸면 <code class=\"language-text\">data -> log.info(\"{}\", data)</code>\n와 같은 코드라 볼 수 있을 것이다. 이 람다 표현식은 <code class=\"language-text\">Consumer</code> 함수형 인터페이스로 <code class=\"language-text\">LambdaSubscriber</code><sup id=\"fnref-12\"><a href=\"#fn-12\" class=\"footnote-ref\">12</a></sup>라는 클래스에 전달되서 데이터를 처리한다.</p>\n<p>그리고 <code class=\"language-text\">just()</code> 나 <code class=\"language-text\">map()</code> 과 같은 메서드들을 <code class=\"language-text\">Operator</code>라고 부르며 원본 데이터를 가공하는 역할을 해주는 메서드들이다.</p>\n<h3 id=\"step-31-cold-sequence--hot-sequence\" style=\"position:relative;\"><a href=\"#step-31-cold-sequence--hot-sequence\" aria-label=\"step 31 cold sequence  hot sequence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.1 Cold Sequence &#x26; Hot Sequence</h3>\n<p>위에서는 간단한 리액터 예시를 토대로 설명을 진행했었다.\n이제 리액터에서 중요한 개념들을 다루고, 글을 마무리 하고자한다.</p>\n<p>먼저, 첫번째로는 Cold Sequence와 Hot Sequence다.\n이는 구독에 대한 중요한 개념이다.  표로 정리하면 아래와 같다.</p>\n<table>\n<thead>\n<tr>\n<th>종류</th>\n<th>특징</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Cold Sequence</td>\n<td>구독할 때마다 데이터 흐름이 처음부터 시작되는 Sequence</td>\n</tr>\n<tr>\n<td>Hot Sequence</td>\n<td>구독이 발생한 시점 이전에 방출된 데이터는 받지 못하고 시점 이후에 방출된 데이터를 전달 받는 Sequence</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"step-311-cold-sequence\" style=\"position:relative;\"><a href=\"#step-311-cold-sequence\" aria-label=\"step 311 cold sequence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.1.1 Cold Sequence</h3>\n<p>이제 Cold Sequence에 대해서 좀 더 알아보고자 한다. 이는 마블다이어그램을 보면 한눈에 확인할 수 있다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/uHHmQbZ.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://velog.io/@korea3611/%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8A%A4%ED%8A%B8%EB%A6%BC%EC%A6%88Reactive-Streams%EB%9E%80\"> 그림 6. Cold Sequence(리액티브 스트림즈란?, korea3611, 2022) </a></em>\n</p>\n<p>위 그림을 참고하면 구독이 언제 발생하든 방출되는 데이터는 동일하게 받는다는 것을 알 수가 있다. 이것을 코드로 구현하면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> coldSequence <span class=\"token operator\">=</span> <span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"g\"</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token operator\">::</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> coldSequence2 <span class=\"token operator\">=</span> <span class=\"token class-name\">Mono</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HI!!\"</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token operator\">::</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tcoldSequence<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>log<span class=\"token operator\">::</span><span class=\"token function\">info</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\tcoldSequence2<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>log<span class=\"token operator\">::</span><span class=\"token function\">info</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tcoldSequence<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>log<span class=\"token operator\">::</span><span class=\"token function\">info</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\tcoldSequence2<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>log<span class=\"token operator\">::</span><span class=\"token function\">info</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Flux</code> 와 <code class=\"language-text\">Mono</code>는 대표적인 Cold Sequence이다.  위 코드에 대한 결과는 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">16:50:54.421 [main] INFO reactive.ColdSequnece -- A\n16:50:54.422 [main] INFO reactive.ColdSequnece -- B\n16:50:54.422 [main] INFO reactive.ColdSequnece -- C\n16:50:54.422 [main] INFO reactive.ColdSequnece -- D\n16:50:54.422 [main] INFO reactive.ColdSequnece -- E\n16:50:54.422 [main] INFO reactive.ColdSequnece -- F\n16:50:54.422 [main] INFO reactive.ColdSequnece -- G\n16:50:54.423 [main] INFO reactive.ColdSequnece -- HI!!\n16:50:55.429 [main] INFO reactive.ColdSequnece -- A\n16:50:55.429 [main] INFO reactive.ColdSequnece -- B\n16:50:55.429 [main] INFO reactive.ColdSequnece -- C\n16:50:55.429 [main] INFO reactive.ColdSequnece -- D\n16:50:55.429 [main] INFO reactive.ColdSequnece -- E\n16:50:55.429 [main] INFO reactive.ColdSequnece -- F\n16:50:55.429 [main] INFO reactive.ColdSequnece -- G\n16:50:55.430 [main] INFO reactive.ColdSequnece -- HI!!</code></pre></div>\n<p><code class=\"language-text\">Thread.sleep(1000L)</code>을 걸어서 1초 뒤에 다시 구독하게끔 수행했지만 동일한 데이터가 방출되었음을 확인할 수 있다.</p>\n<h3 id=\"step-311-hot-sequence\" style=\"position:relative;\"><a href=\"#step-311-hot-sequence\" aria-label=\"step 311 hot sequence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.1.1 Hot Sequence</h3>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/wbJAGsW.png\">\n</p>\n<p align=\"center\">\n    <em><a href=\"https://velog.io/@korea3611/%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-%EC%8A%A4%ED%8A%B8%EB%A6%BC%EC%A6%88Reactive-Streams%EB%9E%80\"> 그림 7. Hot Sequence(리액티브 스트림즈란?, korea3611, 2022) </a></em>\n</p>\n<p>Hot Sequence는 위 그림과 같이 구독 시점마다 데이터가 달라진다.\n실제로 그러한지 한번 코드로 확인해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> hotSequence <span class=\"token operator\">=</span> <span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"e\"</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token operator\">::</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">delayElements</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">refCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\thotSequence<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# Subscribe-1 : {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2100L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\thotSequence<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# Subscribe-2 : {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2100L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\thotSequence<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# Subscribe-3 : {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>리액터에서는 Cold Sequence를 Hot Sequence를 변경해주는 다양한 메서드들을 제공해준다.</p>\n<p>위에서 예시는 <code class=\"language-text\">Flux</code>를 사용하였는데 <code class=\"language-text\">publish()</code> 메서드는 <code class=\"language-text\">ConnectableFlux&lt;T></code> 를 리턴하는 메서드로 이를 통해서 Cold Sequence인 <code class=\"language-text\">Flux</code>를 Hot Sequence로 변환할 수 있다. <code class=\"language-text\">refCount</code>는 최소 <code class=\"language-text\">Subscriber</code>의 개수로 1로 설정했다.</p>\n<p>위 코드를 동작하면 아래와 같은 결과를 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">17:00:57.252 [parallel-1] INFO reactive.HotSequence -- # Subscribe-1 : A\n17:00:58.263 [parallel-2] INFO reactive.HotSequence -- # Subscribe-1 : B\n17:00:59.266 [parallel-3] INFO reactive.HotSequence -- # Subscribe-1 : C\n17:00:59.267 [parallel-3] INFO reactive.HotSequence -- # Subscribe-2 : C\n17:01:00.273 [parallel-4] INFO reactive.HotSequence -- # Subscribe-1 : D\n17:01:00.274 [parallel-4] INFO reactive.HotSequence -- # Subscribe-2 : D\n17:01:01.279 [parallel-5] INFO reactive.HotSequence -- # Subscribe-1 : E\n17:01:01.280 [parallel-5] INFO reactive.HotSequence -- # Subscribe-2 : E\n17:01:01.280 [parallel-5] INFO reactive.HotSequence -- # Subscribe-3 : E</code></pre></div>\n<p>각 구독 시점에 따라서 값이 달라지는 점을 확인할 수 있다. 위에서는 <code class=\"language-text\">Flux</code>를 Hot Sequence로 변환했는데 뒤에서 살펴볼 <code class=\"language-text\">Sinks</code>는 <code class=\"language-text\">Flux</code> 나 <code class=\"language-text\">Mono</code>와 다르게 Hot Sequence가 기본인 녀석이다.</p>\n<h3 id=\"step-32-sinks\" style=\"position:relative;\"><a href=\"#step-32-sinks\" aria-label=\"step 32 sinks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.2 Sinks</h3>\n<p>리액티브 스트림즈의 구성요소 중에서 <code class=\"language-text\">Processor</code>라는 놈이 존재하여, <code class=\"language-text\">Subscriber</code>와 <code class=\"language-text\">Publisher</code>의 역할을 모두 할 수 있다했는데 위에서는 그 내용에서는 다루진 않았다. 물론, 리액터에서도 <code class=\"language-text\">Processor</code>를 제공했지만, 해당 기능을 개선한 <code class=\"language-text\">Sinks</code>가 나왔으니 이로 대체하여 설명하고자 한다.</p>\n<p>우선 어떤 일을 하는 녀석일까?</p>\n<blockquote>\n<p>Sinks는 리액티브 스트림즈의 Signal을 프로그래밍 방식으로 푸시할 수 있는 구조이며 Flux 또는 Mono의 의미 체계를 가진다.</p>\n<ul>\n<li>스프링으로 시작하는 리액티브 프로그래밍, Kevin, p.188 -</li>\n</ul>\n</blockquote>\n<p>무슨 얘기인지 감이 안잡히는데 이 부분은 위에서 본 로그를 보면 바로 이해할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">14:13:08.483 [main] INFO reactor.Flux.Array.1 -- | onSubscribe([Synchronous Fuseable] FluxArray.ArraySubscription)\n14:13:08.485 [main] INFO reactor.Flux.Array.1 -- | request(unbounded)\n14:13:08.485 [main] INFO reactor.Flux.Array.1 -- | onNext(Hello)\n14:13:08.485 [main] INFO reactive.Example1 -- Hello\n14:13:08.485 [main] INFO reactor.Flux.Array.1 -- | onNext(World)\n14:13:08.485 [main] INFO reactive.Example1 -- World\n14:13:08.486 [main] INFO reactor.Flux.Array.1 -- | onComplete()\n14:13:08.486 [main] INFO reactive.Example1 -- complete</code></pre></div>\n<p>이 로그를 보면, 어떤 코드였는지 기억이 날 것이다. 그러나 생각해보면 우리는 <code class=\"language-text\">onSubscribe()</code> 나 <code class=\"language-text\">onNext()</code> 메서드를 코드에서 짠 적은 없었다.\n내부적으로 <code class=\"language-text\">Flux</code>나 <code class=\"language-text\">Mono</code>가 해당 시그널을 전송했기 때문이다.</p>\n<p>그러나, <code class=\"language-text\">Sinks</code>를 사용하면 이를 프로그래밍 코드를 통해 명시적으로 처리할 수 있는 것이다.  그러면 기존 방식과 어떠한 차이가 있었을까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">int</span> tasks <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FluxSink</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> sink<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t\t<span class=\"token class-name\">IntStream</span><span class=\"token punctuation\">.</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> tasks<span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-></span> sink<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token function\">doTasks</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>taskNumber <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# create() : {}\"</span><span class=\"token punctuation\">,</span> taskNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">boundedElastic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">-></span> result <span class=\"token operator\">+</span> <span class=\"token string\">\" success!!\"</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>taskNumber <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# map(): {}\"</span><span class=\"token punctuation\">,</span> taskNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext(): {}\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>  \n  \n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">doTasks</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> taskNumber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">return</span> <span class=\"token string\">\"task\"</span> <span class=\"token operator\">+</span> taskNumber <span class=\"token operator\">+</span> <span class=\"token string\">\" result\"</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드가 복잡해보일 수 있지만 우리가 확인할 내용은 <code class=\"language-text\">subscribeOn()</code> , <code class=\"language-text\">publishOn()</code> , <code class=\"language-text\">doOnNext()</code> 와 같은 시그널을 프로그래밍 적으로 제어할 수 있다는 점이다. <code class=\"language-text\">create()</code> 메서드는 그러한 작업을 위한 대표적인 메서드이다.</p>\n<p>로그를 보면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">17:35:12.687 [parallel-2] INFO reactive.signal.OldSchool -- # create() : task1 result\n17:35:12.689 [parallel-2] INFO reactive.signal.OldSchool -- # create() : task2 result\n17:35:12.689 [parallel-2] INFO reactive.signal.OldSchool -- # create() : task3 result\n17:35:12.689 [parallel-2] INFO reactive.signal.OldSchool -- # create() : task4 result\n17:35:12.689 [parallel-2] INFO reactive.signal.OldSchool -- # create() : task5 result\n17:35:12.689 [boundedElastic-1] INFO reactive.signal.OldSchool -- # map(): task1 result success!!\n17:35:12.689 [boundedElastic-1] INFO reactive.signal.OldSchool -- # map(): task2 result success!!\n17:35:12.689 [boundedElastic-1] INFO reactive.signal.OldSchool -- # map(): task3 result success!!\n17:35:12.689 [boundedElastic-1] INFO reactive.signal.OldSchool -- # map(): task4 result success!!\n17:35:12.689 [boundedElastic-1] INFO reactive.signal.OldSchool -- # map(): task5 result success!!\n17:35:12.689 [parallel-1] INFO reactive.signal.OldSchool -- # onNext(): task1 result success!!\n17:35:12.689 [parallel-1] INFO reactive.signal.OldSchool -- # onNext(): task2 result success!!\n17:35:12.689 [parallel-1] INFO reactive.signal.OldSchool -- # onNext(): task3 result success!!\n17:35:12.689 [parallel-1] INFO reactive.signal.OldSchool -- # onNext(): task4 result success!!\n17:35:12.689 [parallel-1] INFO reactive.signal.OldSchool -- # onNext(): task5 result success!!</code></pre></div>\n<p>보면, 쓰레드 명이 다 다른점을 볼 수가 있다. 이 부분은 다음 스텝에서 다룰 예정이다. (<code class=\"language-text\">Schedulers.parallel()</code>과 같은것)\n다행히도 <code class=\"language-text\">doTasks()</code> 메서드는 초기 실행했던 쓰레드 내에서 동작을 해서 문제가 없었다.</p>\n<p>그러면 만약, 이 <code class=\"language-text\">doTasks()</code> 메서드가 멀티쓰레드로 동작하게 되면 어떤일이 벌어질까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux <span class=\"token operator\">=</span> <span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>sink <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\n\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\tsink<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread 1 - \"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span>  \n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t\t\n\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\tsink<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread 2 - \"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span>  \n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tflux<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 예시처럼 각각 별개의 쓰레드에서 데이터를 방출하는 예제가 있다고 가정해보자. 이러한 케이스에 두 쓰레드에서 방출되는 데이터로 다시 가공처리를 하려고 한다고 보면 누락이 되거나 잘못 방출된 데이터 등이 존재할 수 있다. 즉, <code class=\"language-text\">Flux.create()</code> 로 전달되는 <code class=\"language-text\">FluxSink</code>는 <strong>쓰레드 안정성을 보장해주지 않는다.</strong></p>\n<p><code class=\"language-text\">Sinks</code>는 이러한 문제를 해결해주었다고 보면된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token keyword\">int</span> tasks <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>Many</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> unicastSinks <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">many</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">unicast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux <span class=\"token operator\">=</span> unicastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">asFlux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">IntStream</span><span class=\"token punctuation\">.</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> tasks<span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t\t\tunicastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token function\">doTasks</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 멀티쓰레드 작업</span>\n\t\t\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# emitted: {}\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t\t<span class=\"token punctuation\">}</span>  \n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tflux<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">-></span> result <span class=\"token operator\">+</span> <span class=\"token string\">\" success!!\"</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# map(): {}\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext() : {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">200L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 코드의 결과를 보면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">17:56:52.598 [Thread-0] INFO reactive.signal.SinksExample -- # emitted: 1\n17:56:52.696 [Thread-1] INFO reactive.signal.SinksExample -- # emitted: 2\n17:56:52.801 [Thread-2] INFO reactive.signal.SinksExample -- # emitted: 3\n17:56:52.905 [Thread-3] INFO reactive.signal.SinksExample -- # emitted: 4\n17:56:53.011 [Thread-4] INFO reactive.signal.SinksExample -- # emitted: 5\n17:56:53.140 [parallel-2] INFO reactive.signal.SinksExample -- # map(): task1 result success!!\n17:56:53.141 [parallel-2] INFO reactive.signal.SinksExample -- # map(): task2 result success!!\n17:56:53.141 [parallel-1] INFO reactive.signal.SinksExample -- # onNext() : task1 result success!!\n17:56:53.141 [parallel-2] INFO reactive.signal.SinksExample -- # map(): task3 result success!!\n17:56:53.141 [parallel-1] INFO reactive.signal.SinksExample -- # onNext() : task2 result success!!\n17:56:53.141 [parallel-1] INFO reactive.signal.SinksExample -- # onNext() : task3 result success!!\n17:56:53.141 [parallel-2] INFO reactive.signal.SinksExample -- # map(): task4 result success!!\n17:56:53.141 [parallel-2] INFO reactive.signal.SinksExample -- # map(): task5 result success!!\n17:56:53.141 [parallel-1] INFO reactive.signal.SinksExample -- # onNext() : task4 result success!!\n17:56:53.141 [parallel-1] INFO reactive.signal.SinksExample -- # onNext() : task5 result success!!</code></pre></div>\n<p>새로운 쓰레드를 통해서 <code class=\"language-text\">emitNext()</code> 메서드를 통해서 1부터 6까지 데이터가 생성되는 상황이지만 문제없이 작동하는 것을 볼 수 있다.\n이런식으로 <code class=\"language-text\">Sinks</code>는 멀티쓰레드의 안정성을 가져갔다고 볼 수 있다.</p>\n<p>이 뿐만 아니라 여러가지 특성이 더 있는데 이는 다음 스텝에서 알아보고자 한다.</p>\n<h3 id=\"step-32-sinks-특징\" style=\"position:relative;\"><a href=\"#step-32-sinks-%ED%8A%B9%EC%A7%95\" aria-label=\"step 32 sinks 특징 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.2 Sinks 특징</h3>\n<p>잠깐 위의 코드에서 <code class=\"language-text\">Sinks</code> 를 선언하는 부분 코드를 가져와보겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>Many</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> unicastSinks <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">many</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">unicast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n\t\t\t\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p><code class=\"language-text\">Many</code>라는 값을 보면 알 수 있듯이 이 값은 0 ~ N개의 데이터가 방출가능한 <code class=\"language-text\">Flux</code>와 비슷한 개념이라고 볼 수 있다.\n그렇다면, <code class=\"language-text\">Mono</code>는 없는가? <code class=\"language-text\">Sinks.One()</code> 가 바로 <code class=\"language-text\">Mono</code>와 대치된다고 보면된다.</p>\n<p>코드로 보면 아래와 같이 <code class=\"language-text\">Mono</code> 나 <code class=\"language-text\">Flux</code>로 변환을 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>One</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> sinksOne <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">one</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> mono <span class=\"token operator\">=</span> sinksOne<span class=\"token punctuation\">.</span><span class=\"token function\">asMono</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n<span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>Many</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> manySinks <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">many</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unicast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux <span class=\"token operator\">=</span> manySinks<span class=\"token punctuation\">.</span><span class=\"token function\">asFlux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그렇다면, 데이터 방출은 어떻게 할 수 있을까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>One</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> sinksOne <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">one</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> mono <span class=\"token operator\">=</span> sinksOne<span class=\"token punctuation\">.</span><span class=\"token function\">asMono</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nsinksOne<span class=\"token punctuation\">.</span><span class=\"token function\">emitValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nmono<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같이 처리할 수 있다. 근데 <code class=\"language-text\">emitValue()</code>의 두번째 파라미터인 <code class=\"language-text\">Sinks.EmitFailureHandler.FAIL_FAST</code> 은 무엇일까?\n이는 멀티쓰레드 예시 코드에서도 봤던 내용이다. <code class=\"language-text\">Publisher</code> 쪽에서 데이터 방출이 실패했을 때 처리되는 핸들러로 <code class=\"language-text\">FAIL_FAST</code> 전략을 취하면 재시도 하지 않고 즉시 실패처리하는 전략이다.\n<code class=\"language-text\">Sinks</code>는 이러한 에러 핸들러를 통해서 쓰레드 간의 경합 등으로 발생하는 교착 상태등을 미연에 방지하게끔 설계되었다.</p>\n<p><code class=\"language-text\">Sinks.many()</code>인 경우에는 여러가지 스펙들이 존재한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ManySpec</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">UnicastSpec</span> <span class=\"token function\">unicast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token class-name\">MulticastSpec</span> <span class=\"token function\">multicast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t<span class=\"token class-name\">MulticastReplaySpec</span> <span class=\"token function\">replay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>각 스펙별 특징을 정리하면 아래와 같다.</p>\n<table>\n<thead>\n<tr>\n<th>스펙 종류</th>\n<th>특징</th>\n<th>선언 방법</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>UnicastSpec</td>\n<td>1개의 <code class=\"language-text\">Subscriber</code>만 구독 가능한 <code class=\"language-text\">Publisher</code> 스펙이다</td>\n<td><code class=\"language-text\">Sinks.unicast().onBackpressureBuffer()</code></td>\n</tr>\n<tr>\n<td>MulticastSpec</td>\n<td>N개의 <code class=\"language-text\">Subscriber</code>가 구독 가능한 <code class=\"language-text\">Publisher</code> 스펙이다</td>\n<td><code class=\"language-text\">Sinks.multicast().onBackpressureBuffer()</code></td>\n</tr>\n<tr>\n<td>MulticastReplaySpec</td>\n<td>N개의 <code class=\"language-text\">Subscriber</code>가 구독 가능한 <code class=\"language-text\">Publisher</code> 스펙이며, 방출된 데이터를 다시 방출하는 기능을 갖고 있다.</td>\n<td><code class=\"language-text\">Sinks.replay().onBackpressureBuffer()</code></td>\n</tr>\n</tbody>\n</table>\n<p>JPA랑 비교하자면, <code class=\"language-text\">UnicastSpec</code>은 <code class=\"language-text\">@OneToOne</code> 이라고 볼 수 있고 <code class=\"language-text\">MulticastSpec</code>은 <code class=\"language-text\">@OneToMany</code>와 비슷하다고 볼 수 있다.\n또한, <code class=\"language-text\">MulticastSpec</code>은 위에서 얘기한 Hot Sequence의 특징을 지니고 있기에 다시 기존 데이터를 방출을 해야할 경우에 <code class=\"language-text\">MulticastReplaySpec</code>을 사용한다.\n뒤에 <code class=\"language-text\">onBackPressureBuffer()</code> 메서드는 배압을 설명하면서 같이 설명하도록 하겠다.</p>\n<p>그 전에 실제 사용방법을 코드로 확인해보자</p>\n<ul>\n<li><code class=\"language-text\">UnicastSpec</code> 구현 코드</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  \n\t<span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>Many</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> unicastSinks <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">many</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unicast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tunicastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\tunicastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"World\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux <span class=\"token operator\">=</span> unicastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">asFlux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\tflux<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">// flux.subscribe(data -> log.info(\"{}\", data)); 주석을 풀면 IllegalStateException : Sinks.many().unicast() sinks only allow a single Subscriber 라는 에러가 뜨는데 구독을 1개만 등록할 수 있기 때문이다.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">MulticastSpec</code> 구현 코드</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>Many</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> multicastSinks <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">many</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">multicast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux2 <span class=\"token operator\">=</span> multicastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">asFlux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n  \nmulticastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \nmulticastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"World\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nflux2<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# Subscriber-1 {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nflux2<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# Subscriber-2 {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nmulticastSinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Reactor\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>위에서 얘기한 것처럼 <code class=\"language-text\">MulticastSpec</code> 의 경우에는 Hot Sequence의 특징을 가지게 된다.\n그래서 로그를 찍어보면 아래와 같은 결과가 나온다.</p>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">21:02:06.163 [main] INFO reactive.sinks.SinkManyExample -- # Subscriber-1 Hello\n21:02:06.163 [main] INFO reactive.sinks.SinkManyExample -- # Subscriber-1 World\n21:02:06.163 [main] INFO reactive.sinks.SinkManyExample -- # Subscriber-1 Reactor\n21:02:06.163 [main] INFO reactive.sinks.SinkManyExample -- # Subscriber-2 Reactor</code></pre></div>\n<p>따라서 2번째 <code class=\"language-text\">Subscriber</code>는 구독 이전 시점에 방출된 데이터는 받을 수가 없고, <code class=\"language-text\">Reactor</code>만 받는 것을 확인할 수 있다.\n만약, 이때 이전 방출 데이터를 받고자 하면 어떻게 해야될까?</p>\n<p>그럴 때 사용하는 것이 바로 <code class=\"language-text\">MulticastReplaySpec</code>이다.</p>\n<ul>\n<li><code class=\"language-text\">MulticastReplaySpec</code> 구현</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>Many</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> multicastReplaySinks <span class=\"token operator\">=</span> <span class=\"token class-name\">Sinks</span><span class=\"token punctuation\">.</span><span class=\"token function\">many</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token class-name\">Flux</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flux3 <span class=\"token operator\">=</span> multicastReplaySinks<span class=\"token punctuation\">.</span><span class=\"token function\">asFlux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nmulticastReplaySinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \nmulticastReplaySinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"World\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nflux3<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# Replay Subscriber-1 {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nflux3<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# Replay Subscriber-2 {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \nmulticastReplaySinks<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Reactor\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">21:06:56.887 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-1 Hello\n21:06:56.887 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-1 World\n21:06:56.888 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-2 Hello\n21:06:56.888 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-2 World\n21:06:56.888 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-1 Reactor\n21:06:56.888 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-2 Reactor</code></pre></div>\n<p>여기서 <code class=\"language-text\">replay().all()</code> 메서드는 다시 모든 데이터를 방출하는 메서드이다. <code class=\"language-text\">limit()</code> 과 같이 이전에 몇개까지만 되돌려서 방출할 수도 있다.</p>\n<p><code class=\"language-text\">Sinks.Many&lt;String> multicastReplaySinks = Sinks.many().replay().limit(1); </code></p>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">21:09:04.768 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-1 World\n21:09:04.768 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-2 World\n21:09:04.768 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-1 Reactor\n21:09:04.768 [main] INFO reactive.sinks.SinkManyExample -- # Replay Subscriber-2 Reactor</code></pre></div>\n<p>마지막 결과인 “Reactor” 직전 값인 “World”까지 찍히는 것을 볼 수 있다.</p>\n<h3 id=\"step-33-배압backpressure\" style=\"position:relative;\"><a href=\"#step-33-%EB%B0%B0%EC%95%95backpressure\" aria-label=\"step 33 배압backpressure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.3 배압(Backpressure)</h3>\n<p>위에서 <code class=\"language-text\">Sinks.multicast().onBackpressureBuffer()</code> 와 같이 선언하는 부분을 우리는 보았었다.\n그렇다면 Backpressure는 번역서에 주로 배압으로 나온다. 그렇다면 <code class=\"language-text\">onBackpressureBuffer()</code> 는 무언가 배압처리를 위한 버퍼를 선언하는 것이라 볼 수 있다.</p>\n<p>그러면 배압이란 무엇일까? 리액티브 선언문을 잘 기억하면 비동기 메시지 기반 통신 위에서 이뤄진다고 하였다.</p>\n<blockquote>\n<p>그렇다면, 만약에 <code class=\"language-text\">Publisher</code>가 <code class=\"language-text\">Subscriber</code>가 처리하는 속도보다 빠르게 데이터를 방출하게 될 경우 어떻게 될까?\n반대로 <code class=\"language-text\">Subscriber</code>가 처리하는 속도가 빨라 <code class=\"language-text\">Publisher</code> 가 방출하는 데이터 속도가 느리면 어떻게 될까?</p>\n</blockquote>\n<p>이 두 가지 내용을 바로 “Producer-consumer problem”<sup id=\"fnref-13\"><a href=\"#fn-13\" class=\"footnote-ref\">13</a></sup> 이라 부른다. 이 문제에 대해서 다루기에는 범위가 벗어나므로 독자분들께서 검색을 통해서 확인해보기 바란다.\n결론적으로 이 흐름 제어 혹은 속도 제어를 적절하게 수행해야 리액티브 선언문에 작성된 탄력성을 보장할 수 있을 것이다.</p>\n<p>그러한 역할을 하는 것이 배압이다.  위에서 리액터 프로그래밍을 설명할 때 <code class=\"language-text\">Subscription</code>의 <code class=\"language-text\">request()</code> 메서드에 갯수를 통해서 몇개씩만 요청을 보내는 식으로 처리할 수 있다고 하였다.\n이 부분은 생략하고 배압 전략에서만 보고자 한다.</p>\n<h3 id=\"step-331-배압-전략\" style=\"position:relative;\"><a href=\"#step-331-%EB%B0%B0%EC%95%95-%EC%A0%84%EB%9E%B5\" aria-label=\"step 331 배압 전략 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.3.1 배압 전략</h3>\n<table>\n<thead>\n<tr>\n<th>종류</th>\n<th>특징</th>\n<th>선언 방법</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">IGNORE</code></td>\n<td>배압을 적용하지 않는 전략</td>\n<td>생략</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">ERROR</code></td>\n<td>다운스트림으로 전달할 데이터가 버퍼에 가득 찰 경우, <code class=\"language-text\">Exception</code> 발생시키는 전략</td>\n<td><code class=\"language-text\">.onBackpressureError()</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">DROP</code></td>\n<td>다운스트림으로 전달할 데이터가 버퍼에 가득 찰 경우, 버퍼 밖 방출된 데이터를 버리는 전략</td>\n<td><code class=\"language-text\">.onBackpressureDrop()</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">LATEST</code></td>\n<td>다운스트림으로 전달할 데이터가 버퍼에 가득 찰 경우, 버퍼 밖에서 가장 최근에 방출된 데이터부터 버퍼에 채우는 전략</td>\n<td><code class=\"language-text\">.onBackpressureLatest()</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">BUFFER</code></td>\n<td>다운스트림으로 전달할 데이터가 버퍼에 가득 찰 경우, 버퍼 안에 있는 데이터부터 버리는 전략</td>\n<td><code class=\"language-text\">.onBackpressureBuffer()</code></td>\n</tr>\n</tbody>\n</table>\n<p>각 전략에 대해서 코드를 살펴보자.</p>\n<ul>\n<li><code class=\"language-text\">ERROR</code> 전략</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">interval</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofMillis</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>  \n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  \n\t\t\terror <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onError\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">...\n21:30:24.254 [parallel-1] INFO backpressure.BackPressureStrategyEx1 -- # onNext: 254\n21:30:24.259 [parallel-1] INFO backpressure.BackPressureStrategyEx1 -- # onNext: 255\n21:30:24.260 [parallel-1] ERROR backpressure.BackPressureStrategyEx1 -- # onError\nreactor.core.Exceptions$OverflowException: The receiver is overrun by more signals than expected (bounded queue...)\n\tat reactor.core.Exceptions.failWithOverflow(Exceptions.java:236)\n...</code></pre></div>\n<ul>\n<li>마블 다이어그램</li>\n</ul>\n<p><img src=\"https://i.imgur.com/ObLmi1n.png\" alt=\"\"></p>\n<p>배압 버퍼는 별도 설정이 없다면 기본 사이즈가 255개이다. 그러니 256개째 데이터가 인입되려고 하는 순간 익셉션이 발생하는 모습을 볼 수가 있다.</p>\n<ul>\n<li><code class=\"language-text\">DROP</code> 전략</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">interval</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofMillis</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureDrop</span><span class=\"token punctuation\">(</span>dropped <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# dropped: {}\"</span><span class=\"token punctuation\">,</span> dropped<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>  \n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  \n\t\t\terror <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onError\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">...\n21:32:30.255 [parallel-1] INFO backpressure.BackPressureStrategyEx2 -- # onNext: 40\n21:32:30.255 [parallel-2] INFO backpressure.BackPressureStrategyEx2 -- # dropped: 256\n21:32:30.256 [parallel-2] INFO backpressure.BackPressureStrategyEx2 -- # dropped: 257\n21:32:30.257 [parallel-2] INFO backpressure.BackPressureStrategyEx2 -- # dropped: 258\n21:32:30.258 [parallel-2] INFO backpressure.BackPressureStrategyEx2 -- # dropped: 259\n21:32:30.259 [parallel-2] INFO backpressure.BackPressureStrategyEx2 -- # dropped: 260\n21:32:30.260 [parallel-2] INFO backpressure.BackPressureStrategyEx2 -- # dropped: 261\n21:32:30.261 [parallel-2] INFO backpressure.BackPressureStrategyEx2 -- # dropped: 262\n21:32:30.261 [parallel-1] INFO backpressure.BackPressureStrategyEx2 -- # onNext: 41\n...</code></pre></div>\n<ul>\n<li>마블 다이어그램</li>\n</ul>\n<p><img src=\"https://i.imgur.com/SROqaTm.png\" alt=\"\"></p>\n<p>버퍼에 들어가있는 데이터가 처리되기 이전에 빠르게 <code class=\"language-text\">Publisher</code>가 데이터를 방출하고 있는 상황이며, 버퍼에 인입되지 않은 방출 데이터는 버리는 전략이다.</p>\n<ul>\n<li><code class=\"language-text\">LATEST</code> 전략</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">interval</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofMillis</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureLatest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>  \n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">...\n21:35:02.193 [parallel-1] INFO backpressure.BackPressureStrategyEx3 -- # onNext: 254\n21:35:02.199 [parallel-1] INFO backpressure.BackPressureStrategyEx3 -- # onNext: 255\n21:35:02.206 [parallel-1] INFO backpressure.BackPressureStrategyEx3 -- # onNext: 1180\n21:35:02.212 [parallel-1] INFO backpressure.BackPressureStrategyEx3 -- # onNext: 1181\n...</code></pre></div>\n<ul>\n<li>마블 다이어그램</li>\n</ul>\n<p><img src=\"https://i.imgur.com/E4zYiCx.png\" alt=\"\"></p>\n<p>이 전략은 버퍼가 가득차있을 경우에 가장 최근에 인입된 데이터부터 채워놓는데 그 전에 있는 데이터는 지워진다.\n마블 다이어그램을 보면, 버퍼에 주황색이 있었지만 <code class=\"language-text\">request(2)</code> 를 수행했을 시점에 그 전에 인입된 주황색은 날라갔고, 최신값인 보라색을 얻게 된다.</p>\n<ul>\n<li><code class=\"language-text\">BUFFER</code> 전략</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">interval</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofMillis</span><span class=\"token punctuation\">(</span><span class=\"token number\">300L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# emitted by original Flux: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">onBackpressureBuffer</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>  \n\t\t\tdropped <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"** Overflow &amp; Dropped: {} **\"</span><span class=\"token punctuation\">,</span> dropped<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n\t\t\t<span class=\"token class-name\">BufferOverflowStrategy</span><span class=\"token punctuation\">.</span>DROP_LATEST\n\t\t<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ # emitted by Buffer: {}]\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>  \n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> error <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onError\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">...\n21:46:31.853 [parallel-2] INFO backpressure.BackPressureStrategyEx4 -- # emitted by original Flux: 0\n21:46:31.855 [parallel-2] INFO backpressure.BackPressureStrategyEx4 -- [ # emitted by Buffer: 0]\n21:46:32.151 [parallel-2] INFO backpressure.BackPressureStrategyEx4 -- # emitted by original Flux: 1\n21:46:32.451 [parallel-2] INFO backpressure.BackPressureStrategyEx4 -- # emitted by original Flux: 2\n21:46:32.749 [parallel-2] INFO backpressure.BackPressureStrategyEx4 -- # emitted by original Flux: 3\n21:46:32.749 [parallel-2] INFO backpressure.BackPressureStrategyEx4 -- ** Overflow &amp; Dropped: 3 **\n...</code></pre></div>\n<ul>\n<li>마블 다이어그램</li>\n</ul>\n<p><img src=\"https://i.imgur.com/SPiVdNC.png\" alt=\"\"></p>\n<p>이 전략은 버퍼의 최대 크기를 설정하여 처리할 수 있는 전략으로 버퍼에 추가로 <code class=\"language-text\">BufferOverflowStrategy</code> 를 적용할 수 있다.\n마블 다이어그램에서는 <code class=\"language-text\">DROP_OLDEST</code> 라 되어있는데 이는 가장 오래된 데이터부터 버리는 전략이다.</p>\n<p>즉, 노란색이 존재했고 주황색이 채워진 상황에서 보라색을 넣을 때 오버플로우가 발생했고 <code class=\"language-text\">OLDEST</code> 전략이므로 노란색이 지워진 것이다.\n예시 코드는 <code class=\"language-text\">BufferOverflowStrategy.DROP_LATEST</code> 로 적용했기 때문에 오히려 보라색이 버퍼에 인입이 안될 것이다.</p>\n<h3 id=\"step-34-스케줄러\" style=\"position:relative;\"><a href=\"#step-34-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC\" aria-label=\"step 34 스케줄러 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.4 스케줄러</h3>\n<p>마지막으로 살펴볼 리액터의 마지막 구성요소 중 하나는 스케줄러이다.  우리는 이미 이것을 예시코드로 보긴했다.\n<code class=\"language-text\">.subscribeOn(Schedulers.parallel())</code> 와 같은 코드들에서 쓰이는 것이 바로 스케줄러이다.</p>\n<p>이 스케줄러는 리액터에서 제공하는 것으로 <strong>쓰레드를 관리해주는 관리자 역할을 수행</strong>을 하는데 이를 설명하기 앞서 컴퓨팅에서 사용하는 쓰레드의 종류에 대해서 간략히 알고 갈 필요가 있다.</p>\n<h3 id=\"step-341-쓰레드의-종류\" style=\"position:relative;\"><a href=\"#step-341-%EC%93%B0%EB%A0%88%EB%93%9C%EC%9D%98-%EC%A2%85%EB%A5%98\" aria-label=\"step 341 쓰레드의 종류 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.4.1 쓰레드의 종류</h3>\n<p>쓰레드는 2가지 종류가 존재한다.</p>\n<ol>\n<li><strong>물리적 쓰레드(Physical Thread)</strong> : 코어에 나눠진 실제 하드웨어와 연관된 쓰레드</li>\n<li><strong>논리적 쓰레드(Logical Thread)</strong> : 물리적 쓰레드를 논리적인 단위로 나눈 쓰레드</li>\n</ol>\n<p>필자는 현재 M1 Pro 맥북을 사용하고 있는데 <code class=\"language-text\">sysctl -a | grep cpu</code> 명령어를 통해서 물리적 쓰레드를 확인할 수 있다.</p>\n<p><img src=\"https://i.imgur.com/E0WejdQ.png\" alt=\"\"></p>\n<p>위 명령어에 의하면 M1 Pro는 8개의 코어로 이뤄진 CPU이고, 코어당 1개의 물리적 쓰레드를 가진다는 점을 확인할 수 있다.\n논리적 쓰레드는 이 물리적 쓰레드를 소프트웨어적으로 나눠서 사용하는 것이며, 흔히 자바에서 얘기하는 쓰레드는 대부분 논리적 쓰레드이다.</p>\n<p>이 두 가지 종류의 쓰레드에 대해서 알아야하는 이유는 이 두 가지 쓰레드가 각기 다른 특징을 갖고 있기 때문이다.</p>\n<p>물리적 쓰레드는 <strong>병렬성(Parallelism)</strong> 과 연관이 되어있는데 실제로 동시에 수행할 수 있기 때문이다. (실제 나눠진 별도 코어에서 동시 수행)\n논리적 쓰레드는 <strong>동시성(Concurrency)</strong> 와 연관이 되어있는데 이는 사람 눈에는 동시에 수행되는 것처럼 보이지만 인간의 눈으로 인지가 불가능한 매우 짧은 속도로 서로 쓰레드간 문맥교환이 이뤄지기 때문이다.</p>\n<p>이 내용이 좀 더 궁금하면 아래의 참고자료를 확인해보자.</p>\n<ul>\n<li><a href=\"https://freecontent.manning.com/concurrency-vs-parallelism/\">Concurrency vs Parallelism - MANNING FREE CONTENT CENTER</a></li>\n</ul>\n<h3 id=\"step-342-스케줄러의-동작-원리\" style=\"position:relative;\"><a href=\"#step-342-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC%EC%9D%98-%EB%8F%99%EC%9E%91-%EC%9B%90%EB%A6%AC\" aria-label=\"step 342 스케줄러의 동작 원리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.4.2 스케줄러의 동작 원리</h3>\n<p>스케줄러는 일단 전용 연산자(Operator)가 존재한다 그것이 <code class=\"language-text\">subscribeOn</code> 이나 <code class=\"language-text\">publishOn</code>과 같은 연산자이다.\n그러면 전달된 스케줄러에 의해서 다음 연산은 전달된 스케줄러의 종류에 따른 쓰레드에 해당 작업이 할당되게 되는 방식이다.</p>\n<ul>\n<li><code class=\"language-text\">subscribeOn</code> 예시코드</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnSubscribe</span><span class=\"token punctuation\">(</span>subscription <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnSubscribe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">22:24:27.487 [main] INFO reactive.schedule.SubscribeOnEx -- # doOnSubscribe\n22:24:27.490 [boundedElastic-1] INFO reactive.schedule.SubscribeOnEx -- # doOnNext 1\n22:24:27.491 [boundedElastic-1] INFO reactive.schedule.SubscribeOnEx -- # onNext 1\n22:24:27.491 [boundedElastic-1] INFO reactive.schedule.SubscribeOnEx -- # doOnNext 2\n22:24:27.491 [boundedElastic-1] INFO reactive.schedule.SubscribeOnEx -- # onNext 2\n22:24:27.491 [boundedElastic-1] INFO reactive.schedule.SubscribeOnEx -- # doOnNext 3\n22:24:27.491 [boundedElastic-1] INFO reactive.schedule.SubscribeOnEx -- # onNext 3\n...</code></pre></div>\n<p>초기에는 <code class=\"language-text\">main</code> 쓰레드에서 구독이 수행되었고, 이후 <code class=\"language-text\">boundedElastic-1</code> 쓰레드에서 수행된 것을 확인할 수 있다.  <code class=\"language-text\">doOnNext</code> 이후 연산에서는 별도 <code class=\"language-text\">Scheduler</code> 를 적용하지 않아 <code class=\"language-text\">subscribe</code>의 결과 역시 <code class=\"language-text\">boundedElastic-1</code> 쓰레드에서 수행되었음을 확인할 수 있다.</p>\n<ul>\n<li><code class=\"language-text\">publishOn</code> 예시코드</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext() : {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnSubscribe</span><span class=\"token punctuation\">(</span>subscription <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnSubscribe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext() : {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">22:30:25.355 [main] INFO reactive.schedule.PublishOnEx -- # doOnSubscribe\n22:30:25.360 [main] INFO reactive.schedule.PublishOnEx -- # doOnNext() : 1\n22:30:25.361 [main] INFO reactive.schedule.PublishOnEx -- # doOnNext() : 2\n22:30:25.361 [main] INFO reactive.schedule.PublishOnEx -- # doOnNext() : 3\n22:30:25.361 [parallel-1] INFO reactive.schedule.PublishOnEx -- # onNext() : 1\n22:30:25.361 [parallel-1] INFO reactive.schedule.PublishOnEx -- # onNext() : 2\n22:30:25.361 [parallel-1] INFO reactive.schedule.PublishOnEx -- # onNext() : 3</code></pre></div>\n<p><code class=\"language-text\">PublishOn()</code> 메서드는 이후 다운스트림(<code class=\"language-text\">subscribe()</code>)의 동작에 대한 쓰레드 제어를 할 수 있다.\n그래서 로그를 보면 초기 구독 발생 시에는 메인 쓰레드로 동작하였으나 <code class=\"language-text\">publishOn(Schedulers.parallel())</code>  이후 처리는 <code class=\"language-text\">parallel-1</code> 쓰레드에서 동작함을 볼 수 있다.</p>\n<p>위 결과를 그림으로 보면 아래와 같다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/zcVz4iU.png\">\n</p>\n<p align=\"center\">\n    <em>그림 8. 아무 스케줄러가 적용안됐을 때 경우</em>\n</p>\n<p>별도 스케줄러 설정이 없다면 위와 같이 모든 연산이 전부 메인쓰레드에서 동작할 것이다.\n그러면 위 예시에 본 것처럼 <code class=\"language-text\">publishOn()</code>이 추가되면 어떤식으로 변경될까?</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/sf2blBp.png\">\n</p>\n<p align=\"center\">\n    <em>그림 9. publishOn이 중간에 추가된 경우</em>\n</p>\n<p>이런식으로 <code class=\"language-text\">publishOn</code> 에 전달된 스케줄러에 따른 쓰레드로 변경이 될 것이다.\n그러면 또 <code class=\"language-text\">publishOn</code> 을 추가해도 쓰레드가 다시 변경이 될까?</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/X5bwYke.png\">\n</p>\n<p align=\"center\">\n    <em>그림 9. publishOn을 2번 적용한 경우</em>\n</p>\n<p>실제로 중간 연산 사이에 <code class=\"language-text\">publishOn()</code> 을 다시 추가하면 쓰레드가 변경이 된다. 이를 코드로 표현해보면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnSubscribe</span><span class=\"token punctuation\">(</span>subscription <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnSubscribe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">boundedElastic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext fromArray: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> data <span class=\"token operator\">></span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext filter: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> data <span class=\"token operator\">*</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext map: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">500L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">22:41:23.504 [main] INFO reactive.schedule.MultiplePublishOnEx -- # doOnSubscribe\n22:41:23.507 [boundedElastic-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext fromArray: 1\n22:41:23.508 [boundedElastic-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext fromArray: 3\n22:41:23.508 [boundedElastic-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext fromArray: 5\n22:41:23.508 [boundedElastic-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext filter: 5\n22:41:23.508 [boundedElastic-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext fromArray: 7\n22:41:23.508 [boundedElastic-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext filter: 7\n22:41:23.508 [parallel-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext map: 50\n22:41:23.508 [parallel-1] INFO reactive.schedule.MultiplePublishOnEx -- # onNext: 50\n22:41:23.508 [parallel-1] INFO reactive.schedule.MultiplePublishOnEx -- # doOnNext map: 70\n22:41:23.508 [parallel-1] INFO reactive.schedule.MultiplePublishOnEx -- # onNext: 70</code></pre></div>\n<p>보면 실제 그림과 결과가 같음을 볼수가 있다. 메인 쓰레드에서 <code class=\"language-text\">boundedElastic-1</code> 그리고 <code class=\"language-text\">parallel-1</code> 쓰레드로 변경된 모습을 확인 할 수 있다.</p>\n<p>이후 로그를 보면 <code class=\"language-text\">publishOn()</code> 과 <code class=\"language-text\">subscribeOn()</code>을 같이 썼을 때도 마찬가지의 결과를 보여준다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/3hlB23K.png\">\n</p>\n<p align=\"center\">\n    <em>그림 10. subscribeOn과 publishOn을 적용한 경우</em>\n</p>\n<ul>\n<li>예시 코드</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>  \n\t<span class=\"token class-name\">Flux</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnSubscribe</span><span class=\"token punctuation\">(</span>subscription <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnSubscribe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">boundedElastic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext fromArray: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> data <span class=\"token operator\">></span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext filter: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">publishOn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Schedulers</span><span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> data <span class=\"token operator\">*</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>  \n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# doOnNext map: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>data <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"# onNext: {}\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">500L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>결과</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">22:44:09.965 [boundedElastic-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnSubscribe\n22:44:09.967 [boundedElastic-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext fromArray: 1\n22:44:09.967 [boundedElastic-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext fromArray: 3\n22:44:09.967 [boundedElastic-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext fromArray: 5\n22:44:09.967 [boundedElastic-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext filter: 5\n22:44:09.967 [boundedElastic-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext fromArray: 7\n22:44:09.967 [boundedElastic-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext filter: 7\n22:44:09.967 [parallel-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext map: 50\n22:44:09.968 [parallel-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # onNext: 50\n22:44:09.968 [parallel-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # doOnNext map: 70\n22:44:09.968 [parallel-1] INFO reactive.schedule.SubscribeOnAndPublishOnEx -- # onNext: 70</code></pre></div>\n<p><code class=\"language-text\">subscibeOn()</code> 메서드는 구독이 발생한 직후에 쓰레드를 지정하는 연산자로 <code class=\"language-text\">doOnSubscribe</code> 자체가 <code class=\"language-text\">boundedElastic-1</code> 쓰레드에서 수행되고 <code class=\"language-text\">publishOn()</code> 메서드를 만나 다시 <code class=\"language-text\">parallel-1</code> 쓰레드로 변환하는 것을 볼 수가 있다.</p>\n<p>이러한 방식을 토대로 서두에 얘기했던 콜백 방식과 다르게 <code class=\"language-text\">Schedulers</code> 에서 제공하는 쓰레드를 통해서 각 연산마다 원하는 쓰레드에 작업을 처리할 수 있고 이는 개발자의 멀티 쓰레딩 핸들링에 대한 번거로움을 많이 줄여주었다.</p>\n<p>이제 마지막으로 스케줄러가 제공하는 쓰레드의 종류에 대해서 설명하고 포스팅을 마무리를 짓겠다.</p>\n<h3 id=\"step-342-스케줄러의-종류\" style=\"position:relative;\"><a href=\"#step-342-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC%EC%9D%98-%EC%A2%85%EB%A5%98\" aria-label=\"step 342 스케줄러의 종류 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.4.2 스케줄러의 종류</h3>\n<p>종류에 대해서 간단한 특징과 선언 방법에서 표로 간단하게 알아보고 설명을 하고자 한다.\n여기서 선언 방법 예시는 <code class=\"language-text\">publishOn()</code> 으로 통일하였는데 다른 연산자로도 선언할 수 있으나 편의를 위해서 통일하였다.</p>\n<table>\n<thead>\n<tr>\n<th>종류</th>\n<th>특징</th>\n<th>선언 방법 예시</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">Schedulers.immediate()</code></td>\n<td>별도의 쓰레드를 생성하지 않고 현재 쓰레드에서 작업을 처리하는 스케줄러</td>\n<td><code class=\"language-text\">.publishOn(Schedulers.immediate())</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">Schedulers.single()</code></td>\n<td>쓰레드를 1개만 생성하여 스케줄러가 제거되기 전까지 재사용하는 방식</td>\n<td><code class=\"language-text\">.publishOn(Schedulers.single())</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">Schedulers.newSingle()</code></td>\n<td><code class=\"language-text\">Schedulers.single()</code> 은 1개의 쓰레드를 재사용하지만 <code class=\"language-text\">Schedulers.newSingle()</code> 는 호출할 때마다 새로운 쓰레드를 1개씩 생성하는 방식</td>\n<td><code class=\"language-text\">.publishOn(Schedulers.newSingle(String name, boolean daemon))</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">Schedulers.boundedElastic()</code></td>\n<td><code class=\"language-text\">ExecutorService</code> 기반의 쓰레드 풀을 생성한 후 해당 풀의 쓰레드를 사용하여 처리하고 재사용하는 방식</td>\n<td><code class=\"language-text\">.publishOn(Schedulers.boundedElastic()</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">Schedulers.parallel()</code></td>\n<td>CPU 코어 수만큼의 쓰레드를 생성하는 방식</td>\n<td><code class=\"language-text\">.publishOn(Schedulers.parallel()</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">Schedulers.fromExecutorService()</code></td>\n<td>기존에 사용하고 있던 <code class=\"language-text\">ExecutorService</code>가 있다면 이것을 사용하는 방식(리액터에서는 <code class=\"language-text\">ExecutorService</code> 직접 생성은 권장하지 않음)</td>\n<td><code class=\"language-text\">.publishOn(Schedulers.fromExecutorService()</code></td>\n</tr>\n</tbody>\n</table>\n<p>이 스케줄러에 따른 동작 예시 코드는 많은데서 얻을 수 있으니 위에 나온 스케줄러 중에 부연설명이 필요한 스케줄러에 대한 내용만 추가하고 마무리를 짓고자 한다.</p>\n<ol>\n<li><code class=\"language-text\">Schedulers.immediate()</code> : 이 스케줄러를 주로 사용할 때는 <code class=\"language-text\">publishOn()</code> 메서드로 다른 쓰레드에서 작업하던 내용을 원래 실행되던 쓰레드에서 수행하고자할 때 쓰일 수 있다.</li>\n<li><code class=\"language-text\">Schedulers.newSingle(String name, boolean daemon)</code> :  <code class=\"language-text\">newSingle()</code> 스케줄러는 추가되는 쓰레드를 데몬 쓰레드로 동작할지 안할지 여부를 받을 수 있다. 데몬 쓰레드는 주 쓰레드가 종료되면 자동 종료되는 특성이 있다.</li>\n<li><code class=\"language-text\">Schedulers.boundedElastic()</code> : 쓰레드 풀을 생성하여 해당 쓰레드 풀에서 쓰레드를 사용하고 종료 이후에 재사용하는 방식이기 때문에 블록킹 I/O 작업에 유용한데 별도 쓰레드 풀에 격리가 되기 떄문에 다른 논블록킹 작업에 영향을 줄일 수 있다.</li>\n<li><code class=\"language-text\">Schedulers.parallel()</code> : CPU 코어 수만큼 쓰레드가 생성되기 때문에 이는 논블록킹 작업에 특화되어있다고 볼 수 있다.</li>\n</ol>\n<h1 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h1>\n<p>원래라면 <code class=\"language-text\">Context</code>도 다루고자했는데 이는 나중에 <code class=\"language-text\">WebFlux</code>와 <code class=\"language-text\">Netty</code>를 다룰 때 설명을 해보고자 한다.\n이번 포스팅에 대해서 간단하게 정리해보자.</p>\n<p>먼저, 리액티브 시스템이 어떤 것인지와 왜 대두가 되었는지 그리고 리액티브 프로그래밍에 대해서 역사와 함께 설명을 하였다.\n그 이후에 리액티브 스트림즈라는 표준 라이브러리에 대해서도 왜 탄생했는지 알게되었다.</p>\n<p>우리는 그 리액티브 스트림즈 구현체 중에 프로젝트 리액터를 기준으로 각 구성요소와 특성들을 알아보았다.</p>\n<p>요즘 리액티브는 어떻게 보면 위기라고 볼 수 있을 것이다.\n웹 플럭스에서도 많은 개발자들은 리액티브 프로그래밍에 대해 익숙하지 않다보니 코루틴<sup id=\"fnref-14\"><a href=\"#fn-14\" class=\"footnote-ref\">14</a></sup>을 활용하여 해당 작업들을 처리를 하고 있고, Java21부터는 가상 쓰레드<sup id=\"fnref-15\"><a href=\"#fn-15\" class=\"footnote-ref\">15</a></sup>가 도입될 것이라 리액티브는 어떻게 보면 사장될 수 있다는 의견들이 많다.</p>\n<p>하지만, 그럼에도 리액티브 프로그래밍은 데이터 스트림을 처리, 변환등의 작업을 하는 시나리오에는 강력할 것으로 생각한다.\n오히려 코루틴이나 가상쓰레드를 통해서 기존 명령형 프로그래밍의 장점과 리액티브 프로그래밍의 장점이 결합되서 본래의 러닝커브가 줄어들 수 있지않을까? 생각해보면서 글을 마친다.</p>\n<h1 id=\"레퍼런스\" style=\"position:relative;\"><a href=\"#%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4\" aria-label=\"레퍼런스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>레퍼런스</h1>\n<ol>\n<li><a href=\"https://velog.io/@jihoson94/EventLoopModelInSpring\">Thread per request VS EventLoop Model in Spring - velog</a></li>\n<li><a href=\"https://www.infoq.com/articles/Servlet-and-Reactive-Stacks-Spring-Framework-5/\">Servlet and Reactive Stacks in Spring Framework 5 - infoq</a></li>\n<li><a href=\"https://www.baeldung.com/spring-mvc-async-vs-webflux\">Spring MVC Async vs Spring WebFlux - baeldug</a></li>\n<li><a href=\"https://hadev.tistory.com/29\">Servlet 3.0, 3.1 그리고 스프링 MVC - 하뎁의 기록</a></li>\n<li><a href=\"https://www.linkedin.com/pulse/imperative-vs-declarative-programming-javascript-yehuda-margolis/\">Imperative vs Declarative Programming in JavaScript - linkdin</a></li>\n<li><a href=\"https://engineering.linecorp.com/ko/blog/reactive-streams-with-armeria-1\">Armeria로 Reactive Streams와 놀자! - 1 - LINE Engineering</a></li>\n<li><a href=\"https://perfectacle.github.io/2022/12/29/look-over-java-virtual-threads/\">Java Virtual Threads 훑어보기 - 오늘도 끄적끄적</a></li>\n<li><a href=\"https://spring.io/blog/2019/04/12/going-reactive-with-spring-coroutines-and-kotlin-flow\">Going Reactive with Spring, Coroutines and Kotlin Flow - spring.io</a></li>\n</ol>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\"><a href=\"https://en.wikipedia.org/wiki/Master/slave_(technology)\">Master/slave (technology)</a><a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-2\"><a href=\"https://projectreactor.io/\">Project Reactor</a><a href=\"#fnref-2\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-3\"><a href=\"https://spring.io/projects/spring-cloud-stream\">Spring Cloud Stream</a><a href=\"#fnref-3\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-4\"><a href=\"https://docs.spring.io/spring-framework/reference/web/webflux.html\">Spring WebFlux</a><a href=\"#fnref-4\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-5\"><a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletionStage.html\">CompletionStage - oracle docs</a><a href=\"#fnref-5\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-6\"><a href=\"https://docs.spring.io/spring-framework/docs/4.2.4.RELEASE_to_4.2.5.RELEASE/Spring%20Framework%204.2.5.RELEASE/org/springframework/web/client/AsyncRestTemplate.html\">AsyncRestTempalte - spring docs</a><a href=\"#fnref-6\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-7\"><a href=\"https://velog.io/@jihoson94/EventLoopModelInSpring\">Thread per request VS EventLoop Model in Spring - velog</a><a href=\"#fnref-7\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-8\"><a href=\"https://docs.spring.io/spring-framework/docs/5.0.0.M2/javadoc-api/org/springframework/web/client/reactive/WebClient.html\">Webclient - spring docs</a><a href=\"#fnref-8\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-9\"><a href=\"https://hadev.tistory.com/29\">Servlet 3.0, 3.1 그리고 스프링 MVC - 하뎁의 기록</a><a href=\"#fnref-9\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-10\"><a href=\"https://reactivex.io/\">ReactiveX</a><a href=\"#fnref-10\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-11\"><a href=\"https://github.com/ReactiveX/RxJava\">RxJava</a><a href=\"#fnref-11\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-12\"><a href=\"https://github.com/reactor/reactor-core/blob/main/reactor-core/src/main/java/reactor/core/publisher/LambdaSubscriber.java\">LambdaSubscriber - github</a><a href=\"#fnref-12\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-13\"><a href=\"https://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem\">Producer–consumer problem - wikipedia</a><a href=\"#fnref-13\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-14\"><a href=\"https://kotlinlang.org/docs/coroutines-overview.html\">coroutine - kotlin docs</a><a href=\"#fnref-14\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-15\"><a href=\"https://openjdk.org/jeps/425\">Virtual Thread - openJDK</a><a href=\"#fnref-15\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","excerpt":"STEP 2. 리액티브 시스템과 리액티브 프로그래밍 STEP 2.1 리액티브 시스템이란? STEP 2.2 리액티브 프로그래밍이란? STEP 2.2.1 Blocking I/O에서 Non-Blocking I/O로 STEP 2.2.1.1 블록킹 시나리오 STEP 2.2.1.2 콜백 시나리오 STEP 2.2.1.3 Future 시나리오 STEP 2.2.1.4 CompletableFuture 시나리오 STEP 2.2.2 리액티브 프로그래밍의 특징 STEP 2.2.2.1 명령형 프로그래밍 패러다임 vs 선언형 프로그래밍 패러다임 STEP 2.2.3 리액티브 프로그래밍의 구성 STEP 2.3 리액티브 스트림즈 STEP 2.3.1 리액티브 스트림즈 구성요소 STEP 3. Project Reactor STEP 3.1 Cold Sequence & Hot Sequence STEP 3.1.1 Cold Sequence STEP 3.1.1 Hot Sequence STEP 3.2 Sinks STEP 3.2 …","frontmatter":{"date":"August 02, 2023","title":"리액티브 시스템과 리액티브 스트림즈","categories":"개발","author":"개발한입","emoji":"💻"},"fields":{"slug":"/overview-reactive-system/"}},"next":{"id":"5f019a9d-4ba5-5404-8fb7-15a85aac4e66","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#step-1-%EC%9E%90%EB%B0%94-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EA%B4%80%EB%A6%AC\">STEP 1. 자바 메모리 관리</a></p>\n</li>\n<li>\n<p><a href=\"#step-2-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%98%81%EC%97%AD\">STEP 2. 메모리 영역</a></p>\n<ul>\n<li>\n<p><a href=\"#step-21-%EC%8A%A4%ED%83%9D-%EC%98%81%EC%97%AD\">STEP 2.1 스택 영역</a></p>\n<ul>\n<li><a href=\"#step-211-%EC%A7%80%EC%97%AD%EB%B3%80%EC%88%98-%EB%B0%B0%EC%97%B4\">STEP 2.1.1 지역변수 배열</a></li>\n<li><a href=\"#step-212-%ED%94%BC%EC%97%B0%EC%82%B0%EC%9E%90-%EC%8A%A4%ED%83%9D\">STEP 2.1.2 피연산자 스택</a></li>\n<li><a href=\"#step-213-%ED%94%84%EB%A0%88%EC%9E%84-%EB%8D%B0%EC%9D%B4%ED%84%B0\">STEP 2.1.3 프레임 데이터</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-22-%ED%9E%99-%EC%98%81%EC%97%AD\">STEP 2.2 힙 영역</a></p>\n</li>\n<li>\n<p><a href=\"#step-23-%EB%B2%88%EC%99%B8-%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4-%ED%83%80%EC%9E%85-%EC%82%AC%EC%9A%A9-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\">STEP 2.3 번외) 레퍼런스 타입 사용 주의사항</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-3-%EC%8B%A4%ED%96%89-%EC%97%94%EC%A7%84\">STEP 3. 실행 엔진</a></p>\n<ul>\n<li>\n<p><a href=\"#step-31-gc\">STEP 3.1 GC</a></p>\n<ul>\n<li><a href=\"#step-311-gc-root-set\">STEP 3.1.1 GC Root Set</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-32-%EC%8B%9D%EB%B3%84-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\">STEP 3.2 식별 알고리즘</a></p>\n<ul>\n<li><a href=\"#step-321-%EC%8A%A4%ED%83%91-%EB%8D%94-%EC%9B%94%EB%93%9C\">STEP 3.2.1 스탑-더-월드</a></li>\n<li><a href=\"#step-322-%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4-%EC%B9%B4%EC%9A%B4%ED%8C%85\">STEP 3.2.2 레퍼런스 카운팅</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-33-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\">STEP 3.3 정리 알고리즘</a></p>\n<ul>\n<li><a href=\"#step-331-%EA%B8%B0%EB%B3%B8-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\">STEP 3.3.1 기본 정리 알고리즘</a></li>\n<li><a href=\"#step-332-%EC%95%95%EC%B6%95-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\">STEP 3.3.2 압축-정리 알고리즘</a></li>\n<li><a href=\"#step-333-%EB%B3%B5%EC%A0%9C-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\">STEP 3.3.3 복제-정리 알고리즘</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-34-gc-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98-%EC%A4%91%EA%B0%84-%EC%A0%95%EB%A6%AC\">STEP 3.4 GC 알고리즘 중간 정리</a></p>\n</li>\n<li>\n<p><a href=\"#step-35-generational-algorithm\">STEP 3.5 Generational Algorithm</a></p>\n</li>\n<li>\n<p><a href=\"#step-36-%ED%9E%99%EC%9D%98-%EA%B5%AC%EC%A1%B0%EC%99%80-gc%EC%9D%98-%EA%B8%B0%EB%B3%B8-%EB%8F%99%EC%9E%91\">STEP 3.6 힙의 구조와 GC의 기본 동작</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-4-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%98%81%EC%97%AD%EB%A9%94%ED%83%80%EC%8A%A4%ED%8E%98%EC%9D%B4%EC%8A%A4-%EC%98%81%EC%97%AD\">STEP 4. 메서드 영역(메타스페이스 영역)</a></p>\n<ul>\n<li><a href=\"#step-41-%EC%9E%90%EB%B0%94-8-%EC%9D%B4%EC%A0%84%EA%B3%BC-%EC%9D%B4%ED%9B%84%EC%9D%98-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%98%81%EC%97%AD\">STEP 4.1 자바 8 이전과 이후의 메서드 영역</a></li>\n<li><a href=\"#step-42-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%98%81%EC%97%AD%EC%97%90%EC%84%9C%EC%9D%98-gc-%EB%8F%99%EC%9E%91\">STEP 4.2 메서드 영역에서의 GC 동작</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#step-5-%EA%B0%80%EB%B9%84%EC%A7%80-%EC%88%98%EC%A7%91%EA%B8%B0\">STEP 5. 가비지 수집기</a></p>\n<ul>\n<li><a href=\"#step-51-serial-gc\">STEP 5.1 Serial GC</a></li>\n<li><a href=\"#step-52-parallel-gc\">STEP 5.2 Parallel GC</a></li>\n<li><a href=\"#step-53-cms-gc\">STEP 5.3 CMS GC</a></li>\n<li><a href=\"#step-54-g1garbage-firstgc\">STEP 5.4 G1(Garbage First)GC</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"목차\" style=\"position:relative;\"><a href=\"#%EB%AA%A9%EC%B0%A8\" aria-label=\"목차 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목차</h1>\n<ul>\n<li>개요</li>\n<li>STEP 1. 자바 메모리 관리</li>\n<li>STEP 2. 메모리 영역\n<ul>\n<li>STEP 2.1 스택 영역</li>\n<li>STEP 2.2 힙 영역</li>\n<li>STEP 2.3 번외) 레퍼런스 타입 사용 주의사항</li>\n</ul>\n</li>\n<li>STEP 3. 실행 엔진\n<ul>\n<li>STEP 3.1 GC\n<ul>\n<li>STEP 3.1.1 Garbage Collections roots</li>\n</ul>\n</li>\n<li>STEP 3.2 식별 알고리즘\n<ul>\n<li>STEP 3.2.1 스탑-더-월드</li>\n<li>STEP 3.2.2 레퍼런스 카운팅</li>\n</ul>\n</li>\n<li>STEP 3.3 정리 알고리즘\n<ul>\n<li>STEP 3.3.1 기본 정리 알고리즘</li>\n<li>STEP 3.3.2 압축-정리 알고리즘</li>\n<li>STEP STEP 3.3.3 복제-정리 알고리즘</li>\n</ul>\n</li>\n<li>STEP 3.4 GC 알고리즘 중간 정리</li>\n<li>STEP 3.5 Generational Algorithm</li>\n<li>STEP 3.6 Heap의 구조와 GC의 기본 동작</li>\n</ul>\n</li>\n<li>STEP 4. 메서드 영역(메타스페이스 영역)\n<ul>\n<li>STEP 4.1 자바 8 이전과 이후의 메서드 영역</li>\n<li>STEP 4.2 메서드 영역에서의 GC 동작</li>\n</ul>\n</li>\n<li>STEP 5. 가비지 수집기\n<ul>\n<li>STEP 5.1 Serial GC</li>\n<li>STEP 5.2 Parallel GC</li>\n<li>STEP 5.3 CMS(Concurrent Mark &#x26; Sweep) GC</li>\n<li>STEP 5.4 G1(Garbage First)GC</li>\n</ul>\n</li>\n<li>STEP 5. 결론</li>\n<li>STEP 6. 레퍼런스 및 참고자료</li>\n</ul>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/Mll9lyu.png\">\n</p>\n<p align=\"center\">\n    <em>그림 1. JVM 구조도</em>\n</p>\n<p>위 그림은 전반적인 JVM의 구조를 나타내는 그림이다. 클래스로더 시스템에 대해서는 이전에 <a href=\"https://brewagebear.github.io/fundamental-jvm-classloader/\">한번 다뤘으니</a>, 이 포스팅의 중점은 메모리 영역(Runtime Data Areas)와 실행 엔진(Execution Engine) 부분이라고 볼 수 있을 것 같다.</p>\n<p>예전에 한번 GC 알고리즘에 대해서 다루고자 한다 했는데 너무 시간이 지났다. 그래서 이왕 시간이 많이 지난거 한번에 모든 걸 담아보면 어떨까? 라는 생각으로 글을 작성하였고, 이 때문에 장문의 글이 되어버렸다. 거기다가 최신 GC인 ZGC는 내용의 압박으로 인하여 일단 패스했는데 만약 추가하게 되면 개요에 추가하도록 하겠다.</p>\n<p>추가로 이번 내용의 대부분은 아래의 책들을 참고하였다.</p>\n<ol>\n<li>\n<p><a href=\"https://www.yes24.com/Product/Goods/3577335\">Java Performance Fundamental, 김한도 저, 2009</a></p>\n</li>\n<li>\n<p><a href=\"https://a.co/d/3vI0AU4\">Java Memory Management: A comprehensive guide to garbage collection and JVM tuning, Maaike van Putten, 2022</a></p>\n</li>\n</ol>\n<p>특히, Java Performance Fundamental은 10년이 지난 지금에도 바이블이라고 생각한다. 이 책을 꼭 읽어보기를 추천한다.</p>\n<p>주의할 점은 이 책이 나온 시점에는 Java 1.5 ~ 1.6 시절이므로 그걸 감수하면서 달라진 내용을 팔로우하면서 봐야한다는 점이다. Java Memory Management라는 책 또한, 볼륨이 상대적으로 적은데 (대략 220쪽분량) 핵심적인 내용들과 내가 궁금한 부분들에 대해서는 전부 다 녹여져 있었다.</p>\n<p>이 두 권을 추천하며, 추가적으로 JVM에서 더 넓은 범위의 성능 최적화를 공부하고 싶다면 <a href=\"https://www.yes24.com/Product/Goods/115426829\">실무로 배우는 시스템 성능 최적화, 권문수 저, 2022</a> 이 책을 추천한다.</p>\n<p>자 이제 본론으로 들어가보자.</p>\n<h2 id=\"step-1-자바-메모리-관리\" style=\"position:relative;\"><a href=\"#step-1-%EC%9E%90%EB%B0%94-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EA%B4%80%EB%A6%AC\" aria-label=\"step 1 자바 메모리 관리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 1. 자바 메모리 관리</h2>\n<p>이 메모리 영역은 자바가 동작할 때 사용되는 모든 것들이 올라가지게 된다. JVM의 <strong>주된 역할 중 하나도 이 메모리 영역(Runtime Data Areas)를 관리</strong>하는 것이다.</p>\n<p>JVM이 이 영역을 관리를 하지 않게 되면, 메모리 라이프 사이클 관리와 같은 활동이 수행되지 않을 것이고 이는 OOM과 같은 문제를 발생시킬 수 있다.</p>\n<p>즉, JVM은 이 메모리 영역에 대한 라이프 사이클을 관리하여 프로그래머가 해당 부분에 노력을 기하지 않더라도 자동으로 관리하는 편의성을 가져왔다.</p>\n<p>위에서는 설명한 바와 같이 JVM은 이 메모리 영역에 대한 “라이프 사이클”을 책임져준다. 이는 자바 이전의 프로그래밍 언어들(<code class=\"language-text\">C, CPP</code>)은 프로그래머가 스스로 메모리 관리를 했어야했다는 점이다.</p>\n<p>학부생때 <code class=\"language-text\">C, CPP</code> 와 같은 프로그래밍 언어를 다뤘다면 <code class=\"language-text\">malloc</code> 이나 <code class=\"language-text\">free</code> 등을 사용해서 메모리 관리를 한 적이 있을 것이다. 이 언어들은 메모리 영역에 대한 관리를 프로그래머 스스로가 책임을 졌었다.\n이는 아래와 같은 문제점을 낳았다.</p>\n<ol>\n<li>댕글링 포인터(Dangling Pointer)<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> : 포인터가 여전히 메모리가 해제된 영역을 가르키고 있는 상황</li>\n<li>메모리 릭(Memory leaks) : 더 이상 필요하지 않은 메모리에 대해 할당 해제가 제대로 이뤄지지 않는 상황이 누적되어서 메모리가 고갈되어 부족해지는 상황</li>\n<li>보일러플레이트 코드(Boilerplate code) : 코드에 비즈니스 로직보다 메모리 할당과 해제에 대한 코드가 더 많이 자리 잡게되고, 이 코드를 지속적으로 유지보수 해야했음</li>\n<li>오류 발생 가능성(Error-prone) : 숙련된 개발자라 하더라도 이러한 작업에 대해서 실수가 발생할 가능성이 존재</li>\n</ol>\n<p>자바는 JVM의 메모리 기능을 활용하여 위와 같은 문제를 프로그래머가 더 이상 고민하지 않고, 비즈니스 로직에 전념할 수 있도록 하였다.\n그렇다면, 이러한 기능은 어떤식으로 이뤄질 수 있을까?</p>\n<p>핵심은 위 그림의 세가지 구성요소이다.</p>\n<ol>\n<li>클래스로더 시스템(ClassLoader System) : 초기 바이트 코드 검증 및 클래스 파일을 실제로 로드되기 위해 필요한 구성요소</li>\n<li>메모리 영역(Runtime Data Areas) : 클래스의 로딩과 바이트 코드의 실행은 메모리를 필요로 하는데 이러한 작업들을 수행하는 구성요소</li>\n<li>실행 엔진(Execution Engine) : 클래스로더를 통해서 로드된 클래스들이 메모리에 적재되면 실제 바이트 코드를 실행하는 구성요소</li>\n</ol>\n<p>아마 대충 러프한 플로우는 이해가 됐을 것이다. 자세한 부분은 <a href=\"https://github.com/openjdk/jdk/blob/master/src/hotspot/share/runtime/init.hpp#L38\">OpenJDK - Github</a> 해당 코드를 참고해보자.</p>\n<p><code class=\"language-text\">init_globals()</code> 메서드를 통해서 준비 과정을 거치면서 <code class=\"language-text\">Main Java Thread</code> 를 구성하고, <code class=\"language-text\">vm_init_globas()</code> 메서드를 통해서 <code class=\"language-text\">VM Thread</code> 를 구성하는 헤더파일이다. 요즘 깃허브가 좋아져서, 클릭하면서 해당 내용을 참고할 수 있으니 내부 로직을 상세히 보고 싶으면 해당 깃허브를 참고해보자.</p>\n<p>추가로 앞으로 기술할 모든 내용은 <strong>Hospot VM</strong><sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup> 기준이다.</p>\n<p>우리는 대충 JVM이 어떠한 역할을 하는지와 실제 자바 코드가 어떤식으로 처리되고, 구성요소는 어떤 식으로 동작하는 지 배웠다.\n앞서서 말했듯이 이번에 주요하게 볼 내용은 메모리 영역과 실행엔진 부분이므로 이 두 컴포넌트의 상세한 내용을 확인해보자.</p>\n<h2 id=\"step-2-메모리-영역\" style=\"position:relative;\"><a href=\"#step-2-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%98%81%EC%97%AD\" aria-label=\"step 2 메모리 영역 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2. 메모리 영역</h2>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/UtkS6yx.png\">\n</p>\n<p align=\"center\">\n    <em>그림 2. JVM 메모리 영역 구조도</em>\n</p>\n<p>이미 위에서 보여줬던 그림처럼 메모리 영역은 5가지의 구성요소로 이뤄진다고 하였다.\n간략하게, 각 영역들이 어떠한 일을 하는지를 설명한 후에 세부적인 내용을 다뤄보고자 한다.</p>\n<ol>\n<li><strong>스택 영역</strong></li>\n</ol>\n<p>프리미티브 타입들과 힙 영역에 저장된 참조(Reference)에 대한 정보들이 담기는 영역이다.</p>\n<p>메서드가 호출되면 스택 프레임(Stack Frame)이 생성되며, 각 프레임마다 메서드에 대한 값을 유지하고 있다. 스택 영역은 <strong>각 쓰레드 마다 독립적인 공간이 할당</strong>된다.</p>\n<ol start=\"2\">\n<li><strong>PC 레지스터</strong></li>\n</ol>\n<p>운영체제에서 말하는 PC 레지스터와 상동한 일을 수행한다. 현재 실행 중인 명령의 주소를 저장함으로써 어떤 코드가 실행되는 지를 알게끔한다.\nPC 레지스터는 <strong>각 쓰레드 마다 독립적인 공간이 할당</strong>된다.</p>\n<ol start=\"3\">\n<li><strong>힙 영역</strong></li>\n</ol>\n<p>JVM이 시작되면, RAM의 일부분을 어플리케이션의 메모리 동적할당을 위해서 예약한다고 위에서 말했었다. 이 영역이 해당 부분이라고 보면된다.</p>\n<p>런타임 데이터들은 이 곳에 할당되며, 인스턴스들을 이 영역에서 찾을 수 있다.\n힙 영역은 GC를 통해서 메모리 할당, 해제등이 관리가 된다.</p>\n<p>힙 영역은 <strong>모든 쓰레드가 공유</strong>한다.</p>\n<ol start=\"4\">\n<li><strong>메서드 영역(메타스페이스 영역)</strong></li>\n</ol>\n<p>클래스의 메타데이터인 런타임 코드, 정적 변수, 상수 풀 그리고 생성자 코드등을 포함한다.</p>\n<p>메서드 영역은 <strong>모든 쓰레드가 공유</strong>한다.</p>\n<ol start=\"5\">\n<li><strong>네이티브 메서드 스택 영역</strong></li>\n</ol>\n<p>이 영역은 Java가 아닌 C와 같은 언어로 구현된 네이티브 코드가 실행되는 곳이고, 위에서 살펴본 스택처럼 네이티브 코드 또한, 명령에 대한 스택이 필요하므로 네이티브 코드를 위한 스택 영역이라고 보면 될 것이다.</p>\n<p>이 영역 또한, <strong>스택 영역과 같이 모든 쓰레드가 독립적인 공간</strong>을 갖는다.</p>\n<p>위 내용을 정리하면 아래와 같을 것이다.</p>\n<table>\n<thead>\n<tr>\n<th>영역 명</th>\n<th>특징</th>\n<th>쓰레드 간의 공유 여부</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>스택 영역</td>\n<td>메서드가 호출될 때마다 스택프레임을 생성하며, 힙 영역에 대한 참조가 저장되는 공간</td>\n<td>X</td>\n</tr>\n<tr>\n<td>PC 레지스터</td>\n<td>현재 실행 중인 명령의 주소를 저장하는 역할</td>\n<td>X</td>\n</tr>\n<tr>\n<td>힙 영역</td>\n<td>JVM이 메모리 동적할당을 위해서 예약을 해둔 공간으로 런타임 데이터들과 인스턴트들이 저장되는 공간</td>\n<td>O</td>\n</tr>\n<tr>\n<td>메서드 영역</td>\n<td>클래스의 메타데이터인 런타임 코드, 정적 변수, 상수 풀 등을 저장하는 공간</td>\n<td>O</td>\n</tr>\n<tr>\n<td>네이티브 메서드 스택 영역</td>\n<td>자바 코드가 아닌 네이티브 코드를 위한 스택을 사용하기 위한 공간</td>\n<td>X</td>\n</tr>\n</tbody>\n</table>\n<p>이제 이 영역들에 대해서 세부적으로 보도록 하자.</p>\n<h3 id=\"step-21-스택-영역\" style=\"position:relative;\"><a href=\"#step-21-%EC%8A%A4%ED%83%9D-%EC%98%81%EC%97%AD\" aria-label=\"step 21 스택 영역 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1 스택 영역</h3>\n<p>자바에서의 데이터 값은 크게 2가지 분류로 나뉘어진다.</p>\n<ol>\n<li>원시타입 값(Primitive value) : 이 값은 원시타입(int, char 등…) 중에서 하나의 타입을 갖고 있다.</li>\n<li>참조타입 값(Reference value) : 이 값은 객체 위치에 대한 참조 포인터를 지니고 있다.</li>\n</ol>\n<p>스택 영역을 이해하기 위해서는 이 2가지 값의 할당 방식에 대해서 이해를 할 필요가 있다.</p>\n<p>앞서 위에서 말한 것과 같이 스택은 각 쓰레드마다 별도의 영역을 갖고 있고, 쓰레드가 호출될 때마다 스택 프레임을 생성한다고 하였다.\n그림으로 보면 아래와 같다고 볼 수 있다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/eeQ4ikC.png\">\n</p>\n<p align=\"center\">\n    <em>그림 3. 쓰레드 별 스택과 스택프레임</em>\n</p>\n<p>스택은 말 그대로 자료구조의 스택과 동일하게 후입선출(Last-In First-Out, LIFO)의 구조를 갖고 있다.\n예를 들면 쓰레드 1번의 스택의 상황은 <code class=\"language-text\">a()</code> 메서드가 호출된 상황에서 다시 <code class=\"language-text\">b()</code> 메서드가 호출된 상황이라 보면 될 것이다.</p>\n<p>스택 구조로 되어있기에 <code class=\"language-text\">b()</code> 의 결과를 다시 <code class=\"language-text\">a()</code> 에서 받아서 결과를 조합한 뒤에 결과를 도출할 수 있을 것이다.\n쓰레드마다 스택 구조가 생기는 이유도 동일하다. 만약, 멀티쓰레딩 환경에서 스택 영역을 공유한다고 가정해보자.</p>\n<p>그러면 어떤 쓰레드에서 어떤 메서드가 끝났는지 파악하기도 매우 어렵고, 위 예시와 같이 <code class=\"language-text\">a()</code> 프레임은 <code class=\"language-text\">b()</code> 프레임의 결과를 받아 처리하는 것을 기대하는데, 다른 쓰레드들이 하나의 스택을 사용한다면\n이 처리하는 것이 매우 까다로울 것이다. 따라서, 자바는 각 쓰레드마다 별도의 스택 영역과 PC 레지스터를 둔 것이다.</p>\n<p>그렇다면, 스택 프레임은 어떠한 구조로 되어있을까?</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/QrKNvwY.png\">\n</p>\n<p align=\"center\">\n    <em>그림 4. 스택프레임 내부 구조도</em>\n</p>\n<p>위와 같은 구조로 되어있으며, 스택 프레임의 구성요소는 크게 3가지이다.</p>\n<ol>\n<li>지역변수 배열(Local variable array) : 해당 스택 프레임의 지역 변수들을 담는 배열</li>\n<li>피연산자 스택(Operand Stack) : 만약 프레임 내에서 지역변수 <code class=\"language-text\">x + y</code> 와 같은 연산을 수행할 시 그에 대한 피연산자인 <code class=\"language-text\">x</code>와 <code class=\"language-text\">y</code>를 저장해두는 공간</li>\n<li>프레임 데이터(Frame Data) : 메소드를 실행하는 데 필요한 데이터로 구성 되는 공간</li>\n</ol>\n<p>상세하게 하나씩 살펴보자.</p>\n<h4 id=\"step-211-지역변수-배열\" style=\"position:relative;\"><a href=\"#step-211-%EC%A7%80%EC%97%AD%EB%B3%80%EC%88%98-%EB%B0%B0%EC%97%B4\" aria-label=\"step 211 지역변수 배열 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1.1 지역변수 배열</h4>\n<p>지역변수 배열의 크기는 <strong>컴파일 타임에 결정</strong>되며, 이 배열에는 2가지 공간이 존재한다.</p>\n<ol>\n<li>Single Spot : <strong>int, short, char, float, byte, boolean, reference</strong> 타입을 위한 공간</li>\n<li>Double Spot : <strong>long, double</strong> 타입을 위한 공간</li>\n</ol>\n<p>자바에서는 메서드가 2가지 타입이 존재하는 것은 다들 알고 있을 것이다.</p>\n<ol>\n<li>정적 메서드(static method)</li>\n<li>인스턴스 메서드(instance method)</li>\n</ol>\n<p>만약, 해당 프레임이 인스턴스 메서드를 통해서 생성된 것이면, 지역변수 배열의 첫번째 원소(index == 0)는 바로 <code class=\"language-text\">this</code>  즉, 메서드 호출했던 객체의 레퍼런스를 가르킨다.\n정적 메서드의 호출로 생성된 경우에는 지역변수 배열의 0번째부터 지역변수들이 저장된다.</p>\n<h4 id=\"step-212-피연산자-스택\" style=\"position:relative;\"><a href=\"#step-212-%ED%94%BC%EC%97%B0%EC%82%B0%EC%9E%90-%EC%8A%A4%ED%83%9D\" aria-label=\"step 212 피연산자 스택 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1.2 피연산자 스택</h4>\n<p>이 부분은 어셈블러같은 걸 다뤄봤으면 이해가 쉽다. 아래와 같은 자바코드가 있다고 가정해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// main.java</span>\n<span class=\"token keyword\">package</span> <span class=\"token namespace\">test</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\t <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t\t <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\t\t <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span>\n\t <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>단순한 메서드임을 확인할 수 있는데 이를 자바 컴파일러로 확인하면 아래와 같은 결과를 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">javac main.java # 자바 파일을 컴파일하여 바이트코드화\njavap -c Main.class # 클래스 파일을 역어셈블하여 출력하는 명령 \n\nCompiled from &quot;main.java&quot;\nclass test.Main {\n  test.Main();\n    Code:\n       0: aload_0\n       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V\n       4: return\n\n  public int test();\n    Code:\n       0: iconst_1\n       1: istore_1\n       2: iconst_2\n       3: istore_2\n       4: iload_1\n       5: iload_2\n       6: iadd\n       7: ireturn\n}</code></pre></div>\n<p>여기서 우리가 볼 내용은 <code class=\"language-text\">public int test();</code> 단의 어셈블러인데 <code class=\"language-text\">iconst_</code> 는 언더바 뒤에 상수를 피연산자 스택에 <code class=\"language-text\">push</code> 하는 명령이다.\n즉, <code class=\"language-text\">0: iconst_1</code> 은 피연산자 스택에 <code class=\"language-text\">x</code> 의 리터럴인 1을 푸시하는 명령이다. <code class=\"language-text\">istore_</code> 는 언더바 뒤에 상수를 피연산자 스택에서 <code class=\"language-text\">pop</code> 하여 지역변수 배열에 저장하는 명령이다.\n즉, <code class=\"language-text\">1: istore_1</code> 은 피연산자 스택에 넣어진 1을 지역변수 배열의 인덱스 1에 저장한다. (인스턴스 메서드기 때문이다.) 이후 <code class=\"language-text\">iload_</code> 는 지역변수 배열의 인덱스를 읽어서 값을 읽는 연산이다.\n이후 실제로 <code class=\"language-text\">iadd</code> 명령을 통해서 <code class=\"language-text\">x + y</code> 의 결과를 얻게 되는 것이다.</p>\n<h4 id=\"step-213-프레임-데이터\" style=\"position:relative;\"><a href=\"#step-213-%ED%94%84%EB%A0%88%EC%9E%84-%EB%8D%B0%EC%9D%B4%ED%84%B0\" aria-label=\"step 213 프레임 데이터 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.1.3 프레임 데이터</h4>\n<p>위에서 프레임 데이턴느 메서드를 실행하는 데 필요한 다양한 데이터로 구성된다고 얘기를 하였다.</p>\n<p>런타임 상수 풀(run-time constant pool)에 대한 레퍼런스, 일반 메서드 호출 완료(Normal Method Invocation Completion), 갑작스러운 메서드 호출 완료(Abrupt Method Invocation Completion) 등이 이 데이터에 대한 예시이다.</p>\n<p>스택 프레임은 동적 링킹(Dynamic-Linking)<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup>을 지원하기 위해 현재 메서드 유형에 대한 런타임 상수 풀의 참조를 갖고 있다. 예시를 위해서 위의 코드를 좀 손을 봐보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// main.java</span>\n<span class=\"token keyword\">package</span> <span class=\"token namespace\">test</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\t <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t\t <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\t\t <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello World!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span>\n\t <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 코드의 역어셈블러 결과는 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">Compiled from &quot;main.java&quot;\nclass test.Main {\n  test.Main();\n    Code:\n       0: aload_0\n       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V\n       4: return\n\n  public int test();\n    Code:\n       0: iconst_1\n       1: istore_1\n       2: iconst_2\n       3: istore_2\n       4: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;\n       7: ldc           #3                  // String Hello World!\n       9: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V\n      12: iload_1\n      13: iload_2\n      14: iadd\n      15: ireturn\n}</code></pre></div>\n<p>위에서 봤을 때랑 달라진 부분은 <code class=\"language-text\">#2, #3, #4</code> 로 주석쳐진 부분이다. 이 부분이 바로 런타임 상수 풀에 대한 참조를 처리하는 부분이다. 한 줄씩 봐보자.</p>\n<ol>\n<li><code class=\"language-text\">getstatic</code> 은  클래스의 정적 필드 값(<code class=\"language-text\">System.out == PrintStream</code>)을 가져와서 오퍼랜드 스택에 푸시한다.</li>\n<li><code class=\"language-text\">ldc</code>를 통해서 상수 풀의 참조 값(<code class=\"language-text\">Hello World!</code> 상수의 참조 값)을 스택의 맨 위로 푸시한다.</li>\n<li><code class=\"language-text\">invokevirtual</code> 명령어를 수행한다.\n<ul>\n<li>현재, 오퍼랜드 스택의 탑에는 <code class=\"language-text\">Hello World!</code> 의 참조 값이 들어가 있다 이를 꺼내와서 <code class=\"language-text\">PrintStream.println()</code> 의 인자로 전달하여 새로운 프레임을 생성한다.</li>\n<li>참조 값이 팝되었기 때문에 현재 탑은 <code class=\"language-text\">PrintStream</code> 일 것이다. 이를 다시 팝하여 위에서 처리된 인자들을 활용하여 화면에 출력한다.</li>\n</ul>\n</li>\n</ol>\n<p>이 뿐만 아니라 아까 위에서 적은 것 처럼 스택 프레임에는 <code class=\"language-text\">throws</code> 와 같은 예외 상황이나 정상 리턴에 대한 처리등이 포함된다고 하였다. 이는 실제로 바이트코드를 보면서 확인해보길 바란다.</p>\n<p>위에서 상세하게 스택 영역의 구성요소들이 하는 일에 대해서 다뤄보았다.\n하지만, 원시 타입과 정적 메서드에 대한 테스트로만 예시를 보여줬는데 그렇다면 스택과 힙 영역은 어떻게 연관되어지고, 실제 객체를 힙 영역에 저장할 때는 JVM에서 어떠한 일이 벌어지는 걸까?</p>\n<h3 id=\"step-22-힙-영역\" style=\"position:relative;\"><a href=\"#step-22-%ED%9E%99-%EC%98%81%EC%97%AD\" aria-label=\"step 22 힙 영역 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.2 힙 영역</h3>\n<p>위에서는 스택 영역에 대해서 다뤘었다. 그렇다면, 실제 힙 영역의 객체는 어떤식으로 저장되는 것일까?</p>\n<p>아래와 같은 코드가 있다고 가정해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">test</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> address<span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Person</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>address <span class=\"token operator\">=</span> address<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">Person</span> person <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Person</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bear\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Goyang-si\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드를 그림으로 나타내면 아래와 같을 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/b4NZmnc.png\">\n</p>\n<p align=\"center\">\n    <em>그림 5. 예시코드의 스택과 메모리 상황</em>\n</p>\n<p><code class=\"language-text\">test()</code> 메서드가 호출되면 프레임이 생길테고, 이때 우리는 해당 메서드 내부에서 <code class=\"language-text\">new Person(\"bear\", \"Goyang-si\")</code> 와 같이 생성자를 전달하여 객체를 생성하였다.</p>\n<p>인스턴스가 생성되게 되면, 실제 값은 힙 영역에 저장되고 스택 내 지역변수는 해당 힙 영역에 생성된 값에 대한 레퍼런스를 갖고 있게 된다.</p>\n<p>즉, <code class=\"language-text\">person</code> 이라는 <strong>변수 자체는 실제 값을 들고 있는 것이 아니라 힙 영역에 할당된 데이터에 대한 참조 값을 들고 있는 것</strong>이다.</p>\n<p>위의 예시를 좀 더 우리가 자주 쓰는 자바 언어처럼 바꾸면서 스택 프레임과 힙 영역 할당 과정에 대해서 알아보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">test</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> address<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> age\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Person</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> age<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>address <span class=\"token operator\">=</span> address<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>age <span class=\"token operator\">=</span> age<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">introduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token class-name\">String</span> template <span class=\"token operator\">=</span> <span class=\"token string\">\"안녕하세요. 제 이름은 \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">\"이고, 사는 곳은 \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>address <span class=\"token operator\">+</span> <span class=\"token string\">\" 에 살고 있으며, 나이는 \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>age <span class=\"token operator\">+</span> <span class=\"token string\">\"입니다.\"</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">return</span> template<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Person</span> bear <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Person</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bear\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Goyang-si\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>bear<span class=\"token punctuation\">.</span><span class=\"token function\">introduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 예시가 좀 더 그럴싸해졌다. 그렇다면 스택 프레임의 구조는 어떻게 될까?</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/1x6ZWE8.png\">\n</p>\n<p align=\"center\">\n    <em>그림 6. 예시코드의 스택과 메모리 상황</em>\n</p>\n<p>위 스택 프레임을 분석하면 아래와 같이 분석할 수 있다.</p>\n<ol>\n<li><code class=\"language-text\">main()</code> 메서드가 호출됨에 따라 스택프레임이 생성된 후에 스택 영역에 푸시된다.</li>\n<li>스택 프레임 내에 <code class=\"language-text\">args, x</code> 값이 지역 변수 배열에 저장된다. (<code class=\"language-text\">x</code> 는 원시타입으로 별도 레퍼런스를 갖고 있지 않고, <code class=\"language-text\">main()</code> 메서드 내에 선언된 지역 변수라 따로 레퍼런스가 없다.)</li>\n<li>객체(<code class=\"language-text\">bear</code>)가 아래와 같은 과정으로 이뤄진다.\n<ul>\n<li>문자열 리터럴 2개 (“bear”, “Goyang-si”, 29)를 전달하여 <code class=\"language-text\">Person</code> 객체를 생성한다.\n<ul>\n<li>문자열 리터럴은 <code class=\"language-text\">String</code> 객체이므로 힙에 저장되며, <code class=\"language-text\">String</code> 이기 때문에 특별한 공간인 <strong>String Pool</strong>에도 저장된다.</li>\n<li><code class=\"language-text\">age</code> 의 경우에는 원시타입이므로 힙에 직접 저장이 된다.</li>\n<li>그러나, 객체의 레퍼런스 값이 담기는 <code class=\"language-text\">bear</code> 변수는 <code class=\"language-text\">main()</code> 메서드 내에 저장된다.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>이후 <code class=\"language-text\">System.out.println(x)</code> 에 따라 <code class=\"language-text\">println()</code> 메서드의 새로운 프레임이 스택 영역에 푸시된다.</li>\n<li>추가로 <code class=\"language-text\">bear.introduce()</code> 메서드도 호출됨에 따라 이 프레임도 해당 스택 영역에 푸시된다.</li>\n</ol>\n<p>이 과정을 끝낸 후에 위에서 우리가 바이트 코드를 분석했던 방식과 같이 프로그램이 동작할 것이다.</p>\n<h3 id=\"step-23-번외-레퍼런스-타입-사용-주의사항\" style=\"position:relative;\"><a href=\"#step-23-%EB%B2%88%EC%99%B8-%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4-%ED%83%80%EC%9E%85-%EC%82%AC%EC%9A%A9-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\" aria-label=\"step 23 번외 레퍼런스 타입 사용 주의사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 2.3 번외) 레퍼런스 타입 사용 주의사항</h3>\n<p>우리는 스택 영역을 깊게 보면서, 스택과 힙 영역이 어떤 역할을 하는 지와 자바에서 객체들이 생성될 때 어떠한 과정으로 생성되는 지 등을 살펴보았다.\n또한, 힙 영역에 우리가 사용할 객체가 생성되면 이 값은 레퍼런스를 토대로 참조를 하여 접근하는 식으로 동작하는 것을 알게되었다.</p>\n<p>이때, 자바의 특성이 레퍼런스 타입을 사용할 때는 위와 같이 동작을 하기 때문에 주의할 점이 존재한다.</p>\n<p>이에 대해서 잠깐 설명을 해보고자 한다. 이를 위해 아래의 간단한 코드를 참고해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">NameBuilder</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">StringBuilder</span> name<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token class-name\">NameBuilder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringBuilder</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">StringBuilder</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> args<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">StringBuilder</span> first <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token class-name\">NameBuilder</span> nameBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NameBuilder</span><span class=\"token punctuation\">(</span>first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>nameBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// test</span>\n\n\t\t<span class=\"token class-name\">StringBuilder</span> second <span class=\"token operator\">=</span> nameBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsecond<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n\t\t\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>nameBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// testtest</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 코드의 작성자는 <code class=\"language-text\">NameBuilder</code> 라는 클래스에 <code class=\"language-text\">String</code> 을 인자로 받는 것보다 <code class=\"language-text\">StringBuilder</code> 를 인자로 전달받아서 보다 <code class=\"language-text\">append()</code> 작업등을 원할하게 하는 식의 작업을 생각했던 것 같다.\n그리고 <code class=\"language-text\">NameBuilder</code> 의 멤버변수 <code class=\"language-text\">name</code>은 접근제어자를 <code class=\"language-text\">private</code>으로 두는 등 얼핏보면 나름 잘짠 코드라고 보일 수도 있다.</p>\n<p>그러나, 이 코드는 <strong>캡슐화가 제대로 이뤄지지 않는다.</strong> 우리는 <code class=\"language-text\">NameBuilder</code> 내부에 <code class=\"language-text\">StringBuilder</code> 가 <code class=\"language-text\">private</code> 이므로 바깥에서 접근도 안될 것이라 생각했지만 실제 코드를 동작해보면 옆에 주석을 달아둔 부분과 같이 <code class=\"language-text\">testtest</code>가 찍힘을 볼 수가 있다.</p>\n<p>왜 이런 문제가 발생하는 것일까? 정답은 ”<strong>레퍼런스</strong>“에 있다.\n그림으로 확인해보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/aDoI9xQ.png\">\n</p>\n<p align=\"center\">\n    <em>그림 7. 예시코드의 스택과 메모리의 레퍼런스 상황</em>\n</p>\n<p><code class=\"language-text\">first</code> 와 <code class=\"language-text\">nameBuilder</code> 를 생성한 시기에 스택과 힙 영역을 보면 위 구조와 동일할 것이다.</p>\n<p>이제 <code class=\"language-text\">StringBuilder second = nameBuilder.get();</code> 이후에는 어떻게 변하는지 그림을 확인해보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/9pa6JCy.png\">\n</p>\n<p align=\"center\">\n    <em>그림 8. 변경된 코드에 의한 스택과 메모리의 레퍼런스 상황</em>\n</p>\n<p><code class=\"language-text\">nameBuilder.get()</code> 를 호출하게 됐을 때, 사실 상 <code class=\"language-text\">first</code>가 가르키는 곳과 동일한 레퍼런스를 참고하고 있으며, <code class=\"language-text\">second.append(\"test\")</code> 를 하게 되면, 이는 같은 레퍼런스를 바라보고 있는 <code class=\"language-text\">nameBuilder</code> 의 <code class=\"language-text\">name</code> 에도 영향을 주고 말아 값이 변경되게 되는 것이다.</p>\n<p>이러한 문제때문에 접근제어자를 <code class=\"language-text\">private</code>으로 두었다 해도, 캡슐화가 깨질수가 있는 것이다.\n이 문제를 해결할 수 있는 방법은 무엇일까?</p>\n<p>아래와 같이 코드를 바꾸면 방법이 존재한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">NameBuilder</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">StringBuilder</span> name<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token class-name\">NameBuilder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringBuilder</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 새로운 객체를 생성하여 전달</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">StringBuilder</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 새로운 객체를 생성하여 전달</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> args<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">StringBuilder</span> first <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token class-name\">NameBuilder</span> nameBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NameBuilder</span><span class=\"token punctuation\">(</span>first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>nameBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// test</span>\n\n\t\t<span class=\"token class-name\">StringBuilder</span> second <span class=\"token operator\">=</span> nameBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsecond<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n\t\t\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>nameBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// test</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 방식을 유식한 말로 방어적 복사 기법(Defensive copy)<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup> 이라 한다. 위에서 <code class=\"language-text\">get()</code> 을 호출하거나 생성자를 호출 할 때 <code class=\"language-text\">new StringBuilder</code> 를 통해서 아예 새로운 객체를 할당하여 리턴하는 것을 볼 수 있다. 이를 통해서 레퍼런스를 끊고, 올바르게 캡슐화를 시킬 수 있다.</p>\n<p>이러한 문제는 레퍼런스 타입에 발생한다고 얘기를 했는데 우리가 자주 사용하는 콜렉션 프레임워크인 <code class=\"language-text\">List, Map, Set</code> 등에도 발생할 수 있다.</p>\n<p>따라서, 일급콜렉션<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup> 을 사용할 때도 위와 같은 방어적 복사 기법과 같이 불변 객체(<code class=\"language-text\">unmodifiableList</code> 와 같은)를 활용하기도 한다.\n이 내용에 대해서 좀 더 알고 싶으면, 깊은 복사(Deep Copy)<sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup> 혹은 얕은 복사(Shallow Copy)<sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup> 에 대해서 공부해보도록 하자.</p>\n<h2 id=\"step-3-실행-엔진\" style=\"position:relative;\"><a href=\"#step-3-%EC%8B%A4%ED%96%89-%EC%97%94%EC%A7%84\" aria-label=\"step 3 실행 엔진 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3. 실행 엔진</h2>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/NOlggKt.png\">\n</p>\n<p align=\"center\">\n    <em>그림 9. 실행 엔진 내부 구조도</em>\n</p>\n<p>위에서는 스택 &#x26; 힙 영역에 대해서 다뤘었다. 이제는 실행 엔진에 대해서 다뤄보고자 한다.\n특히, 중점적으로 GC에 대해서 다룰 예정이다.</p>\n<h3 id=\"step-31-gc\" style=\"position:relative;\"><a href=\"#step-31-gc\" aria-label=\"step 31 gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.1 GC</h3>\n<p>서두에서 자바는 <code class=\"language-text\">C, CPP</code>와 다르게 JVM 내에서 메모리를 할당하고 해제하는 등의 라이프 사이클을 관리해준다고 얘기하였다.\n이 기능을 제공해주는 것이 바로 “GC” 이다.</p>\n<p>이제 GC가 어떤 매커니즘으로 동작하는지 알아볼 차례이다.</p>\n<h4 id=\"step-311-gc-root-set\" style=\"position:relative;\"><a href=\"#step-311-gc-root-set\" aria-label=\"step 311 gc root set permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.1.1 GC Root Set</h4>\n<p>GC의 로직은 매우 간단하다.</p>\n<blockquote>\n<p>“현재 힙과 메서드 영역에서 사용되지 않는 객체(Object)를 정리하는 것이다.”</p>\n</blockquote>\n<p>그렇다면, 이 사용유무는 어떻게 판별할까? 그것을 판단해주는 것이 바로 <em>“GC Root Set”</em> 이다.</p>\n<p>Root Set에서 어떤 식으로든 레퍼런스를 참고하고 있으면 <em><strong>접근가능한 객체(Reachable Object)</strong></em> 라 부르고 이를 현재 사용 객체라 판단한다.</p>\n<p>GC Root Set의 종류는 아래와 같다.</p>\n<ol>\n<li>스택 내 레퍼런스 정보</li>\n<li>JNI 레퍼런스 정보</li>\n<li>메서드 영역 내 로드된 클래스 중 클래스 정적 변수 및 상수 풀 레퍼런스 정보</li>\n</ol>\n<p>위 세가지가 왜 GC 대상이 되면 안되는 지는 하나씩 설명해보도록 하겠다.</p>\n<ul>\n<li><strong>스택 내 레퍼런스 정보</strong></li>\n</ul>\n<p>스택 내 레퍼런스 정보는 엄밀하게 따지면, 현재 동작 중인 상황에서의 레퍼런스에 대해서라고 볼 수 있다.</p>\n<p>즉, 지역변수 배열이나 피연산자 스택 등에 레퍼런스 정보가 현재 존재한다면 이는 접근가능한 객체이므로, GC의 대상이 아니다.</p>\n<p>상식적으로 생각해보면 매우 쉬운데 정상적으로 어플리케이션이 동작 중인데 해당 레퍼런스가 GC의 대상이 된다면 아마도 수 많은 오류들을 마주하게 될 것이다.</p>\n<ul>\n<li><strong>JNI 레퍼런스 정보</strong></li>\n</ul>\n<p>위에서 JNI에 대해서는 간략히 다뤘는데, 네이티브 호출을 한 후에 실제로 사용 중인지 확인을 해야될 것이다.</p>\n<p>스택 내 레퍼런스 정보와 마찬가지로 해당 객체를 네이티브 코드에서 사용 중인데 함부로 GC를 하게 된다면 많은 오류가 발생할 것이기 때문이다.</p>\n<p>따라서, JNI에 대한 레퍼런스 정보를 GC Root Set으로 사용하는 것이다.</p>\n<ul>\n<li><strong>메서드 영역 내 로드된 클래스 중 클래스 정적 변수 및 상수 풀 레퍼런스 정보</strong></li>\n</ul>\n<p>메서드 영역에 대해서도 서두에서 간략하게 말했었다. 두 데이터 모두 클래스 수준의 데이터이며, 둘 다 클래스가 로드될 때 생성된 후에 클래스가 JVM 내에 로드된 상태로 유지되는 한 존재한다.</p>\n<p>따라서, 두 데이터를 갖고 있는 클래스가 로드 되는 동안에는 GC의 대상이 되서는 안된다.</p>\n<p>이는 후에 메서드 영역에 대한 GC를 다루면서 좀 더 다뤄보고자 한다.</p>\n<blockquote>\n<p>위와 같은 세가지 레퍼런스 정보에 <strong>직, 간접적</strong>으로 참조되고 있다면 모두 접근가능한 객체이고, GC 대상이 아니라는 점을 명심하자.</p>\n</blockquote>\n<p>이제, 실제 GC가 어떤 식으로 동작하는 지 알아보자.</p>\n<h3 id=\"step-32-식별-알고리즘\" style=\"position:relative;\"><a href=\"#step-32-%EC%8B%9D%EB%B3%84-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\" aria-label=\"step 32 식별 알고리즘 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.2 식별 알고리즘</h3>\n<p>아래의 코드가 주어진다 가정하고 스택 프레임을 그려보겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> age<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> age<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>age <span class=\"token operator\">=</span> age<span class=\"token punctuation\">;</span> \n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> args<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">Member</span> member1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"bear\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Member</span> member2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rabbit\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Member</span> member3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tiger\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>member1<span class=\"token punctuation\">,</span> member2<span class=\"token punctuation\">,</span> member3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>스택 프레임은 아래와 같이 그려질 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/hhsbkF8.png\">\n</p>\n<p align=\"center\">\n    <em>그림 10. 예시 코드의 스택과 힙의 레퍼런스</em>\n</p>\n<p>만약 여기서 <code class=\"language-text\">member1 = null</code> 로 변경하면 레퍼런스가 아래와 같은 그림으로 변경될 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/wWLztN9.png\">\n</p>\n<p align=\"center\">\n    <em>그림 11. null로 처리된 후의 스택과 힙의 레퍼런스</em>\n</p>\n<p>하지만, 여전히 <code class=\"language-text\">members</code> 의 레퍼런스는 <code class=\"language-text\">null</code> 로 변경된 <code class=\"language-text\">member1</code> 을 참조하고 있다.</p>\n<p>이 부분이 바로 우리가 GC Root Set을 얘기할 때 나왔던 스택 내 레퍼런스 정보에 해당하는 예시라 볼 수 있다.\n현재, <code class=\"language-text\">member1</code> 의 직접적인 참조는 제거되었지만, <code class=\"language-text\">members</code> 가 해당 객체의 레퍼런스를 갖고 있으므로 간접적으로 접근이 가능하다.</p>\n<p>즉, <em><strong>접근가능한 객체(Reacheable Object)</strong></em> 로써 <code class=\"language-text\">member1</code> 은 아직 GC의 대상이 아니다.</p>\n<p>그렇다면 <code class=\"language-text\">members = null</code> 로 변경하게 되면 어떻게 될까?</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/r9OqVsE.png\">\n</p>\n<p align=\"center\">\n    <em>그림 12. 접근불가능한 객체(Unreacheable Object)가 나타난 상황</em>\n</p>\n<p>이런식으로 스택 프레임 내의 레퍼런스 정보가 변경될 것이다 더이상 접근할 수 없는 두 객체(Member Object, List Object)는 비로소 GC의 대상이 된다.</p>\n<p>그렇다면, 궁금한 점이 생길 것이다.</p>\n<blockquote>\n<p>그렇다면, 지속적으로 접근가능한 객체인지 아닌지 판별을 해야될 것 같은데 이는 어떻게 처리가 되나요?</p>\n</blockquote>\n<p>저러한 판별을 해주는 것이 바로 <em><strong>식별 알고리즘(Marking Algorithm)</strong></em> 이다.</p>\n<p>GC를 통한 마킹은 모든 활성 객체와 가비지 수집 준비가 되지 않은 모든 객체에 마킹이 된다.\n객체는 이 마킹 여부를 표시하는 <strong>특수 비트</strong>를 갖고 있다.</p>\n<p>생성 시에는 해당 비트가 0이고, 마킹 단계에서 객체가 여전히 사용 중이며 제거되지 않아야하는 경우 1로 설정된다.</p>\n<p>위 예시 중에서 <code class=\"language-text\">member1 = null</code> 이였던 상황을 재활용해서 스택 프레임과 특수비트를 표기하면 아래와 같을 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/0g4GOsB.png\">\n</p>\n<p align=\"center\">\n    <em>그림 13. 초기 마킹을 하는 상황</em>\n</p>\n<p>초기에는 모두 0으로 표기되다가 마킹을 수행하면, <code class=\"language-text\">member1</code> 제외하고 레퍼런스를 갖고 있기 때문에 아래와 같이 변경된다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/d0XRhAS.png\">\n</p>\n<p align=\"center\">\n    <em>그림 14. 스택에서 직접적으로 레퍼런스로 식별하는 객체 마킹</em>\n</p>\n<p>일단, 먼저 스택 내에서 직접적으로 접근 가능한 레퍼런스들을 갖고 있는 객체들에 대한 특수비트를 1로 바꾼다.\n이 후에 힙 내에서도 접근 가능한 레퍼런스를 마킹한다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/Cd67rdr.png\">\n</p>\n<p align=\"center\">\n    <em>그림 15. 힙 내부의 레퍼런스를 통한 객체 마킹</em>\n</p>\n<p>우리는 JVM에서 GC가 이뤄질 때 접근가능한 객체인지 아닌지를 판별하는 알고리즘을 살펴보았다.\n이 마킹 방법에는 크게 2가지 방법이 존재한다.</p>\n<h4 id=\"step-321-스탑-더-월드\" style=\"position:relative;\"><a href=\"#step-321-%EC%8A%A4%ED%83%91-%EB%8D%94-%EC%9B%94%EB%93%9C\" aria-label=\"step 321 스탑 더 월드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.2.1 스탑-더-월드</h4>\n<p>위에 식별 매커니즘을 보았을 때 궁금한 점이 있지 않은가? 바로 <strong>시점의 충돌</strong>이다.</p>\n<blockquote>\n<p>마킹하는 순간에 새로운 객체가 생겨나면?</p>\n<p>이 객체는 아직 특수비트가 0일 테고 나중에 GC대상이 될 수 있지 않을까요?</p>\n</blockquote>\n<p>라는 질문이 나올 수 있다. 이러한 시점의 차이로 인해서 살아있어야할 객체가 GC에 의해 수집된다면 아마도 재앙이라고도 볼 수 있을 것이다.</p>\n<p>스탑-더-월드 알고리즘은 이름처럼 마킹 단계에서 <strong>새 객체가 생성되지 않도록 실행을 일시 중지하는 기법</strong> 이라고 볼 수 있다.</p>\n<p>이 방법은 당연히 어플리케이션 <strong>성능에 매우 치명적인 영향</strong> 을 끼친다. 그래서, 많은 자바 개발자들은 스탑-더-월드가 없이 마킹 단계를 수행하고 싶어하였다.\n이러한 요구사항으로 나온 기법이 바로 <strong>레퍼런스 카운팅(Reference Counting)</strong> 이다.</p>\n<h4 id=\"step-322-레퍼런스-카운팅\" style=\"position:relative;\"><a href=\"#step-322-%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4-%EC%B9%B4%EC%9A%B4%ED%8C%85\" aria-label=\"step 322 레퍼런스 카운팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.2.2 레퍼런스 카운팅</h4>\n<p>이 알고리즘은 객체 헤더의 필드를 주어서 레퍼런스 카운트를 저장한 후 이 객체가 다른 객체에 의해 참조되는 경우 해당 객체의 레퍼런스 카운트는 1씩 증가하고, 해제될 경우에는 1씩 감소하는 단순한 매커니즘을 갖고 있다.</p>\n<p>즉, 카운트가 0이 되면 가비지 수집의 대상이 된다.</p>\n<p>스탑-더-월드가 일시 중지하는 이유는 위에서 설명했듯이 잠깐 중단하고, 힙의 모든 레퍼런스를 마킹해야되기 때문이라고 하였다. 하지만, 레퍼런스 카운팅은 실제 힙에 카운트를 저장하는 개념이다보니 이 스탑-더-월드를 최소화시킬 수 있다.</p>\n<p>위의 장점만 보면 매우 아름다운 알고리즘이라고 볼 수 있으나, 요즘 GC는 스탑-더-월드 방식을 채택한 후 이 스탑-더-월드 시간을 최소화하는 식으로 발전해왔다.\n왜 그럴까? 이 알고리즘은 2가지 단점을 갖고 있다.</p>\n<ol>\n<li>카운트 유지 오버헤드 : 각 객체는 레퍼런스 카운트를 유지해야되며, 레퍼런스가 삭제/생성될 때마다 업데이트해야된다. 이는 객체가 많아질 경우 상당한 오버헤드가 발생한다.</li>\n<li>고립된 섬 문제(Island of Isolation)<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup> : 순환참조 관계에서 발생하는 문제인데, 순환참조 관계에서는 카운트가 0으로 떨어지지않고 GC가 안되는 문제가 발생하여 메모리 릭이 발생할 수 있다.</li>\n</ol>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/ofah5OD.png\">\n</p>\n<p align=\"center\">\n  <em><a href=\"https://alibabatech.medium.com/how-does-garbage-collection-work-in-java-cf4e31343e43\">그림 16. Island of Isolation - Alibaba Tech</a></em>\n</p>\n<p>즉, 위와 같은 단점들을 갖고 있기 때문에 오늘날에도 우리는 식별 알고리즘에 스탑-더-월드를 사용하고 있는 것이다.\n이제 식별을 했으니 실제 메모리를 지우는 작업을 보고자한다. 이를 정리 알고리즘(Sweep Algorithm)이라 부를 것이다.</p>\n<h3 id=\"step-33-정리-알고리즘\" style=\"position:relative;\"><a href=\"#step-33-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\" aria-label=\"step 33 정리 알고리즘 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.3 정리 알고리즘</h3>\n<p>정리 알고리즘은 그냥 비워버리는 알고리즘부터 정리하면서 압축하는 알고리즘, 다른 곳으로 복제하는 알고리즘이 존재한다.\n기본적인 알고리즘부터 확인해보자.</p>\n<h4 id=\"step-331-기본-정리-알고리즘\" style=\"position:relative;\"><a href=\"#step-331-%EA%B8%B0%EB%B3%B8-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\" aria-label=\"step 331 기본 정리 알고리즘 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.3.1 기본 정리 알고리즘</h4>\n<p>기본 정리 알고리즘(Normal Sweeping, Mark-and-Sweep Algorithm)은 아주 단순하다.  아래의 그림을 보면 바로 이해될 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/LRqNaYu.png\">\n</p>\n<p align=\"center\">\n  <em>그림 17. 기본 정리 알고리즘</em>\n</p>\n<p>마킹 단계에서 접근가능하지 않은 객체로 판별된 녀석들을 위 그림과 같이 할당 해제하는 것이다.\n여기서, 점선은 메모리의 가용 영역이라고 생각하자.</p>\n<p>그런데, 위와 같이 처리하면 어떠한 문제가 생길까? 애초에 그림 상으로 봐도 메모리 단편화(Memory Fragmentation)<sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup> 이 발생했음을 확인할 수 있다.\n만약, 가용용량보다 큰 객체를 할당하고자 하면 어떠한 문제가 발생할까?</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/PIgTDYP.png\">\n</p>\n<p align=\"center\">\n  <em>그림 18. 크기가 큰 객체는 할당하지 못하는 문제(메모리 단편화)</em>\n</p>\n<p>위와 같은 객체가 들어오고자하면 두 가용공간 모두 할당을 실패하므로, <code class=\"language-text\">OutOfMemory</code> 가 발생할 것이다.\n이러한, 단편화를 막기 위해서 먼저, 접근가능하지 않은 객체를 지운 후 압축을 하는 압축-정리 알고리즘이 탄생하였다.</p>\n<h4 id=\"step-332-압축-정리-알고리즘\" style=\"position:relative;\"><a href=\"#step-332-%EC%95%95%EC%B6%95-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\" aria-label=\"step 332 압축 정리 알고리즘 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.3.2 압축-정리 알고리즘</h4>\n<p>압축-정리 알고리즘(Sweeping with compacting, Mark-and-Compaction Algorithm)은 위에서 말한 것과 같이 기본 알고리즘 이후에 압축 단계가 추가된 알고리즘이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/iuBg8oq.png\">\n</p>\n<p align=\"center\">\n  <em>그림 19. 압축-정리 알고리즘</em>\n</p>\n<p>이렇게 되면, 더 큰 객체도 할당할 수 있게 되고 메모리 단편화 문제도 해결할 수 있다.\n하지만 이 알고리즘의 경우 <strong>비용이 매우 비싼데</strong>, 그 이유는 위에서 보면 알 수 있듯이 압축을 하면서 모든 메모리 블록을 이동시키기 때문이다.</p>\n<p>이러한 문제때문에 복제-정리 알고리즘이 대두되었다.</p>\n<h4 id=\"step-333-복제-정리-알고리즘\" style=\"position:relative;\"><a href=\"#step-333-%EB%B3%B5%EC%A0%9C-%EC%A0%95%EB%A6%AC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98\" aria-label=\"step 333 복제 정리 알고리즘 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.3.3 복제-정리 알고리즘</h4>\n<p>복제-정리 알고리즘(Sweeping with copying, Copying Algorithm)은 <strong>아예 메모리 영역을 2개의 공간</strong>으로 나누어서 정리한다는 개념에서 출범하였다.</p>\n<p>그 이유는 <em><strong>압축 비용보다 영역 자체를 2개를 나눈 뒤 연속적으로 복제하는 것</strong></em>이 비용이 저렴하기 때문이다.</p>\n<p>복제-정리 알고리즘은 2단계로 나눠지는데 그림을 보면 이해하기 쉬울 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/WFawkyx.png\">\n</p>\n<p align=\"center\">\n  <em>그림 20. 복제-정리 알고리즘 (복제 단계)</em>\n</p>\n<p>GC 대상이 아닌 활성 객체들을 다른 영역에 복제를 한다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/V7oCY4Z.png\">\n</p>\n<p align=\"center\">\n  <em>그림 21. 복제-정리 알고리즘 (정리 단계)</em>\n</p>\n<p>기존 영역을 모두 정리한다.\n이 알고리즘은 압축보다 빠른 성능을 가지는 장점이 있지만, 추가적인 메모리 공간이 필요하다는 단점이 존재한다.\n위의 정리 알고리즘은 어떤 가비지 수집기(Garbage Collector)를 선택하는 지에 따라 달려있다.</p>\n<h3 id=\"step-34-gc-알고리즘-중간-정리\" style=\"position:relative;\"><a href=\"#step-34-gc-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98-%EC%A4%91%EA%B0%84-%EC%A0%95%EB%A6%AC\" aria-label=\"step 34 gc 알고리즘 중간 정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.4 GC 알고리즘 중간 정리</h3>\n<p>우리는 위에서 GC에서 이뤄지는 단계들에 대한 알고리즘을 세부적으로 살펴보았다.</p>\n<ol>\n<li>마킹 단계\n<ol>\n<li>스탑-더-월드</li>\n<li>레퍼런스 카운팅</li>\n</ol>\n</li>\n<li>스위핑 단계\n<ol>\n<li>기본 정리 알고리즘</li>\n<li>압축-정리 알고리즘</li>\n<li>복제-정리 알고리즘</li>\n</ol>\n</li>\n</ol>\n<p>마킹 단계에서는 레퍼런스 카운팅의 단점(독립된 섬 문제)<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup>가 존재하여 요즘날의 GC들은 스탑-더-월드 방식을 사용한다고 말했었다. 마킹 후에 새 객체를 위해 공간을 비우는 알고리즘들을 정리 알고리즘이라 말하며, 이에 대한 여러가지 알고리즘을 살펴보았다.</p>\n<p>이제 힙 &#x26; 스택 영역에서 어떤식으로 GC가 일어나는지를 확인하기에 앞 서 한가지 중요한 알고리즘을 보고 가자.</p>\n<h3 id=\"step-35-generational-algorithm\" style=\"position:relative;\"><a href=\"#step-35-generational-algorithm\" aria-label=\"step 35 generational algorithm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.5 Generational Algorithm</h3>\n<p>복제-정리 알고리즘을 사용하면서 몇 가지 경험적 지식이 체득되었는데 바로 <strong>대부분의 프로그램에서 생성되는 객체는 생성된 지 얼마 되지 않아 GC 대상이 되는 짧은 수명을 갖게 된다는 점</strong>과 또한 <strong>어떤 프로그램도 수명이 긴 몇 개의 객체들은 반드시 가지고 있다는 점</strong>이다.</p>\n<p>이를 <strong>약한 세대 가설(weak generational hypothesis)</strong><sup id=\"fnref-9\"><a href=\"#fn-9\" class=\"footnote-ref\">9</a></sup>라 한다.</p>\n<p>이 가설이 왜 복제-정리 알고리즘에서 경험적 지식으로 파생되었냐면, 수명이 긴 객체의 경우 위에 복제-정리 알고리즘 매커니즘에 의해서 두 영역을 서로 오고갈텐데 정리 대상은 아니게 되는 것이다.</p>\n<p>그러다보니 <em><strong>오버헤드가 만만치 않게 된다</strong></em>는 사실을 알게 된 것이다. 이 사실은 Generational Algorithm이 만들어지는 데 기여를 하였다.\n이 알고리즘을 토대로 메모리 단편화, 활용 그리고 복제-정리 알고리즘이 가진 오버헤드를 상당 부분 극복할 수 있었고 각 영역에 대해서 적절한 알고리즘을 선택할 수 있게 되었다.</p>\n<p>아래의 그림을 잠깐 봐보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/Cx9dI52.png\">\n</p>\n<p align=\"center\">\n  <em><a href=\"https://www.yes24.com/Product/Goods/3577335\">그림 22. Generational Algorithm, Java Performance Fundamental, 김한도 저</a></em>\n</p>\n<p>①은 GC 이전이고, ②는 GC 이후를 보여준다.</p>\n<p>각 영역에 대해서 적절한 알고리즘을 선택할 수 있게 된다고 얘기했는데 여기서 “Youngest Generation Sub Heap”은 기본 정리 알고리즘처럼 단편화가 발생한 모습을 볼 수 있고, “Oldest Generation Sub Heap” 영역은 복제-정리 알고리즘에 본듯이 처리된 모습을 볼 수 있다.</p>\n<blockquote>\n<p>💡 그림22는 JDK 1.5 시절 그림이므로 “영역별로 각기 다른 알고리즘을 적재적소에 쓸 수 있었다” 정도로 기억하자.</p>\n</blockquote>\n<p>현대의 대부분 가비지 수집기들은 이 알고리즘을 근간에 두고 있고, 밑에서 다룰 기본적인 GC 매커니즘을 설명할 때 나올 힙의 영역들에 대해서도 이 알고리즘의 영향을 받았다.</p>\n<h3 id=\"step-36-힙의-구조와-gc의-기본-동작\" style=\"position:relative;\"><a href=\"#step-36-%ED%9E%99%EC%9D%98-%EA%B5%AC%EC%A1%B0%EC%99%80-gc%EC%9D%98-%EA%B8%B0%EB%B3%B8-%EB%8F%99%EC%9E%91\" aria-label=\"step 36 힙의 구조와 gc의 기본 동작 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 3.6 힙의 구조와 GC의 기본 동작</h3>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/WgCCx2Q.png\">\n</p>\n<p align=\"center\">\n  <em>그림 23. 힙 메모리의 구조</em>\n</p>\n<p>위 그림은 힙의 구조를 나타낸다. 위에서 설명한 “Generational Algorithm” 에 따라서 2개의 세대의 영역으로 분리가 된다.</p>\n<ol>\n<li>Young Generation Space\n<ul>\n<li>에덴 영역(Eden Space) : 새로 할당되는 객체들이 위치하는 영역으로, 에덴영역에 더 이상 할당할 수 있는 객체의 공간이 없으면 <strong>마이너 GC가 발생</strong>한다.</li>\n<li>서바이버 영역(Survivor Space) :  2개의 동일한 크기를 가진 영역(S0, S1)으로 구성된다. <strong>마이너 GC</strong>는 이 영역을 서로 변경하면서 복제하는 방식으로 활용한다.  (복제-정리 알고리즘 참고)</li>\n</ul>\n</li>\n<li>Old Generation Space\n<ul>\n<li>GC에서 살아남은(Survivor Space에 존재하는) 일정 수의 객체가 임계값을 초과하여 생존할 때 넘어가는 공간으로 이 영역에 할당할 수 있는 공간이 없다면 <strong>풀(Full) GC가 발생</strong>한다.</li>\n</ul>\n</li>\n</ol>\n<p>참고로, 서바이버 영역의 <code class=\"language-text\">SO, S1</code> 은 <strong>논리적인 구분이고, 물리적인 구분은 아니다.</strong></p>\n<p>위에서 정리한 내용을 수도코드로 표기하면 아래와 같이 볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">- 에덴 영역이 가득차면 => 마이너 GC가 실행된다 :\n\t- Run #1:\n\t\t- 처음에 S0가 타겟 서바이버 영역(Target Survivor Space)이라고 가정한다.\n\t\t- 활성 객체를 에덴에서 S0로 복제한다; age=1 \n\t\t- S1의 활성객체를 검사한다 :\n\t\t\t- age + 1 >= threshold 일 경우 \n\t\t\t\tY : 오브젝트를 Old Generation Space로 복제한다.\n\t\t\t\tN : 오브젝트를 S0로 복제한다; age += 1\n\t\t- 에덴영역과 S1를 비운다\n\t\t- 에덴영역에 객체를 할당한다\n\t- Run #2:\n\t\t- S1이 타겟 서바이버 영역이면\n\t\t- 활성 객체를 에덴에서 S1로 복제한다; age=1 \n\t\t- S0의 활성객체를 검사한다 :\n\t\t\t- age + 1 >= threshold 일 경우\n\t\t\t\tY : 오브젝트를 Old Generation Space로 복제한다.\n\t\t\t\tN : 오브젝트를 S1로 복제한다; age += 1\n\t\t- 에덴영역과 S1를 비운다\n\t\t- 에덴영역에 객체를 할당한다\n\n- Old Generation Space가 가득차면 => 풀 GC가 실행된다 :\n\t- Old Generation Space를 정리한다.(GC에 따라 다름)</code></pre></div>\n<p>이 부분을 그림을 통해서 확인해보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/1iwbASD.png\">\n</p>\n<p align=\"center\">\n  <em>그림 24. 힙에 새로운 메모리가 할당</em>\n</p>\n<p>새로운 객체(H)가 들어오고자 하는데, 에덴 영역에 공간이 없는 상황이다.  이때, 마이너 GC가 발생한다.\n여기서, 빨간색으로 칠해진 A, D, G가 GC의 대상이라고 생각해보고 아래의 그림을 본 후 수도코드를 다시 한번 보면 어떤 일이 발생 했는지 이해가 될 것이다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/ee8sm6q.png\">\n</p>\n<p align=\"center\">\n  <em>그림 25. 새 객체가 에덴에 할당, 기존 생존 객체들은 서바이버 영역으로 이동</em>\n</p>\n<p>여기서 살아남은 객체들 밑에 생긴 숫자는 나중에 Old Generation Space로 승격(promotion)하기 위한 기준 값이 된다.\n또, 아래의 그림을 봐보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/S1JsY1L.png\">\n</p>\n<p align=\"center\">\n  <em>그림 26. 추가로 또 마이너 GC가 일어나는 상황</em>\n</p>\n<p>위와 같은 상황에서 GC가 일어나면 어떤 그림이 그려질 지 생각해보고 아래의 그림을 봐보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/DTcVPnj.png\">\n</p>\n<p align=\"center\">\n  <em>그림 27. 생존 객체들을 Target 서바이버 영역으로 복제</em>\n</p>\n<p>위 그림과 비슷하게 생각했다면 정답이다.\n마이너 GC는 위 매커니즘으로 동작하며, 오래 생존한 객체는 수도 코드에 보이듯  <code class=\"language-text\">age + 1 >= threshold</code> 조건이 될 경우 Old Generation Space으로 승격된다.\n이 임계값은  <code class=\"language-text\">-XX:MaxTenuringThreshold</code> 로 조절할 수 있다.</p>\n<p>위의 마이너 GC 또한 어떠한 가비지 수집기(Garbage Collector)를 쓰느냐에 따라서 달라지는데 이를 알아보기 앞서 메서드 영역을 살펴보고, 마지막으로 각 가비지 수집기에 대한 특징과 동작 방식을 설명한 후에 글을 마무리 짓도록 하겠다.</p>\n<h2 id=\"step-4-메서드-영역메타스페이스-영역\" style=\"position:relative;\"><a href=\"#step-4-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%98%81%EC%97%AD%EB%A9%94%ED%83%80%EC%8A%A4%ED%8E%98%EC%9D%B4%EC%8A%A4-%EC%98%81%EC%97%AD\" aria-label=\"step 4 메서드 영역메타스페이스 영역 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 4. 메서드 영역(메타스페이스 영역)</h2>\n<p>메서드 영역은 서두에서 설명했던 내용처럼 <em><strong>클래스의 메타데이터인 런타임 코드, 정적 변수, 상수 풀 그리고 생성자 코드등을 포함</strong></em>한다고 하였다.</p>\n<p>메서드 영역도 변경의 역사가 존재하는데 이에 대해서 간단하게 짚고 넘어가보자.</p>\n<h3 id=\"step-41-자바-8-이전과-이후의-메서드-영역\" style=\"position:relative;\"><a href=\"#step-41-%EC%9E%90%EB%B0%94-8-%EC%9D%B4%EC%A0%84%EA%B3%BC-%EC%9D%B4%ED%9B%84%EC%9D%98-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%98%81%EC%97%AD\" aria-label=\"step 41 자바 8 이전과 이후의 메서드 영역 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 4.1 자바 8 이전과 이후의 메서드 영역</h3>\n<p>원래, 이 영역은 본래 자바 8 이전에는 <code class=\"language-text\">PermGen</code> 이라는 영역으로 불렀고, <strong>힙 영역의 일부로 자리</strong>를 하고 있었다.\n물론, 위에서 GC Root Set을 설명할 때 말했지만, 이 영역은 GC의 대상이 아닐 확률이 크고(밑에서 메서드 영역의 GC에 대해서 설명할 것임), 고정된 크기로 할당되었다.\n<code class=\"language-text\">-XX:PermSize=256m -XX:MaxPermSize=256m</code> 과 같은 인자를 통해서 늘리거나 줄일 수 있었다.</p>\n<p>하지만, 하드웨어 성능이 좋아지고 램은 더 싸지기 시작하면서 자바 언어를 활용하여 더 많은 클래스와 객체들이 올라가기 시작했고 이는 OOM의 원인이 되기도 하였다.\n따라서, 이 영역을 대체하고자 하였고 그 내용은 <a href=\"https://openjdk.org/jeps/122\">JEP 122 - Remove the Permnent Generation</a> 이 이슈를 확인하여 볼 수 있다.</p>\n<p>저 이슈에서 “Success Metric” 부분만 발췌해오면 아래와 같다.</p>\n<blockquote>\n<p>Class metadata, interned Strings and class static variables will be moved from the permanent generation to either the Java heap or native memory.\nThe code for the permanent generation in the Hotspot JVM will be removed.\nApplication startup and footprint will not regress more than 1% as measured by a yet-to-be-chosen set of benchmarks.</p>\n</blockquote>\n<p>맨 윗줄을 보면 클래스 메타데이터나 정적 변수 등이 <code class=\"language-text\">PermGen</code> 에서 자바 힙 혹은 네이티브 메모리로 옮겨진다고 되어있다.\n이 중 네이티브 메모리 영역으로 옮겨진 부분이 바로, 메타스페이스 영역이다.</p>\n<p>즉,  <code class=\"language-text\">Metaspace</code> 영역은 네이티브 메모리에 동작을 함으로써 부족할 경우에 자동으로 늘어나는 식으로 하여 기존의 <code class=\"language-text\">PermGen</code> 에 비해 클래스 로드되는 건 수가 많더라하더라도 비교적 안전해졌다.</p>\n<p>물론, <code class=\"language-text\">-XX:MaxMetaspaceSize</code> 인자를 통해서 상한을 지정할 수도 있긴하다.</p>\n<p>이뿐만 아니라, 압축 클래스 영역(Compress Class Space) 라는 영역도 추가되었다.</p>\n<p>우리가 이 글에서 자주 보았던 레퍼런스는 JVM이 OOPS(Ordinary Object Pointers)<sup id=\"fnref-10\"><a href=\"#fn-10\" class=\"footnote-ref\">10</a></sup>라는 자료구조를 활용하여 관리한다.</p>\n<p>32bit 시스템에서는 oops는 최대 힙을 4GB<span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><msup><mn>2</mn><mn>32</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(2^{32})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">32</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span>까지 사용할 수 있고, 64bit 시스템에서는 oops는 최대 힙을 18.5EB<span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><msup><mn>2</mn><mn>64</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(2^{64})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span>까지 사용할 수 있다.</p>\n<p>이것은 이론적인 숫자에 불과하고, 실제로 64bit 포인터로 공간을 관리하는 것은 매우 비효율적이다.</p>\n<p>이에, Compressed OOPS라는 녀석이 나왔는데 이는 64bit 환경에서도 OOPS는 32bit 포인터를 활용하게끔 하는 것이다. 이 때문에 많은 자바 어플리케이션들이 32GB 이상 힙 사이즈를 넘지 않는 것을 권고하는 이유기도 하다.</p>\n<p>이유는 32GB가 넘어갈 경우에는 Compressed OOPS 기능이 꺼지고, 원래대로 포인터 자체가 64bit를 활용하게 된다.</p>\n<p>이러한 이유때문에 ES와 같은 곳에서 32GB 이하의 힙사이즈를 추천 설정으로 이야기하는 것이다. 이 부분에 대해서 궁금하다면 아래의 링크를 참고해보자.</p>\n<p>참고 : <a href=\"https://discuss.elastic.co/t/es-lucene-32gb-heap-myth-or-fact/22920\">ES&#x26;Lucene 32GB heap myth or fact? - Elsatic Discuss</a></p>\n<p>이에 대한 자세한 동작 방식이나 매커니즘은 <a href=\"https://github.com/openjdk/jdk/blob/jdk-18-ga/src/hotspot/share/oops/compressedOops.hpp\">compressedOops.hpp - OpenJDK github</a> 를 참고해보도록 하자.</p>\n<p>어쨋든간 중요한 점은 <code class=\"language-text\">PermGen</code> 이라는 기존 힙에서 관리하던 메타데이터들을 네이티브 영역에 분리하였는데 그것을 <code class=\"language-text\">Metaspace</code> 라 부르며,  Compressed OOPS나 네이티브 메모리를 활용한 기능들을 통해서 보다 현대적인 어플리케이션의 요구사항을 감당하게끔 되었다는 점이다.</p>\n<h3 id=\"step-42-메서드-영역에서의-gc-동작\" style=\"position:relative;\"><a href=\"#step-42-%EB%A9%94%EC%84%9C%EB%93%9C-%EC%98%81%EC%97%AD%EC%97%90%EC%84%9C%EC%9D%98-gc-%EB%8F%99%EC%9E%91\" aria-label=\"step 42 메서드 영역에서의 gc 동작 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 4.2 메서드 영역에서의 GC 동작</h3>\n<p>간략하게 메서드 영역에 대해서 소개를 진행하였다.\n메서드 영역 또한 우리가 위에서 보았던 힙 영역의 Minor GC 매커니즘과 흡사한데 차이점이 있는 부분은 접근가능 객체를 식별하는데 <em><strong>클래스 로딩</strong></em>과 관련이 있다 정도이다.</p>\n<p>이 구조를 그림으로 봐보자.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/FSf6dCG.png\">\n</p>\n<p align=\"center\">\n  <em>그림 28. 스택, 힙 그리고 메타스페이스의 상황</em>\n</p>\n<p>에덴 영역에 들어있는 빨간색 동그라미는 <em><strong>클래스 로더 객체</strong></em>를 뜻하며, 파란색은 A 객체, 노란색은 C 객체라고 보면서 설명을 읽어주길 바란다.</p>\n<ul>\n<li>JVM은 클래스 로더 객체와 A 객체 2개, 그리고 C 객체 1개를 힙에 생성한다.</li>\n<li>첫번째 A와 C를 생성할 때, 클래스 로더는 메타스페이스에 A와 C에 대한 메타데이터를 로드한다.</li>\n<li>하지만 두번째 A 객체는 메타스페이스에서는 어떤 일도 발생하지않는다. 이미 “Metadata A”가 로드되어 있기 때문이다.</li>\n</ul>\n<p>자 이제 아래와 같이 레퍼런스가 변경되었다고 가정해보겠다.</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/hCUm3PT.png\">\n</p>\n<p align=\"center\">\n  <em>그림 29. A 객체에 대해서 끊어진 레퍼런스</em>\n</p>\n<p>스택에 대한 레퍼런스 정보가 <code class=\"language-text\">pop</code> 되었지만, GC가 실행되지 않아서 인스턴스가 살아있는 상황이다. 이때 만약, GC가 벌어지면 어떠한 그림으로 변경될까?</p>\n<p align=\"center\">\n    <img src=\"https://i.imgur.com/6J1zXZQ.png\">\n</p>\n<p align=\"center\">\n  <em>그림 30. 에덴 영역에서 서바이버 영역으로 이동</em>\n</p>\n<p>위에서 본 내용과 같이 객체 C는 에덴 영역에서 서바이버 영역으로 이동될 것이다. 이때, 클래스 로더 객체도 같이 움직인다.\nA 객체가 가비지 수집에 의해서 제거됐지만, 메타스페이스는 A의 메타데이터를 들고 있다. 이는 <em><strong>힙에 C 객체가 남아있어서 클래스 로더를 회수 할 수 없기 때문</strong></em>이다.\n즉, 클래스 로더가 가비지 수집에 의해서 회수가 되고 메타스페이스 영역이 정리가 되려면, <em><strong>클래스 로더 객체에 의해 로드된 모든 클래스가 정리</strong></em>가 되어야만 한다.</p>\n<p>이것이 힙 영역에서의 GC와 메서드 영역에서의 GC의 동작 방식 중에 가장 차이가 나는 부분이다.\n이제 마지막으로 가비지 수집기에 대해서 다루고 포스팅을 마무리 짓도록 하겠다.</p>\n<h2 id=\"step-5-가비지-수집기\" style=\"position:relative;\"><a href=\"#step-5-%EA%B0%80%EB%B9%84%EC%A7%80-%EC%88%98%EC%A7%91%EA%B8%B0\" aria-label=\"step 5 가비지 수집기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 5. 가비지 수집기</h2>\n<h3 id=\"step-51-serial-gc\" style=\"position:relative;\"><a href=\"#step-51-serial-gc\" aria-label=\"step 51 serial gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 5.1 Serial GC</h3>\n<p><img src=\"https://i.imgur.com/u6kHGF0.png\" alt=\"\"></p>\n<p>오늘날 개발자들은 자주 사용하지 않을 GC면서 절대로 사용해서는 안되는 방식이다. (CPU 코어가 1개일 경우를 위해서 만든 녀석이다.)</p>\n<ul>\n<li>Young Generation Space(Minor GC) : 우리가 앞서서 봤던 알고리즘대로 동작한다. (수도코드 참고 (복제-정리 알고리즘과 흡사))</li>\n<li>Old Generation Space(Full GC) : 압축-정리 알고리즘을 사용한다.</li>\n</ul>\n<p>GC 쓰레드가 수행되면 다음과 같은 순서에 의해서 동작된다.</p>\n<ol>\n<li>마킹을 수행 (스탑-더-월드 발생)</li>\n<li>정리를 수행</li>\n<li>압축을 수행</li>\n</ol>\n<p>해당 GC를 활성하기 위해서는 <code class=\"language-text\">-XX: +UseSerialGC</code> 를 JVM 인자로 넘겨주면 된다.</p>\n<h3 id=\"step-52-parallel-gc\" style=\"position:relative;\"><a href=\"#step-52-parallel-gc\" aria-label=\"step 52 parallel gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 5.2 Parallel GC</h3>\n<p><img src=\"https://i.imgur.com/EdWHvqU.png\" alt=\"\"></p>\n<p>동작 원리는 Serial GC와 흡사하지만, 멀티쓰레드로 수행한다는 차이가 존재한다.</p>\n<ul>\n<li>Young Generation Space(Minor GC) : 우리가 앞서서 봤던 알고리즘대로 동작한다. (단, 병렬 복제를 지원)</li>\n<li>Old Generation Space(Full GC) : 압축-정리 알고리즘을 사용한다.</li>\n</ul>\n<p>해당 GC가 생겨나게 된 이유는 멀티 코어 혹은 멀티 CPU 환경이 대두되면서, 힙 영역의 크기 또한 덩달아 커져갔고 Serial GC의 스탑-더-월드는 길어져만 갔다.\n이 길어진 스탑-더-월드를 해결하고, 어플리케이션의 처리량(Throughput)을 증대시키는 것을 목표로 하였다.</p>\n<p>병렬로 여러 쓰레드를 사용하여 동시에 힙 영역을 정리하며,  스탑-더-월드가 발생하지만 Serial GC와 비교해서 시간이 보다 짧으므로 더 나은 성능을 갖는다.</p>\n<p>주의할 점은 병렬 쓰레드로 처리되다보니 두 개의 쓰레드나 프로세스가 동일 메모리 공간을 점유하는 레이스 컨디션 문제가 발생할 수 있다. 이 때문에 동기화 작업이 수반되어야하는데 이 경우 서바이버 영역에서 살아남은 객체들을 승격하는 성능이 떨어지게 된다. 이 때문에, HotSpot VM에서는 PLAB(Parallel Local Allocation Buffer)<sup id=\"fnref-11\"><a href=\"#fn-11\" class=\"footnote-ref\">11</a></sup>라는 승격용 버퍼를 만들었다. 해당 부분은 각주를 보고 참고하자.</p>\n<p>이 GC를 활성화하기 위해서는 <code class=\"language-text\">-XX: +UseParallelGC</code> 인자를 전달하자.</p>\n<h3 id=\"step-53-cms-gc\" style=\"position:relative;\"><a href=\"#step-53-cms-gc\" aria-label=\"step 53 cms gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 5.3 CMS GC</h3>\n<p><img src=\"https://i.imgur.com/EYVaigT.png\" alt=\"\"></p>\n<p>CMS(Concurrent Mark &#x26; Sweep) GC는 아래의 특징을 갖고 있다.</p>\n<ul>\n<li>Young Generation Space(Minor GC) : 우리가 앞서서 봤던 알고리즘대로 동작한다. (수도코드 참고 (복제-정리 알고리즘과 흡사))</li>\n<li>Old Generation Space(Full GC) : 동시성 기본 정리 알고리즘(Concurrent Mark &#x26; Sweep)</li>\n</ul>\n<p>이 알고리즘의 초점은 GC 이벤트(Fast Elapsed Time)의 기간을 줄이는 것이다.\n즉, 스탑-더-월드의 시간을 적절하게 분산하여 응답시간을 개선하는데 초점을 둔 수집기라고 볼 수 있다.</p>\n<p>이를 단계별로 설명하면 아래와 같다.</p>\n<ol>\n<li>Initial Mark\n<ul>\n<li>힙 내부의 모든 살아있는 객체를 살피는 것이 아니라 Root Set에서 직접적으로 연결된 객체만 마킹한다. 따라서, 스탑-더-월드는 매우 짧다.</li>\n<li>그림에서 보는 바와 같이 이 단계는 싱글 쓰레드로 동작한다.</li>\n</ul>\n</li>\n<li>Concurrent Mark\n<ul>\n<li>Initial Mark 단계에서 식별된 객체들을 대상으로 레퍼런스를 추적하여 마킹을 수행한다.</li>\n<li>이때, 다른 쓰레드가 실행 중인 상태에서 동시에 진행된다. (즉 파란색 쓰레드들은 어플리케이션 실행에 쓰인다.)</li>\n</ul>\n</li>\n<li>Remark\n<ul>\n<li>Concurrent Mark 단계에서 새로 추가되거나 레퍼런스가 끊긴 객체를 확인한다. (실제 스탑-더-월드 발생이 제일 긺)</li>\n</ul>\n</li>\n<li>Concurrent Sweep\n<ul>\n<li>Remark 단계에서 최종적으로 수집 대상이 된 객체들을 정리한다. (이 작업도 다른 쓰레드가 실행 중인 상황에서 동작한다.)</li>\n</ul>\n</li>\n</ol>\n<p>중요한 점은 다른 GC들과 다르게 압축을 수행하지 않는데, 그 이유는 동시성(Concurrent)를 보장하기 위해서는 힙 영역 전체가 멈추는 상황을 최소화해야하는데, 압축을 수행하게될 경우에 위에서 살펴본 바와 같이 모든 메모리 블록을 움직여야하고 그렇다면 힙 영역을 멈춰야하는 작업이 필요하다. 따라서, CMS GC는 압축을 수행하지 않는다.</p>\n<p>위에서 본 압축을 안하면 생기는 단점처럼 CMS 역시, 단편화 현상을 유발할 수 있다.\n이를 위해서 Freelist를 활용하는데 이를 활용하면 Freelist를 탐색하는 과정이 추가되기 때문에 승격(Promotion) 시간이 길어지고, 에덴 영역 혹은 서바이버 영역에 객체가 체류하는 시간이 늘어난다.</p>\n<p>하지만 압축은 위에서 말했듯이 비용이 매우 비싼 작업이므로 승격이 자주 일어나지 않는 경우에 성능 상의 이점을 가져갈 수 있다.</p>\n<h3 id=\"step-54-g1garbage-firstgc\" style=\"position:relative;\"><a href=\"#step-54-g1garbage-firstgc\" aria-label=\"step 54 g1garbage firstgc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>STEP 5.4 G1(Garbage First)GC</h3>\n<p><img src=\"https://i.imgur.com/k5VpgxW.png\" alt=\"\"></p>\n<p>자바11부터 기본적으로 설정되는 GC로, 지금까지 살펴보았던 GC들과 다르다.\n위에서 Generational Algorithm에 의해서 힙의 구조가 설계되었고, 대부분의 GC는 이를 따른다고 하였다.</p>\n<p>하지만, G1GC는 Young Generation Space와 Old Generation Space의 물리적인 공간을 허물고, 논리적으로만 분리되게끔 하였다.</p>\n<p>이러한 이유는 위에서 본 GC들의 단점에서부터 비롯되었는데 CMS GC를 설명하면서 결국 압축을 하지않음으로서 파편화가 발생할 수 있다고 하였다. 여기서는 생략했지만 CMS GC 이후에 Parallel Compaction GC라는 수집기도 생겼는데 이름에서만 봐도 알 수 있듯이 결국 다시 “압축” 방식으로 회귀하였다.</p>\n<p>G1GC는 이러한 근본적인 문제를 해결하기 위해서 물리적인 Generation의 구분을 없애고 전체 힙 영역을 리전(Region)이라는 단위로 개편하였다.\n따라서, 더 이상 세대를 관리하는 두 공간 모두 연속된 메모리 공간이라는 보장도 사라졌고, Young / Old라는 개념도 논리적인 개념으로만 자리잡게 되었다.</p>\n<p>이름에서 보듯이 이 수집기의 동작원리를 알 수 있는데 Garbage로 차있는 Region부터 먼저(First) 정리를 수행하기 때문에 G1GC라는 이름이 붙이게 되었다.\n추가적으로 “Humongous Region” 처럼 큰 크기의 객체를 할당하기 위한 리전도 추가가 되었다.</p>\n<ul>\n<li>Minor GC</li>\n</ul>\n<p>Young Generation 리전들을 대상으로 접근가능한 객체를 찾아낸 후 일정 임계치를 넘지 않은 객체들은 서바이버 리전으로 복제(Copy)한다.\n임계치를 넘은 리전들은 Old Generation 리전으로 복제한다. 그리고 기존의 Young Generation은 가비지로 간주하여 Region 단위로 할당을 해지한다.</p>\n<ul>\n<li>Full GC</li>\n</ul>\n<p>Minor GC가 끝나면 바로 Full GC가 발생한다. 그렇다고 해서 이전의 GC들처럼 힙 영역 전반에 걸친 가비지 수집이 일어나지는 않고, Region 단위로 발생한다.\n이러한 까닭에 스탑-더-월드 현상도 해당 리전을 사용하는 쓰레드에 국한된다. 이러한 기법을 통해서 가비지 수집의 충격을 최소화하였다.</p>\n<p>간략한 플로우는 아래와 같다.</p>\n<ol>\n<li>Minor GC 발생 (Evaucation Pause) : 위의 Minor GC와 동일</li>\n<li>Concurrent Mark : 마킹 / 리마킹으로 구분이된다.\n<ul>\n<li>마킹(Marking) : 이전 단계에서 변경된 정보를 토대로 Initial Mark를 빠르게 수행한다. (CMS 참고, CMS와 같이 동시적으로 수행 가능)</li>\n<li>리마킹(Remarking) : 전체 쓰레드가 함께 작업에 참가하여, 스탑-더-월드가 발생하며 각 리전마다 접근가능한 객체를 판별하며 가비지 리전은 다음 단계로 넘어가지 않고 이 단계에서 해지된다.</li>\n</ul>\n</li>\n<li>Old Region Reclaim : Old 리전에 대한 회수 단계로 여기도 리마킹 / Evacauation Pause 단계가 포함된다.\n<ul>\n<li>리마킹(Remarking) : 가비지 수집을 위해 살아있는 객체의 비율이 낮은 리전 중 몇 개를 추려내는 작업을 수행한다.</li>\n<li>Evacuation Pause : Young 리전에 대한 가비지 수집도 포함하며, 리마킹 단계에서 식별한 Old Region과 같이 수집이 된다.\n<ul>\n<li>이렇게 함으로써, 생존률이 높은 리전들만 골라낼 수 있게되고 이 단계에서 Young / Old에 대한 작업이 동시적으로 수행되서 Mixed-GC라고도 부른다.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Compaction : 다른 GC의 압축과 달리 동시성을 보장해준다. 이러한 방식이 가능한 이유는 리전단위로 작업을 수행하기 때문이다. 이를 토대로 단편화를 방지할 수 있다.</li>\n</ol>\n<p><img src=\"https://i.imgur.com/7LqTMaD.png\" alt=\"\"></p>\n<p>이에 대한 GC Cycle도 존재하는데 Young-only 단계는 위에서 본 Minor GC의 시작으로 시작되며, 이후  Old Region Reclaim 단계가 Space Reclamation 단계라고 보면 된다.\n여기서 Mixed-GC가 수행되서 공간을 확보하며, 더 이상 효율적으로 Old 리전을 줄일 수 없다 판단되면 다시 Young-only 단계로 돌아간다.</p>\n<h1 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h1>\n<p>어쩌다보니까 초 장문의 글이 되었다.\n정리해서 담으려다보니 대부분의 내용을 담고 싶어졌고, 오히려 욕심때문인지 글이 매우 길어졌다.</p>\n<p>일단, 새벽에 작성하는 글이라 추후 다음을 예정인데 혹시라도 다듬기 전에 글을 보고 계시는 분이라면 댓글로 오타나 수정사항이 있으면 알려주시면 감사할 것 같다.</p>\n<p>아무쪼록 매우 긴 글인데 읽어주셔서 감사합니다.</p>\n<h1 id=\"레퍼런스-및-참고자료\" style=\"position:relative;\"><a href=\"#%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4-%EB%B0%8F-%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\" aria-label=\"레퍼런스 및 참고자료 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>레퍼런스 및 참고자료</h1>\n<ol>\n<li><a href=\"https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-2.html#jvms-2.6.2\">Chapter 2. The Structure of the Java Virtual Machine - Oracle Java SE17 JVM Spec</a></li>\n<li><a href=\"https://homoefficio.github.io/2019/01/31/Back-to-the-Essence-Java-%EC%BB%B4%ED%8C%8C%EC%9D%BC%EC%97%90%EC%84%9C-%EC%8B%A4%ED%96%89%EA%B9%8C%EC%A7%80-1/\">Back to the Essence - Java 컴파일에서 실행까지 - (1) - HomoEfficio</a></li>\n<li><a href=\"https://homoefficio.github.io/2019/01/31/Back-to-the-Essence-Java-%EC%BB%B4%ED%8C%8C%EC%9D%BC%EC%97%90%EC%84%9C-%EC%8B%A4%ED%96%89%EA%B9%8C%EC%A7%80-2/\">Back to the Essence - Java 컴파일에서 실행까지 - (2) - HomoEfficio</a></li>\n<li><a href=\"https://alibabatech.medium.com/how-does-garbage-collection-work-in-java-cf4e31343e43\">How Does Garbage Collection Work in Java? - Alibaba Tech</a></li>\n<li><a href=\"https://johngrib.github.io/wiki/jvm-stack/\">JVM stack과 frame - 기계인간 John Grib</a></li>\n<li><a href=\"https://johngrib.github.io/wiki/defensive-copy/\">방어적 복사(defensive copy) - 기계인간 John Grib</a></li>\n<li><a href=\"https://blog.voidmainvoid.net/315\">Java PermGen의 역사 - 데브원영</a></li>\n<li><a href=\"https://goodgid.github.io/Java-8-JVM-Metaspace/\">Java 8에서 JVM의 변화 : PermGen이 사라지고 Metaspace가 등장하다. - goodGid</a></li>\n<li><a href=\"https://openjdk.org/jeps/122\">JEP 122: Remove the Permanent Generation - OpenJDK Project</a></li>\n<li><a href=\"https://www.oracle.com/webfolder/technetwork/tutorials/mooc/JVM_Troubleshooting/week1/lesson1.pdf\">JVM Trobleshooting MOOC - Oracle</a></li>\n<li><a href=\"https://xephysis.tistory.com/6\">JVM Compressed OOPS - xephysis</a></li>\n<li><a href=\"https://www.baeldung.com/jvm-compressed-oops\">Compressed OOPs in the JVM - Baeldung</a></li>\n<li><a href=\"https://johngrib.github.io/wiki/jvm-memory/\">JVM 메모리 구조와 GC - 기계인간 John Grib</a></li>\n<li><a href=\"https://thinkground.studio/2020/11/07/%EC%9D%BC%EB%B0%98%EC%A0%81%EC%9D%B8-gc-%EB%82%B4%EC%9A%A9%EA%B3%BC-g1gc-garbage-first-garbage-collector-%EB%82%B4%EC%9A%A9/\">일반적인 GC 내용과 G1GC (Garbage-First Garbage Collector) 내용 - ThinkGround</a></li>\n<li><a href=\"https://velog.io/@hanblueblue/GC-1.-G1GC\">1. G1GC - keep going</a></li>\n<li><a href=\"https://www.codecentric.de/wissens-hub/blog/35gb-heap-less-32gb-java-jvm-memory-oddities\">Why 35GB Heap is Less Than 32GB – Java JVM Memory Oddities - codecentric</a></li>\n</ol>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\"><a href=\"https://thinkpro.tistory.com/67\">댕글링 포인터(Dangling Pointer) -THINK-PRO BLOG</a><a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-2\"><a href=\"https://en.wikipedia.org/wiki/HotSpot_(virtual_machine)\">HotSpot(virtual machine) - wikipedia</a><a href=\"#fnref-2\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-3\"><a href=\"https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-2.html#jvms-2.6.3\">Java Virtual Machine Specification - Oracle Docs</a><a href=\"#fnref-3\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-4\"><a href=\"https://johngrib.github.io/wiki/defensive-copy/\">방어적 복사(defensive copy) - 기계인간 John Grib</a><a href=\"#fnref-4\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-5\"><a href=\"https://jojoldu.tistory.com/412\">일급 콜렉션(First Class Collection)의 소개와 써야할 이유 - 기억보단 기록을</a><a href=\"#fnref-5\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-6\"><a href=\"https://en.wikipedia.org/wiki/Object_copying\">Object Copying - wikipedia</a><a href=\"#fnref-6\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-7\"><a href=\"https://medium.com/javarevisited/curious-case-of-island-of-isolation-6243f3a6698d\">The curious case of Island of Isolation - Arun Jijo</a><a href=\"#fnref-7\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-8\"><a href=\"https://jeong-pro.tistory.com/91\">메모리 단편화(Memory Fragmentation)가 무엇이고 왜 발생하는가? - 기본기를 쌓는 정아마추어 코딩블로그</a><a href=\"#fnref-8\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-9\"><a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/generations.html\">Generations - Oracle JDK8 Docs</a><a href=\"#fnref-9\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-10\"><a href=\"https://wiki.openjdk.org/display/HotSpot/CompressedOops\">CompressedOops - OpenJDK Wiki</a><a href=\"#fnref-10\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-11\"><a href=\"https://alidg.me/blog/2019/6/21/tlab-jvm\">Thread-Local Allocation Buffers in JVM - Kemikit</a><a href=\"#fnref-11\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","frontmatter":{"date":"July 15, 2023","title":"Fundamental of JVM and Memory and GC - Java JVM과 메모리 그리고 GC의 동작 과정 이해","categories":"개발","author":"개발한입","emoji":"💻"},"fields":{"slug":"/fundamental-jvm-memory/"}},"prev":{"id":"addafc2f-d783-5e3c-9397-e7d16b087547","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#1-%EC%84%9C%EB%A1%A0\">1. 서론</a></p>\n<ul>\n<li>\n<p><a href=\"#11-%EB%B3%91%EB%A0%AC%EC%84%B1%EA%B3%BC-%EB%8F%99%EC%8B%9C%EC%84%B1\">1.1 병렬성과 동시성</a></p>\n</li>\n<li>\n<p><a href=\"#12-run-queue%EC%99%80-wait-queue\">1.2 Run Queue와 Wait Queue</a></p>\n<ul>\n<li><a href=\"#121-run-queue\">1.2.1 Run Queue</a></li>\n<li><a href=\"#122-wait-queue\">1.2.2 Wait Queue</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%A6%AC%EB%88%85%EC%8A%A4-%EB%82%B4%EC%97%90%EC%84%9C-%EA%B8%B0%EB%B3%B8%EC%A0%81%EC%9D%B8-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81\">리눅스 내에서 기본적인 스케줄링</a></p>\n<ul>\n<li><a href=\"#13-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%83%81%ED%83%9C-%EB%B3%80%ED%99%94\">1.3 프로세스 상태 변화</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B0%80%EC%83%81-%EC%A3%BC%EC%86%8C-%EA%B3%B5%EA%B0%84\">가상 주소 공간</a></p>\n<ul>\n<li><a href=\"#14-mmiomemory-mapped-io\">1.4 MMIO(Memory Mapped I/O)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#2-%EB%B3%B8%EB%A1%A0\">2. 본론</a></p>\n<ul>\n<li>\n<p><a href=\"#21-virt--res--shr\">2.1 VIRT &#x26; RES &#x26; SHR</a></p>\n</li>\n<li>\n<p><a href=\"#22-memory-commit\">2.2 Memory Commit</a></p>\n</li>\n<li>\n<p><a href=\"#23-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%9D%98-%EC%83%81%ED%83%9C\">2.3 프로세스의 상태</a></p>\n</li>\n<li>\n<p><a href=\"#24-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%9D%98-%EC%9A%B0%EC%84%A0%EC%88%9C%EC%9C%84\">2.4 프로세스의 우선순위</a></p>\n</li>\n<li>\n<p><a href=\"#3-load-averrage%EC%99%80-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EB%B6%80%ED%95%98\">3. Load Averrage와 시스템 부하</a></p>\n<ul>\n<li><a href=\"#31-cpu-bound-vs-io-bound\">3.1 CPU Bound vs I/O Bound</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<p>최근에 커널 책을 같이 읽고 정리하는 스터디를 시작하였다. 이를 다루기 앞서, 난이도가 조금 있다보니 배경지식이 조금 필요한 것으로 보인다.\n이에 따라, 중요한 개념 몇가지만 짚고 이와 연관된 내용으로 같이 얘기를 해보고자 한다.</p>\n<h2 id=\"1-서론\" style=\"position:relative;\"><a href=\"#1-%EC%84%9C%EB%A1%A0\" aria-label=\"1 서론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 서론</h2>\n<h3 id=\"11-병렬성과-동시성\" style=\"position:relative;\"><a href=\"#11-%EB%B3%91%EB%A0%AC%EC%84%B1%EA%B3%BC-%EB%8F%99%EC%8B%9C%EC%84%B1\" aria-label=\"11 병렬성과 동시성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 병렬성과 동시성</h3>\n<p><img src=\"https://i.imgur.com/KW1ffSd.png\" alt=\"\"></p>\n<ol>\n<li>병렬성(Parallelism)\n<ul>\n<li>물리적 쓰레드에 연관이 있으며, 코어 당 만약 1개의 쓰레드를 가지게 되면 4개의 물리적 쓰레드를 갖게 된다.</li>\n<li>이 물리적 쓰레드는 실제로 분리된 코어 상에서 동작하므로 동시에 수행될 수 있다.</li>\n</ul>\n</li>\n</ol>\n<p><img src=\"https://i.imgur.com/vyDaj7R.png\" alt=\"\"></p>\n<p>위와 같이 태스크들이 4개로 병렬 수행을 한다해도 문제 없이 동작을 할 수 있다. 이것이 병렬성이다.</p>\n<ol start=\"2\">\n<li>동시성(Concurrency)\n<ul>\n<li>프로세스 혹은 프로그램 상에서 생성한 논리적 쓰레드에 연관이 있다</li>\n<li>실제로 동시 수행은 일어나지 않으나 시분할적으로 매우 빠르게 문맥교환이 일어나서 하나의 흐름처럼 동시에 보이는 것이다.</li>\n</ul>\n</li>\n</ol>\n<p><img src=\"https://i.imgur.com/YuGifc5.png\" alt=\"\"></p>\n<p>위의 그림에서 Process에 2개의 논리적 쓰레드가 있었는데 해당 쓰레드 2개가 어떠한 작업(<span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi><mn>1</mn><mo separator=\"true\">,</mo><mi>T</mi><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">T1, T2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\">2</span></span></span></span></span>)를 처리하는 상황을 그려본 것이다.</p>\n<p>참고 : <a href=\"https://freecontent.manning.com/concurrency-vs-parallelism/\">https://freecontent.manning.com/concurrency-vs-parallelism/</a></p>\n<p>그렇다면, 이 병렬성과 동시성의 개념이 왜 중요할까?</p>\n<p>밑에서 Run Queue와 Wait Queue를 다루면서 컨텍스트 스위칭에 대한 내용을 다룰 것인데 이 개념을 이해하기 위해서 중요하다고 보면 된다.</p>\n<h3 id=\"12-run-queue와-wait-queue\" style=\"position:relative;\"><a href=\"#12-run-queue%EC%99%80-wait-queue\" aria-label=\"12 run queue와 wait queue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 Run Queue와 Wait Queue</h3>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/* Used in tsk->state: */</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TASK_RUNNING</span>\t\t\t<span class=\"token expression\"><span class=\"token number\">0x00000000</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TASK_INTERRUPTIBLE</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x00000001</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TASK_UNINTERRUPTIBLE</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x00000002</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__TASK_STOPPED</span>\t\t\t<span class=\"token expression\"><span class=\"token number\">0x00000004</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__TASK_TRACED</span>\t\t\t<span class=\"token expression\"><span class=\"token number\">0x00000008</span></span></span></code></pre></div>\n<ul>\n<li>출처 : <a href=\"https://github.com/torvalds/linux/blob/master/include/linux/sched.h#L86\">https://github.com/torvalds/linux/blob/master/include/linux/sched.h#L86</a></li>\n</ul>\n<p>위는 리눅스에서 작업(Task)의 상태를 나타내는 식별자이다.</p>\n<table>\n<thead>\n<tr>\n<th>상태</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">TASK_RUNNING</code></td>\n<td>작업 실행 가능 상태를 나타내며, 현재 실행 중이거나 실행 대기열(<code class=\"language-text\">Run Queue</code>)에서 대기중</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">TASK_INTERRUPTIBLE</code></td>\n<td>작업이 어떤 상황이 발생하는 동안 잠을 자는 상황, 신호가 수신되면 일찍 잠에서 깨울 수 있다.</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">TASK_UNINTERRUPTIBLE</code></td>\n<td>작업이 어떤 상황이 발생하는 동안 잠을 자는 상황, 조기에 깨울 수 없다.</td>\n</tr>\n</tbody>\n</table>\n<p>이 큰 맥락말고도 실제 동작 유무에 따라서 아래와 같이 상태를 나타낼 수 있다.</p>\n<ol>\n<li><code class=\"language-text\">running</code> : <code class=\"language-text\">TASK_RUNNING</code> 상태이며, 현재 동작중인 작업</li>\n<li><code class=\"language-text\">runnable</code> : <code class=\"language-text\">TASK_RUNNING</code> 상태이며, <code class=\"language-text\">Run Queue</code>에 인입되어 실행되기를 기다리는 작업</li>\n<li><code class=\"language-text\">blocked</code> : <code class=\"language-text\">TASK_INTERRUPTIBLE</code> 혹은 <code class=\"language-text\">TASK_UNINTERRUPTIBLE</code> 인 작업 상태</li>\n</ol>\n<p>이제 실제 <code class=\"language-text\">Run Queue</code>의 구조를 보자.</p>\n<h4 id=\"121-run-queue\" style=\"position:relative;\"><a href=\"#121-run-queue\" aria-label=\"121 run queue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2.1 Run Queue</h4>\n<p><img src=\"https://i.imgur.com/qW8dVbK.png\" alt=\"\"></p>\n<p>위와 같은 <code class=\"language-text\">task_struct</code>의  <code class=\"language-text\">list_head</code> 포인터를 통해서 자식/형제 계층들이 연결이 된다.\n<code class=\"language-text\">run queue</code>는 상태가 <code class=\"language-text\">TASK_RUNNING</code>인 <code class=\"language-text\">list_head</code> 들과 연결이 된다. 따라서, <code class=\"language-text\">run queue</code> 용으로 <code class=\"language-text\">task_struct</code>에는 별도로 <code class=\"language-text\">list_head</code>가 있어야한다.</p>\n<p><code class=\"language-text\">run queue</code>는 코어당 존재를 하며, 4코어일 경우에는 각 코어마다 1개씩 존재하여 4개의 <code class=\"language-text\">run queue</code>가 존재하게 된다.</p>\n<p>그러나 주의할 점은 아래의 내용이다.</p>\n<ul>\n<li><code class=\"language-text\">run queue</code> 에 위치하는 부모/자식 작업은 동일한 CPU에서 실행되지 않을 수 있다.\n<ul>\n<li>Core1에 위치하던 <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">T1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\">1</span></span></span></span></span>이 Core2에서도 수행가능 (OS 스케줄러에 의한 로드밸런싱에 의거)</li>\n<li>그러나, CPU 선호도(CPU Affinity)나 캐시 워밍업때문에 같은 작업이 같은 코어에서 작업되는 것이 선호된다.</li>\n</ul>\n</li>\n<li><code class=\"language-text\">run queue</code>에 위치하는 부모/자식 작업은 모두 실행 중일 필요는 없다.</li>\n</ul>\n<p>이것이 어떻게 보면 병렬성이 보장되는 이유기도 하다. (각 코어마다 <code class=\"language-text\">run queue</code>가 존재하기에 이상적으로 4개의 작업이 4개의 코어의 <code class=\"language-text\">run queue</code>가 비워져있다면, 동시수행 가능)</p>\n<p>참고 : <a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/sched.h#L957-L1030\">https://github.com/torvalds/linux/blob/master/kernel/sched/sched.h#L957-L1030</a></p>\n<h4 id=\"122-wait-queue\" style=\"position:relative;\"><a href=\"#122-wait-queue\" aria-label=\"122 wait queue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2.2 Wait Queue</h4>\n<p><img src=\"https://i.imgur.com/VZzy5ob.png\" alt=\"\"></p>\n<p><code class=\"language-text\">Wait Queue</code>는 <code class=\"language-text\">Run Queue</code>와 <code class=\"language-text\">TASK_INTERRUPTIBLE</code> 혹은 <code class=\"language-text\">TASK_UNINTERRUPTIBLE</code> 상태를 가진 작업과 연결이 된다.</p>\n<p>참고 : <a href=\"https://github.com/torvalds/linux/blob/master/include/linux/wait.h#L30-L43\">https://github.com/torvalds/linux/blob/master/include/linux/wait.h#L30-L43</a></p>\n<p>이 과정에 대한 이벤트 루프 방식은 아래와 같다.</p>\n<ol>\n<li><code class=\"language-text\">prepare_to_wait()</code> : <code class=\"language-text\">TASK_INTERRUPTIBLE</code>로 변경 후 <code class=\"language-text\">Wait Queue</code>에 작업을 인입시킨다.</li>\n<li><code class=\"language-text\">signal_pending(state)</code> : 작업에 시그널이 전달됐으면 <code class=\"language-text\">true</code> 아니면 <code class=\"language-text\">false</code> 를 리턴시킨다.\n<ul>\n<li>잠들기 전에 시그널을 받았으면 잠드는 대신에 루프를 탈출한다.</li>\n</ul>\n</li>\n<li><code class=\"language-text\">schedule()</code> : 실제로 잠들기를 수행한다.</li>\n<li><code class=\"language-text\">finish_wait()</code> : <code class=\"language-text\">TASK_RUNNING</code> 상태로 변경한 후에 해당 작업을 <code class=\"language-text\">Wait Queue</code>에서 제거한다.</li>\n</ol>\n<p>이러한 이벤트 루프가 존재하며, 1-4를 계속 반복한다고 보면 된다.</p>\n<h2 id=\"리눅스-내에서-기본적인-스케줄링\" style=\"position:relative;\"><a href=\"#%EB%A6%AC%EB%88%85%EC%8A%A4-%EB%82%B4%EC%97%90%EC%84%9C-%EA%B8%B0%EB%B3%B8%EC%A0%81%EC%9D%B8-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81\" aria-label=\"리눅스 내에서 기본적인 스케줄링 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>리눅스 내에서 기본적인 스케줄링</h2>\n<p>먼저, <a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/core.c#L6591-L6718\">linux/kernel/sched/core.c</a> 쪽을 보면 <code class=\"language-text\">schedule()</code> 이라는 함수가 있음을 확인할 수 있다.</p>\n<p>이 함수 내부적으로는 아래의 함수들도 사용된다.</p>\n<ol>\n<li><code class=\"language-text\">pick_next_task()</code> : run queue에서 꺼내서 실행시킬 새 작업을 선택하는 함수</li>\n<li><code class=\"language-text\">context_switch()</code> : 현재 작업을 휴면상태로 변경 후 위 함수에서 가져온 작업을 실행 시키는 함수</li>\n</ol>\n<p>이를 토대로, Wait Queue에 대한 스케줄링은 아래와 같이 나눠진다.</p>\n<ul>\n<li>\n<p>휴면상태 돌입</p>\n<ol>\n<li><a href=\"https://github.com/torvalds/linux/blob/master/include/linux/wait.h#L300-L322\">wait_event()</a>함수 호출</li>\n<li><a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/wait.c#L305-L339\">Wait Queue에 작업을 적재</a></li>\n<li><a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/core.c#L6591-L6718\">schedule()</a> 함수 호출</li>\n<li>Run Queue에 해당 작업 제거</li>\n<li><a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/core.c#L6674C9-L6674C23\">pick_next_task()</a> 함수 호출</li>\n<li><a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/core.c#L6710C8-L6710C22\">context_switch()</a> 함수 호출</li>\n<li>다른 작업 수행</li>\n</ol>\n</li>\n<li>\n<p>휴면상태를 깨우기</p>\n<ol>\n<li><a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/wait.c#L80-L121\">wake_up()</a>함수 호출</li>\n<li>각 작업마다 <a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/core.c#L4197-L4354\">try_to_wake_up()</a> 함수 호출</li>\n<li>각 작업을 Run Queue에 적재</li>\n<li><code class=\"language-text\">schedule()</code> 함수를 호출하고 이전에 잠들었던 태스크가 선택된다.\n<ul>\n<li>조건이 <code class=\"language-text\">false</code>면 : 계속 휴면상태에 있음</li>\n<li>조건이 <code class=\"language-text\">true</code>면 : 휴면상태를 끝내고, <a href=\"https://github.com/torvalds/linux/blob/master/include/linux/wait.h#L320C2-L320C13\">finish_wait()</a> 함수를 호출하여 Wait Queue에 작업을 제거</li>\n</ul>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"13-프로세스-상태-변화\" style=\"position:relative;\"><a href=\"#13-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%83%81%ED%83%9C-%EB%B3%80%ED%99%94\" aria-label=\"13 프로세스 상태 변화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 프로세스 상태 변화</h3>\n<p><img src=\"https://i.imgur.com/8492Pvm.png\" alt=\"\"></p>\n<p>위 상태에서 <code class=\"language-text\">read()</code>라는 시스템콜이 유저모드에서 발생할 시 아래와 같이 처리가 된다.</p>\n<ol>\n<li>커널에 트랩이 발생\n<ul>\n<li>각 프로세스에 대한 레지스터를 커널 스택에 저장</li>\n</ul>\n</li>\n<li>디바이스 드라이버(DMA와 같은)가 I/O Request(IRQ)를 디바이스에 발행</li>\n<li>호출되는 프로세스를 휴면상태로 변화\n<ul>\n<li><code class=\"language-text\">wait_event()</code> -> <code class=\"language-text\">schedule()</code> -> <code class=\"language-text\">pick_next_task()</code> -> <code class=\"language-text\">context_switch()</code></li>\n</ul>\n</li>\n<li>다른 프로세스를 수행(문맥교환이 발생하였기 때문에)</li>\n<li>디바이스에서 IRQ를 성공적으로 처리하였으면, 하드웨어 인터럽트 발생</li>\n<li>커널에 트랩을 발생시킨 후, 인터럽트 핸들러로 PC를 이동\n<ul>\n<li><code class=\"language-text\">wake_up()</code> : 현재 블록킹 중인 작업을 Run Queue로 적재</li>\n<li>현재 태스크는 결과적으로 <code class=\"language-text\">schedule()</code> -> <code class=\"language-text\">pick_next_task()</code> -> <code class=\"language-text\">context_switch()</code>의 과정을 호출함.</li>\n</ul>\n</li>\n<li>다른 프로세스를 수행\n<ul>\n<li>여기서, 휴면상태에서 다시 동작하게끔 변경이 되었다면 이 프로세스는 <code class=\"language-text\">read()</code> 함수를 호출한 프로세스일 수도 있으며 아닐 경우 다른 프로세스일 수 있다.</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"가상-주소-공간\" style=\"position:relative;\"><a href=\"#%EA%B0%80%EC%83%81-%EC%A3%BC%EC%86%8C-%EA%B3%B5%EA%B0%84\" aria-label=\"가상 주소 공간 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>가상 주소 공간</h2>\n<p>C나 CPP같은 언어를 써서 <code class=\"language-text\">malloc()</code> 같은 시스템 메모리(Physical Memory)를 요구하는 함수를 호출한다 가정했을 때, 우리는 뭔가 <code class=\"language-text\">malloc()</code>을 호출하면 당연하게도 어떠한 시스템 메모리에 영역을 할당받는다고 생각했을 것이다.</p>\n<p>하지만, 리눅스에서도 가상 메모리라는 개념을 활용한다. 이는 SWAP 영역과는 별개의 가상 메모리라고 보면 될 것같다.</p>\n<p><img src=\"https://i.imgur.com/7uArXuJ.png\" alt=\"\"></p>\n<blockquote>\n<p>위에서는 <code class=\"language-text\">malloc()</code> 호출 시 시스템 콜이 발생되는 가정으로 하였는데 실제로는 발생안하는 케이스도 있으니 참고하기 바란다.</p>\n</blockquote>\n<p>실제로는 위와 같이 바인딩이 된다고 보면된다. 실제로 어플리케이션을 사용할 때는 물리적 메모리에 대해서 가상공간으로 변환해서 사용하는데, 이 가상공간으로 변환되어서 사용되는 물리적 메모리 공간을 가상메모리라고 뜻한다고 보면된다. (이 작업은 MMU에서 처리해준다.)</p>\n<p>참고로, MMU나 가상 메모리를 사용하지 않는 시스템의 경우도 있다.</p>\n<p>참고 : <a href=\"https://docs.kernel.org/admin-guide/mm/concepts.html\">https://docs.kernel.org/admin-guide/mm/concepts.html</a></p>\n<h3 id=\"14-mmiomemory-mapped-io\" style=\"position:relative;\"><a href=\"#14-mmiomemory-mapped-io\" aria-label=\"14 mmiomemory mapped io permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.4 MMIO(Memory Mapped I/O)</h3>\n<p>MMIO는 위 가상메모리와 비슷하게, I/O 작업을 좀 더 빠르게 처리하기 위해서 사용하는 방식이다.</p>\n<p><code class=\"language-text\">malloc()</code> 이 아닌 <code class=\"language-text\">read()</code> 와 같은 시스템 콜을 활용하여 File I/O 처리가 필요하다고 가정해보자.\n그렇다면, <code class=\"language-text\">lseek()</code> 과 같은 시스템 콜을 통해서 파일을 접근 한후 실제 <code class=\"language-text\">read()</code>를 통해서 내용을 커널에서 유저 모드의 버퍼로 전달해야될 것이다.</p>\n<p>이런 과정은 어떻게 보면 느리며, 복잡할 수 있다. 이에 대한 대안은 파일의 영역을 가상 주소 공간에 매핑시키는 것이다. 아래와 같이 말이다.</p>\n<p><img src=\"https://i.imgur.com/AfVhSnr.png\" alt=\"\"></p>\n<p>매핑된 영역은 디스크에 의해 지원이 되는데 메모리 매핑된 영역에 대한 업데이트는 먼저 메모리로 가고, 후에 디스크로 플러시 된다고 보면된다.</p>\n<p>또한 이 매핑 영역은 두 가지 방식이 존재한다.</p>\n<ol>\n<li>Private Mapping : 파일의 스냅샷을 제공 받지만 변경 사항은 디스크로 플러시가 되지 않으며, 동일한 영역을 매핑하는 다른 프로세스에게는 보이지 않는다.</li>\n<li>Shared Mapping : 같은 메모리를 참조하며, 이런식으로 매핑된 데이터를 가진 프로세스는 서로의 업데이트를 확인할 수 있다.</li>\n</ol>\n<p>실제 동작원리는 잘 쓰여진 포스팅이 있어서 이로 대체한다.</p>\n<ul>\n<li>참고 : <a href=\"https://pr0gr4m.tistory.com/entry/Linux-Kernel-5-mmap\">https://pr0gr4m.tistory.com/entry/Linux-Kernel-5-mmap</a></li>\n</ul>\n<p>위에서는 File에 대한 매핑에 대한 예시라면, 때때로 파일에 의해 백업되지 않은 메모리를 매핑할 수도 있으면 좋겠다라는 요구사항이 발생할 수 있다.(<code class=\"language-text\">malloc()</code> 과 같은)</p>\n<p>이럴 때 사용하는 것이 익명 메모리 매핑이라고 보면된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">LEGACY_MAP_MASK</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>MAP_SHARED </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_PRIVATE </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_FIXED </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_ANONYMOUS </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_DENYWRITE </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_EXECUTABLE </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_UNINITIALIZED </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_GROWSDOWN </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_LOCKED </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_NORESERVE </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_POPULATE </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_NONBLOCK </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_STACK </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_HUGETLB </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_32BIT </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_HUGE_2MB </span><span class=\"token punctuation\">\\</span>\n\t\t<span class=\"token expression\"><span class=\"token operator\">|</span> MAP_HUGE_1GB<span class=\"token punctuation\">)</span></span></span></code></pre></div>\n<p>위는 <a href=\"https://github.com/torvalds/linux/blob/master/include/linux/mman.h\">mman.h</a>에 대한 코드 중에서 매모리 매핑에 관련된 마스크에 대한 내용을 담고 있다.\n이때, 익명 메모리 매핑을 사용하기 위해서는 <code class=\"language-text\">MAP_ANONYMOUS</code> 를 둬서 처리하면 된다.</p>\n<p>이때도 마찬가지로 매핑을 공유할 지 안할 지 처리할 수 있는데 이 구조에 따라서 <code class=\"language-text\">fork()</code> 와 같은 시스템콜에 영향을 끼친다.</p>\n<p><code class=\"language-text\">MAP_PRIVATE</code> : <code class=\"language-text\">fork()</code> 와 같은 시스템콜로 생성된 자식 프로세스는 독립적인 복사본을 얻게된다. (<code class=\"language-text\">malloc()</code>과 같은)</p>\n<p><code class=\"language-text\">MAP_SHARED</code> : 자식 프로세스는 메모리 매핑을 공유하며, 서로의 업데이트를 볼 수 있다. 이렇게 될 경우 IPC 형태라 볼 수 있는데 이 방식으로 생성된 자식 프로세스는 <code class=\"language-text\">pipe()</code>와 같이 사용된다. 비슷한 IPC 형태는 공유 메모리에 의한 IPC라 보면될 것이다.</p>\n<p>참고 : <a href=\"http://csl.snu.ac.kr/courses/4190.307/2020-1/9-mmap.pdf\">http://csl.snu.ac.kr/courses/4190.307/2020-1/9-mmap.pdf</a></p>\n<h2 id=\"2-본론\" style=\"position:relative;\"><a href=\"#2-%EB%B3%B8%EB%A1%A0\" aria-label=\"2 본론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 본론</h2>\n<p>이제 본론으로 들어와보자.</p>\n<p>사실 위 내용을 다뤘던 이유는 현재 스터디 중인 책과 관련이 있다.</p>\n<p><img src=\"https://i.imgur.com/Wr6OE3y.png\" alt=\"\"></p>\n<p>현재, 이 책에 대한 스터디를 진행 중이었고, 1 ~ 3장을 각자 정리를 해오자라고 얘기가 나왔는데 보다 심층적으로 파악할 필요가 있어서 위와 같은 배경지식을 설명해보았다.\n이제 본격적으로 이 책에서 다뤘던 내용을 다뤄보고자한다.</p>\n<p>초점은 2 ~ 3장과 관련된 내용이라고 보면될 것이다.</p>\n<h3 id=\"21-virt--res--shr\" style=\"position:relative;\"><a href=\"#21-virt--res--shr\" aria-label=\"21 virt  res  shr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 VIRT &#x26; RES &#x26; SHR</h3>\n<p>먼저, 리눅스의 top 명령어를 입력하게 되면 아래와 같은 화면을 볼 수 있다.</p>\n<p><img src=\"https://i.imgur.com/WjZnsOx.png\" alt=\"\"></p>\n<p>이 중에서 우리가 중점적으로 볼 지표는 <code class=\"language-text\">VIRT</code>, <code class=\"language-text\">RES</code>, <code class=\"language-text\">SHR</code> 이다.</p>\n<p><img src=\"https://i.imgur.com/sI9WtTX.png\" alt=\"\"></p>\n<ol>\n<li><code class=\"language-text\">VIRT</code> : <code class=\"language-text\">RES</code>와 <code class=\"language-text\">SHR</code> 그리고 SWAP영역까지 프로세스가 사용되는 메모리의 전체 용량</li>\n<li><code class=\"language-text\">RES</code> :  프로세스가 사용 중인 물리 메모리(Physical Memory)의 용량</li>\n<li><code class=\"language-text\">SHR</code> :  프로세스가 사용 중인 공유 메모리의 용량</li>\n</ol>\n<p>여기서 헷갈렸던 부분은 책에서는 <code class=\"language-text\">VIRT</code>에 대해서 가상메모리(Virtual Memory)의 전체 용량으로 얘기했어서 이것이 위에서 보았던 가상 주소 공간(Virtual Address Area)의 용량을 나타내는 것인지 아니면 실제 HDD나 SDD를 메모리처럼 활용하기 위한 가상메모리인 SWAP 영역을 나타내는지 궁금해졌다.</p>\n<p>찾아보니 <code class=\"language-text\">VIRT</code>가 나타내는 메모리 총 용량은 아래와 같이 계산된다.</p>\n<p><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>V</mi><mi>I</mi><mi>R</mi><mi>T</mi><mo>=</mo><mi>R</mi><mi>E</mi><mi>S</mi><mo>+</mo><mi>S</mi><mi>W</mi><mi>A</mi><mi>P</mi><mo>+</mo><mi>S</mi><mi>H</mi><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">VIRT = RES + SWAP + SHR</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">RT</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">RES</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span></span></p>\n<p>즉, 물리메모리, 공유메모리, 가상메모리(SWAP)에 대한 프로세스가 점유하고 있는 메모리 총 용량이라고 볼 수 있다.\n따라서, <code class=\"language-text\">VIRT</code>를 통해서 어떤 프로세스가 스왑메모리를 많이 사용하는지도 파악이 가능할 수 있다.</p>\n<p>왜냐면, 스왑메모리는 가상메모리의 일종이므로 <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>V</mi><mi>I</mi><mi>R</mi><mi>T</mi><mo>></mo><mi>T</mi><mi>O</mi><mi>T</mi><mi>A</mi><mi>L</mi><mtext>  </mtext><mi>M</mi><mi>E</mi><mi>M</mi><mi>O</mi><mi>R</mi><mi>Y</mi></mrow><annotation encoding=\"application/x-tex\">VIRT > TOTAL \\; MEMORY</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7224em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">RT</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">TOT</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">MEMOR</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span></span></span> 인 상황이면 스왑메모리를 사용하는 것을 추측할 수 있다. (<code class=\"language-text\">SHR</code> 의 크기는 그리 크지 않기 때문이다.)\n이를 토대로 <code class=\"language-text\">SWAP</code> 을 최소화해서 사용해야하는 어플리케이션의 사용량을 추적할 수도 있어보인다.</p>\n<p>어떤 케이스에 SWAP 영역을 최소화 해야되는지 궁금하다면 제 블로그의 아래의 아티클을 읽어보기를 추천한다.</p>\n<ul>\n<li><a href=\"https://brewagebear.github.io/fundamental-os-page-cache/\">https://brewagebear.github.io/fundamental-os-page-cache/</a></li>\n</ul>\n<p>그리고 <code class=\"language-text\">VIRT</code>가 Virtual을 나타내는 것과 같이 보이는데 위에서 얘기했던 내용에 대해서 첨언하면, <code class=\"language-text\">VIRT</code>는 <strong>가상 주소 공간에 대한 용량이 맞다</strong>고 보면 된다.</p>\n<blockquote>\n<p>💡즉, 가상 주소 공간에 메모리 할당을 할 때 SWAP에 처리되는 페이지 캐시나 기타 데이터도 이 영역에 할당이 되어지는 것이다.\n이 부분은 서론에서 얘기했듯이 MMU가 관리하고, 스왑-아웃을 통해서 스왑 영역으로 페이지가 이동되더라도 가상 주소 공간에서 할당이 일관되게 유지되는 것이다.</p>\n</blockquote>\n<p>오해의 소지가 있어보이므로 앞으로 물리 메모리와 실제 매핑되서 MMU에 관리되는 부분을 가상 주소 공간, 보조기억장치와 메모리 영역 사이에서 관리되는 부분을 SWAP이라고 명시하도록 하겠다.</p>\n<h3 id=\"22-memory-commit\" style=\"position:relative;\"><a href=\"#22-memory-commit\" aria-label=\"22 memory commit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Memory Commit</h3>\n<p>자 그러면, 리눅스에서 왜 <code class=\"language-text\">VIRT</code>와 <code class=\"language-text\">SHR</code>를 따로 나눠서 관리를 할까?\n이는 메모리 커밋과 관련이 있다.</p>\n<p>서론에서 얘기한 바와 같이 <code class=\"language-text\">malloc()</code> 등으로 메모리 할당을 요청하면 가상 주소 공간에 대한 주소를 넘겨준다.</p>\n<p><img src=\"https://i.imgur.com/wXo9CGA.png\" alt=\"\"></p>\n<p>하지만, 이때도 실제 물리 메모리에 해당 영역이 할당된 상태는 아니라는 것이다.\n예약은 해두고 가상 주소 공간에서 주소를 넘겨받는 이러한 동작 방식을 <code class=\"language-text\">Memory Commit</code> 이라 한다.</p>\n<p>그러면 실제 물리 메모리에 언제 바인딩이 될까? 그것은 바로 직접적으로 쓰기 작업이 발생할 때이다.\n쓰기 작업을 수행하면 페이지 부재(Page Fault)가 발생할 것이고 내부적인 매커니즘에 따라서 처리가 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/*\n*문제의 VMA(가상 메모리 영역)가 거대한 페이지(HugeTLB)에 의해 지원되는 경우 커널은 결함 처리를 `hugetlb_fault` 기능에 위임. \n* 이 기능은 크기 및 관리 방식으로 인해 일반 페이지와 다르게 처리되는 대형 페이지와 특히 관련된 오류를 처리.\n*/</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">unlikely</span><span class=\"token punctuation\">(</span><span class=\"token function\">is_vm_hugetlb_page</span><span class=\"token punctuation\">(</span>vma<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">hugetlb_fault</span><span class=\"token punctuation\">(</span>vma<span class=\"token operator\">-></span>vm_mm<span class=\"token punctuation\">,</span> vma<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n<span class=\"token comment\">/*\n* 거대한 페이지 폴트가 아닌 경우 `__handle_mm_fault` 함수로 페이지 부재를 전달. 이 함수에는 표준 페이지 오류를 처리하는 기본 논리가 포함되어 있고, 여기에는 여러 작업이 포함될 수 있다.\n* 1. 페이지가 이미 메모리에 있지만 프로세스의 페이지 테이블에 매핑되지 않았는지 확인(사소한 결함).\n* 2. 이전에 교체된 경우(스와핑) 교체 공간(스왑 영역)에서 페이지를 로드.\n* 3. 파일 기반 매핑인 경우 백업 저장소(예: 디스크의 파일)에서 페이지를 가져옴.\n* 4. 이전에 기록되지 않은 익명 매핑인 경우 새로운 제로 페이지 할당.\n*/</span>\n<span class=\"token keyword\">else</span> ret <span class=\"token operator\">=</span> <span class=\"token function\">__handle_mm_fault</span><span class=\"token punctuation\">(</span>vma<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>참고 코드 1 : <a href=\"https://github.com/torvalds/linux/blob/master/arch/arm64/mm/fault.c#L500C1-L500C1\">https://github.com/torvalds/linux/blob/master/arch/arm64/mm/fault.c#L500C1-L500C1</a>\n참고 코드 2 : <a href=\"https://github.com/torvalds/linux/blob/master/mm/memory.c#L5201\">https://github.com/torvalds/linux/blob/master/mm/memory.c#L5201</a>\n참고 코드 3 : <a href=\"https://github.com/torvalds/linux/blob/master/mm/page_alloc.c#L4594C5-L4594C5\">https://github.com/torvalds/linux/blob/master/mm/page_alloc.c#L4594C5-L4594C5</a></p>\n<p>즉, 새로 할당을 하는 케이스면 4번에 해당될 것이고 새로운 제로 페이지를 할당 받는 것이다.<br>\n이렇게 바인딩된 값을 페이지 테이블(Page Table)이라 부르며, 물리 메모리에 실제 바인딩된 영역이 <code class=\"language-text\">RES</code>로 계산된다.</p>\n<p>책에서도 나오지만 그렇다면 위 방식과 같이 처리할 경우 무제한으로 <code class=\"language-text\">malloc</code> 과 같은 시스템 콜을 사용할 수 있는가에 대해서 나온다.\n이에 대한 짧은 코드도 제시해주는데 실제로 돌려보면 비슷한 결과를 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MEGABYTE</span> <span class=\"token expression\"><span class=\"token number\">1024</span><span class=\"token operator\">*</span><span class=\"token number\">1024</span></span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>myblock <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span> \n\t<span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tmyblock <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span>MEGABYTE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>myblock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span>“Error<span class=\"token operator\">!</span>”<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span> \n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span>“Currently allocating <span class=\"token operator\">%</span>d MB\\n”<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">++</span>count<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>MEGABYTE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\t\t<span class=\"token comment\">// memset(myblock, 1, MEGABYTE);</span>\n\t\t<span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드를 <code class=\"language-text\">gcc example1.c</code> 로 <code class=\"language-text\">a.out</code> 실행 파일을 얻어서 돌려본 결과를 아래와 같다.</p>\n<p><img src=\"https://i.imgur.com/2A5yc1J.png\" alt=\"\"></p>\n<p>보면 세번째 (6XXXX) 숫자가 <code class=\"language-text\">VIRT</code>고 1548 값이 <code class=\"language-text\">RES</code> 값이다.  <code class=\"language-text\">//memset(myblock, 1, MEGABYTE);</code> 이 주석처리 되어있어서 우리가 이론 상으로 배웠던 내용처럼 <code class=\"language-text\">RES</code>는 증가하지 않는 모습을 보여준다.\n그렇다면 주석을 해제하고 돌려보면 어떻게 될까?</p>\n<p><img src=\"https://i.imgur.com/7lkKwqL.png\" alt=\"\"></p>\n<p>3152였던 <code class=\"language-text\">RES</code> 값이 실제로 증가함을 확인할 수 있다. 동일한 값이 나오는 이유는 VM에 돌리는 환경이다보니 메모리가 한정적이라 <code class=\"language-text\">sleep(2)</code>로 둬서 2초의 간격이 생겨서 그런거라고 보면 된다.\n자 이제 실제 메모리 쓰기 전까지는 <code class=\"language-text\">VIRT</code>만 증가하고, 실제 메모리가 쓰여질 때 물리 메모리인 <code class=\"language-text\">RES</code>를 할당받는다는 점을 알게되었다.</p>\n<p>그렇다면, <code class=\"language-text\">VIRT</code>는 무한정 늘어날 수 있을까? 그 부분에 관련된 커널 파라미터(<code class=\"language-text\">vm.overcommit_memory</code>)의 값에 따라서 달라진다.\n그러면 왜 리눅스 커널은 이런식으로 메모리 커밋을 수행하면 바로 할당되는 것이 아니라 지연되게끔 개발 되었을까?</p>\n<p>이유는 새로운 프로세스를 만드는 <code class=\"language-text\">fork()</code> 와 같은 시스템 콜을 처리해야되기 때문이다.</p>\n<p>서론에서도 잠깐 언급된 <code class=\"language-text\">fork()</code> 시스템 콜은 현재 커널에 실행 중인 프로세스와 똑같은 프로세스를 하나 만들게 된다. 그 프로세스는 후에 <code class=\"language-text\">exec()</code>와 같은 시스템 콜을 통해서 다른 프로세스로 변화한다.\n이러한 상황이다보니 <strong>확보한 메모리가 대부분 쓸모가 없어질 수도 있는 것</strong>이다.</p>\n<p>그래서 COW(Copy-On-Write)라는 기법을 통해서 복사된 메모리에 실제 쓰기 작업이 발생한 후에야 실질적인 메모리 할당을 시작한다.\n이를 위해서 메모리 커밋이 필요하다.</p>\n<p><img src=\"https://i.imgur.com/ODNgVTH.png\" alt=\"\"></p>\n<p>위는 <code class=\"language-text\">fork()</code> 시스템 콜 상황에서 COW가 동작하는 원리를 보여준다. 이렇게 처리되기 때문에 메모리 커밋이 없으면 다음과 같은 상황이 발생할 수 있다.</p>\n<p><img src=\"https://i.imgur.com/h0lAhWM.png\" alt=\"\"></p>\n<p>1기가의 가용메모리가 있고, 3GB의 프로세스를 <code class=\"language-text\">fork()</code> 를 통해서 복제한 상황이다. 이 케이스에 만약, 메모리 커밋처럼 지연처리가 없다면 OOM과 같은 문제도 발생할 수 있다.\n어쨋든 메모리 커밋으로 위와 같은 상황에서도 오버커밋이 되긴했지만 쓰이기 전까지는 지연처리 되니 보다 안정성을 제공한다 볼 수 있다.</p>\n<p>이 커밋 비율을 보기 위해서는 <code class=\"language-text\">sar</code> 와 같은 모니터링 도구를 활용할 수 있다. 커밋된 비율도 중요한 점이 순간적으로 시스템에 부하나 장애를 야기할 수 있기 때문에 위에서 잠깐 보았던 커널 파라미터인 <code class=\"language-text\">vm.overcommit_memory</code>를 통해 메모리 커밋에 대한 제어권을 사용자가 선택할 수 있게 하였다.</p>\n<table>\n<thead>\n<tr>\n<th>파라미터 옵션</th>\n<th>동작 방시</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>기본동작 방식이며, overcommit 최댓값은 page cache + swap area + slab reclaimable 이다. (현재 가용 메모리 영역은 보지 않는다.)</td>\n</tr>\n<tr>\n<td>1</td>\n<td>무조건 commit을 진행한다. 아무것도 계산하지 않으면 요청 온 모든 메모리에 대한 commit이 발생한다.</td>\n</tr>\n<tr>\n<td>2</td>\n<td>제한적으로 commit을 진행한다. <code class=\"language-text\">vm.overcommit_ratio</code>에 대한 비율과 swap 영역에 대한 크기를 토대로 계산된다. (/proc/meminfo 에서 확인가능)</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"23-프로세스의-상태\" style=\"position:relative;\"><a href=\"#23-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%9D%98-%EC%83%81%ED%83%9C\" aria-label=\"23 프로세스의 상태 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 프로세스의 상태</h3>\n<p>위에서는 <code class=\"language-text\">VIRT</code>, <code class=\"language-text\">RES</code>, <code class=\"language-text\">SHR</code>를 다루면서 메모리 커밋에 대해서도 다뤘었다. 이제 <code class=\"language-text\">top</code> 명령어를 볼 수 있는 지표 중에 프로세스의 상태를 보는 지표를 확인할 차례이다.</p>\n<p><img src=\"https://i.imgur.com/CN6oaqZ.png\" alt=\"\"></p>\n<p>해당 지표는 <code class=\"language-text\">SHR</code> 옆에 보이는 <code class=\"language-text\">S</code>라는 값이며 각 프로세스의 상태를 나타낸다.\n프로세스의 상태는 아래와 같다.</p>\n<table>\n<thead>\n<tr>\n<th>상태 플래그 값</th>\n<th>상태</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>D</td>\n<td>디스크 혹은 네트워크 I/O를 대기하는 프로세스 (<code class=\"language-text\">TASK_UNINTERRUPTIBLE</code> 상태와 비슷)</td>\n</tr>\n<tr>\n<td>R</td>\n<td>실행 중인 프로세스를 의미하며, 실제로 CPU 자원을 소모하고 있는 프로세스 (<code class=\"language-text\">TASK_RUNNING</code> 상태와 비슷)</td>\n</tr>\n<tr>\n<td>S</td>\n<td>D 상태와 비슷하지만, 조기에 깨울 수 있는 상태의 프로세스 (<code class=\"language-text\">TASK_INTERRUPTIBLE</code> 상태와 비슷)</td>\n</tr>\n<tr>\n<td>T</td>\n<td><code class=\"language-text\">strace</code> 등으로 프로세스의 시스템 콜을 추적하고 있는 상태의 프로세스(<code class=\"language-text\">__TASK_TRACED</code> 혹은 <code class=\"language-text\">__TASK_STOPPED</code> 상태와 비슷)</td>\n</tr>\n<tr>\n<td>Z</td>\n<td>좀비상태의 프로세스로, 부모 프로세스가 죽은 자식 프로세스이다.</td>\n</tr>\n</tbody>\n</table>\n<p>위 값을 잘보면 우리가 서론에서 Run Queue와 Wait Queue를 다루면서 했던 내용과 흡사하다고 볼 수 있다.\n우리는 어느정도 이 개념에 대해서 알고 있으니 바로 프로세스 상태 변화표를 확인해보자.</p>\n<p><img src=\"https://i.imgur.com/zmNE7a6.png\" alt=\"\"></p>\n<p>아마도 서론을 잘 읽었던 분이라면 이 부분에 대해서 이해하기 수월할 것이라고 생각한다.  위에서 다루지 않았던 내용은 좀비 상태 뿐인데 이건 아래의 표로 설명이 가능하다.</p>\n<p><img src=\"https://i.imgur.com/dVDQC44.png\" alt=\"\"></p>\n<p>위 그림은 <code class=\"language-text\">fork()</code>를 통해서 자식 프로세스가 생성되는 모습을 보여주고 있다. 이런 케이스에 부모 프로세스가 죽었는데 자식 프로세스가 남아 있거나 자식 프로세스의 비정상 동작으로 부모 프로세스가 죽을 수 있다.</p>\n<p><img src=\"https://i.imgur.com/4wG4l9Q.png\" alt=\"\"></p>\n<p>위와 같은 케이스가 좀비 프로세스가 된다고 보면 된다. 좀비 프로세스는 시스템의 리소스를 차지하지 않으므로 큰 문제는 되지 않으나 PID는 대략 65536개로 생성이 가능하기때문에 이 PID를 점유하고 있고, 새로운 프로세스가 할당될 PID가 부족하여 PID 고갈을 야기할 수 있다.</p>\n<h3 id=\"24-프로세스의-우선순위\" style=\"position:relative;\"><a href=\"#24-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%9D%98-%EC%9A%B0%EC%84%A0%EC%88%9C%EC%9C%84\" aria-label=\"24 프로세스의 우선순위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 프로세스의 우선순위</h3>\n<p>이제는 <code class=\"language-text\">top</code> 명령어에서 볼 수 있는 지표인 <code class=\"language-text\">PR</code>과 <code class=\"language-text\">NI</code>에 대해서 알아보고자 한다.</p>\n<p><img src=\"https://i.imgur.com/n6IROxy.png\" alt=\"\"></p>\n<p>이 두 개의 값은 모두 프로세스 우선순위와 연관되어있다.\nRun Queue와 Wait Queue 과정에서 각 프로세스들이 어떻게 휴면상태로 바뀌고 다시 런상태로 바뀌고, 스케줄러가 해당 태스크들을 처리한다고 하였다.\n이때, 실행될 프로세스의 우선순위를 통해서 스케줄러가 디스패처라는 개념에게 해당 프로세스에 대한 정보를 넘겨준다고 보면된다.</p>\n<p><img src=\"https://i.imgur.com/bXW9o3Q.png\" alt=\"\"></p>\n<p>그렇다면, <code class=\"language-text\">PR</code>과 <code class=\"language-text\">NI</code> 지표는 어떤 것을 나타낼까?</p>\n<table>\n<thead>\n<tr>\n<th>지표</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PR</td>\n<td>커널에서 인식하는 해당 프로세스의 실제 우선순위 값</td>\n</tr>\n<tr>\n<td>NI</td>\n<td>nice값이라 부르며, 명령어를 통해 우선순위를 낮출 때 사용된다. (즉, 이 값을 통해서 PR 값을 낮출 수 있다.)</td>\n</tr>\n</tbody>\n</table>\n<p>실제로 nice 값을 낮추면 우선순위 낮은 프로세스가 먼저 수행될까?</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">#!/usr/bin/python\n\nimport datetime\n\nstart_time = datetime.datetime.now()\nprint(&quot;START : &quot; + str(start_time))\n\nsum = 0\n\nfor i in range(1,1000000000):\n    sum = sum + i\n    #print(i)\nprint(sum)\n\nend_time = datetime.datetime.now()\nprint(&quot;END : &quot; + str(end_time))\n\nelapsed_time = end_time - start_time\nprint(&quot;Elapsed : &quot; + str(elapsed_time))</code></pre></div>\n<p>위와 같은 파이썬 코드를 주고, 아래와 같이 두 개의 프로세스를 구동 시켰다.</p>\n<p><img src=\"https://i.imgur.com/tT3WdYH.png\" alt=\"\"></p>\n<p>책에서는 5000만건으로 처리했는데 M1 Pro 프로세서의 단일 코어 성능이 좋아서 그런지 원하던 결과가 안나와서 10억번 반복을 돌도록 처리하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">ubuntu@ubuntu:~/example$ sudo python3 ex.py\nSTART : 2023-08-23 10:53:48.624415\n499999999500000000\nEND : 2023-08-23 10:55:23.304349\nElapsed : 0:01:34.679934\n\nubuntu@ubuntu:~/example$ sudo nice -n -20 python3 ex.py\nSTART : 2023-08-23 10:53:48.879665 # nice를 -20으로 우선순위(PR)을 0으로 할당된 프로세스가 아래의 프로세스보다 늦게 수행\n499999999500000000\nEND : 2023-08-23 10:55:21.738873 # 그러나 더 빨리 처리된 모습을 볼 수 있다.\nElapsed : 0:01:32.859208\n\nubuntu@ubuntu:~/example$ grep -c processor /proc/cpuinfo\n1</code></pre></div>\n<p>VM으로 단일 코어로 처리했을 경우에 나오는 결과이다.\n그러나, 단일 코어가 아닐 경우에는 위와 같이 nice값으로 우선순위를 올린 프로세스가 먼저 끝나는 것을 보장할 수가 없다.</p>\n<p>이유는 바로 병렬성과 관련되어있다.</p>\n<p><img src=\"https://i.imgur.com/w1oQ1VG.png\" alt=\"\"></p>\n<p>2개 코어라고 가정하였을 경우 각각 코어 마다 Run Queue가 위치한다고 말했었다. 그러다보니 nice 값을 낮춰도 다른 코어에서 프로세스를 충분히 돌릴 수 있다면 nice 값을 낮춘 프로세스보다 빨리 끝날 수 있다.\n실제 시작할 프로세스에 대한 nice 값은 <code class=\"language-text\">nice</code> 명령어로 처리할 수 있으며, 동작 중인 프로세스에 대한 핸들링은 <code class=\"language-text\">renice</code> 명령을 통해서 낮출 수 있다.</p>\n<p>이때 사용되는 스케줄 방식이 바로 CFS(Completely Fair Scheduling)이다.</p>\n<h3 id=\"3-load-averrage와-시스템-부하\" style=\"position:relative;\"><a href=\"#3-load-averrage%EC%99%80-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EB%B6%80%ED%95%98\" aria-label=\"3 load averrage와 시스템 부하 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Load Averrage와 시스템 부하</h3>\n<p>리눅스에서는 Load Average를 아래와 같이 정의한다.</p>\n<blockquote>\n<p>R과 D인 상태의 프로세스의 개수의 1분, 5분, 15분마다의 평균 값</p>\n</blockquote>\n<p>즉, 얼마나 많은 프로세스가 실행 / 실행 대기 중이냐를 의미하는 수치이다.\n이 값이 높다면 많은 수의 프로세스가 실행 중이거나 I/O를 처리하기 위해 대기 상태 있다는 것이고 낮으면 적은 수의 프로세스가 그렇다는 것이다.</p>\n<p>이는 위에서 본 바와 같이 CPU 코어 수에 따라서 상대적이다.</p>\n<p><img src=\"https://i.imgur.com/OtiERRi.png\" alt=\"\"></p>\n<p>두 개 모두 Load Average값은 2의 근사 값이 나올 것이다. (프로세스의 개수를 뜻하기 때문에) 그러나, 단일 코어일 경우에는 Run Queue에 두 개의 프로세스가 있으며, 듀얼 코어일 경우에는 각 Run Queue에 분리되어서 동작한다.\n즉, 병렬성이 보장되므로 듀얼코어인 케이스가 싱글코어인 케이스보다 대기 상태가 적을 수 밖에 없다.</p>\n<p>따라서, 같은 Load Average라고 해도 CPU 코어 수에 따라 의미가 달라질 수 있다.</p>\n<p>실제 커널 코드는 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// linux/kernel/sched/ladavg.c</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">get_avenrun</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token operator\">*</span>loads<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> offset<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> shift<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\tloads<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>avenrun<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> shift<span class=\"token punctuation\">;</span>\n\tloads<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>avenrun<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> shift<span class=\"token punctuation\">;</span>\n\tloads<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>avenrun<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> shift<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">calc_global_load</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t\n\tactive <span class=\"token operator\">=</span> <span class=\"token function\">atomic_long_read</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>calc_load_tasks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// calc_load_tasks 값을 atomic_long_read() 매크로 함수를 통해서 읽은 후 active에 넣는다.</span>\n\tactive <span class=\"token operator\">=</span> active <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> active <span class=\"token operator\">*</span> FIXED_1 <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n\tavenrun<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">calc_load</span><span class=\"token punctuation\">(</span>avenrun<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EXP_1<span class=\"token punctuation\">,</span> active<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tavenrun<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">calc_load</span><span class=\"token punctuation\">(</span>avenrun<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EXP_5<span class=\"token punctuation\">,</span> active<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tavenrun<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">calc_load</span><span class=\"token punctuation\">(</span>avenrun<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> EXP_15<span class=\"token punctuation\">,</span> active<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// active 값을 바탕으로 avenrun[] 배열에 있는 값들을 calc_load_n() 함수를 이용해서 계산한다.</span>\n\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">(</span>중략<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">long</span> <span class=\"token function\">calc_load_fold_active</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">rq</span> <span class=\"token operator\">*</span>this_rq<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> adjust<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">long</span> nr_active<span class=\"token punctuation\">,</span> delta <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n\tnr_active <span class=\"token operator\">=</span> this_rq<span class=\"token operator\">-></span>nr_running <span class=\"token operator\">-</span> adjust<span class=\"token punctuation\">;</span> <span class=\"token comment\">// nr_active 변수에 Run Queue기준으로 nr_running 상태의 개수를 adjust값을 뺴서 입력한다. (R 상태 프로세스)</span>\n\tnr_active <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>this_rq<span class=\"token operator\">-></span>nr_uninterruptible<span class=\"token punctuation\">;</span> <span class=\"token comment\">// nr_uniterruptible 프로세스 개수도 nr_active 변수에 더해준다 (D 상태 프로세스)</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nr_active <span class=\"token operator\">!=</span> this_rq<span class=\"token operator\">-></span>calc_load_active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tdelta <span class=\"token operator\">=</span> nr_active <span class=\"token operator\">-</span> this_rq<span class=\"token operator\">-></span>calc_load_active<span class=\"token punctuation\">;</span> \n\t\tthis_rq<span class=\"token operator\">-></span>calc_load_active <span class=\"token operator\">=</span> nr_active<span class=\"token punctuation\">;</span> <span class=\"token comment\">// nr_active 값이 기존 값과 다르면 clac_load_active 변수에 입력한다.</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">return</span> delta<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>참고 : <a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/loadavg.c#L71C1-L76\">https://github.com/torvalds/linux/blob/master/kernel/sched/loadavg.c#L71C1-L76</a>\n참고 2 : <a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/loadavg.c#L349C1-L380C1\">https://github.com/torvalds/linux/blob/master/kernel/sched/loadavg.c#L349C1-L380C1</a>\n참고 3 : <a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/loadavg.c#L78-L91\">https://github.com/torvalds/linux/blob/master/kernel/sched/loadavg.c#L78-L91</a></p>\n<p>책에서 사용하는 커널버전과 다르다보니 좀 더 변경된 부분이 있으나, 매번 Tick 주기에 호출되는 <a href=\"https://github.com/torvalds/linux/blob/master/kernel/sched/core.c#L5640\">schedule_tick(void)</a> 함수를 보면 책에 나온 <code class=\"language-text\">calc_laod_account_active()</code> 함수 대신 <code class=\"language-text\">calc_global_load_tick()</code> 함수로 변경되었고, 이 함수 내부적으로 <code class=\"language-text\">calc_load_fold_active()</code> 함수를 호출하는 방식을 볼 수 있다.</p>\n<p><img src=\"https://i.imgur.com/awmZ9Ts.png\" alt=\"\"></p>\n<p>위 내용을 정리하면 위와 같이 볼 수 있다. 함수명은 위에서 말한 듯이 커널 버전이 올라감에 따라 달라진 부분이 있으니 참고바란다.\n결국 서두에서도 얘기했듯 R과 D 상태의 프로세스의 개수를 세는 것을 Load Average로 볼 수 있다.</p>\n<h4 id=\"31-cpu-bound-vs-io-bound\" style=\"position:relative;\"><a href=\"#31-cpu-bound-vs-io-bound\" aria-label=\"31 cpu bound vs io bound permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 CPU Bound vs I/O Bound</h4>\n<p>따라서, Load Average 값이 높은 부분은 CPU가 많이 사용되는 프로세스(R)가 많을 수도 있고, I/O 대기에 따른 프로세스(D)가 많아서 일수 있다.\n즉, 이 값만으로는 어떤 부하가 시스템이 겪고 있는지 알기가 힘든 것이다.</p>\n<p>이를 단순하게 확인하기 위해서 아래 2가지 파이썬 코드를 돌려보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">#!/usr/bin/python\n### CPU Bound 어플리케이션 예시\n\ntest = 0\n\n\nwhile True:\n\ttest = test + 1\n\n#!/usr/bin/python\n### I/O Bound 어플리케이션 예시\n\nwhile True:\n\tf = open(&quot;./io_test.txt&quot;, &#39;w&#39;)\n\tf.write(&quot;test&quot;)\n\tf.close()</code></pre></div>\n<p>자 이 두가지 스크립트를 돌려보자\n먼저 CPU Bound 어플리케이션일 경우다.</p>\n<p><img src=\"https://i.imgur.com/sctfpuy.png\" alt=\"\"></p>\n<p>실제로 Load Average가 올라감을 확인할 수 있다.\n그렇다면, I/O Bound 어플리케이션은 어떨까?</p>\n<p><img src=\"https://i.imgur.com/BEitHl1.png\" alt=\"\"></p>\n<p>어떻게 보면 둘다 비슷한 Load Average를 보여주지만 실제로 주는 부하의 형태는 매우 다르다.\n부하의 종류에 따라서 해결방법도 달라진다.</p>\n<p>여기서는 단순한 파이썬 스크립트를 통해서 보여줬지만 실제 웹 어플리케이션이나 실무에서 겪는 문제에서도 이 문제를 해결하는 방식은 달라진다.\nCPU Bound 어플리케이션으로 인해 부하가 발생하면 신규 인스턴스를 투입하거나 로드밸런싱으로 부하분산을 할 수 있으나 I/O같은 경우에는 주로 DB같은데서 부하가 발생하므로 이중화해도 결국 똑같은 문제이다.\n이는 별도로 처리를 해줘야한다.</p>\n<p>이에 대해서 아주 자세히 설명한 강의가 있어서 이를 링크로 남겨본다.</p>\n<ul>\n<li><a href=\"https://class101.net/classic/products/T6HT0bUDKIH1V5i3Ji2M\">현직 대기업 개발자 푸와 함께하는 진짜 백엔드 시스템 실무!</a></li>\n</ul>\n<p>그렇다면, Load Average가 부하의 성격은 보여주지 않는데 CPU Bound인지 I/O Bound인지 파악할 수 있는 방법이 있을까?\n바로 <code class=\"language-text\">vmstat</code> 을 통해서 해결할 수 있다.</p>\n<p>CPU Bound 어플리케이션을 수행 후에 확인해보자.</p>\n<p><img src=\"https://i.imgur.com/f1akP5D.png\" alt=\"\"></p>\n<p>이제 I/O Bound 어플리케이션을 수행 후에 확인해보자.</p>\n<p><img src=\"https://i.imgur.com/dAtEzvt.png\" alt=\"\"></p>\n<p>포인트는 바로 <code class=\"language-text\">r</code> 과 <code class=\"language-text\">b</code> 열이다</p>\n<ul>\n<li>r : 실행되기를 기다리거나 현재 실행되고 있는 프로세스의 개수 (nr_running)</li>\n<li>b : I/O를 위해 대기열에 있는 프로세스의 개수 (nr_uniterruptible)</li>\n</ul>\n<p>실제로 이러한 부하는 운영하는 입장에서 시스템에 미치는 영향은 다양하다.\n이 때문에 실무에서 이러한 지표를 수집하는 것이라 볼 수 있다.</p>\n<h1 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h1>\n<p>이 책은 어떠한 명령어를 통해서 어떤 지표를 봐야하는 지와 그와 관련된 커널 내부 매커니즘을 설명한다.\n그렇다보니 OS에 대한 기본 배경지식이 없다면 읽기에 난이도가 높을 수 있다고 볼 수 있다.</p>\n<p>하지만, 책 자체가 친절하게 적혀있어서 더 궁금한 부분은 독자들의 몫으로 남겨줬다고 생각한다.</p>\n<p>우리는 초기에 이 기본 개념들을 이해하기 위한 최소한의 배경지식을 배웠고, 그 뒤로 커널 스케줄링이나 컨텍스트 스위치 개념 그리고 Load Average에 대한 개념을 배우게 되었다.\n책에서는 웹서버를 실제로 열어서 Load Average를 재곤했는데 이 부분은 생략하였다.</p>\n<p>궁금하신 분이 계시다면 책을 사서 읽기를 추천드린다.</p>\n<p>커널 공부를 하면서 느끼는 점은 결국 기본기가 매우 중요하다는 점이다.\n특히, 운영체제는 공부할 내용도 방대하고 엄두가 안날 때가 많다. 하지만 운영체제에서 쓰이는 개념들은 결국 웹 어플리케이션이나 프로그래밍 언어에서도 쓰인다.</p>\n<p>대표적으로 자바의 NIO에서는 기존 I/O의 성능을 올리기 위해서 OS 레벨의 기능들을 제공해주는데 그 중 대표적인 기능이 MMIO다.\n또한, 실제 어플리케이션들을 운영할 때 왜 이런식으로 튜닝하기를 권장하는 지 등도 운영체제를 공부하는데 도움이 된다.</p>\n<p>위 내용과 관련된 필자의 포스팅은 아래와 같다.</p>\n<ol>\n<li><a href=\"https://brewagebear.github.io/fundamental-nio-and-io-models/\">자바 NIO의 동작원리 및 IO 모델</a></li>\n<li><a href=\"https://brewagebear.github.io/fundamental-os-page-cache/\">왜 처리량이 중요한 JVM 어플리케이션은 vm.swappiness = 1로 설정하라고 할까?</a></li>\n</ol>\n<p>필자는 무협소설이나 웹툰을 좋아하는 편인데 무협지에는 이러한 대사가 많이 나온다.</p>\n<blockquote>\n<p>수단과 과정은 달라도 극에 달하면 결국 같은 걸로 귀결 된다. 정파든 사파든 마도든 극에 이르는 것은 같다.</p>\n</blockquote>\n<p>즉, 만류귀종이라고 볼 수 있다. 요즘 추상화된 레벨보다는 로우레벨 배경의 공부를 하다보니 문뜩 든 생각이었다.\n어? 이 개념 이거랑 같은데? 보면 비슷하고 그랬었다. 아직은 무림초출급 내공이지만 언젠가 공부를 계속하다보면 극에 달할 때가 올까?</p>\n<p>그 부분은 모르겠지만 궁금해서 하는 공부가 제일 재밌는 것 같다.</p>\n<h1 id=\"참고자료\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\" aria-label=\"참고자료 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고자료</h1>\n<ol>\n<li><a href=\"https://cs4118.github.io/www/2023-1/\">COMS W4118 Operating Systems 1 - Columbia University</a></li>\n<li><a href=\"https://blog.naver.com/PostView.naver?blogId=crushhh&#x26;logNo=221568455956\">시그널: 유저 공간에서 pause() 함수 호출 시 커널 실행 흐름 파악하기 - Austin Kim</a></li>\n<li><a href=\"http://books.gigatux.nl/mirror/kerneldevelopment/0672327201/ch04lev1sec2.html\">The Liunx Scheduling Algorithm - Team LiB</a></li>\n<li><a href=\"https://blog.naver.com/sysapi/20011482139\">wait Queue - 달려라</a></li>\n<li><a href=\"http://csl.snu.ac.kr/courses/4190.307/2020-1/9-mmap.pdf\">Memory Mapping - Seoul National University</a></li>\n<li><a href=\"https://class101.net/classic/products/T6HT0bUDKIH1V5i3Ji2M\">현직 대기업 개발자 푸와 함께하는 진짜 백엔드 시스템 실무!</a></li>\n</ol>","frontmatter":{"date":"August 23, 2023","title":"[Kernel] 리눅스 스케줄링 매커니즘과 Load Average","categories":"개발 인프라 독서요약","author":"개발한입","emoji":"💻"},"fields":{"slug":"/linux-kernel-internal-1/"}},"site":{"siteMetadata":{"siteUrl":"https://brewagebear.github.io","comments":{"utterances":{"repo":"brewagebear/blog-comments"}}}}},"pageContext":{"slug":"/overview-reactive-system/","nextSlug":"/fundamental-jvm-memory/","prevSlug":"/linux-kernel-internal-1/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}